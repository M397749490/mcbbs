{
    "title": "客户端服务端数据同步问题",
    "author": "数据system",
    "replyCount": 10,
    "timestamp": 1585707960,
    "txt_content": "                    \n                    entity.setname(\"magicbullet.png\");\n                    MessagePositionHistory message = new MessagePositionHistory();\n                    message.entity=entity;\n                    message.nbt = new NBTTagCompound();\n\n                    message.nbt.setString(\"name\",\"magicbullet.png\");\n                    NetworkLoader.instance.sendToAll(message);复制代码public class MessagePositionHistory implements IMessage\n{\n    public NBTTagCompound nbt;\n        public EntityMagicBullet entity;\n\n    @Override\n    public void fromBytes(ByteBuf buf)\n    {\n        nbt = ByteBufUtils.readTag(buf);\n    }\n\n    @Override\n    public void toBytes(ByteBuf buf)\n    {\n        ByteBufUtils.writeTag(buf, nbt);\n    }\n    \n    public static class Handler implements IMessageHandler<MessagePositionHistory, IMessage>\n    {\n        @Override\n        public IMessage onMessage(MessagePositionHistory message, MessageContext ctx)\n        {\n            if (ctx.side == Side.CLIENT)\n            {\n                final String name = message.nbt.getString(\"name\");\n                Minecraft.getMinecraft().addScheduledTask(new Runnable()\n                {\n                    @Override\n                    public void run()\n                    {\n                            //EntityPlayer player = Minecraft.getMinecraft().player;\n                            EntityMagicBullet e= message.entity;\n                            e.setname(name);\n                    }\n                });\n            }\n            return null;\n        }\n    }\n}复制代码\n\n如题，应该如何将服务端对自定义的数据同步到客户端，这样写似乎没有作用，是实体的数据没传输过去吗？应该如何去客户端同步某一实体的数据。",
    "replies": [
        {
            "author": "数据system",
            "timestamp": 1585743000,
            "txt_content": "没有大佬能来解答一下吗？"
        },
        {
            "author": "3TUSK",
            "timestamp": 1585767660,
            "txt_content": "Minecraft.getMinecraft().addScheduledTask(new Runnable()\n                {\n                    @Override\n                    public void run()\n                    {\n                            //EntityPlayer player = Minecraft.getMinecraft().player;\n                            EntityMagicBullet e= message.entity;\n                            e.setname(name);\n                    }\n                });复制代码\n显然你没有在这个数据包里写明“我要同步的是哪一个实体”。所以没有效果。\n\nsendToAll 方法是“面向玩家”的，也就是说你发送数据包，收数据包的人是你的玩家。玩家的客户端负责处理数据。你不写清楚是哪一个实体的数据需要同步，那玩家的客户端也就不知道哪一个实体的数据需要同步。\n具体来说，fromBytes() 方法里你不仅要从 ByteBuf 里读实体信息，还要读“是哪一个实体”。\n\n\n\n题外话，这个需求看上去用 DataParameter<?> 更好一点。一次同步一整个 NBT？你在浪费流量。"
        },
        {
            "author": "数据system",
            "timestamp": 1585794480,
            "txt_content": " 本帖最后由 数据system 于 2020-4-2 10:29 编辑 \n3TUSK 发表于 2020-4-2 03:01\n显然你没有在这个数据包里写明“我要同步的是哪一个实体”。所以没有效果。\n\nsendToAll 方法是“面向玩家 ...\n大佬这个该怎么去读取实体，ByteBufUtils好像没有读取实体的方法,这方面我实在不会，请问有教程之类的资料吗？"
        },
        {
            "author": "洞穴夜莺",
            "timestamp": 1585796760,
            "txt_content": "数据system 发表于 2020-4-2 10:28\n大佬这个该怎么去读取实体，ByteBufUtils好像没有读取实体的方法,这方面我实在不会，请问有教程之类的资料 ...\n读取实体的UUID，在客户端根据UUID找到这个实体"
        },
        {
            "author": "数据system",
            "timestamp": 1585805160,
            "txt_content": "Billy12345 发表于 2020-4-2 11:06\n读取实体的UUID，在客户端根据UUID找到这个实体    @SubscribeEvent\n    public void onUseItem(RightClickItem event) {\n            EntityLivingBase player=event.getEntityPlayer();\n            World worldIn=player.getEntityWorld();\n            ItemStack Mainhand=player.getHeldItemMainhand();\n            if(Mainhand.getDisplayName()==\"book\") {\n                    if (!worldIn.isRemote) {\n                    EntityMagicBullet entity=new EntityMagicBullet(worldIn, player);\n                    entity.setTime(360);\n                    worldIn.spawnEntity(entity);\n                    entity.setname(\"magicbullet.png\");\n                    \n                    MessagePositionHistory message = new MessagePositionHistory();\n                    UUID uuid=entity.getUniqueID();\n                    message.nbt = new NBTTagCompound();\n                    \n                    message.nbt.setString(\"name\",\"magicbullet.png\");\n                    message.nbt.setUniqueId(\"ID\", uuid);\n                    NetworkLoader.instance.sendToAll(message);\n                    }\n            }\n            \n    }复制代码    public static class Handler implements IMessageHandler<MessagePositionHistory, IMessage>\n    {\n        @Override\n        public IMessage onMessage(MessagePositionHistory message, MessageContext ctx)\n        {\n            if (ctx.side == Side.CLIENT)\n            {\n                final String name = message.nbt.getString(\"name\");\n                final UUID uuid = message.nbt.getUniqueId(\"ID\");\n                Minecraft.getMinecraft().addScheduledTask(new Runnable()\n                {\n                    @Override\n                    public void run()\n                    {\n                            EntityPlayerSP player=Minecraft.getMinecraft().player;\n                            World world =player.world;\n                            List<Entity> i=world.loadedEntityList;\n                            Entity t=i.get(0);\n                            int u=1;\n                            \n                            while((!uuid.equals(t.getUniqueID()))&&u<i.size()) {\n                                    t=i.get(u);\n                                    u++;\n                            }\n                            \n                            if(u<=i.size()) {((EntityMagicBullet) t).setname(name);}\n                    }\n                });\n            }\n            return null;\n        }\n    }复制代码请问这样是哪里出问题，实体还是没变化"
        },
        {
            "author": "洞穴夜莺",
            "timestamp": 1585812420,
            "txt_content": "没必要这么搞，直接用DataParameter<?>"
        },
        {
            "author": "数据system",
            "timestamp": 1586410380,
            "txt_content": "Billy12345 发表于 2020-4-2 15:27\n没必要这么搞，直接用DataParameter private static final DataParameter<Float> Yaw = EntityDataManager.<Float>createKey(EntityMagicBullet.class, DataSerializers.FLOAT);\n        private static final DataParameter<Float> Pitch = EntityDataManager.<Float>createKey(EntityMagicBullet.class, DataSerializers.FLOAT);\n        private static final DataParameter<String> Name = EntityDataManager.<String>createKey(Entity.class, DataSerializers.STRING);\n        \n        protected void entityInit() {\n                this.dataManager.register(Yaw,Float.valueOf(15.0f) );\n                this.dataManager.register(Pitch, Float.valueOf(15.0f) );\n                this.dataManager.register(Name, \"\");\n        }\n        public void setrotation(Float t1,Float t2) {\n                this.dataManager.set(Yaw, t1);\n                this.dataManager.set(Pitch, t2);\n        }\n        public Float getYaw() {\n                return (Float)this.dataManager.get(Yaw);\n        }\n        public Float getPitch() {\n                return (Float)this.dataManager.get(Pitch);\n        }复制代码那个大佬，请问一下，Yaw和Pitch的同步似乎都没有问题，但加上this.dataManager.register(Name, \"\");这条后实体就会无法召唤，这是什么原因？"
        },
        {
            "author": "洞穴夜莺",
            "timestamp": 1586427840,
            "txt_content": "数据system 发表于 2020-4-9 13:33\n那个大佬，请问一下，Yaw和Pitch的同步似乎都没有问题，但加上this.dataManager.register(Name, \"\");这条 ...\n有什么报错吗？\n我这样写是没问题的啊"
        },
        {
            "author": "数据system",
            "timestamp": 1586429580,
            "txt_content": "Billy12345 发表于 2020-4-9 18:24\n有什么报错吗？\n我这样写是没问题的啊\n[18:48:07] [Server thread/ERROR] [FML]: Exception caught during firing event net.minecraftforge.event.entity.player.PlayerInteractEvent$RightClickItem@f152f19:  java.lang.IllegalArgumentException: Duplicate id value for 6!          at net.minecraft.network.datasync.EntityDataManager.register(EntityDataManager.java:107) ~[EntityDataManager.class:?]          at com.data.dataextension.entity.EntityMagicBullet.entityInit(EntityMagicBullet.java:36) ~[EntityMagicBullet.class:?]          at net.minecraft.entity.Entity.(Entity.java:265) ~[Entity.class:?]          at net.minecraft.entity.projectile.EntityThrowable.(EntityThrowable.java:44) ~[EntityThrowable.class:?]          at net.minecraft.entity.projectile.EntityThrowable.(EntityThrowable.java:53) ~[EntityThrowable.class:?]          at net.minecraft.entity.projectile.EntityThrowable.(EntityThrowable.java:59) ~[EntityThrowable.class:?]          at com.data.dataextension.entity.EntityMagicBullet.(EntityMagicBullet.java:76) ~[EntityMagicBullet.class:?]          at com.data.dataextension.proxy.EventLoader.onUseItem(EventLoader.java:60) ~[EventLoader.class:?]          at net.minecraftforge.fml.common.eventhandler.ASMEventHandler_22_EventLoader_onUseItem_RightClickItem.invoke(.dynamic) ~[?:?]          at net.minecraftforge.fml.common.eventhandler.ASMEventHandler.invoke(ASMEventHandler.java:90) ~[ASMEventHandler.class:?]          at net.minecraftforge.fml.common.eventhandler.EventBus.post(EventBus.java:182) [EventBus.class:?]          at net.minecraftforge.common.ForgeHooks.onItemRightClick(ForgeHooks.java:1123) [ForgeHooks.class:?]          at net.minecraft.server.management.PlayerInteractionManager.processRightClick(PlayerInteractionManager.java:379) [PlayerInteractionManager.class:?]          at net.minecraft.network.NetHandlerPlayServer.processTryUseItem(NetHandlerPlayServer.java:796) [NetHandlerPlayServer.class:?]          at net.minecraft.network.play.client.CPacketPlayerTryUseItem.processPacket(CPacketPlayerTryUseItem.java:43) [CPacketPlayerTryUseItem.class:?]          at net.minecraft.network.play.client.CPacketPlayerTryUseItem.processPacket(CPacketPlayerTryUseItem.java:9) [CPacketPlayerTryUseItem.class:?]          at net.minecraft.network.PacketThreadUtil$1.run(PacketThreadUtil.java:21) [PacketThreadUtil$1.class:?]          at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source) [?:1.8.0_202]          at java.util.concurrent.FutureTask.run(Unknown Source) [?:1.8.0_202]          at net.minecraft.util.Util.runTask(Util.java:53) [Util.class:?]          at net.minecraft.server.MinecraftServer.updateTimeLightAndEntities(MinecraftServer.java:798) [MinecraftServer.class:?]          at net.minecraft.server.MinecraftServer.tick(MinecraftServer.java:743) [MinecraftServer.class:?]          at net.minecraft.server.integrated.IntegratedServer.tick(IntegratedServer.java:192) [IntegratedServer.class:?]          at net.minecraft.server.MinecraftServer.run(MinecraftServer.java:592) [MinecraftServer.class:?]          at java.lang.Thread.run(Unknown Source) [?:1.8.0_202]  [18:48:07] [Server thread/ERROR] [FML]: Index: 2 Listeners:  [18:48:07] [Server thread/ERROR] [FML]: 0: NORMAL  [18:48:07] [Server thread/ERROR] [FML]: 1: ASM: com.data.dataextension.proxy.EventLoader@7c732d09 onUseItemNBT3(Lnet/minecraftforge/event/entity/player/PlayerInteractEvent$RightClickItem;)V  [18:48:07] [Server thread/ERROR] [FML]: 2: ASM: com.data.dataextension.proxy.EventLoader@7c732d09 onUseItem(Lnet/minecraftforge/event/entity/player/PlayerInteractEvent$RightClickItem;)V  [18:48:07] [Server thread/FATAL] [minecraft/MinecraftServer]: Error executing task  java.util.concurrent.ExecutionException: java.lang.IllegalArgumentException: Duplicate id value for 6!          at java.util.concurrent.FutureTask.report(Unknown Source) ~[?:1.8.0_202]          at java.util.concurrent.FutureTask.get(Unknown Source) ~[?:1.8.0_202]          at net.minecraft.util.Util.runTask(Util.java:54) [Util.class:?]          at net.minecraft.server.MinecraftServer.updateTimeLightAndEntities(MinecraftServer.java:798) [MinecraftServer.class:?]          at net.minecraft.server.MinecraftServer.tick(MinecraftServer.java:743) [MinecraftServer.class:?]          at net.minecraft.server.integrated.IntegratedServer.tick(IntegratedServer.java:192) [IntegratedServer.class:?]          at net.minecraft.server.MinecraftServer.run(MinecraftServer.java:592) [MinecraftServer.class:?]          at java.lang.Thread.run(Unknown Source) [?:1.8.0_202]  Caused by: java.lang.IllegalArgumentException: Duplicate id value for 6!          at net.minecraft.network.datasync.EntityDataManager.register(EntityDataManager.java:107) ~[EntityDataManager.class:?]          at com.data.dataextension.entity.EntityMagicBullet.entityInit(EntityMagicBullet.java:36) ~[EntityMagicBullet.class:?]          at net.minecraft.entity.Entity.(Entity.java:265) ~[Entity.class:?]          at net.minecraft.entity.projectile.EntityThrowable.(EntityThrowable.java:44) ~[EntityThrowable.class:?]          at net.minecraft.entity.projectile.EntityThrowable.(EntityThrowable.java:53) ~[EntityThrowable.class:?]          at net.minecraft.entity.projectile.EntityThrowable.(EntityThrowable.java:59) ~[EntityThrowable.class:?]          at com.data.dataextension.entity.EntityMagicBullet.(EntityMagicBullet.java:76) ~[EntityMagicBullet.class:?]          at com.data.dataextension.proxy.EventLoader.onUseItem(EventLoader.java:60) ~[EventLoader.class:?]          at net.minecraftforge.fml.common.eventhandler.ASMEventHandler_22_EventLoader_onUseItem_RightClickItem.invoke(.dynamic) ~[?:?]          at net.minecraftforge.fml.common.eventhandler.ASMEventHandler.invoke(ASMEventHandler.java:90) ~[ASMEventHandler.class:?]          at net.minecraftforge.fml.common.eventhandler.EventBus.post(EventBus.java:182) ~[EventBus.class:?]          at net.minecraftforge.common.ForgeHooks.onItemRightClick(ForgeHooks.java:1123) ~[ForgeHooks.class:?]          at net.minecraft.server.management.PlayerInteractionManager.processRightClick(PlayerInteractionManager.java:379) ~[PlayerInteractionManager.class:?]          at net.minecraft.network.NetHandlerPlayServer.processTryUseItem(NetHandlerPlayServer.java:796) ~[NetHandlerPlayServer.class:?]          at net.minecraft.network.play.client.CPacketPlayerTryUseItem.processPacket(CPacketPlayerTryUseItem.java:43) ~[CPacketPlayerTryUseItem.class:?]          at net.minecraft.network.play.client.CPacketPlayerTryUseItem.processPacket(CPacketPlayerTryUseItem.java:9) ~[CPacketPlayerTryUseItem.class:?]          at net.minecraft.network.PacketThreadUtil$1.run(PacketThreadUtil.java:21) ~[PacketThreadUtil$1.class:?]          at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source) ~[?:1.8.0_202]          at java.util.concurrent.FutureTask.run(Unknown Source) ~[?:1.8.0_202]          at net.minecraft.util.Util.runTask(Util.java:53) ~[Util.class:?]          ... 5 more\n召唤实体时游戏没有崩溃，控制台输出了这些东西\n"
        },
        {
            "author": "洞穴夜莺",
            "timestamp": 1586475240,
            "txt_content": "数据system 发表于 2020-4-9 18:53\n召唤实体时游戏没有崩溃，控制台输出了这些东西\nprivate static final DataParameter<String> Name = EntityDataManager.<String>createKey(Entity.class, DataSerializers.STRING);\n改成\nprivate static final DataParameter<String> Name = EntityDataManager.<String>createKey(EntityMagicBullet.class, DataSerializers.STRING);"
        }
    ]
}