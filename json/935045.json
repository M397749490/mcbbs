{
    "title": "在Linux下配合第三方网盘客户端实现自动差异备份到网盘",
    "author": "Zapic",
    "replyCount": 3,
    "timestamp": 1577164800,
    "txt_content": " 本帖最后由 Zapic 于 2019-12-25 13:40 编辑 \n \n  FBI Warning\n\n\nYour data are invaluable,please operate with cautiousness.\nThe way to backup in article doesn't test carefully,you'd better NOT TO USE IT IN PRODUCTION.\nThis article DOSE NOT APPLY TO Windows,do this with your hand if you're using Windows.\n \n  索引\n\n\n     废话\n       为啥要\"差异备份\"? \n       \n     安装需求\n       \n     基本操作\n       创建基础压缩包\n       创建差异压缩包\n       备份MySQL数据库\n       上传到网盘\n       \n     自动化\n       一键脚本\n       Crontab定时备份/上传\n       \n     恢复数据\n       \n\n \n  在Linux下配合第三方网盘客户端实现自动差异备份到网盘\n\n\n     废话\n  \n  为啥要\"差异备份\"?\n\n  有很多腐竹喜欢把服务器打包备份到网盘,每次都需要将文件完全打包,再占用服务器上传带宽上传到网盘里,这样对带宽的影响大而久.\n  但是差异备份,顾名思义,仅备份与之前不同的文件,未修改的文件将被忽略.这可以大大减小备份压缩包的大小,以减少备份所用时间/上传对带宽的影响.\n\n  一个服务器修改最频繁的可能就是地图存档了.其他很多文件可能都不会动.况且很多时候大部分存档处于不活动的状态,这时候每次都备份他们就会显得很多此一举.\n  每天活动的文件可能就...那么几十M?我们为啥要带上那一堆根本没有修改过的文件呢?\n  如果使用差异备份,可以大大减小你每次备份的文件大小和所需时间.\n  所以这就是差异备份存在的意义,也是这篇教程存在的意义.\n  想想都爽\n\n     安装需求\n  GNU Tar(系统应该自带)GNU Gzip(系统应该自带)或XZUtils(系统可能自带)Crontab(大部分系统自带)iikira/BaiduPCS-Go(百度网盘用上传工具)或rclone(WebDAV/OneDrive/Google Drive/SFTP等上传工具),按需求安装.\n   前三项的安装在网上教程烂大街,不做解释.\n\n  关于BaiduPCS-Go安装的方法:\n在Releases页面下载对应系统/硬件的文件(发行说明里有详细的解释).解压(unzip xxx)并赋权(chmod +x xxx).尝试登陆百度账号(BaiduPCS-Go login).\n\n  关于rclone安装的方法:\n在Releases页面下载对应系统/硬件的压缩包(64位amd64,32位386).解压(unzip xxx)并赋权(chmod +x xxx).尝试登陆网盘(rclone config,选择new,按照提示操作).\n\n     基本操作\n  \n  创建基础压缩包\n\n  建议为备份文件创建独立的文件夹,防止意外操作.教程内将以\"/var/backup/\"文件夹作为备份文件夹,\"/home/zapic/msvr/\"作为mc服务器文件夹.\n  \n  创建基本压缩包很简单,只需要一条命令:\ntar -g <snapfile>.snap -czf <filename> <directory/file>复制代码 比如:\ntar -g /var/backup/msvr.snap -czf /var/backup/msvr_backup_full_2019_12_24_15_47.tar.gz /home/zapic/msvr复制代码\n  这样就可以获得一个位于\"/var/backup\"基础压缩包和一个差异文件.\n  当然,可以不必写绝对路径,但这会对后面的自动化造成影响(无法正确确定文件位置),[ruby=心里有B数]有linux基础[/ruby]的观众可以试试.\n\n  请注意,差异文件十分重要.如果差异文件丢失,差异压缩包会无法正常恢复你的数据,因此请务必妥善保存.\n\n\n\n  创建差异压缩包  \n  命令跟之前一样:\ntar -g <snapfile>.snap -czf <filename> <directory/file>复制代码  但是需要指定一个有效的差异文件.如果差异文件不存在就会自动创建新的差异文件,并进行一次基础压缩包的创建.\n  在上面的例子中已经在\"/var/backup\"创建了一个基础备份和一个差异文件,那么这样就可以创建一个差异压缩包: tar -g /var/backup/msvr.snap -czf /var/backup/msvr_backup_diff_2019_12_24_15_59.tar.gz /home/zapic/msvr复制代码  然后你就得到一个包含从上次基础备份后修改过的文件的备份.\n  当然,一个差异文件后创建后可以反复使用.你可以通过修改命令里的文件名以创建一个新的差异备份到新的文件里.\n\n\n  备份MySQL数据库  \n  有的服务器可能会使用MySQL数据库,备份只需要将数据库导出到文件连同服务端一同备份即可.mysqldump -u<用户名> -p<密码> -h<数据库IP> -P<数据库端口> --database <数据库名> > <输出文件名>复制代码  例如将\"msvr\"数据库备份导出到\"/home/zapic/msvr/sqlbak.sql\"里:mysqldump -uroot --database mc >  /home/zapic/msvr/sqlbak.sql复制代码  当然,把数据库导出到与MC服务端同一文件夹下是最好的,可以一同备份.\n\n\n  上传到网盘 \n  对于BaiduPCS-Go:\nBaiduPCS-Go u <本地文件/目录的路径1> <文件/目录2> <文件/目录3> ... <目标目录>复制代码  假设你已经登陆了网盘账号.\n  例如将上面创建的三个文件上传到网盘的\"backup\"文件夹里:\nBaiduPCS-Go u /var/backup/msvr.snap /var/backup/msvr_backup_diff_2019_12_24_15_59.tar.gz /var/backup/msvr_backup_full_2019_12_24_15_47.tar.gz /backup复制代码  等待上传完毕.\n  由于他会自动覆盖旧的同名文件,所以无需删除旧的文件.  \n\n  对于Rclone:\nrclone copy source:<file/directory> dest:<file/directory>复制代码  假设你有且只有一个配置.\n  由于不支持一条命令上传多个文件,这里直接上传整个备份文件夹到网盘的\"backup\"文件夹内:\nrclone copy /var/backup /backup复制代码  等待上传完毕.\n\n  rclone不会覆盖旧的文件,在第二次上传时先删除旧的差异文件:\nrclone delete <file/directory>复制代码  这里差异文件为\"msvr.snap\",位于网盘的\"/backup\"文件夹内:\nrclone delete /backup/msvr.snap复制代码  再上传:\nrclone copy /var/backup /backup复制代码 \n     自动化\n  \n  一键脚本\n\n  把上面的命令拼一下,再把路径写成绝对的,最后自动生成日期就完事了:#!/bin/bash\ndate=`date +%Y_%m_%d_%H_%M`复制代码\n  如果需要上传再补一句上传:\n  BaiduPCS-Go:\n#!/bin/bash\ndate=`date +%Y_%m_%d_%H_%M`\nmysqldump -uroot --database mc >  /home/zapic/msvr/sqlbak.sql\n/bin/tar -g /var/backup/msvr.snap -czf /var/backup/msvr_backup_diff_${date}.tar.gz /home/zapic/msvr\n/path/to/your/BaiduPCS-Go u /var/backup/msvr.snap /var/backup/msvr_backup_diff_${date}.tar.gz /backup复制代码\n  Rclone:\n#!/bin/bash\ndate=`date +%Y_%m_%d_%H_%M`\nmysqldump -uroot --database mc >  /home/zapic/msvr/sqlbak.sql\n/bin/tar -g /var/backup/msvr.snap -czf /var/backup/msvr_backup_diff_${date}.tar.gz /home/zapic/msvr\nrclone delete /backup/msvr.snap\nrclone copy /var/backup /backup复制代码  注意按实际情况修改绝对路径.\n  \n  Crontab定时备份/上传\n\n  先按上面的步骤写一个一键脚本,保存并赋权运行(chmod +x xxx).\n  然后按照需求编写定时运行语句,参考教程 Linux crontab 命令 | 菜鸟教程\n  例如每日凌晨3点执行备份:* 3 * * * /path/to/your/script.sh复制代码  直接把这一句添加到文件末尾保存退出即可.\n  \n     恢复数据\n  \n  你需要3个文件:\n 基础备份包 你想要恢复到的时间点的差异备份包(如果时间点恰为基础备份包创建时间则不需要) 差异文件\n\n  先恢复基础包:tar -g <SnapFilename> -zcf <filename> <directory>复制代码  例如:tar -g /var/backup/msvr.snap -zcf /var/backup/msvr_backup_full_2019_12_24_15_47.tar.gz /home/zapic/msvr复制代码  然后再恢复差异备份包,直接往文件夹里覆盖解压即可:tar -g /var/backup/msvr.snap -zcf /var/backup/msvr_backup_diff_2019_12_24_15_59.tar.gz /home/zapic/msvr复制代码  记得恢复数据库,在MySQL命令行界面输入如下指令:use <database>;source <path to sql file>;复制代码  例如:use mc;source /home/zapic/msvr/sqlbak.sql;复制代码  然后一次恢复就完成了.\n  \n\n \n  再 废 话\n\n\n  数据无价,谨慎操作.\n  仅供实验,翻车概不负责.\n  请[ruby=把人] 支 [/ruby][ruby=气给] 持 [/ruby]我.[groupid=1701]Complex Studio[/groupid]",
    "replies": [
        {
            "author": "袋里的鲨",
            "timestamp": 1578025500,
            "txt_content": "如果不使用 https://www.mcbbs.net/thread-935523-1-1.html 的话\n\n这个表格似乎出锅了 = ="
        },
        {
            "author": "Zapic",
            "timestamp": 1578025620,
            "txt_content": "袋里的鲨 发表于 2020-1-3 12:25\n如果不使用 https://www.mcbbs.net/thread-935523-1-1.html 的话\n\n这个表格似乎出锅了 = = ...\n毕竟那个就是为了解决这个破问题而出现的,我不想修改现有样式."
        },
        {
            "author": "晓夜Port",
            "timestamp": 1582281360,
            "txt_content": "排版炸了。。把代码文字删掉吧"
        }
    ]
}