{
    "title": "记一次解决Disabling terminal...unsupported environment的经历",
    "author": "a1294790523",
    "replyCount": 2,
    "timestamp": 1592236980,
    "txt_content": " 本帖最后由 a1294790523 于 2020-6-16 00:10 编辑 \n\n太长不看版：\n下载Jna的核心jar，然后将里面除了META-INF的文件夹拖进服务端核心即可：\nhttps://repo1.maven.org/maven2/net/java/dev/jna/jna/5.5.0/jna-5.5.0.jar\n如果仍然没有解决，请参考梨子的解决帖：https://www.mcbbs.net/thread-548550-1-1.html\n安装Microsoft Visual C++ 2008 SP1 Redistributable包\n\n起因\n某天闲着无聊想组一个1.12的纯Forge服务端和朋友玩，但是发现在服务端使用Tab补全时不管用，只会输出Tab字符。\n奇怪的我翻了翻日志，发现第一行有这么一行warning：2020-06-15 22:51:47,089 main WARN Disabling terminal, you're running in an unsupported environment.我当时就？？？了，因为从来没遇到这种情况，只好上网冲浪搜索看看\n解决经过\n排在首页的结果都是Forge论坛内的，满心欢喜的我打开一看，结果里面都是“此版本已不受支持，请升级MC版本”。\n不过老天不负有心人，总算是让我在这个paper的issue里面看见了曙光：1.14.3 unsupported environment terminal\nhttps://github.com/PaperMC/Paper/issues/2257虽然说这个issue最后是通过PR解决的，但是我在回复中注意到了这个：Minecrell:\nTCA prints a proper stack trace for this when debug logging is enabled:\nhttps://github.com/Minecrell/TerminalConsoleAppender/blob/23ac053d5a401761555f55cc6bb668a9f3474ad6/src/main/java/net/minecrell/terminalconsole/TerminalConsoleAppender.java#L241-L246\nRight now I can't remember exactly how to enable debug logging. I believe it's not in log4j2.xml since it runs before logging configuration is initialized (you can see that because of the different log layout).\nSo it's probably one of the system properties: https://logging.apache.org/log4j/2.x/manual/configuration.html#SystemProperties通过查看代码可以发现当LOGGER.isDebugEnabled()返回true时输出带stacktrace的异常信息，从此总算有个入手点了，那么，怎么让LOGGER.isDebugEnabled()==true呢？\n通过搜索，发现只需要让日志等级为DEBUG即可，于是愉悦地打开服务端核心jar，编辑内部的log4j2_server.xml修改日志级别，然后删除在META-INF的校验文件，启动一看：\n2020-06-15 22:59:04,831 main WARN Disabling terminal, you're running in an unsupported environment. java.lang.IllegalStateException: Unable to create a system terminal\nat org.jline.terminal.TerminalBuilder.doBuild(TerminalBuilder.java:273)\nat org.jline.terminal.TerminalBuilder.build(TerminalBuilder.java:219)\nat net.minecraftforge.server.terminalconsole.TerminalConsoleAppender.initializeTerminal(TerminalConsoleAppender.java:243)\nat net.minecraftforge.server.terminalconsole.TerminalConsoleAppender.<init>(TerminalConsoleAppender.java:213)\nat net.minecraftforge.server.terminalconsole.TerminalConsoleAppender.createAppender(TerminalConsoleAppender.java:368)\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\nat sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)\nat java.lang.reflect.Method.invoke(Unknown Source)\nat org.apache.logging.log4j.core.config.plugins.util.PluginBuilder.build(PluginBuilder.java:132)\nat org.apache.logging.log4j.core.config.AbstractConfiguration.createPluginObject(AbstractConfiguration.java:952)\nat org.apache.logging.log4j.core.config.AbstractConfiguration.createConfiguration(AbstractConfiguration.java:892)\nat org.apache.logging.log4j.core.config.AbstractConfiguration.createConfiguration(AbstractConfiguration.java:884)\nat org.apache.logging.log4j.core.config.AbstractConfiguration.doConfigure(AbstractConfiguration.java:508)\nat org.apache.logging.log4j.core.config.AbstractConfiguration.initialize(AbstractConfiguration.java:232)\nat org.apache.logging.log4j.core.config.AbstractConfiguration.start(AbstractConfiguration.java:244)\nat org.apache.logging.log4j.core.LoggerContext.setConfiguration(LoggerContext.java:545)\nat org.apache.logging.log4j.core.LoggerContext.reconfigure(LoggerContext.java:617)\nat org.apache.logging.log4j.core.LoggerContext.reconfigure(LoggerContext.java:634)\nat org.apache.logging.log4j.core.LoggerContext.start(LoggerContext.java:229)\nat org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:242)\nat org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:45)\nat org.apache.logging.log4j.LogManager.getContext(LogManager.java:174)\nat org.apache.logging.log4j.LogManager.getLogger(LogManager.java:618)\nat net.minecraft.launchwrapper.LogWrapper.configureLogging(LogWrapper.java:14)\nat net.minecraft.launchwrapper.LogWrapper.log(LogWrapper.java:28)\nat net.minecraft.launchwrapper.Launch.launch(Launch.java:94)\nat net.minecraft.launchwrapper.Launch.main(Launch.java:28)\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\nat sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)\nat java.lang.reflect.Method.invoke(Unknown Source)\nat net.minecraftforge.fml.relauncher.ServerLaunchWrapper.run(ServerLaunchWrapper.java:70)\nat net.minecraftforge.fml.relauncher.ServerLaunchWrapper.main(ServerLaunchWrapper.java:34)\nSuppressed: java.lang.NoClassDefFoundError: com/sun/jna/win32/StdCallLibrary\nat java.lang.ClassLoader.defineClass1(Native Method)\nat java.lang.ClassLoader.defineClass(Unknown Source)\nat java.security.SecureClassLoader.defineClass(Unknown Source)\nat java.net.URLClassLoader.defineClass(Unknown Source)\nat java.net.URLClassLoader.access$100(Unknown Source)\nat java.net.URLClassLoader$1.run(Unknown Source)\nat java.net.URLClassLoader$1.run(Unknown Source)\nat java.security.AccessController.doPrivileged(Native Method)\nat java.net.URLClassLoader.findClass(Unknown Source)\nat java.lang.ClassLoader.loadClass(Unknown Source)\nat sun.misc.Launcher$AppClassLoader.loadClass(Unknown Source)\nat java.lang.ClassLoader.loadClass(Unknown Source)\nat org.jline.terminal.impl.jna.win.JnaWinSysTerminal.<clinit>(JnaWinSysTerminal.java:25)\nat org.jline.terminal.impl.jna.JnaSupportImpl.winSysTerminal(JnaSupportImpl.java:26)\nat org.jline.terminal.TerminalBuilder.doBuild(TerminalBuilder.java:297)\n... 33 more\nCaused by: java.lang.ClassNotFoundException: com.sun.jna.win32.StdCallLibrary\nat java.net.URLClassLoader.findClass(Unknown Source)\nat java.lang.ClassLoader.loadClass(Unknown Source)\nat sun.misc.Launcher$AppClassLoader.loadClass(Unknown Source)\nat java.lang.ClassLoader.loadClass(Unknown Source)\n... 48 more\nSuppressed: java.lang.UnsupportedOperationException\nat org.jline.terminal.impl.jansi.JansiSupportImpl.winSysTerminal(JansiSupportImpl.java:104)\nat org.jline.terminal.TerminalBuilder.doBuild(TerminalBuilder.java:305)\n... 33 more好家伙，没找到类，肯定是Forge忘记打包了，通过一番搜索找到这个类是一个叫jna的库里面的：https://github.com/java-native-access/jna\n在里面找到了jna核心jar的下载地址：https://repo1.maven.org/maven2/net/java/dev/jna/jna/5.5.0/jna-5.5.0.jar\n那么怎么让java载进这个jar呢？\n最简单粗暴的方法就是将里面的类拖进服务端核心里面：\n\n\n\n\nTIM截图20200615232552.jpg (60.97 KB, 下载次数: 0)\n\n下载附件\n\n2020-6-15 23:26 上传\n\n\n\n\n\n至此问题解决\n相关链接：\n服务器出现关于org.fusesource.jansi.WindowsAnsiOutputStream的错误之解决办法\nhttps://www.mcbbs.net/thread-548550-1-1.html",
    "replies": [
        {
            "author": "qiuzz",
            "timestamp": 1592338680,
            "txt_content": "???????????????????????????????????"
        },
        {
            "author": "310749832",
            "timestamp": 1592551320,
            "txt_content": "感谢分享"
        }
    ]
}