{
    "title": "[内网穿透][lunnel]使用无公网ip主机开服的实现",
    "author": "inapp",
    "replyCount": 4,
    "timestamp": 1520136480,
    "txt_content": " 本帖最后由 inapp 于 2018-3-5 12:25 编辑 \n\n基于内网穿透使用无公网主机开服的实现\n\nPrologue.序言\n\n总所周知，服务器要提供服务，必须要暴露一些端口到公网。就好比你要和一个人交♂易，你总得碰着他才行，对吧？\n\n说到碰到主机，这里有几个思路：直接暴露到公网，代理，反向代理。\n\n为了方便说明，我们打个比方：想象有一个神奇的国度，国度里住着三个神奇的大魔法师，他们分别掌握着各种神奇的魔术，而且都很愿意将这些魔术传授给本国的居民。这时候，某Artoria想向这三位大师学习一点简单的魔术，她便向邻居询问如何才能找到这三位大师，邻居告诉她：\n\n大师1特别坐不住。总喜欢在大街上游荡，在自己家门口就可能遇见他大师2是个死宅，总喜欢宅在家里面，想找他，得去他家里面。大师3很害怕与外界事物直接接触，他总是把自己关在家里面。若你想找他，得通过他的信使转述才行。\n\n按照这三个大师的特点，Artoria决定了向他们请教的办法：\n\n对于大师1，搞不好在家门口都能直接撞到他，直接乘机请教就好。对于大师2，可以跑到他家里去请教他。对于大师3，可以由他的信使转达请教的内容。\n\n在这个例子中，如果把大师们看作服务器，同时将Artoria看作客户端，那么便会是这样一幅图景：\n\n服务器1（大师1）将自己暴露在公网（大街）上，任何一个客户端（Artoria）都可以直接和他通讯（请教问题）。服务器2（大师2）处在本地网（宅在家）中，客户端（Artoria）要想与它通信（请教问题），需要通过代理进入内网（跑到他家里）。服务器3（大师3）也处在本地网（宅在家）中，客户端（Artoria）要想与它通信，需要一台中转服务器（大师3的信使）将请求（请教的内容）反向代理到服务器3上。\n\n在这三个服务器中，第一个服务器的设计是最简单，也是最高效的。在整个通信过程当中，只有服务器本身与客户端直接通信。如果可行的话，推荐大家都采用这种方法开服。但受限于我锅特色宽带基本不提供将计算机暴露到公网的服务，我们只得另寻僻径。\n\n在本教程中，我们主要通过longXboy的lunnel来还原服务器3的方案\n\n在这篇教程开始之前，我们先来看看我们需要一些什么：\n\n一台处于公网的服务器（最好高带宽，不要流量计费） 整个服务器的流量基本都跑在这上面，其带宽需要2倍于正常开服时所用的带宽。\n\n最好linux系统且最好是debian系。。。没有apt的世界真的是一片黑暗。。。下面的教程也会采用debian系作为演示教学.游戏/应用服务端\n\n因为我没有这么多计算机，所以我将用几台虚拟机来模拟出同样的效果。大概如下：\n\n有两台虚拟机，分别命名为server,reverseproxy\nserver,就是处于内网中的服务器。\nreverseproxy,就是中转服务器。\n至于Artoria去哪了。。。那就是我的物理机啦。。。\n三台机器的用户名都是saber(月厨guna!)复制代码\n注：为了防止混淆两台服务器，我们约定放在公网中的那台，也就是扮演\"信使\"角色的那一台称为信使服务器，而位于本地的那台，也就是扮演\"大师3\"角色的那一台称为主服务器。\n\n准备好了么？\n\nChapter.1 配置信使服务器\n\n1.登陆信使服务器\n\n(这个就不用我教了吧。。。什么putty,xshell都行)\n\n2.更新软件源并安装一些必要的软件:\n\nsudo apt-get update复制代码\n\n\n在使用sudo命令时，可能需要输入密码。\n\n若提示\"[sudo] password for <用户名>：\"，请输入当前用户的密码\n\n注：密码不会显示出来（连星号都没有）。使劲输就对了\n\nsudo apt-get install golang git screen nano make -y复制代码\n\n\n3.下载编译lunnel.\n\ngit clone https://github.com/longXboy/lunnel.git复制代码\n\n\n重建目录结构,切换到构建目录。\n\nmkdir go\nmkdir go/src\nmkdir go/src/github.com\nmkdir go/src/github.com/longXboy\nmv -rf lunnel go/src/github.com/longXboy/\nexport GOPATH=$(pwd)\ncd go/src/github.com/longXboy/lunnel复制代码\n开始编译。\n\nmake复制代码\n\n\n对，就这么短！\n\n将编译出来的程序丢到一个目录里。\n\ncp -rf bin ~/lunnelbin复制代码\n现在已经编译好了lunnel的服务端与客户端。\n\n如果你的主机与信使服务器架构，系统，位数都相同的话，那么你可以直接把编译出来的客户端传到主服务器上使用。请执行以下命令，并跳至下方\"4.配置lunnel服务端\"\n\ncp -rf ~/lunnelbin/client ~/client\ntar czvf ~/client.tar.gz -C ~/ client/复制代码\n否则。。。我们需要使用一种名为交叉编译的科技。\n\nA cross compiler is a compiler capable of creating executable code for a platform) other than ** on which the compiler is running. For example, a compiler that runs on a Windows 7 PC but generates code that runs on Android) smartphone is a cross compiler.\n\n---Wikipedia,CC-BY-SA 3.0\n请先按照以下模板填空，然后复制到信使服务器终端：\n\nGOOS=<请填空1> GOARCH=<请填空2> make复制代码\n将<请填空1>按照以下规则替换：\n\n若你的主服务器的系统为windows，请填空windows\n若你的主服务器的系统为linux，请填空linux\n若你的主服务器的系统为Mac os(OSX)，请填空drawin复制代码\n将<请填空2>按照以下规则替换：\n\n若你的主服务器cpu是龙芯，请收下我的膝盖并填空mips64le\n若你的主服务器为32位，请填空386\n若你的主服务器为64位，请填空amd64复制代码\n记得要连着尖括号一起替换掉！！！\n\n一个回车下去瞬！间！爆！炸！执行代码。\n\n\n\n复制并整理客户端。\n\ncp -rf bin/client ~/client\ntar czvf ~/client.tar.gz -C ~/ client/复制代码\n4.配置lunnel服务端\n\n回到主目录,复制一份lunnel服务端,切换到lunnel服务端目录:\n\ncd ~\ncp -rf lunnelbin/server .\ncd server复制代码\n用文本编辑器(我使用的是nano编辑器)新建并编辑配置文件：\n\nnano config.yml复制代码\n进入后，复制以下模板：\n\nserver_domain: <请填空1>\nport: <请填空2>\nhttp_port: <请填空3>\nhttps_port: <请填空4>\naes:\n  secret_key: <请填空5>\nhealth:\n  interval: 15\n  timeout: 40复制代码\n按照以下规则填空：\n\n将<请填空1>替换为信使服务器的域名。如果没有域名的话请把整行删去。\n将<请填空2>替换为信使服务器的连接端口(＞1，＜65535，尽量大一些。）\n将<请填空3>替换为信使服务器的http(网页)端口(＞1，＜65535，尽量大一些。）\n将<请填空4>替换为信使服务器的https(加密网页)端口(＞1，＜65535，尽量大一些。）\n将<请填空5>替换为你想使用的密码（用于加密，可以复杂一些）并将密码记录下来。\n注意：2,3,4不能重复！复制代码\n替换好后大概是这个样子↓\n\n\n\n保存并退出编辑器（如果你也用nano，请按Ctrl-X 然后按Y,然后按回车）\n\n启动一次做测试：\n\n./lunnelSer复制代码\n如果启动后大概长这个样子↓，说明配置无误！\n\n\n\n如果出现错误，请参考附录1。\n\n5.启动lunnel服务端：\n\n在后台运行这玩意有两种方式：\n\n丢进一个screen里面直接丢到后台里。\n\n第一种方式适用于你没事想把服务端捞出来看看长啥样了，而第二种方式适用于你就想让服务端跑，并不想管他。\n\n对于第一种方法：\n\nscreen -S lunnel\n./lunnelSer复制代码\n然后按住ctrl，按A，放开A，按D，放开D，放开ctrl,完成。\n\n以后想捞出来的时候，输入以下指令：\n\nscreen -r lunnel复制代码\n再把它丢回去的方法和上面说的（按住ctrl，按A，放开A，按D，放开D，放开ctrl）一样。\n\n对于第二种方法：\n\nnohup ./lunnelSer &复制代码\n完成，以后想关闭它的时候直接\n\nkillall lunnelSer复制代码\nChapter.2 配置主服务器\n\n1.若你的主服务器是linux系统:\n\n先在主服务器上下载一份lunnel客户端\n\n请在主服务器上输入以下指令：\n\nscp <信使服务器用户名>@<信使服务器ip>:~/client.tar.gz client.tar.gz复制代码\n\n\n下载完成后进行解压并切换进客户端目录：\n\ntar xzvf client.tar.gz\ncd client复制代码\n用文本编辑器(我又使用了nano编辑器)新建并编辑配置文件：\n\nnano config.yml复制代码\n复制以下模板：\n\nserver_addr: <请填空1>:<请填空2>\ntunnels:\n  mcserver:\n    schema: tcp\n    port: <请填空3>\n    local: 127.0.0.1:<请填空4>\nencrypt_mode: aes\naes:\n  secret_key: <请填空5>\nenable_compress: true\ntransport: mix\nhealth:\n  interval: 15\n  timeout: 40复制代码\n按照以下规则填空\n\n将<请填空1>替换为信使服务器的ip\n将<请填空2>替换为信使服务器的连接端口(上面写过的那个)\n将<请填空3>替换为想让玩家连接游戏的端口,minecraft默认为25565\n将<请填空4>替换为本地游戏服务端的端口,minecraft默认为25565\n将<请填空5>替换为上面记下来的密码复制代码\n替换好后大概是这个样子：\n\n\n\n保存并退出编辑器（如果你也用nano，请按Ctrl-X 然后按Y,然后按回车）\n\n启动一次做测试：\n\n./lunnelCli复制代码\n如果启动后大概长这个样子↓，说明配置无误！\n\n\n\n如果出现错误，请参考附录1。\n\n接着把它用上方提到的方式丢到后台，启动游戏服务端，跳转到Chapter.3吧!\n\n2.若你的主服务器是Windows系统:\n\n先在主服务器上下载pscp:https://the.earth.li/~sgtatham/putty/latest/w32/pscp.exe  将其复制到你想安装lunnel的位置，然后按住shift,点击右键，选择“在此处打开命令窗口”\n\n\n\n然后在打开的命令提示符中输入：\n\npscp <信使服务器用户名>@<信使服务器ip>:/home/<信使服务器用户名>/client.tar.gz client.tar.gz复制代码\n\n\n解压client.tar.gz,进入client目录\n\n将lunnelCli文件重命名，在后面添加“.exe”后缀名\n\n\n\n用文本编辑器(我使用notepad++编辑器)新建并编辑配置文件\n\n复制以下模板：\n\nserver_addr: <请填空1>:<请填空2>\ntunnels:\n  mcserver:\n    schema: tcp\n    port: <请填空3>\n    local: 127.0.0.1:<请填空4>\nencrypt_mode: aes\naes:\n  secret_key: <请填空5>\nenable_compress: true\ntransport: mix\nhealth:\n  interval: 15\n  timeout: 40复制代码\n按照以下规则填空\n\n将<请填空1>替换为信使服务器的ip\n将<请填空2>替换为信使服务器的连接端口(上面写过的那个)\n将<请填空3>替换为想让玩家连接游戏的端口,minecraft默认为25565\n将<请填空4>替换为本地游戏服务端的端口,minecraft默认为25565\n将<请填空5>替换为上面记下来的密码复制代码\n保存该配置文件为config.yml(在保存时将保存类型设置为所有文件，在文件名处填写config.yml)\n\n按照以上操作执行以后，大概是这个样子的↓\n\n\n\n启动一次做测试.如果启动后大概像这样↓，说明配置无误！\n\n如果出现错误，请参考附录1。\n\n启动游戏服务端,然后,,,,,,\n\nChapter.3 测试\n\n尝试让客户端连接信使服务器。。。\n\n\n\n如果成功连入，说明成功了！\n\nAppendix.附录\n\n1. 报错的处理方法\n\n人在代码飘，哪有不报错？既然爆了错，干脆补个漏！\n\n还是先来看看报错内容，对症**\n\n报错1：端口被占用\n\n\n\n关键词：\"bind:address already in use\"\n\n解决方法：在配置文件中换一个端口\n\n报错2：文件不存在\n\n\n\n关键词：\"no such file or directory\"\n\n解决方法。。。口恩。。。检查文件名。。。。如果是windows系统，请特别注意检查扩展名是否为.yml\n\n报错3：yml格式错误\n\n\n\n关键词：\"load config failed\",\"decode\"\n\n解决方法：检查一下yml格式是否有误。对于yml来说：\n\n\n\n(每一项钱的空格数量必须严格把握，冒号之后必须跟空格或者直接换行！)\n\n报错4：写错密钥\n\n\n\n关键词：\"not match want\"\n\n解决方案：检查配置文件密码部分！\n\n报错5：\n\n\n\n关键词：\"permission denied\"\n\n解决方案：信使服务端使用1024以下的端口时需root权限。。。可以在启动命令前加sudo,或者将端口改为大于1024的值。\n\n2.进阶用途\n\n添加多条代理隧道(tcp,udp)：\n\n在lunnel客户端配置文件中，encrypt_mode: 的前一行（也就是最后一条代理隧道的最后一行）尾部换行，删除新行中的所有空格，复制并粘贴以下模板：\n\n  <请填空1>:\n    schema: <请填空2>\n    port: <请填空3>\n    local: <请填空4>:<请填空5>复制代码\n按以下规则填空：\n\n将<请填空1>替换为你想使用的对本隧道的称呼\n将<请填空2>替换为该服务所使用的协议名称,可以是tcp(Minecraft)、udp\n将<请填空3>替换为想让用户连接的端口.\n将<请填空4>替换为本地服务器所在IP(如果是在本机运行lunnel客户端及应用服务端，请填127.0.0.1)\n将<请填空5>替换为本地服务端的端口.复制代码\n添加多条代理隧道(http,https)：\n\n在lunnel客户端配置文件中，encrypt_mode: 的前一行（也就是最后一条代理隧道的最后一行）尾部换行，删除新行中的所有空格，复制并粘贴以下模板：\n\n  <请填空1>:\n    schema: <请填空2>\n    host: <请填空3>\n    local: <请填空4>:<请填空5>复制代码\n按以下规则填空：\n\n将<请填空1>替换为你想使用的对本隧道的称呼\n将<请填空2>替换为该服务所使用的协议名称,可以是http,https\n将<请填空3>替换为想让用户连接的完整域名（如http://Artoria.iccmc.cc).\n将<请填空4>替换为本地服务器所在IP(如果是在本机运行lunnel客户端及应用服务端，请填127.0.0.1)\n将<请填空5>替换为本地服务端的端口.复制代码\nEpilogue.后话\n\n写这篇教程的时候是假期结束前的最后一天。\n\n也算是做完了一件大事。。。？真是奇奇怪怪的总结啊。\n\n本文原来是发在github pages[链接]上的，后得到了我的朋友，snow-dream大佬对于文章严谨性的修改[链接]。在此对他表示万分的感谢。\n\n\n还有，才没有neta 信使RNA呢！\n\n这篇教程到这里就结束了。个人语文能力不好，如果有看不懂/需要补充的地方，欢迎回复或向我的邮箱发信(inapp@iccmc.cc)，谢谢！\n",
    "replies": [
        {
            "author": "leavessoft",
            "timestamp": 1520140320,
            "txt_content": "这个是反代吗？"
        },
        {
            "author": "inapp",
            "timestamp": 1520146080,
            "txt_content": "leavessoft 发表于 2018-3-4 13:12\n这个是反代吗？\n是的。可以参考lunnel git的自述文件\nhttps://github.com/longXboy/lunnel"
        },
        {
            "author": "millerx",
            "timestamp": 1522574880,
            "txt_content": "CentOS 7 编译失败了 ， 有什么操作不对吗 \n\n[root[url=home.php?mod=space&uid=25056]@www[/url] lunnel]# make \ngo build -o bin/server/lunnelSer ./cmd/lunnelSer\ncmd/lunnelSer/main.go:23:2: cannot find package \"github.com/longXboy/lunnel/server\" in any of:\n        /usr/lib/golang/src/github.com/longXboy/lunnel/server (from $GOROOT)\n        /root/src/github.com/longXboy/lunnel/server (from $GOPATH)\nmake: *** [lunelSer] Error 1\n复制代码\n\n[root@www ~]# tree go | head -n 20\ngo\n└── src\n    └── github.com\n        └── longXboy\n            └── lunnel\n                ├── client\n                │?? ├── clientConfig.go\n                │?? ├── clientControl.go\n                │?? └── client.go\n                ├── cmd\n                │?? ├── lunnelCli\n                │?? │?? ├── cacert-example.pem\n                │?? │?? ├── config-example.yml\n                │?? │?? ├── config-full-example.yml\n                │?? │?? └── main.go\n                │?? └── lunnelSer\n                │??     ├── config-example.yml\n                │??     ├── config-full-example.yml\n                │??     ├── example.crt\n                │??     ├── example.key\n复制代码"
        },
        {
            "author": "hoshizorayuki",
            "timestamp": 1551471000,
            "txt_content": "楼主darwin写成drawin了  （忍不住想水"
        }
    ]
}