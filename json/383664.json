{
    "title": "开发后客户说出问题了，请问这样的传送方式有问题么？",
    "author": "HotFlow",
    "replyCount": 0,
    "timestamp": 1420853700,
    "txt_content": " 本帖最后由 HotFlow 于 2015-1-9 17:54 编辑 \n\n客户说装了这款插件后就不能跨服传送了。\n\nBungeecord端\npublic class Main extends Plugin\n{\n    public void onEnable()\n    {\n            ProxyServer.getInstance().registerChannel(\"BungeeCord\");\n            this.getProxy().getPluginManager().registerListener(this, new com.HotFlow.bsspk.bc.Listener.onServerMessage());\n    }\n}复制代码public class onServerMessage implements Listener\n{\n    @EventHandler\n    public void onServerMessage(PluginMessageEvent event)\n    {\n        try\n        {\n            if (!event.getTag().equals(\"BungeeCord\"))\n            {\n                return;\n            }\n\n            if (!(event.getSender() instanceof Server))\n            {\n                return;\n            }\n\n            event.setCancelled(true);\n            ByteArrayDataInput in = ByteStreams.newDataInput(event.getData());\n\n            String subchannel = in.readUTF();\n            String message =  new String(in.readUTF().getBytes(\"GB2312\"));\n\n            if (subchannel.equals(\"bsspk\"))\n            {\n                for(ServerInfo server : Main.info.plugin.getProxy().getServers().values())\n                {\n                    for(ProxiedPlayer player : server.getPlayers())\n                    {\n                        ISystem.Message.sendToServer(player, subchannel, message);\n                        break;\n                    }\n                }\n            }\n        }\n        catch(Exception ex)\n        {\n            Main.logger.severe(ex.toString());\n        }\n    }\n}复制代码public class Messager \n{\n    public void sendToServer(ProxiedPlayer player,String targetSever,String message)\n    {\n        try\n        {\n            ByteArrayOutputStream b = new ByteArrayOutputStream();\n            DataOutputStream out = new DataOutputStream(b);\n            \n            out.writeUTF(targetSever);\n            out.writeUTF(message);\n            \n            player.getServer().sendData(\"BungeeCord\", b.toByteArray());\n        }\n        catch(Exception ex)\n        {\n            Main.logger.severe(ex.toString());\n        }\n    }\n}复制代码\nBukkit端\n\n    public class Main extends JavaPlugin\n    {\n        public void onEnable()\n        {\n            getServer().getMessenger().registerOutgoingPluginChannel(this, \"BungeeCord\");\n            getServer().getMessenger().registerIncomingPluginChannel(this, \"BungeeCord\", new com.HotFlow.bsspk.Listener.onServerMessage());\n        }\n    }复制代码\n\npublic class onServerMessage implements PluginMessageListener\n{\n    public void onPluginMessageReceived(String channel, Player player, byte[] b) \n    {\n        if (!channel.equals(\"BungeeCord\"))\n        {\n            return;\n        }\n        \n        try\n        {\n            ByteArrayDataInput in = ByteStreams.newDataInput(b);\n            String subchannel = in.readUTF();\n            String message = new String(in.readUTF().getBytes(\"GB2312\"));\n            \n            if (subchannel.equals(Main.config.getString(\"插件设置.BungeeCord频道\")))\n            {\n                Bukkit.broadcastMessage(message);\n            }\n        }\n        catch(Exception ex)\n        {\n            Main.logger.severe(ex.toString());\n        }\n    }\n}复制代码public class Messager \n{\n    public void sendToServer(Player player,String targetSever,String message)\n    {\n        try\n        {\n            ByteArrayOutputStream b = new ByteArrayOutputStream();\n            DataOutputStream out = new DataOutputStream(b);\n            \n            out.writeUTF(targetSever);\n            out.writeUTF(message);\n            player.sendPluginMessage(Main.info.plugin, \"BungeeCord\", b.toByteArray());\n        }\n        catch(Exception ex)\n        {\n            Main.logger.severe(ex.toString());\n        }\n    }\n}复制代码\n\n\n\n",
    "replies": []
}