{
    "title": "20181218听说签到炸了……",
    "author": "。—。",
    "replyCount": 8,
    "timestamp": 1545130620,
    "txt_content": " 本帖最后由 a6809936 于 2019-2-16 11:03 编辑 \n\n已过期20190210: setTimeout用法修正，就懒得写更新日志了，顺带把框框去掉了【部分代码已回滚\n20190208: 核心内容没动，但是有个看脸触发的bug，反正手动刷新一次能解决就不管了吧~\n使用书签前务必等待页面读条完毕，之前已经触发了乱码的话，可以点一下其他楼层的评分或回复，然后新的框会取代旧的，注意别回错贴了~\n之前提到的签到入口http://www.mcbbs.net/plugin.php?id=dc_signin:sign，请一定从该入口签到，论坛默认的签到界面调用的官方脚本很长，咱懒得去想该咋打补丁了【x\n之前的帖子：http://www.mcbbs.net/thread-813253-1-1.html，原理：http://www.mcbbs.net/thread-835702-1-1.html\n希望从默认签到入口签到的可以参考http://www.mcbbs.net/thread-843668-1-1.html\n使用方法：就像上次那样吧=v=\n用了 throw new Error 强行让脚本报错来停止后继事务暂时只在电脑版chrome测试这次防火墙比上次高级，我看控制台有时候重发了十几遍直到服务器未响应的……超过十秒没动静的话请刷新重试【话说这样和之前有差别咩……其它的等想到了再补叭……\nTODO:好想加一个GUI……已加，看看反馈……关于点了提交之后没响应，在控制台里应该会看到一行一行刷的detected ccdefend之类的东西，同时网络那栏也会有自动重试的请求出来的！加了个用户体验爆炸的框……\n\n[\n    {\n        \"date\":\"2019-02-08\",\n        \"desc\":\"论坛模板v2.0重构：(ZhaiSoul)gamerteam更新：2018/12/06\",\n        \"poem\":\"没有bug的代码是没有灵魂的！\"\n    },\n    {\n        \"date\":\"2019-01-05\",\n        \"desc\":\"把之前的代码搬回来了，尝试性加个弹窗，计数器不重置是特性！\"\n    },\n    {\n        \"date\":\"2018-12-18-rc2\",\n        \"desc\":\"终于看完签到插件怎么从服务器获取token的逻辑了，为嘛感觉比dz自己的代码还复杂 = =\"\n    },\n    {\n        \"date\":\"2018-12-18-rc1\",\n        \"desc\":\"重新利用起自带的evalscript()，终于填完了同时支持两种格式ccdefend的坑\"\n    },\n    {\n        \"date\":\"2018-08-10-v1\",\n        \"desc\":\"往_ajaxget函数多塞了一段判断ccdefend出现时的处理逻辑，改动过的地方应该都加上了注释，原始的_ajaxget代码来自discuz\"\n    }\n]\n\n// GUI初始化\na68counter = 0;\na68wait = 2000;\ncookie_start = document.cookie.indexOf('ccdefend');\ncookie_end = document.cookie.indexOf(\";\", cookie_start);\ncookie_end = cookie_end > cookie_start ? cookie_end : document.cookie.length;\na68ccdefend = document.cookie.substring(cookie_start + name.length + 1, cookie_end);\n\n// 验证XHR内容，提取cookies并写入浏览器\nfunction is_ccdefend(s) {\n        // portal处登录，评分，楼层左下回复: \n        // <script type=\"text/javascript\">var v='76d6751f93d24a571d2d4cedeb330733'; document.cookie='ccdefend='+v+'; path=/'; window.location.reload();</script>\n        // \n        flag = 0;\n        if (s.indexOf('; document.cookie=\\'ccdefend=\\'+v+\\'; path=/\\'; window.location.reload();') != -1) {\n                flag = 1;\n                s = s.replace(' window.location.reload();', '');\n    s = s.replace(' type=\"text/javascript\"', '');\n                if (s.indexOf(\"script\") == -1) {\n                        s = '<script>' + s + '</script>';\n                }\n    console.info(s);\n                evalscript(s);\n                cookie_start = document.cookie.indexOf('ccdefend');\n                cookie_end = document.cookie.indexOf(\";\", cookie_start);\n                cookie_end = cookie_end > cookie_start ? cookie_end : document.cookie.length;\n    newcookie = document.cookie.substring(cookie_start + name.length + 1, cookie_end);\n                if(a68ccdefend == newcookie)\n    {\n      // console.info(v);\n      showDialog('自动刷新失败<br />请手动刷新页面', 'confirm', '未知错误', '', 1);\n      throw new Error('failed to change');\n    }\n    a68ccdefend = newcookie;\n                a68counter++;\n                showDialog('1秒后自动刷新请求，无需重复点击提交按钮~<br />当前重试次数：' + a68counter + '<br />【这个窗口可以关', 'confirm', '自动处理中！', '', 1);\n                if (a68counter > 9) {\n                        showDialog('重试次数过多，服务器可能过载<br />请打开记事本保存帖子内容，并刷新页面重试', 'confirm', '重试过多', '', 1);\n                        throw new Error('too many failed');\n                }\n        }\n        return flag\n}\n\nfunction _ajaxget(url, showid, waitid, loading, display, recall) {\n        waitid = typeof waitid == 'undefined' || waitid === null ? showid : waitid;\n        var x = new Ajax();\n        x.setLoading(loading);\n        x.setWaitId(waitid);\n        x.display = typeof display == 'undefined' || display == null ? '' : display;\n        x.showId = $(showid);\n        if (url.substr(strlen(url) - 1) == '#') {\n                url = url.substr(0, strlen(url) - 1);\n                x.autogoto = 1\n        }\n        var __url = url; // 保留原始url\n        var url = url + '&inajax=1&ajaxtarget=' + showid;\n        x.get(url, function(s, x) {\n                if (is_ccdefend(s)) {\n                        setTimeout(_ajaxget, a68wait, __url, showid, waitid, loading, display, recall);\n                        throw new Error('detected ccdefend');\n                }\n                var evaled = false;\n                if (s.indexOf('ajaxerror') != -1) {\n                        evalscript(s);\n                        evaled = true\n                }\n                if (!evaled && (typeof ajaxerror == 'undefined' || !ajaxerror)) {\n                        if (x.showId) {\n                                x.showId.style.display = x.display;\n                                ajaxinnerhtml(x.showId, s);\n                                ajaxupdateevents(x.showId);\n                                if (x.autogoto) scroll(0, x.showId.offsetTop)\n                        }\n                }\n                ajaxerror = null;\n                if (recall && typeof recall == 'function') {\n                        recall()\n                } else if (recall) {\n                        eval(recall)\n                }\n                if (!evaled) evalscript(s)\n        })\n}\n\n// 重新获取多处Geetest验证token\nparse_xml_callback = function() {\n        if ((xmlHttp.readyState == 4) && (xmlHttp.status == 200)) {\n                if (is_ccdefend(xmlHttp.responseText)) {\n                        setTimeout(reloadGeetest, a68wait);\n                        throw new Error('detected ccdefend');\n                }\n                var obj = JSON.parse(xmlHttp.responseText);\n                initGeetest({\n                        gt: obj.gt,\n                        challenge: obj.challenge,\n                        offline: !obj.success,\n                        timeout: '5000',\n                        product: \"bind\",\n                        width: \"300px\"\n                }, handler)\n        }\n};\n\nfunction reloadGeetest() {\n        xmlHttp.open(\"GET\", \"./plugin.php?id=geetest3&amp;model=start&amp;t=\" + (new Date()).getTime());\n        xmlHttp.send(null);\n        xmlHttp.onreadystatechange = parse_xml_callback\n}\n\n// 页面底部的回复框\nfunction checkpostrule(showid, extra) {\n        var x = new Ajax();\n        x.get('forum.php?mod=ajax&action=checkpostrule&inajax=yes&' + extra, function(s) {\n                if (is_ccdefend(s)) {\n                        setTimeout(checkpostrule, a68wait, showid, extra);\n                        throw new Error('detected ccdefend');\n                }\n                ajaxinnerhtml($(showid), s);\n                evalscript(s)\n        })\n}\n\nfunction checkpostrule_post(theform) {\n        if (!seccodecheck && !secqaacheck && !theform.sechash) {\n                var x = new Ajax();\n                x.get('forum.php?mod=ajax&action=checkpostrule&ac=' + postaction + '&inajax=yes', function(s) {\n                        if (s) {\n                                if (is_ccdefend(s)) {\n                                        setTimeout(checkpostrule_post, a68wait, theform);\n                                        throw new Error('detected ccdefend');\n                                }\n                                ajaxinnerhtml($('seccheck'), s);\n                                evalscript(s);\n                                seccodecheck = true\n                        } else {\n                                postsubmit(theform)\n                        }\n                })\n        } else {\n                postsubmit(theform)\n        }\n}\n\nipNotice(); // 异地登录提示\nif (typeof xmlHttp != \"undefined\") reloadGeetest();复制代码还是那句话，不要在不理解到底会怎样的情况下往控制台或书签里输任何东西……javascript:a68counter=0;a68wait=2000;cookie_start=document.cookie.indexOf('ccdefend');cookie_end=document.cookie.indexOf(\";\",cookie_start);cookie_end=cookie_end>cookie_start?cookie_end:document.cookie.length;a68ccdefend=document.cookie.substring(cookie_start+name.length+1,cookie_end);function is_ccdefend(s){flag=0;if(s.indexOf('; document.cookie=\\'ccdefend=\\'+v+\\'; path=/\\'; window.location.reload();')!=-1){flag=1;s=s.replace(' window.location.reload();','');s=s.replace(' type=\"text/javascript\"','');if(s.indexOf(\"script\")==-1){s='<script>'+s+'</script>'}console.info(s);evalscript(s);cookie_start=document.cookie.indexOf('ccdefend');cookie_end=document.cookie.indexOf(\";\",cookie_start);cookie_end=cookie_end>cookie_start?cookie_end:document.cookie.length;newcookie=document.cookie.substring(cookie_start+name.length+1,cookie_end);if(a68ccdefend==newcookie){showDialog('自动刷新失败<br />请手动刷新页面','confirm','未知错误','',1);throw new Error('failed to change');}a68ccdefend=newcookie;a68counter++;showDialog('1秒后自动刷新请求，无需重复点击提交按钮~<br />当前重试次数：'+a68counter+'<br />【这个窗口可以关','confirm','自动处理中！','',1);if(a68counter>9){showDialog('重试次数过多，服务器可能过载<br />请打开记事本保存帖子内容，并刷新页面重试','confirm','重试过多','',1);throw new Error('too many failed');}}return flag}function _ajaxget(url,showid,waitid,loading,display,recall){waitid=typeof waitid=='undefined'||waitid===null?showid:waitid;var x=new Ajax();x.setLoading(loading);x.setWaitId(waitid);x.display=typeof display=='undefined'||display==null?'':display;x.showId=$(showid);if(url.substr(strlen(url)-1)=='#'){url=url.substr(0,strlen(url)-1);x.autogoto=1}var __url=url;var url=url+'&inajax=1&ajaxtarget='+showid;x.get(url,function(s,x){if(is_ccdefend(s)){setTimeout(_ajaxget,a68wait,__url,showid,waitid,loading,display,recall);throw new Error('detected ccdefend');}var evaled=false;if(s.indexOf('ajaxerror')!=-1){evalscript(s);evaled=true}if(!evaled&&(typeof ajaxerror=='undefined'||!ajaxerror)){if(x.showId){x.showId.style.display=x.display;ajaxinnerhtml(x.showId,s);ajaxupdateevents(x.showId);if(x.autogoto)scroll(0,x.showId.offsetTop)}}ajaxerror=null;if(recall&&typeof recall=='function'){recall()}else if(recall){eval(recall)}if(!evaled)evalscript(s)})}parse_xml_callback=function(){if((xmlHttp.readyState==4)&&(xmlHttp.status==200)){if(is_ccdefend(xmlHttp.responseText)){setTimeout(reloadGeetest,a68wait);throw new Error('detected ccdefend');}var obj=JSON.parse(xmlHttp.responseText);initGeetest({gt:obj.gt,challenge:obj.challenge,offline:!obj.success,timeout:'5000',product:\"bind\",width:\"300px\"},handler)}};function reloadGeetest(){xmlHttp.open(\"GET\",\"./plugin.php?id=geetest3&amp;model=start&amp;t=\"+(new Date()).getTime());xmlHttp.send(null);xmlHttp.onreadystatechange=parse_xml_callback}function checkpostrule(showid,extra){var x=new Ajax();x.get('forum.php?mod=ajax&action=checkpostrule&inajax=yes&'+extra,function(s){if(is_ccdefend(s)){setTimeout(checkpostrule,a68wait,showid,extra);throw new Error('detected ccdefend');}ajaxinnerhtml($(showid),s);evalscript(s)})}function checkpostrule_post(theform){if(!seccodecheck&&!secqaacheck&&!theform.sechash){var x=new Ajax();x.get('forum.php?mod=ajax&action=checkpostrule&ac='+postaction+'&inajax=yes',function(s){if(s){if(is_ccdefend(s)){setTimeout(checkpostrule_post,a68wait,theform);throw new Error('detected ccdefend');}ajaxinnerhtml($('seccheck'),s);evalscript(s);seccodecheck=true}else{postsubmit(theform)}})}else{postsubmit(theform)}}ipNotice();if(typeof xmlHttp!=\"undefined\")reloadGeetest();复制代码changelog:20190101:刚发现，重复评分的问题依旧能人为触发……\n之前帖子里放的源代码部分其实有尝试修复编辑功能的半成品，急用的话就拿来用吧……\n近几天发现直接签到都没问题了，这里的脚本是赶时间对付前段时间签到困难附带评分的那部分，也可以单纯只拿来评分\n20190102:嘛，如果点提交的时候只是弹一个蓝色空白框框，没有人机验证的话说明签到依旧炸了……不过右上角公告说最近要搬家了，开心<3\n之前提到的签到入口http://www.mcbbs.net/plugin.php?id=dc_signin:sign ，20180207: 发现快捷回帖框拉cookie的逻辑应该是炸了……待修复顺带，5号的版本新增了限制重试频率的机制，之前的版本请尽快更新，避免误封……20190105: 稍微更新了一下，核心代码没啥改动，签到应该不需要手动干预了，开始作死试一下能不能把评分附件和编辑之类的修好……\n也就是说应该不会有重复评分的问题了【也许吧……评分的时候不要重复点提交，我刚才评了个人气+6的……\n",
    "replies": [
        {
            "author": "Abraham511",
            "timestamp": 1545132660,
            "txt_content": "学到啦....\n\n再也不用担心短签了"
        },
        {
            "author": "zyjking",
            "timestamp": 1545133800,
            "txt_content": "我用F12找到的签到网址跟你的一样..."
        },
        {
            "author": "178846008",
            "timestamp": 1545686220,
            "txt_content": "还是买自动签到比较好。懒得手签"
        },
        {
            "author": "xmdhs",
            "timestamp": 1546517160,
            "txt_content": " 本帖最后由 xmdhs 于 2019-1-3 20:21 编辑 \n\n哇，几乎完美解决所有问题了。\n\n无论是评分还是什么。"
        },
        {
            "author": "RSN_GK",
            "timestamp": 1546522620,
            "txt_content": "我记得好像直接新开页面就能解决？\n反正我这样肯定能解决就对了"
        },
        {
            "author": "。—。",
            "timestamp": 1546527960,
            "txt_content": "RSN_GK 发表于 2019-1-3 21:37\n我记得好像直接新开页面就能解决？\n反正我这样肯定能解决就对了\n理论上手动刷新两三次也行，不过半个月前发这贴的时候，需要刷新十几次才能回上一贴，所以才有自动化解决方案，浏览器已经是个成熟的软件了，该学会自己刷新了"
        },
        {
            "author": "小囧爱逗比",
            "timestamp": 1546564920,
            "txt_content": "厉害，居然是技术大佬，果然牛逼"
        },
        {
            "author": "夏夜的风w",
            "timestamp": 1549641420,
            "txt_content": "学到了学到了～"
        }
    ]
}