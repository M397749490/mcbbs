{
    "title": "[PHP] Swoole WebSocket 基础应用教程",
    "author": "Akkariin",
    "replyCount": 0,
    "timestamp": 1544144220,
    "txt_content": " 本帖最后由 Akkariin 于 2018-12-7 08:55 编辑 \n\n\n# 什么是 WebSocket\nWebSocket 协议是基于 TCP 的一种新的网络协议。它实现了浏览器与服务器全双工 (full-duplex) 通信 —— 允许服务器主动发送信息给客户端。\nWebSocket 通信协议于 2011 年被 IETF 定为标准 RFC 6455，并被 RFC7936 所补充规范。\n\n# 什么是 Swoole\nSwoole 是一个 PHP 扩展，扩展不是为了提升网站的性能，是为了提升网站的开发效率。最少的性能损耗，换取最大的开发效率。利用 Swoole 扩展，开发一个复杂的 Web 功能，可以在很短的时间内完成了。\n\n今天，我要给大家带来的就是 WebSocket 的基础应用教程。首先举个例子，传统我们想要保持网页上的内容实时刷新，有什么办法呢？那就是通过 AJAX 轮询，而这种方法，会发起大量短连接请求，这对于 PHP 来说，单用户没什么影响，但是如果遇到了多用户的情况，就很容易出现网站反应迟钝，或者打不开的情况。\n\n不知道各位有没有遇到过网站服务器被 CC 攻击的情况，当有黑客向你的服务器发起大量连接，你的服务器就会因为承受不了高并发的请求量而崩溃。\n而如果 AJAX 短连接数量过多，请求次数过于频繁的时候，效果就和 CC 攻击差不多了，让普通用户攻击你的网站，自 己 坑 自 己。\n\n\n那么有什么办法在不发起短连接的情况下还能实时刷新网页内容呢？答案就是 WebSocket。\n其实 AJAX 严格意义上都不能算是实时刷新，因为轮询请求是存在延迟的，我们先简单了解下 AJAX 和 WebSocket 的工作原理。\n\nAJAX 工作原理\n客户端：Hi 服务器，有没有新内容可以更新？\n服务器：没有，请稍等一会再来。\n过了一会……\n客户端：Hi 服务器，有没有新内容可以更新？\n服务器：没有，请稍等一会再来。\n又过了一会……\n客户端：Hi 服务器，有没有新内容可以更新？\n服务器：好的，这是新的内容，balabala...\nWebSocket 工作原理\n客户端：Hi 服务器，我是客户端 01，如果有新消息请告诉我。\n服务器：好的，已经和你建立连接，稍后有新消息我会推送给你。\n过了一会……\n服务器：有新消息了，内容是 balabala...\n客户端：已收到消息\n从这个简单的例子可以看出，WebSocket 只需要客户端和服务器建立一条长连接，就可以实时推送消息了，而不需要客户端频繁向服务器发起请求。\n第一节省了时间，因为每次发起新连接都需要时间。\n第二降低了处理每个连接的开销，少量连接可能还感觉不出来，但是连接量大了差异就很明显了。\n\n\n\n# 环境依赖\n仅支持 Linux、FreeBSD、MacOS 三种操作系统在 Windows 平台，可使用 CygWin 或 WSL(Windows Subsystem for Linux)Linux 内核版本 2.3.32 以上gcc4.4 以上版本或者 clang4.x 版本起需要 gcc-4.8 或更高版本, 编译失败请先尝试升级 gcc编译为 libswoole.so 作为 C/C++ 库时需要使用 cmake-2.4 或更高版本\n\n建议使用 Ubuntu14、CentOS7 或更高版本的操作系统\n\n# PHP版本依赖\nSwoole-1.x 需要 PHP-5.3.10 或更高版本Swoole-2.x 需要 PHP-7.0.0 或更高版本Swoole-4.x 需要 PHP-7.1.0 或更高版本\n\n不依赖 PHP 的 stream、sockets、pcntl、posix、sysvmsg 等扩展。PHP 只需安装最基本的扩展即可\n\n# ARM平台（树莓派Raspberry PI）\n请使用 1.7.10 或更高版本使用 GCC 交叉编译在编译 Swoole 时，需要手工修改 Makefile 去掉 -O2 编译参数\n\n# MIPS平台（OpenWrt路由器）\n请使用 swoole-1.7.21 或更高版本使用 GCC 交叉编译\n\n# CygWin环境支持（Windows系统）\nswoole-1.7.7 增加了对 cygwin 环境的支持，在 Windows 环境下，可以直接使用 cygwin + php 来跑 swoole 程序。\n\n安装 cygwin，并安装 gcc、make、autoconf、php 4个包下载 swoole 源码，在 cygwin-shell 中进行 phpize/configure/make/make install修改 php.ini，加入 swoole.so\n\ncygwin 模式下需要对 PHP 进行简化，去掉不使用的扩展，避免进程占用内存过大，导致 Fork 操作失败\n\n# BashOnWindows\nWindows 10 系统增加了 Linux 子系统支持，BashOnWindows 环境下也可以使用 swoole。安装命令\napt-get install php7.0 php7.0-curl php7.0-gd php7.0-gmp php7.0-json php7.0-mysql php7.0-opcache php7.0-readline php7.0-sqlite3 php7.0-tidy php7.0-xml  php7.0-bcmath php7.0-bz2 php7.0-intl php7.0-mbstring  php7.0-mcrypt php7.0-soap php7.0-xsl  php7.0-zip\npecl install swoole\necho 'extension=swoole.so' >> /etc/php/7.0/mods-available/swoole.ini\ncd /etc/php/7.0/cli/conf.d/ && ln -s ../../mods-available/swoole.ini 20-swoole.ini\ncd /etc/php/7.0/fpm/conf.d/ && ln -s ../../mods-available/swoole.ini 20-swoole.ini复制代码BashOnWindows 环境下必须关闭 daemonize 选项需要修改 config.h 关闭 HAVE_SIGNALFD\n\n# DockerOnWindows\n在 Windows 下开发可以使用 Hyper-V+Docker 来方便的开发 Swoole 应用，安装好 Docker 后再 Settings 里的 Shared Droves 选项里共享代码所在磁盘。然后使用如下命令来快速启动 Docker 容器。\ndocker run --rm -t -i --name myapp -p 9501:9501 -v e:/path/to:/app:rw xutongle/php:7.1-fpm /bin/bash复制代码e:/path/to 为源码所在路径/app 为容器内路径在 bash 里执行 cd /app && php server.php\n\n\n\n# 编译安装\nSwoole 扩展是按照 PHP 标准扩展构建的。使用 phpize 来生成编译检测脚本，./configure 来做编译配置检测，make 进行编译，make install 进行安装。\n\n请下载 releases 版本的 swoole，直接从 github 主干上拉取最新代码可能会编译不过如无特殊需求, 请务必编译安装 swoole 的最新版本如果当前用户不是 root，可能没有 PHP 安装目录的写权限，安装时需要 sudo 或者 su如果是在 git 分支上直接 git pull 更新代码，重新编译前务必要执行 make clean\n\n# 安装准备\n安装前必须保证系统已经安装了下列软件\n\nphp-7.0 或更高版本gcc-4.8 或更高版本makeautoconfpcre (CentOS 系统可以执行命令：yum install pcre-devel)\n\n# 下载地址\nhttps://github.com/swoole/swoole-src/releaseshttp://pecl.php.net/package/swoolehttp://git.oschina.net/swoole/swoole\n\n下载源代码包后，在终端进入源码目录，执行下面的命令进行编译和安装\n\n# 新手编译示例\ncd swoole\nsudo phpize (ubuntu 没有安装phpize可执行命令：sudo apt-get install php-dev来安装phpize)\nsudo ./configure\nsudo make \nsudo make install复制代码\n# 进阶完整编译示例\n初次接触swoole的开发者请先尝试上方的简单编译，如果有进一步的需要，可以根据具体的需求和版本，调整以下示例的编译参数\n\n编译参数参考\n\n以下脚本会下载并编译master分支的源码, 需保证你已安装所有依赖, 否则会遇到各种依赖错误\nmkdir -p ~/build && \\\ncd ~/build && \\\nrm -rf ./swoole-src && \\\ncurl -o ./tmp/swoole.tar.gz https://github.com/swoole/swoole-src/archive/master.tar.gz -L && \\\ntar zxvf ./tmp/swoole.tar.gz && \\\nmv swoole-src* swoole-src && \\\ncd swoole-src && \\\nphpize && \\\n./configure \\\n--enable-coroutine \\\n--enable-openssl  \\\n--enable-http2  \\\n--enable-async-redis \\\n--enable-sockets \\\n--enable-mysqlnd && \\\nmake clean && make && sudo make install复制代码\n# PECL\nSwoole项目已收录到PHP官方扩展库，除了手工下载编译外，还可以通过PHP官方提供的pecl命令，一键下载安装\npecl install swoole复制代码\n# 配置php.ini\n编译安装成功后，修改php.ini加入\nextension=swoole.so复制代码通过 php -m 或 phpinfo() 来查看是否成功加载了 swoole.so，如果没有可能是 php.ini 的路径不对，可以使用 php --ini 来定位到 php.ini 的绝对路径。\n\n\n\n# WebSocket 服务端代码\n编写一个简单的 WebSocket 服务器。\n$server = new Swoole\\WebSocket\\Server(\"0.0.0.0\", 9501);\n\n$server->on('open', function (Swoole\\WebSocket\\Server $server, $request) {\n    echo \"有新的客户端连接，识别 ID 为：{$request->fd}\\n\";\n});\n\n$server->on('message', function (Swoole\\WebSocket\\Server $server, $frame) {\n    echo \"客户端 {$frame->fd} 发送了：{$frame->data}\\n\";\n    $server->push($frame->fd, \"你发送了：{$frame->data}\\n\");\n});\n\n$server->on('close', function ($server, $fd) {\n    echo \"客户端 {$fd} 已离线\\n\";\n});\n\n$server->start();复制代码这就是一个简单的 ECHO 服务器，你发送什么它就会返回什么。\n\n介绍\n$server 是 WebSocket 服务器实例的变量，这个服务器运行在 9501 端口，允许任何 IP 连接（0.0.0.0）\n\n介绍一下几个事件\n\nopen 是当有新连接的时候执行的事件message 是当客户端发送数据的时候执行的事件close 是当客户端离线的时候执行的事件\n\n$server->start() 是启动已创建的实例。\n\n简单聊天室程序\n下面我们来写一个简单的例子，一个网页在线聊天室。\n$server = new Swoole\\WebSocket\\Server(\"0.0.0.0\", 9523);\n$server->on('open', function (Swoole\\WebSocket\\Server $server, $request) {\n    foreach($server->connections as $key => $fd) {\n        $server->push($fd, \"欢迎客户端 {$request->fd} 加入聊天！\");\n    }\n});\n\n$server->on('message', function (Swoole\\WebSocket\\Server $server, $frame) {\n    foreach($server->connections as $key => $fd) {\n        $server->push($fd, \"客户端 {$frame->fd}：{$frame->data}\");\n    }\n});\n\n$server->on('close', function ($server, $fd) {\n    foreach($server->connections as $key => $id) {\n        // 即使客户端离线了，但是 connections 里还是有这个客户端的，需要判断一下\n        if($fd !== $id) {\n            $server->push($id, \"欢迎客户端 {$fd} 已退出聊天！\");\n        }\n    }\n});\n\n$server->start();复制代码\n介绍\nforeach($server->connections as $key => $fd)\n这段代码的作用呢，是遍历当前所有客户端连接，作用就是为了给每个客户端都发送一条消息（通过 push 方法）\n\n客户端\n我们简单写一个网页对接一下服务端。\n<span id=\"status\">输入消息</span>\n<input type=\"text\" id=\"data\">\n<button onclick=\"ws.send(data.value)\">发送</button>\n<div id=\"msg\"></div>\n<script src=\"https://libs.baidu.com/jquery/2.1.4/jquery.min.js\"></script>\n<script type=\"text/javascript\">\n        var ws;\n        ws = new WebSocket(\"ws://192.168.3.181:9523/\");\n        ws.onopen = function(event) {\n                $(\"#status\").html('已连接成功');\n        };\n        ws.onmessage = function (event) {\n                var msg = event.data + \"<br>\";\n                $(\"#msg\").html(msg + $(\"#msg\").html());\n        }\n        ws.onclose = function(event) {\n                $(\"#status\").html(\"已经与服务器断开连接，状态：\" + this.readyState);\n        };\n        ws.onerror = function(event) {\n                $(\"#status\").html(\"WebSocket 连接失败！\");\n        };\n</script>复制代码\n效果如下\n\n\n\n\n\n# 关于 SSL 问题\n请注意，如果你的网站是 https 的，而 WebSocket 是普通的 ws 协议，那么会导致无法连接，这是浏览器的安全设定。因为 ws 协议是非加密的，你需要使用 wss 协议（即 WebSocket + SSL）。\n以下是 Nginx 反向代理 WebSocket 增加 SSL 的相关配置。\nserver {\n    # 监听端口 9524\n    listen 9524 ssl;\n    # SSL 证书的储存位置\n    ssl_certificate /path/to/ssl.crt;\n    ssl_certificate_key /path/to/ssl.key;\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n    ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;\n    ssl_prefer_server_ciphers on;\n    ssl_session_timeout 10m;\n    ssl_session_cache builtin:1000 shared:SSL:10m;\n    ssl_buffer_size 1400;\n    ssl_stapling on;\n    ssl_stapling_verify on;\n    # 绑定的域名\n    server_name example.com;\n    include /usr/local/nginx/conf/rewrite/none.conf;\n\n    location / {\n        # 反向代理后的后端地址及端口\n        proxy_pass                  http://127.0.0.1:9523;\n        proxy_redirect              off;\n        proxy_set_header            Host $host; \n        proxy_set_header            X-Real-IP $remote_addr; \n        proxy_set_header            X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_http_version          1.1;\n        proxy_set_header Upgrade    $http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n    }\n}\n复制代码\n# 相关 Demo\n我自己写的论坛程序评论功能已经改成了实时刷新，同时增加了在线人数统计的功能，这一切都是 WebSocket 的功劳。\nhttps://www.zerobbs.net/\n\n感谢阅读，如果这篇文章对你有帮助，欢迎评分。\n\n",
    "replies": []
}