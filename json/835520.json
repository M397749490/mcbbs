{
    "title": "论mod服优化——tiles、entity、C/T",
    "author": "MC_tingfeng",
    "replyCount": 40,
    "timestamp": 1545874680,
    "txt_content": " 本帖最后由 MC_tingfeng 于 2018-12-27 13:58 编辑 \n\n丑话说前头，这里不是提问帖，想说请参考某某某帖子进行优化的请直接绕道\n\n讨论针对mod服务器的深度优化，抛转引玉，希望能给大家带来一些帮助，同业也能促进自己成长\n\n一、CPU核心限定\n假设服务器开放在物理独立机上（因为VPS讨论这个没有意义），假设你的cpu是6核心12线程，假设同时开放两个mod服，\n此时，如果对这两个java程序进行CPU核心限定，是否会提升每个服务器性能，比如1服限定使用0-5核心，2服使用6-11核心\n为何要如此设置，CPU在处理事件的时候都有一个优先级，如果两个程序都是多线程程序（即开一个程序就能使全核心运行），此时两个程序的处理存在一个优先级，如果这两个程序又都处在高负荷状态，那么CPU的处理机制会导致两个程序都运行缓慢。那么，如果将两个程序的cpu手动进行绑定或者分开呢？\n\n\n二、spigot设置中 max-tick-time的正真含义\n众所周知的某优化贴中明确表示tiles+entity小于30能显著提升tps，如果你是纯净，那么这是对的，如果你是mod服，那么问题很严重\n这里entity不需要过多解释，能耐心看到这的应该都明白，关键是看tiles，tiles到底是什么！\n原版中：tiles指箱子熔炉一类\nmod服中：抛开原版的之外，任意一个mod能放置到地上东西几乎都是tiles（为什么是几乎呢，比如植物魔法的火花能放置，但是他是entity）\n当一个mod开了一段时间后，tiles都会变得很大，10万20万都很常见\n实际测试中发现，thermos包括后来的优化版铀端，sponge，catserver在默认的情况下tiles和entity都是1000\n拿thermos举例，当我把tiles和entity限制到20时，tps并没有提高且同时发现服务器机器处理速度显著变慢，比如mek的熔炼工厂\n而当tiles在1000时，tps依旧比较低，但是机器处理速度显著变高\n那么从tps和max-tick-time的解释中，我是否可以这么理解，一个加载的tiles需要cpu运算一次，20万个就是20万次，而且这20万次是需要在1/20秒内完成，也就是一秒钟cpu需要运算400万次，再结合cpu频率，换算过来400万次=4MHz？显然这里的换算关系不对，只是这样可能方便理解\n回到tps上来说，1/20秒内服务器无法处理完这20万个tiles，卡顿就发生了，如果设置tiles为20，那么每一秒都有大量的tiles等待处理或者被跳过处理，这对玩家的体验来说显然是很不愉快的\n所以当我有一个4.0GHz主频的CPU时，我是否可以把tiles和entity设置的更高呢，比如2000\n\n\n三、forge chunk loading中maximum chunks per ticket\n一般都知道在forge设置中打开remove errorentity和remove error tileentity   这两项只是用来保障服务器不容易崩溃，在遇到出错物品是直接清除以避免崩溃，\n但是在forge chunk loading设置中，有两个选项一直不太明白到底什么意思，分别是\nmaximum chunks per ticket和maximum ticket count\n从自带备注中是否可以理解为：每个区块在一个tick中为mod计算的次数；每一个tick为mod计算的次数\n如果这里理解是对的，那么提高maximum ticket count 是否能显著提升tps呢？\n\n\n本人非科班出身，以上论点如有不恰当之处还望各位大佬指正，以上三项只是在平时不断的尝试中得出的一些总结，希望各位大佬能不吝赐教，用以更好的提升服务器对玩家的体验度\n\n\n\n",
    "replies": [
        {
            "author": "MC_tingfeng",
            "timestamp": 1545891060,
            "txt_content": "呼唤大佬，\n随机@几个@80267702 @763712739 @Akkariin @夜夜夜、 @qiangshuiya @improbit0 @帅逼流年 @混乱 @九幽之帝"
        },
        {
            "author": "YY-HeiDaDa",
            "timestamp": 1545894720,
            "txt_content": "你在矿工区开一个那么高大上帖子叫我们这些想划水的怎么办？！！\n\n当一个mod开了一段时间后，tiles都会变得很大，10万20万都很常见....\n\n没钱！！！！"
        },
        {
            "author": "Tollainmear",
            "timestamp": 1545895380,
            "txt_content": "我说一下我的看法吧。。。\n\n首先，我觉得手动给程序分配CPU的想法有些**，我们知道，所有的程序在运行的时候，都是依托于操作系统，而不是依托于“手”，也就是说，对于内核相关的操作，面向用户的操作系统是不会提供给使用者的，举一个不太恰当的例子，我们知道民航客机上有6列乘座，但是机长任何时候都不能从自己的操作面板上让两个乘客调换座位，为什么？因为这个早在打印登机牌的时候，这些东西就定好了。乘客按照航空管理办法落座，就像操作系统自己写好的执行规范一样，去执行程序，作为“机长”的操作系统管理员是不应当参与这一过程的。\n\n然鹅退一步讲，如果我们一定要这么做的话，我认为也并不会有实质意义的提升。\n关于这个论点，我没有什么高深的计算机理论做支撑，但是从实际操作中，我观察到就算我的服务器有12个核心，Forge也只会使用其中的一个核心，大多数mod在运算的时候，也只使用一个核心（可能Forge将加载的mod都丢在一个核心里处理，各自的mod也只使用自己使用的那个核心处理，造成所有的mod都在一个核心里处理，以上为腿短），这就是为什么我们常听到“服务器只吃单核”（表现是这样，实际还是有差异的）。\n我尝试过很多办法，让服务器能够尽可能的使用多个核心，但是一直都没有成功（因为我也不懂应该怎么做）。\n\n也许在设计的时候，这些弊端就已经出现了吧。。。\n\n另外，表达一下我对TileEntity的理解，首先，我认为楼主的描述是不准确的，mod中添加的矿石方块不是TileEntity，只是一个Block。\n\n对于我而言，我想用一下几个特点描述TileEntity：\n1、容器，这里的容器不单指箱子，还有带有操作界面的东西，比如合成台、附魔台、告示牌、储电盒。\n2、TileEntity通常需要频繁更新并进行运算（比如：漏斗、线缆、管道、IE的温室，Botania的火花属于这一类）\n3、区别于Entity，TileEntity是一个有额外数据的方块（这代表TileEntity不能移动或被推走例如工业的作物架，而Entity是实体生物，例如没有血条的盔甲架和展示框）\n4、应该还有，我一时间想不起来了。。。。\n\n当然啦，我们不是在讨论这个概念，我想说的是，其实限制TileEntity数量一定要根据实际情况来判定的，有的TileEntity非常卡，而有的TileEntity对服务器的负载几乎没影响（举例：EIO流体管道VS钻石箱子）。\n\n我见过最卡的TileEntity是IC2的电动分拣机，全服务器只需要一个，只要他加载，TPS变成1/4，所以要不要试试放置10个满负载的电动分拣机呢（XD）？\n\n\n第三个话题我没考虑过，就不献丑啦 嘻嘻"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1545895380,
            "txt_content": "@YY-HeiDaDa   论坛没法回复，@一下吧   这个和没钱有啥关系···雾"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1545896460,
            "txt_content": "感谢米二大佬参与，还是不能回复，@Tollainmear\n\n对于第一个问题，乘客这个比喻不太恰当把，让我想到了飞机引擎，我可以在天上关掉两个省油啊，不过好像也不是很恰当，看图吧 ，是这个东西\n（再一次蒙圈，论坛暂时传不了图，就是在任务管理器中点程序会有一个相关性，可以指定用哪几个核心来处理这个程序）\n\n\n另外，矿物这个东西确实是个例外，那么就以电动分拣机为例，还有哪些东西是会非常卡服呢？据我所知：MEK涡轮机，MEK各类管道，更多实用设备洒水器，魔法作物的增生什么来着的（就是那个蓝色的方块）    \n\n其他如有大佬发现可以一起交流一下\n\n\n"
        },
        {
            "author": "Abraham511",
            "timestamp": 1545896880,
            "txt_content": "MC_tingfeng 发表于 2018-12-27 15:23\n@YY-HeiDaDa   论坛没法回复，@一下吧   这个和没钱有啥关系···雾\n友情提示：可以使用链接回复的哦~~\n\n比如说回复三楼的：http://www.mcbbs.net/forum.php?m ... page%3D1&page=1\n\n回复四楼的：http://www.mcbbs.net/forum.php?m ... page%3D1&page=1"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1545897360,
            "txt_content": "Tollainmear 发表于 2018-12-27 15:23\n我说一下我的看法吧。。。\n\n首先，我觉得手动给程序分配CPU的想法有些**，我们知道，所有的程序在运行的时 ...\n看下 这个图有没有出来"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1545897480,
            "txt_content": "Abraham511 发表于 2018-12-27 15:48\n友情提示：可以使用链接回复的哦~~\n\n比如说回复三楼的：http://www.mcbbs.net/forum.php?mod=post&action ...\n简单摸索一下之后好像知道怎么回事了\n大水怪来了不发表一下看法吗"
        },
        {
            "author": "Tollainmear",
            "timestamp": 1545898260,
            "txt_content": "@MC_tingfeng \n\n这个其实有很多，但是实际上还需要看服务器具体情况和玩家的方块布局，比如：\n原版：观察者（尤其是高频电路）、（空岛服务器里非常密集的）漏斗\nIC：风力动能发电机（尤其是大规模）、储电堆（不是单一方块，是多个MFSU组成的升压阵）、电动分拣机（1个就致命）、电缆\nNC：裂变堆控制器、电熔机\nEIO：各种管道\nMek：物品管道、流体管道、所有能够同时处理五个的高级机器、盐化塔\nBotania：火红莲阵、彼方兰阵\n\n以上吧，我没办法一一列举了，毕竟太多而且不同版本也有不通“特性”，可以使用Sponge的Timings功能来检测卡服的东西"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1545900000,
            "txt_content": "Tollainmear 发表于 2018-12-27 16:11\n@MC_tingfeng \n\n这个其实有很多，但是实际上还需要看服务器具体情况和玩家的方块布局，比如：\n嗯，已收录，其他物品我晚上回去看下服务器内容后再行添加，或考虑后期开个帖子公示各种mod中的卡服物品"
        },
        {
            "author": "。—。",
            "timestamp": 1545906120,
            "txt_content": "max-tick-time的详细解释在https://www.spigotmc.org/wiki/spigot-configuration/有，默认值为50\n该项以毫秒为计量单位，单个tick最多允许消耗多少时间，如果超过这个时间，服务器会放弃剩下的操作，开始下一个tick的运算，根据社区反，预留生物20-25ms和物品10-20ms的时间足以应付大部分情况【注：不知道这是多少年前的结论了……下一行开始加粗\n降低这个数值能提升性能，代价是游戏的体验，周围的物件总是在瞬移、卡顿。"
        },
        {
            "author": "1723624171",
            "timestamp": 1545906300,
            "txt_content": "提示: 作者被禁止或删除 内容自动屏蔽"
        },
        {
            "author": "Ariy",
            "timestamp": 1545908160,
            "txt_content": "非科班出身，对操作系统略懂皮毛，这里说一下我对CPU调度的理解，抛砖引玉，欢迎大佬指正\n比如，1服有主线程和8个异步线程，2服也同样。CPU调度的基本单位，就是这些线程，假设你一共有6个CPU核心（不考虑超线程），那么最多有6个线程并行，根据线程的优先级，优先级最高的线程将会获得CPU的使用权。\n我觉得楼主对于，两个jvm进程争夺CPU执行权的担忧是多余的，因为操作系统已经有了一套合理的CPU调度方式。优先级高的进程抢占了一个时间片的CPU执行权之后，他的优先级会下降。不可能出现1个服的线程优先级一直比另一个服高的情况。\nPS：windows系统处理器调度机制：https://blog.csdn.net/qq_29131783/article/details/68951562\n\n\n"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1545911820,
            "txt_content": "a6809936 发表于 2018-12-27 18:22\nmax-tick-time的详细解释在https://www.spigotmc.org/wiki/spigot-configuration/有，默认值为50\n该项以毫 ...\n所以问题就在这里啊，这个已经不知道是多少年前的结论了，而且关键的关键是这个论断是针对spigot纯净服的，纯净服才能有多少个tiles，\n而现在的mod服，mod数量动辄30-40.tiles动辄10多万，这个时候再以纯净端的优化方式来优化mod显然是不合适的"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1545911880,
            "txt_content": "1723624171 发表于 2018-12-27 18:25\n那开mod服用核心多u好呢还是核心少高频的呢?\n我的看法是高主频优先于高核心数量，至于这两者怎么权衡设计费用问题，看你自己选择"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1545912180,
            "txt_content": "tian_wc 发表于 2018-12-27 18:56\n非科班出身，对操作系统略懂皮毛，这里说一下我对CPU调度的理解，抛砖引玉，欢迎大佬指正\n比如，1服有主线 ...\n以这个逻辑来判断，依旧适用于我所提出的方法啊\n同样假设6核心cpu不考虑超线程，开两个服，每个服6个线程既12个线程\n一服优先级高于二服，那么在同一个tick  一服的数据处理完之后优先级降低，开始处理二服的\n\n那此时如果我手动分配123核心给一服，456核心给二服进行固定\n那么这两个程序间就不需要考虑优先级的问题，不要相互影响\n这样是否能提高服务器tps呢"
        },
        {
            "author": "Ariy",
            "timestamp": 1545915060,
            "txt_content": "MC_tingfeng 发表于 2018-12-27 20:03\n以这个逻辑来判断，依旧适用于我所提出的方法啊\n同样假设6核心cpu不考虑超线程，开两个服，每个服6个线程 ...\n为什么分开独立运行就更不卡呢？即使是分开各自使用3个核心，每个服务器内部的线程也会抢占CPU，一样存在切换线程的开销。有的时候，1服可能需要大量资源，但是2服这个时间点并不需要计算，1服就阔以使用全部的资源。但是如果你独立运行，1服顶天了也就用3个核心，另外3个核心不工作。\n"
        },
        {
            "author": "Akkariin",
            "timestamp": 1545917580,
            "txt_content": "泻药\n不开 Mod 服，不过介绍的挺详细\n我这边纯净服日常 tps 19.99+"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1545957780,
            "txt_content": "tian_wc 发表于 2018-12-27 20:51\n为什么分开独立运行就更不卡呢？即使是分开各自使用3个核心，每个服务器内部的线程也会抢占CPU，一样存在 ...\n假设两个服人数相同，mod相同，也就是分别需要占用的资源是基本相同的，再假设当只有一个服的时候是可以满足保障服务器tps稳定。此时\n情况1：核心不独立分配，两个服需要轮流获取CPU优先权来处理，导致两个服tps都会有一定程度波动以及平均tps的降低，当数据处理不及时造成的瞬间卡顿等现象\n\n情况2：核心独立分配，同程序内的CPU优先级争夺，tps同样降低，但相互不影响，即tps可以稳定在一个值上，波动降低\n\n你绝的是不是这样的？\n\n如此推论，以目前的情况下看来想要提升tps的最好办法就是单物理机单开服，不过这样很浪费资源啊"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1545960360,
            "txt_content": "Akkariin 发表于 2018-12-27 21:33\n泻药\n不开 Mod 服，不过介绍的挺详细\n我这边纯净服日常 tps 19.99+\n纯净服的优化相比mod服简单很多，而且有很多优秀的服务端，比如paper spigot"
        },
        {
            "author": "。—。",
            "timestamp": 1545968880,
            "txt_content": "MC_tingfeng 发表于 2018-12-27 19:57\n所以问题就在这里啊，这个已经不知道是多少年前的结论了，而且关键的关键是这个论断是针对spigot纯净服的 ...\n默认的 50ms 意味着在每一个 tick 时刻只能有 0.05s 的时间来处理一切事物，一旦到时间就都不管了，直接开始下一个循环，出现机器工作慢是因为其所在区块很不幸被排在后头了，没能在规定时间排到，也就没机会更新自身状态，作物生长同理……"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1545988020,
            "txt_content": "a6809936 发表于 2018-12-28 11:48\n默认的 50ms 意味着在每一个 tick 时刻只能有 0.05s 的时间来处理一切事物，一旦到时间就都不管了，直接 ...\n目前我是设了tiles1000    entity 50   \ntps10左右，但是玩家体验还不错"
        },
        {
            "author": "xzb3306688477",
            "timestamp": 1545988560,
            "txt_content": "我看不懂这个=-=大佬求教"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1545998580,
            "txt_content": "xzb3306688477 发表于 2018-12-28 17:16\n我看不懂这个=-=大佬求教\n那就好好把上面的看一下然后对照自己的服务器学习一下呗"
        },
        {
            "author": "xmdhs",
            "timestamp": 1545999840,
            "txt_content": "a6809936 发表于 2018-12-27 18:22\nmax-tick-time的详细解释在https://www.spigotmc.org/wiki/spigot-configuration/有，默认值为50\n该项以毫 ...\n所以服务器并没有卡顿，反而占用的资源更少了吗。。。。。\n\n所以调高似乎很有必要"
        },
        {
            "author": "Twilight_Two",
            "timestamp": 1546021680,
            "txt_content": "很简单，有nbt的就是tile，有碰撞箱的就是entity。"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1546044300,
            "txt_content": "xmdhs 发表于 2018-12-28 20:24\n所以服务器并没有卡顿，反而占用的资源更少了吗。。。。。\n\n所以调高似乎很有必要\n嗯，理论上设置tiles  50    entity   50   应该是最好的，当时需要cpu能处理的过来\n如果处理不过来，适当放弃tps来保障玩家的游戏体验即提高这两个数值也是可行的\n而为了想要提高tps而降低这两项数值，带来的结果是游戏体验的极度下降以及随着时间推移跳过或推迟事件越来越多最终不是蹦就是卡的不能玩"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1546044420,
            "txt_content": "Twilight_Two 发表于 2018-12-29 02:28\n很简单，有nbt的就是tile，有碰撞箱的就是entity。\n嗯，大致上这么分也行，但是植物魔法的火花怎么说  /手动滑稽"
        },
        {
            "author": "。—。",
            "timestamp": 1546050540,
            "txt_content": "xmdhs 发表于 2018-12-28 20:24\n所以服务器并没有卡顿，反而占用的资源更少了吗。。。。。\n\n所以调高似乎很有必要\n没看懂……这里翻译的项目应该是和一个定时器差不多，到点了强行取消一切未完成的实体更新事件，默认的 50ms 会让所有需要 51ms 或更长时间来完成的计算失效，有时候作物老是不长大多就是过度优化，把这个值调低的结果……\n顺带一秒除50ms就是20tps，除非是插件作者有特别的需求，一般都是把这项往低了调，限制实体的运算消耗，把计算资源分给别的高消耗插件……"
        },
        {
            "author": "Tommer",
            "timestamp": 1546051020,
            "txt_content": "老实说我觉得这个帖应该发在联机教程。。"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1546052700,
            "txt_content": "Tommer 发表于 2018-12-29 10:37\n老实说我觉得这个帖应该发在联机教程。。\n目前阶段并没有确定性的结论，针对mod服的优化此前的教程基本都不具太大的参考价值，\n所以想和各位大佬共同探讨"
        },
        {
            "author": "Twilight_Two",
            "timestamp": 1546087080,
            "txt_content": "植物魔法火花有碰撞箱，是实体。killall可以清理掉"
        },
        {
            "author": "DGai",
            "timestamp": 1546087620,
            "txt_content": "这贴 应该精啊"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1546146780,
            "txt_content": "Twilight_Two 发表于 2018-12-29 20:38\n植物魔法火花有碰撞箱，是实体。killall可以清理掉\nkillall指令其实不是很好用，用laggremove里面的 lr c e a  这个指令清理更干净"
        },
        {
            "author": "残念cannian",
            "timestamp": 1546221720,
            "txt_content": "搞得我都水不下去了"
        },
        {
            "author": "残念cannian",
            "timestamp": 1546221720,
            "txt_content": "搞得我都水不下去了"
        },
        {
            "author": "_DIM_",
            "timestamp": 1546223880,
            "txt_content": "我 max-tick-time=0 。。。。。。。"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1546225080,
            "txt_content": "酷车手BB弹 发表于 2018-12-31 10:38\n我 max-tick-time=0 。。。。。。。\n意思是不进行限制？效果如何啊"
        },
        {
            "author": "_DIM_",
            "timestamp": 1546227120,
            "txt_content": "MC_tingfeng 发表于 2018-12-31 10:58\n意思是不进行限制？效果如何啊\n服务器开几个钟就卡了，要重启"
        },
        {
            "author": "MC_tingfeng",
            "timestamp": 1546238640,
            "txt_content": "酷车手BB弹 发表于 2018-12-31 11:32\n服务器开几个钟就卡了，要重启\n可以配合自动重启，回头去试试看效果\n"
        }
    ]
}