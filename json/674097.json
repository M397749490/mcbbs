{
    "title": "[插件高级编程]如何向核心中插入自己的事件 - 以PlayerOPEvent举例",
    "author": "coderzeng",
    "replyCount": 1,
    "timestamp": 1487013300,
    "txt_content": " 本帖最后由 coderzeng 于 2017-2-14 04:20 编辑 \n\n如何向核心中插入自己的事件 - 以PlayerOPEvent举例\n\n这不是基础教程，函数详细用法参考百度，这里只提供思路和源码\n\n我们知道Bukkit在添加用户为OP的时候是没有对应事件给插件的，这可不方便管理，所以我们自己给他加一个\n\n本文涉及如下内容 :\nJavaAgent -  如果知道是啥就不用点开了\n\n\njavaagent的主要功能如下：可以在加载class文件之前做拦截，对字节码做修改可以在运行期对已加载类的字节码做变更，但是这种情况下会有很多的限制，后面会详细说还有其他一些小众的功能\n获取所有已经加载过的类获取所有已经初始化过的类（执行过clinit方法，是上面的一个子集）获取某个对象的大小将某个jar加入到bootstrap classpath里作为高优先级被bootstrapClassloader加载将某个jar加入到classpath里供AppClassloard去加载设置某些native方法的前缀，主要在查找native方法的时候做规则匹配\n\n\n\nJavassist -  如果知道是啥就不用点开了\n\nJavassist是一个开源的分析、编辑和创建Java字节码的类库。是由东京工业大学的数学和计算机科学系的 Shigeru Chiba 所创建的。它已加入了开放源代码JBoss 应用服务器项目,通过使用Javassist对字节码操作为JBoss实现动态\"AOP\"框架。\n\n\n所以我们的目的就很简单了 -- 找到MC处理OP的代码，在真正执行之前进行判断\n\nStep 1 - 找到处理OP的代码\n\n\n方案1 -- 直接查找每个类【太特么恶心了】\n方案2 -- 根据提示查找【主要讲这个】\n你需要 : JD- GUI,一个核心\n\n首先我们在后台随便给个OP,比如给123这个玩家吧，看看会显示什么\n\n\n\n\n1.PNG (21.18 KB, 下载次数: 2)\n\n下载附件\n\n2017-2-14 03:22 上传\n\n\n\n\n\n好的，接下来让我们看看Opped这个字符出现在哪里\n\n\n\n\n2.PNG (42.68 KB, 下载次数: 2)\n\n下载附件\n\n2017-2-14 03:30 上传\n\n\n\n\n\n双击打开，可以发现是调用了player.setOP()的方法，继续向前追踪\n最后来到PlayerList类的addOP();,长这样\n\n\n\n\n3.PNG (9.06 KB, 下载次数: 4)\n\n下载附件\n\n2017-2-14 03:36 上传\n\n\n\n\n\n所以第一步到此结束\n\n\n\nStep 2 - 构建我们自己的PlayerList\n\n目标 - 在真正进行添加OP操作前进行判断\n先上代码，再解释功能，函数功能请查看JavaDoc\npublic class ABDClassPatcher {\n    private ClassPool pool;\n    public ABDClassPatcher(){\n        try {\n            pool = ClassPool.getDefault();\n            pool.appendClassPath(ABDClassHelper.getJarFilePathFromClass(ABDClassHelper.getCraftClassAsName(\"PlayerList\",false)));\n            pool.appendClassPath(ABDClassHelper.getJarFilePathFromClass(this.getClass()));\n        } catch (NotFoundException e) {\n            e.printStackTrace();\n        }\n    }\n    \n    public byte[] PatchPlayerList(){\n        try {\n            CtClass classplayerlist = pool.get(ABDClassHelper.getCraftClassAsName(\"PlayerList\",false)); \n            CtMethod addopmenthod = classplayerlist.getDeclaredMethod(\"addOp\");\n            addopmenthod.insertBefore(\"{com.verofess.abdapi.patcher.SetOpPatcher#CallEvent($1);}\"); \n            return classplayerlist.toBytecode();\n        } catch (NotFoundException | CannotCompileException | IOException e) {\n            e.printStackTrace();\n            return new byte[0];\n        }\n    }\n}\n复制代码这是我之前发布的某个插件中的源码，\n在构造函数中向ClassPool中添加了核心和自身的路径，\nPatchPlayerList()大概的意思就是向addOP()的前面插入了一行\n\ncom.verofess.abdapi.patcher.SetOpPatcher#CallEvent($1);\n\n那么SetOpPatcher的内容是什么呢？\npublic class  SetOpPatcher {\n    static public void CallEvent(GameProfile gp){\n        Player player = Bukkit.getServer().getPlayer(gp.getId());\n        StackTraceElement stack[] = Thread.currentThread().getStackTrace();  \n        if(ABDClassHelper.isFromPlugins(stack)){\n            PlayerSetOPEvent event = new PlayerSetOPEvent(player);\n            Bukkit.getServer().getPluginManager().callEvent(event);\n        }\n    }\n}复制代码判断了一下这个事件是不是来自插件的，如果是就new 一个PlayerSetOPEvent()出来\n\n\ngetCraftClassAsName是用来取类名的，不用管它\n\n\nstep - 3  替换原始的PlayerList\n\n我们为了完成替换，应当在原始的PlayerList类加载前对其进行处理\n所以只需要实现JavaAgent的premain就好，代码如下\n\npublic class ABDAgent {\n    private static String Ver;\n    public static void premain(String agentArgs, Instrumentation inst){\n        Ver = agentArgs;\n        ABDClassPatcher patcher = new ABDClassPatcher();\n        try {\n            inst.redefineClasses(new ClassDefinition(Class.forName(ABDClassHelper.getCraftClassAsName(\"PlayerList\",false)),patcher.PatchPlayerList()));\n        } catch (ClassNotFoundException | UnmodifiableClassException e) {\n            e.printStackTrace();\n        }\n    }\n    public static String getVer() {\n        return Ver;\n    }\n}复制代码这里就是调用了刚才的函数对PlayerList类进行了重定义，为了让java知道我们要用这个功能，还需要修改下MANIFEST.MF文件\nManifest-Version: 1.0\nPremain-Class: com.verofess.abdapi.ABDAgent\nCan-Redefine-Classes: true\n\n复制代码就像这样\n\n\n\n最后，在命令行里加上 -javaagent的选项就可以执行了\n\n太麻烦？其实我写的有API，不过只有我自己用的嘿嘿\n\n下次来讲讲Forge的，恩，完结撒花\n\n",
    "replies": [
        {
            "author": "深海板蓝根",
            "timestamp": 1501140480,
            "txt_content": "一眨眼过去5个月了"
        }
    ]
}