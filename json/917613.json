{
    "title": "【CBL|00ll00】[1.14+，附数据包] 更精准的方块视线追踪方法",
    "author": "00ll00",
    "replyCount": 6,
    "timestamp": 1570104840,
    "txt_content": " 本帖最后由 00ll00 于 2020-4-5 23:04 编辑 \n\n更精准的方块视线追踪与更更精准的方块视线追踪\n-1.这个方法已过时\n\n这个方法虽然比较精确，但是大量使用实体，实用性能不强。空白白直接采用数学计算，可以精确到方块内部碰撞箱，而且很快：\n\n\n[CBL|K_bai]解决你的一切射线追踪烦恼！超精准的射线追踪碰撞检测器[1.14.4+]\n\n\n0.目前方法的缺陷\n\n臆测目前大部分的CBer在遇到追踪玩家所指向的远处的方块时都会用如下方法：\n以玩家的视线方向步进基准点判断基准点处是否为空气若是，则返回第一步若不是，则当前方块即所求方块\n\n\n但这个方法有很多缺陷：\n在视线从方块边缘穿过方块时有极大的几率漏过：\n\n而通常的解决方法是减小步长，这样不仅增大了游戏的负担，而且仍然难以解决这种刁钻的问题：\n\n虽然一般来说这种情况的误差可以忽略，但若放在目前本人正在制作的绘图包中，就很容易因为穿透而出现漏墨的现象。因此需要一种更加精准的判定方法。\n\n1.更精准的方法\n\n这是我目前使用的方法，仍发现了一些漏洞，但是已经够用了（应该）。详见2.更更精准的方法\n以玩家的视线方向步进基准点判断基准点处是否为空气若不是，则当前方块即所求方块若是，则继续判断基准点周围六个方块是否都为空气若是，则返回第一步若不是，则继续判断视线所指向方块为哪个方向的方块（X+,X-,Y+,Y-,Z+,Z-）继续判断该方向的方块是否为空气若是，则返回第一步若不是，则指向的方块为所求方块\n\n\n这一系列步骤中，最关键的一步就是第六步，判断视线所指向方块为哪个方向的方块了，接下来重点讲解。\n\n\n首先我们简化一下问题，只考虑xz平面上的情况。\n（以X+方向为0°，逆时针方向为正）\n\n假设在当前基准点及水平视角如图\n\n\n\n很容易看出视线指向了X+方向的方块，那么如何计算出这个结果呢\n我们可以通过找出X+方向的临界值的方式来判断\n\n只要视线角度在临界角度之间，我们就可以认为指向的是X+方向的方块。其他方向同理。于是再简化一下，如图，因为视线角度在0°~90°内，我们只需要判断是指向了X+还是Z+，因为在这个范围内是不可能指向其他方向的，于是就只需要获取到一个临界值并进行比较。其他情况同理。\n\n那么如何找出临界角？我们可以分别在基准点位置和顶点处召唤两个Marker[O,T]，然后用execute facing的方式使O看向T，这时O的视角即临界角。\n通过测试，比较角度时只需要精确到十分位便可以在xz方向上拥有能与mc自带黑框相媲美的精确度。\n接下来我们继续考虑y方向的问题，即视线是否是从Y+或Y-方向的方块穿出。这个判断要稍微麻烦一些，要用到一些初中数学知识。\n还是沿用以上判断临界值的方法，并且我们已经能知道视线水平上指向了哪个方向，于是先考虑以下情况：\n\n用以上的思维，由于仰角小于0°（mc内是这样的，抬头为负，低头为正），所以只需要判断是指向了X+还是Y+，于是需要在这个地方刷一个Marker来确定临界值\n\n\n怎么刷呢我们先忽视仰角，在视线前方一定距离处刷一个Marker[U]，获取到U和O的坐标信息，然后分别计算出x1,x2,z1，由三角形相似可得z2=z1*x2/x1\n\n于是，我们可以算出临界点的z坐标，又因为临界点是在方块的棱上，所以x,y都是整数化的，通过基于视线角的一些调整便能得到具体的值。再通过相似的方法获取到仰角临界值并与视线的仰角进行比较，便可判断视线是从Y+还是侧面穿出。\n通过测试，将角度放大10倍，坐标放大为128倍后进行运算能得到比较满意的结果。\n\n2.更更精准的方法（只是补充）\n\n在测试的过程中发现了一个非常刁钻的情况\n\n\n图中视线方向为左下到右上，可以看出，视线本应指到红色混凝土，但前一个点处进行判断时四周都为空气，而下一个点时所指向的方向又并不是非空气方块，所以判定结果就是视线直接穿过了。\n这种情况可以通过反向的穿透判定来解决，于是更更精准的方法为：\n以玩家的视线方向步进基准点判断基准点处是否为空气若不是，则当前方块即所求方块若是，则继续判断基准点周围六个方块是否都为空气若是，则返回第一步若不是，则继续判断视线所指向方块为哪个方向的方块（X+,X-,Y+,Y-,Z+,Z-）继续判断该方向的方块是否为空气若不是，则指向的方块为所求方块若是，反转视线方向进行6~8步若反向判定结果仍为空气，则返回第一步若反向判定结果不为空气，则反向判定指向的方块为所求方块\n\n3.感谢\n\n\n感谢空白白，SPG，素学姐，如花等大佬的指点\n这个教程过于简陋，也暂时没空做单独的数据包，后来做了看下面，感谢各位看了之后没把我打死\n4.数据包\n使用更更精准的方法，追踪距离为200m，应该能在所有1.14+版本使用（最近的几个快照渲染炸炸的，看起来可能有些奇怪）\n\n\n\n\nAGT.zip\n(6.19 KB, 下载次数: 30)\n\n\n\n2019-10-5 10:27 上传\n点击文件名下载附件\n精准视线追踪数据包\n\n\n\n\n",
    "replies": [
        {
            "author": "底层咸鱼",
            "timestamp": 1570105080,
            "txt_content": " 本帖最后由 我是萌新（ 于 2019-10-3 21:11 编辑 \n感谢各位看了之后没把我打死\n因为我打不到你 \n还有一件事，你说的 绘图包 是啥（\n是画线段、多边形、圆、多面体之类的吗？\n\n↓ 建筑者是什么，不应该是建造者吗（跑\n   我终于可以安心地弃坑啦（"
        },
        {
            "author": "00ll00",
            "timestamp": 1570105800,
            "txt_content": "我是萌新（ 发表于 2019-10-3 20:18\n因为我打不到你 \n还有一件事，你说的 绘图包 是啥（\n是画线段、多边形、圆、多面体之类的吗？ ...\n目前做的工具有：铅笔，刷子，橡皮，滴管，填充，变暗，减淡，杂色，模糊，喷枪；三维笔刷，三维橡皮，三维喷枪，三维填充，剥离，长方体，球体\n计划中还有一些矢量作图工具\n\n:]"
        },
        {
            "author": "(=°ω°)丿",
            "timestamp": 1570107600,
            "txt_content": " 本帖最后由 隐退 于 2019-10-4 12:47 编辑 \n00ll00 发表于 2019-10-3 20:30\n目前做的工具有：铅笔，刷子，橡皮，滴管，填充，变暗，减淡，杂色，模糊，喷枪；三维笔刷，三维橡皮，三 ...\n听到你这个消息，我感到十分喜悦（来，让我把我知道的都告诉你……\n破模组 建造者 Builder\nhttps://www.mcbbs.net/thread-843864-1-1.html\n绘制长方体\nhttps://www.mcbbs.net/thread-814021-1-1.html\n绘制三角形和圆\nhttps://www.mcbbs.net/thread-816932-1-1.html\n绘制 2D 的圆\nhttps://www.mcbbs.net/thread-841681-1-1.html\n简易平面内的点径画圆与三点画圆\nhttps://www.mcbbs.net/thread-845834-1-1.html\n绘制圆\nhttps://www.mcbbs.net/thread-840985-1-1.html\n绘制多边形：使用多个三角形拼接而成\n绘制棱锥/圆锥：先绘制多边形/圆，然后使多边形上的点向平面外的一个点递归\n绘制棱柱/圆柱：先绘制多边形/圆，然后平移\n绘制球：先让一个点绕另一个点旋转半周，形成半圆，然后让半圆旋转一周\n……如果是只绘不建的话，（我们假设绘制出来的几何图形上的点都是药水云）\n我的计划是在完成一个图形的绘制后，给所有药水云分数+1，\n那么最后一个完成绘制的图形上的点的分数都是1，倒数第2个完成绘制的图形上的点的分数都是2……以此类推。\n这样的话，可以用于区分不同的图形，也可以用于开发撤销功能。（没有 Ctrl+Z 的绘图软件是没有灵魂的）"
        },
        {
            "author": "kongbaiyo",
            "timestamp": 1570115940,
            "txt_content": " 本帖最后由 kongbaiyo 于 2019-10-9 13:49 编辑 \n\n感觉我想到一个简化方案...不需要把xyz分开处理，也不用比较角度\n\n就是先得到视线的指向方向 比如是+x+y+z方向\n然后在当前位置朝方块的那个顶点处1格的距离处放个marker\n然后在视线方向1格开外执行：如果marker在当前位置下方，则必会先碰到xz平面，其他类推\n\n\n\n\nAnnotation 2019-10-03 232213.png (13.41 KB, 下载次数: 3)\n\n下载附件\n\n2019-10-3 23:22 上传\n\n\n\n\n\n红线都是1格的长度，相当于标准化 图里这种情况就可以判断 marker如果在绿点位置-x方向，则一定先碰到z轴\n\n\n我以上说的全是错的\n"
        },
        {
            "author": "BlackCB.",
            "timestamp": 1570116300,
            "txt_content": "说的好，我选择第一种方法\n想问一下每做一个基准点就探测周围6个方块的做法不会增加游戏负担吗，一般用途都应该会忽略这种情况的吧……"
        },
        {
            "author": "00ll00",
            "timestamp": 1570119420,
            "txt_content": "BlackCB. 发表于 2019-10-3 23:25\n说的好，我选择第一种方法\n想问一下每做一个基准点就探测周围6个方块的做法不会增加游戏负担吗，一 ...\n会的，但是我也没办法了（"
        }
    ]
}