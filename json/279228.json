{
    "title": "为什么tileentity无法在退出游戏后保存？",
    "author": "qq869653899",
    "replyCount": 3,
    "timestamp": 1401294900,
    "txt_content": "用gameregisty注册了tileentity，在退出重进之前一切功能正常，但是一旦退出重进后，tileentity就会变成初始状态，我用的是1.6.4版本，求大神解救。。。\nTileEntityUnionCore.java\npackage littlebug.ModUnion;\n\nimport java.lang.reflect.Field;\nimport java.util.ArrayList;\nimport java.util.List;\n\nimport cpw.mods.fml.client.FMLClientHandler;\nimport net.minecraft.client.Minecraft;\nimport net.minecraft.client.gui.GuiScreen;\nimport net.minecraft.nbt.NBTTagCompound;\nimport net.minecraft.network.INetworkManager;\nimport net.minecraft.network.packet.Packet;\nimport net.minecraft.network.packet.Packet132TileEntityData;\nimport net.minecraft.tileentity.TileEntity;\n\npublic class TileEntityUnionCore extends TileEntity{\n        private String union_name = \"\";\n        private String chair_name = \"\";\n        private List<String> members = new ArrayList<String>();\n        private String permissions = \"\";\n\n        public int a = 4;\n        public String getUnion_name() {\n                return this.union_name;\n        }\n        public void setUnion_name(String union_name) {\n                this.union_name = union_name;\n        }\n        \n        @Override\n        public void readFromNBT(NBTTagCompound par1NBTTagCompound)\n    {\n        super.readFromNBT(par1NBTTagCompound);\n        this.union_name = par1NBTTagCompound.getString(\"union_name\");\n        this.permissions = par1NBTTagCompound.getString(\"permissions\");\n        String[] members = par1NBTTagCompound.getString(\"members\").split(\";\");\n        for (String m : members){\n                this.members.add(m);\n        }\n        a = par1NBTTagCompound.getInteger(\"a\");\n    }\n        \n        @Override\n    public void writeToNBT(NBTTagCompound par1NBTTagCompound)\n    {\n        super.writeToNBT(par1NBTTagCompound);\n        par1NBTTagCompound.setString(\"union_name\", union_name);\n        par1NBTTagCompound.setString(\"permissions\", permissions);\n        String members = \"\";\n        for (String m : this.members){\n                members += m + \";\";\n        }\n        par1NBTTagCompound.setString(\"members\", members);\n        par1NBTTagCompound.setInteger(\"a\", a);\n    }\n        public String getChair_name() {\n                return chair_name;\n        }\n        public void setChair_name(String chair_name) {\n                this.chair_name = chair_name;\n        }\n        public List<String> getMembers() {\n                return members;\n        }\n        public void setMembers(List<String> members) {\n                this.members = members;\n        }\n        public String getPermissions() {\n                return permissions;\n        }\n        public void setPermissions(String permissions) {\n                this.permissions = permissions;\n        }\n        \n                \n}\n复制代码\nBlockUnionCore.java\npackage littlebug.ModUnion;\n\nimport java.util.ArrayList;\nimport java.util.List;\n\nimport littlebug.ModUnion.NetWork.UnionPacket;\nimport cpw.mods.fml.common.network.PacketDispatcher;\nimport cpw.mods.fml.common.network.Player;\nimport cpw.mods.fml.common.registry.GameRegistry;\nimport cpw.mods.fml.common.registry.LanguageRegistry;\nimport cpw.mods.fml.relauncher.Side;\nimport cpw.mods.fml.relauncher.SideOnly;\nimport net.minecraft.block.Block;\nimport net.minecraft.block.BlockContainer;\nimport net.minecraft.block.material.Material;\nimport net.minecraft.client.Minecraft;\nimport net.minecraft.client.gui.GuiScreen;\nimport net.minecraft.client.renderer.texture.IconRegister;\nimport net.minecraft.creativetab.CreativeTabs;\nimport net.minecraft.entity.EntityLivingBase;\nimport net.minecraft.entity.player.EntityPlayer;\nimport net.minecraft.item.ItemStack;\nimport net.minecraft.tileentity.TileEntity;\nimport net.minecraft.world.World;\nimport net.minecraftforge.common.MinecraftForge;\n\npublic class BlockUnionCore extends BlockContainer{\n\n         \n        public BlockUnionCore(int par1, Material par2Material) {\n                super(par1, par2Material);\n                // TODO Auto-generated constructor stub\n                this.init();\n        }\n\n        public void init(){\n                this.setUnlocalizedName(\"UnionCore\");\n                //this.setTextureName(\"ghoul:GhoulAltar\");\n                this.setHardness(1.5f); //设置砖块的硬度\n                this.setResistance(10.0f); //置对爆炸的抗性\n                this.setLightValue(0.0f); //设置发光亮度\n                this.setStepSound(Block.soundStoneFootstep); //设置踩在上面的脚步声\n                this.setCreativeTab(CreativeTabs.tabBlock); //设置在创造模式中它在哪个菜单分类里\n                GameRegistry.registerBlock(this, \"UnionCore\");\n                LanguageRegistry.addName(this, \"工会核心\");\n                \n                //MinecraftForge.setBlockHarvestLevel(this, \"GhoulsArm\", 3);\n        }\n        \n        /**\n     * 注册贴图。\n     */\n    @SideOnly(Side.CLIENT)\n    public void registerIcons(IconRegister par1IconRegister)\n    {\n        this.blockIcon = par1IconRegister.registerIcon(\"ghoul:GhoulAltar\");\n    }\n        \n    \n        public void onBlockPlacedBy(World par1World, int par2, int par3, int par4, EntityLivingBase par5EntityLivingBase, ItemStack par6ItemStack){\n                super.onBlockPlacedBy(par1World, par2, par3, par4, par5EntityLivingBase, par6ItemStack);\n                \n                String name = par5EntityLivingBase.getEntityName() + \"union\";\n                int[] rect = new int[]{par2-16,par4-16,par2-16,par4+16,par2+16,par4-16,par2+16,par4+16};\n                List<String> members = new ArrayList<>();\n                members.add(par5EntityLivingBase.getEntityName());\n                String chair_man = par5EntityLivingBase.getEntityName();\n                String permissions = \"1111\";\n                UnionList.addUnion(name, rect, members, chair_man, permissions);\n                TileEntity tile = Minecraft.getMinecraft().theWorld.getBlockTileEntity(par2, par3, par4);\n                if (tile instanceof TileEntityUnionCore){\n                        ((TileEntityUnionCore) tile).setUnion_name(name);\n                        ((TileEntityUnionCore) tile).setChair_name(chair_man);\n                        ((TileEntityUnionCore) tile).setMembers(members);\n                        ((TileEntityUnionCore) tile).setPermissions(permissions); \n                        \n                }\n        }\n        \n        @Override\n        public boolean onBlockActivated(World par1World, int par2, int par3, int par4, EntityPlayer par5EntityPlayer, int par6, float par7, float par8, float par9){\n                super.onBlockActivated(par1World, par2, par3, par4, par5EntityPlayer, par6, par7, par8, par9);\n                TileEntityUnionCore tileEntity = (TileEntityUnionCore) par1World.getBlockTileEntity(par2, par3, par4);\n                if (tileEntity == null || par5EntityPlayer.isSneaking()){\n                        return false;\n                }\n                if(par1World.isRemote)\n        {\n            //如果蹲下但是客户端，也跳出，但返回true使其挥舞手臂\n            return true;\n        }\n                //Minecraft.getMinecraft().displayGuiScreen(new GuiUnionCore(par2, par3, par4));\n                UnionPacket pak = new UnionPacket();\n                //我们要发送3个int数据，所以初始化数组大小为3\n                pak.dataInt = new int[3];\n                //数据包ID为0\n                pak.packetType = 0;\n                //方块X轴坐标\n                pak.dataInt[0] = par2;\n                //方块Y轴坐标\n                pak.dataInt[1] = par3;\n                //方块Z轴坐标\n                pak.dataInt[2] = par4;\n                //发送数据包\n                PacketDispatcher.sendPacketToPlayer(pak.toPacket(), (Player)par5EntityPlayer);\n                //System.out.println(\"123\");\n                \n                return true;\n        }\n\n        @Override\n        public TileEntity createNewTileEntity(World world) {\n                // TODO Auto-generated method stub\n                return new TileEntityUnionCore();\n        }\n        \n}\n复制代码\nUnion.java  //mod主类\npackage littlebug.ModUnion;\n\nimport littlebug.ModArcana.ArcanaEventHooks;\nimport littlebug.ModUnion.NetWork.PaketHandler;\nimport littlebug.ModUnion.NetWork.UnionPacket;\nimport net.minecraft.block.material.Material;\nimport net.minecraft.client.Minecraft;\nimport net.minecraft.entity.EnumCreatureType;\nimport net.minecraft.entity.player.EntityPlayerMP;\nimport net.minecraft.item.Item;\nimport net.minecraft.item.ItemStack;\nimport net.minecraft.src.ModLoader;\nimport net.minecraft.tileentity.TileEntity;\nimport net.minecraft.world.biome.BiomeGenBase;\nimport net.minecraftforge.common.MinecraftForge;\nimport cpw.mods.fml.common.Mod;\nimport cpw.mods.fml.common.SidedProxy;\nimport cpw.mods.fml.common.event.FMLInitializationEvent;\nimport cpw.mods.fml.common.event.FMLPostInitializationEvent;\nimport cpw.mods.fml.common.event.FMLPreInitializationEvent;\nimport cpw.mods.fml.common.network.NetworkMod;\nimport cpw.mods.fml.common.network.NetworkRegistry;\nimport cpw.mods.fml.common.registry.EntityRegistry;\nimport cpw.mods.fml.common.registry.GameRegistry;\nimport cpw.mods.fml.common.registry.LanguageRegistry;\nimport cpw.mods.fml.common.Mod.EventHandler;\nimport cpw.mods.fml.common.Mod.Instance;\nimport cpw.mods.fml.relauncher.Side;\nimport cpw.mods.fml.relauncher.SideOnly;\n\n@Mod(modid=\"Union\", name=\"Union\", version=\"alpha\")\n@NetworkMod(clientSideRequired=true, serverSideRequired=false, channels={\"UnionMod\"}, packetHandler=PaketHandler.class)\npublic class Union {\n        @Instance(\"Union\")\n        public static Union instance;\n//        public static int ScrollID;\n        public static int BlockUnionCoreID;\n        \n        public static BlockUnionCore blockUnionCore;\n        \n        @SidedProxy(clientSide = \"littlebug.ModUnion.Client\", serverSide = \"littlebug.ModUnion.Common\")\n        public static Common proxy;\n        \n        @EventHandler\n        public void preLoad(FMLPreInitializationEvent event)\n        {\n                \n                UnionConfig.InitliazeConfig(event.getSuggestedConfigurationFile());\n                try\n                {\n                        BlockUnionCoreID = UnionConfig.GetBlockID(\"BlockUnionCore\", 1000);\n                }\n                catch(Exception error)\n                { \n                    System.out.println(error.getMessage());\n                    System.out.println(error.getStackTrace());\n                }\n                UnionConfig.SaveConfig();\n                try{\n                        UnionList.setList();\n                }\n                catch(Exception error){\n                        \n                }\n                \n                blockUnionCore = new BlockUnionCore(BlockUnionCoreID, Material.rock);\n                GameRegistry.registerBlock(blockUnionCore,\"BlockUnionCore\");\n                //EntityRegistry.addSpawn(EntityMirrorImage.class, 2, 1, 1, EnumCreatureType.monster, BiomeGenBase.biomeList);\n                \n                proxy.registerRenderThings();\n                proxy.registerSound();\n                        \n                //LanguageRegistry.instance().addStringLocalization(\"entity.WeakDio.name\", \"en_US\", \"WeakDio\");\n        }\n         \n        @EventHandler\n        public void load(FMLInitializationEvent event)\n        {\n                //TileEntity.addMapping(TileEntityUnionCore.class, \"UnionCoreTileEntity\");\n                GameRegistry.registerTileEntity(TileEntityUnionCore.class, \"ucTile\");\n        }\n         \n        @EventHandler\n        public void postLoad(FMLPostInitializationEvent event)\n        {\n                this.registerEvents();\n                this.semltingInit();\n                this.recipeInit();\n        }\n        private void semltingInit(){\n                //GameRegistry.addSmelting(bloodOfVampire.itemID, new ItemStack(animaOfVampire), 1f);\n        }\n        private void recipeInit(){\n                //GameRegistry.addRecipe(new ItemStack(animaOfVampire,1), new Object[] {\" # \", \"#X#\", \" # \", '#', Block.blockLapis, 'X', bloodOfVampire});\n        }\n        private void registerEvents(){\n                MinecraftForge.EVENT_BUS.register(new UnionEventHooks());\n        }\n        \n        public static void handlePacketFromClient(UnionPacket packet, EntityPlayerMP player)\n        {\n                if(packet.packetType == 1)\n                {\n                    String name = packet.dataString[0];\n                    String permissions = packet.dataString[1];\n                    \n                    UnionList union = UnionList.unions.get(name);\n                    if (union == null){\n                            return;\n                    }\n                    UnionList.updateUnion(name, union.getRect(), union.getMembers(), union.getChair_name(), permissions);\n                }\n        }\n        @SideOnly(Side.CLIENT)\n        public static void handlePacketFromServer(UnionPacket packet)\n        {\n            if (packet.packetType == 0){\n                    Minecraft.getMinecraft().displayGuiScreen(new GuiUnionCore(packet.dataInt[0], packet.dataInt[1], packet.dataInt[2]));\n            }\n        }\n}\n复制代码\n\n",
    "replies": [
        {
            "author": "yuxuanchiadm",
            "timestamp": 1401297900,
            "txt_content": "当tileEntity更新后，有需要写入NBT的信息，必须执行TileEntity.markDirty()方法，才能确保在地图保存时保存此次更改的信息到NBT。"
        },
        {
            "author": "yuxuanchiadm",
            "timestamp": 1401298080,
            "txt_content": "如果是1.6以及以下版本则是TileEntity.onInventoryChanged()方法"
        },
        {
            "author": "qq869653899",
            "timestamp": 1401323100,
            "txt_content": "yuxuanchiadm 发表于 2014-5-29 01:28\n如果是1.6以及以下版本则是TileEntity.onInventoryChanged()方法\n谢谢，但是没有用，我试着在修改tileentity后调用onInventoryChanged()方法，但是没有效果，还是说我调用的姿势不对？"
        }
    ]
}