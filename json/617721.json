{
    "title": "弱弱地问一下，Capability怎么使用",
    "author": "hkpxt1588",
    "replyCount": 2,
    "timestamp": 1470661020,
    "txt_content": " 本帖最后由 hkpxt1588 于 2016-8-8 21:11 编辑 \n\n我想给玩家附加一个Capability用来存储玩家信息，相关代码如下：\n\nCapabilityPlayerData：public class CapabilityPlayerData{\n        @CapabilityInject(ICapabilityPlayerData.class)\n        public static final Capability<ICapabilityPlayerData> INSTANCE = null;\n\n        \n        public interface ICapabilityPlayerData {\n                public String getType();\n                public void setType(String type);\n                public int getLevel();\n                public void setLevel(int lv);\n                public String getProfession();\n                public void setProfession(String profession);\n        }\n}\n\nCapabilityPlayerDataDefault：\npublic class CapabilityPlayerDataDefault implements ICapabilityPlayerData{\n        private String type = \"Human\"\n        private String profession = \"none\"\n        private int level=0;\n        @Override\n        public String getType() {\n                return type;\n        }\n        @Override\n        public void setType(String type) {\n                this.type = type;\n        }\n        @Override\n        public int getLevel() {\n                return level;\n        }\n        @Override\n        public void setLevel(int lv) {\n                this.level = lv;\n        }\n        @Override\n        public String getProfession() {\n                return profession;\n        }\n        @Override\n        public void setProfession(String profession) {\n                this.profession = profession;\n        }\n}\n\nCapabilityPlayerDataHandler：\npublic class CapabilityPlayerDataHandler implements IStorage<ICapabilityPlayerData>{\n        public final static CapabilityPlayerDataHandler capabilityPlayerDataHandler = new CapabilityPlayerDataHandler();\n        public CapabilityPlayerDataHandler(){}\n        \n        @Override\n        public NBTBase writeNBT(Capability<ICapabilityPlayerData> capability, ICapabilityPlayerData instance,EnumFacing side) {\n            NBTTagCompound nbt = new NBTTagCompound();\n            nbt.setInteger(\"level\", instance.getLevel());\n            nbt.setString(\"profession\", instance.getProfession());\n            nbt.setString(\"type\", instance.getType());\n            return nbt;\n        }\n\n\n        @Override\n        public void readNBT(Capability<ICapabilityPlayerData> capability, ICapabilityPlayerData instance, EnumFacing side,NBTBase nbt) {\n            if (((NBTTagCompound) nbt).hasKey(\"type\", 8))\n                    instance.setType(((NBTTagCompound) nbt).getString(\"type\"));\n            if (((NBTTagCompound) nbt).hasKey(\"profession\", 8))\n                    instance.setProfession(((NBTTagCompound) nbt).getString(\"profession\"));\n            if (((NBTTagCompound) nbt).hasKey(\"level\", 3))\n                    instance.setLevel(((NBTTagCompound) nbt).getInteger(\"level\"));\n        }\n}\n\nCapabilityPlayerDataProvider：\npublic class CapabilityPlayerDataProvider implements ICapabilitySerializable<NBTTagCompound>{\n        private Entity player;\n        private ICapabilityPlayerData playerCapability = CapabilityPlayerData.INSTANCE.getDefaultInstance();\n\n        public CapabilityPlayerDataProvider(Entity player){\n                this.player = player;\n        }\n        @Override\n        public boolean hasCapability(Capability<?> capability, EnumFacing facing) {\n                return CapabilityPlayerData.INSTANCE != null && capability == CapabilityPlayerData.INSTANCE;\n        }\n        @Override\n        public <T> T getCapability(Capability<T> capability, EnumFacing facing) {\n                if (CapabilityPlayerData.INSTANCE != null && capability == CapabilityPlayerData.INSTANCE) \n                        return (T) new CapabilityPlayerDataDefault();\n                return null;\n        }\n        @Override\n        public NBTTagCompound serializeNBT() {\n                NBTTagCompound nbt = new NBTTagCompound();\n                nbt.setTag(\"playerData\", CapabilityPlayerData.INSTANCE.getStorage().writeNBT(CapabilityPlayerData.INSTANCE, playerCapability, null));\n                return nbt;\n        }\n        @Override\n        public void deserializeNBT(NBTTagCompound nbt) {\n                NBTBase list = nbt.getTag(\"playerData\");\n                CapabilityPlayerData.INSTANCE.getStorage().readNBT(CapabilityPlayerData.INSTANCE, playerCapability, null, list);\n        }\n}\n\nCapabilityPlayerDataEvent：\npublic class CapabilityPlayerDataEvent {\n        @SubscribeEvent\n        public void onTELoad(AttachCapabilitiesEvent.Entity event)\n        {\n                if(!event.getEntity().hasCapability(CapabilityPlayerData.INSTANCE, null) && event.getEntity() instanceof EntityPlayer)\n                        event.addCapability(new ResourceLocation(SOR.MODID+\".PlayerData\"), new CapabilityPlayerDataProvider(event.getEntity()));\n        }\n}\n\n\n\n然后有两个Item，UserBook用来显示玩家信息，CurrencyCommon用来更改等级（无视类名。。。。）\n\nUserBook:\npublic class UserBook extends Item{\n        public static final String ID = \"userBook\";\n        public UserBook() {\n                super();\n                setCreativeTab(SORCreativeTabs.Human);\n                setUnlocalizedName(SOR.MODID+\".\"+ID);\n                setRegistryName(SOR.MODID, ID);\n        }\n        @Override\n        public ActionResult<ItemStack> onItemRightClick(ItemStack itemStackIn, World worldIn, EntityPlayer playerIn, EnumHand hand)\n        {\n                if(!worldIn.isRemote){\n                        if(playerIn.hasCapability(CapabilityPlayerData.INSTANCE, playerIn.getHorizontalFacing())){\n                                ICapabilityPlayerData inv = playerIn.getCapability(CapabilityPlayerData.INSTANCE, null);\n                                playerIn.addChatMessage(new TextComponentTranslation(\"sor.chat.level.name\",inv.getLevel()));\n                                playerIn.addChatMessage(new TextComponentTranslation(\"sor.chat.profession.name\",new                                                                                                           TextComponentTranslation(\"sor.profession.\"+inv.getProfession()+\".name\")));\n                                playerIn.addChatMessage(new TextComponentTranslation(\"sor.chat.type.name\",new                                                                                                                   TextComponentTranslation(\"sor.type.\"+inv.getType()+\".name\")));\n                        }\n                }\n                return new ActionResult(EnumActionResult.SUCCESS, itemStackIn);\n        }\n}\n\n\nCurrencyCommon\npublic class CurrencyCommon extends MultiItem{\n        public static final String ID = \"currencyCommon\";\n        public CurrencyCommon() {\n                super();\n                this.setMaxStackSize(64);\n                this.setCreativeTab(SORCreativeTabs.Human);\n                this.setUnlocalizedName(SOR.MODID+\".\"+ID);\n                this.setRegistryName(SOR.MODID,ID);\n        }\n        @Override\n        public ActionResult<ItemStack> onItemRightClick(ItemStack itemStackIn, World worldIn, EntityPlayer playerIn, EnumHand hand)\n        {\n                if(!worldIn.isRemote){\n                        if(playerIn.hasCapability(CapabilityPlayerData.INSTANCE, playerIn.getHorizontalFacing())){\n                                ICapabilityPlayerData inv = playerIn.getCapability(CapabilityPlayerData.INSTANCE, playerIn.getHorizontalFacing());\n                                int level = inv.getLevel();\n                                inv.setLevel(level+1);\n                                playerIn.addChatMessage(new TextComponentTranslation(\"sor.chat.change.level.name\",inv.getLevel()));\n                        }\n                }\n                return new ActionResult(EnumActionResult.SUCCESS, itemStackIn);\n        }\n\n    。。。。。。（后面是一些无关的代码）\n}\n\n\n\n在游戏里，右键 UserBook 了以后会显示 level 是1，右键 CurrencyCommon 后显示 level 变成2，可是再右键 UserBook 的时候 level 还是 1\n求轻喷。。。。。求大神解释一下。。。\n\n\n",
    "replies": [
        {
            "author": "土球球",
            "timestamp": 1470678120,
            "txt_content": " 本帖最后由 ustc_zzzz 于 2016-8-9 01:51 编辑 \n        @Override\n        public <T> T getCapability(Capability<T> capability, EnumFacing facing) {\n                if (CapabilityPlayerData.INSTANCE != null && capability == CapabilityPlayerData.INSTANCE) \n                        return (T) new CapabilityPlayerDataDefault();\n                return null;\n        }复制代码\n这里不要new一个再返回啊。。。ICapabilitySerializable既然是用来存储数据的，就不要每次获取的时候就生成一个新的数据类，不然每次的数据岂不是重置了= =\n直接返回playerCapability，此外，你这同一个类里的player没有用处，可以直接删了。"
        },
        {
            "author": "hkpxt1588",
            "timestamp": 1470886980,
            "txt_content": "ustc_zzzz 发表于 2016-8-9 01:42\n这里不要new一个再返回啊。。。ICapabilitySerializable既然是用来存储数据的，就不要每次获取的时候就生 ...\n后来发现这个问题了= =，谢谢~"
        }
    ]
}