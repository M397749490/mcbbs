{
    "title": "如何用 Mixin 注入方法？（有特殊要求，见帖内）",
    "author": "sjx",
    "replyCount": 1,
    "timestamp": 1535807940,
    "txt_content": " 本帖最后由 sjx 于 2018-9-2 16:48 编辑 \n\n要求：注入一个方法，使得能在修改变量时得到参数（如果也能得到其他变量就更好）\n原代码：@Mixin(NetHandlerPlayClient.class)\npublic abstract class MixinNetHandlerPlayClient {\n    @Shadow\n    private WorldClient world;\n\n    @ModifyVariable(method = \"handleSpawnObject\", at = @At(value = \"JUMP\", opcode = Opcodes.IFNULL, ordinal = 0), index = 8)\n    private Entity handleSpawnObject(Entity entity) {\n        if (packet /* 如何得到类型为 SPacketSpawnObject 的参数？ */.getType() == 9398272 /* Magic number */) return new EntityTestProjectile(this.world, x, y, z /* 如何得到类型为 double 的局部变量？ */);\n        return entity;\n    }\n}复制代码日常吐槽：Mixin 的官方 Wiki 没写完……\n\nEdit:\n问题已经解决，代码：public class TestModTransformer implements IClassTransformer, Opcodes {\n    private static final Logger logger = LogManager.getLogger();\n    private static final ClassRef CL_NetHandlerPlayClient = new ClassRef(\"cqs\", \"net/minecraft/client/network/NetHandlerPlayClient\");\n    private static final ClassRef CL_SPacketSpawnObject = new ClassRef(\"iz\", \"net/minecraft/network/play/server/SPacketSpawnObject\");\n    private static final FieldRef FD_NetHandlerPlayClient_world = new FieldRef(\"f\", \"world\", \"Lcqv;\", \"Lnet/minecraft/client/multiplayer/WorldClient;\");\n    private static final MethodRef MD_NetHandlerPlayClient_handleSpawnObject = new MethodRef(\"a\", \"handleSpawnObject\", \"(Liz;)V\", \"(Lnet/minecraft/network/play/server/SPacketSpawnObject;)V\");\n    private static final MethodRef MD_SPacketSpawnObject_getType = new MethodRef(\"l\", \"getType\", \"()I\", \"()I\");\n\n    @Override\n    public byte[] transform(String name, String transformedName, byte[] basicClass) {\n        if (basicClass == null) return null;\n        MatchType matchType;\n        if ((matchType = CL_NetHandlerPlayClient.matchType(name)) != null) {\n            boolean succeeded = false;\n            ClassNode clazz = new ClassNode();\n            ClassReader reader = new ClassReader(basicClass);\n            reader.accept(clazz, 0);\n            for (MethodNode method : clazz.methods)\n                if (MD_NetHandlerPlayClient_handleSpawnObject.matchType(method) != null) for (ListIterator<AbstractInsnNode> it = method.instructions.iterator(); it.hasNext();) {\n                    AbstractInsnNode next = it.next();\n                    if (next.getOpcode() == ASTORE && ((VarInsnNode) next).var == 8) {\n                        LabelNode finishLabel = new LabelNode();\n                        it.add(new VarInsnNode(ALOAD, 1));\n                        it.add(new MethodInsnNode(INVOKEVIRTUAL, CL_SPacketSpawnObject.name(matchType), MD_SPacketSpawnObject_getType.name(matchType), MD_SPacketSpawnObject_getType.desc(matchType), false));\n                        it.add(new LdcInsnNode(9398272 /* Magic number */));\n                        it.add(new JumpInsnNode(IF_ICMPNE, finishLabel));\n                        it.add(new TypeInsnNode(NEW, \"com/sjx233/testmod/entity/EntityTestProjectile\"));\n                        it.add(new InsnNode(DUP));\n                        it.add(new VarInsnNode(ALOAD, 0));\n                        it.add(new FieldInsnNode(GETFIELD, name.replace('.', '/'), FD_NetHandlerPlayClient_world.name(matchType), FD_NetHandlerPlayClient_world.desc(matchType)));\n                        it.add(new VarInsnNode(DLOAD, 2));\n                        it.add(new VarInsnNode(DLOAD, 4));\n                        it.add(new VarInsnNode(DLOAD, 6));\n                        it.add(new MethodInsnNode(INVOKESPECIAL, \"com/sjx233/testmod/entity/EntityTestProjectile\", \"<init>\", matchType == MatchType.UNTRANSFORMED ? \"(Laxs;DDD)V\" : \"(Lnet/minecraft/world/World;DDD)V\", false));\n                        it.add(new VarInsnNode(ASTORE, 8));\n                        for (AbstractInsnNode node = next.getNext(); node != null; node = node.getNext())\n                            if (node.getOpcode() == IFNULL) {\n                                for (node = node.getPrevious(); node != null; node = node.getPrevious())\n                                    if (node.getType() == AbstractInsnNode.LABEL) {\n                                        it.add(new JumpInsnNode(GOTO, (LabelNode) node));\n                                        succeeded = true;\n                                        break;\n                                    }\n                                break;\n                            }\n                        it.add(finishLabel);\n                        break;\n                    }\n                }\n            if (!succeeded) {\n                logger.error(\"Failed to transform {}\", name);\n                return basicClass;\n            }\n            ClassWriter writer = new ClassWriter(0);\n            clazz.accept(writer);\n            return writer.toByteArray();\n        }\n        return basicClass;\n    }\n}复制代码（Ref 类已略去）",
    "replies": [
        {
            "author": "gooding300",
            "timestamp": 1535869320,
            "txt_content": " 本帖最后由 gooding300 于 2018-9-2 14:27 编辑 \n\n之前有个人在这里回复了向楼主求助如何在ForgeGradle中配置Mixin相关的内容\n根据版规，相关回复已被删除\n附录#1-13: 如果不懂请勿回复否则将以灌水进行处理；\n附录#1-14: 误导性的、无意义的、过于空泛的、对解决问题无帮助的回复以灌水进行处理。\n关于楼主的问题本身，平时为了达到楼主要求的效果，都是直接注册ClassTransformer使用ASM进行修改，非常抱歉无法解决您的问题。\n"
        }
    ]
}