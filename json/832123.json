{
    "title": "[编程]LaterAgent——无需命令行加载Agent|修改已加载的类[1.7+]",
    "author": "深海鲸鱼座",
    "replyCount": 1,
    "timestamp": 1543507320,
    "txt_content": " 本帖最后由 lj2000lj 于 2018-11-30 04:05 编辑 \n\n_前言\n  该插件是一个前置Api，没有编程经验的服主们可以等其他大佬操作出有意思的插件了\n  本贴中的用语对于刚接触插件开发的开发者可能略有艰深，可以参阅下文列出的参考资料进行学习\n\n  这段时间各种黑科技频繁出没，某P的某V，某U的某M，我一寻思是时候来点有意思的操作了【然而对于一般服主来说没什么用，对于开发者或许能方便些……\n  \n  简而言之，该插件通过调用于Java 6时（是个古董）就已经存在的Api(Instrumentation)做到在不修改服务器命令行的前提下，动态的加载Java Agent从而对已加载/未加载的Java类进行修改\n\n  有关该Api(Instrumentation)，请参见：\n  https://www.ibm.com/developerworks/cn/java/j-lo-jse61/index.html\n\n\n  由于技术限制，目前无法对已经加载的类添加或删除方法或变量\n\n\n  【这插件本来是想着自用的，不过一琢磨发出来也没啥关系，反正就一破烂轮子【笑】\n\n\n_Api\nAgentApi.register(transformer, true, true);\n// 以上代码将transformer添加至Jre提供的Instrumentation实例以便后续进行transform，并且允许该transformer重复进行transform，在这之后立即对所有已加载的类重新进行一次transform\npublic static void register(ClassFileTransformer transformer, boolean canRetransform, boolean doRetransform)\n// 以上是该方法的声明\n\n// 例程：\npackage cn.apisium.demo;\n\nimport java.lang.instrument.ClassFileTransformer;\nimport java.lang.instrument.IllegalClassFormatException;\nimport java.security.ProtectionDomain;\n\nimport org.bukkit.plugin.java.JavaPlugin;\n\nimport cn.apisium.lateragent.AgentApi;\n\npublic class Main extends JavaPlugin implements ClassFileTransformer {\n        @Override\n        public void onEnable() {\n                getLogger().info(\"Demo\");\n                AgentApi.register(this, true, true);\n                // 以上代码将transformer添加至Jre提供的Instrumentation实例以便后续进行transform，并且允许该transformer重复进行transform，在这之后立即对所有已加载的类重新进行一次transform\n        }\n\n        @Override\n        public byte[] transform(ClassLoader loader, String className, Class<?> classBeingRedefined,\n                        ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {\n                System.out.println(className);\n                // 这一行用于调试，将会输出当前进行transform的类的名字\n                \n                // 您可以在这里添加您的代码\n                                \n                return null;\n                // 返回值是该类的字节码，如不进行修改可以返回null\n        }\n}\n\n复制代码\n\n  除此之外，您需要在plugin.yml中添加一些参数\n\ndepend: [LaterAgent]\nload: STARTUP\n复制代码\ndepend参数不必多说，是将本插件作为前置插件使用\nload参数确保您的插件会在大部分插件与服务端的类加载以前进行加载，从而减少需要重新进行transform的类的数量\n\n_截图/命令/配置\n  作为一个前置Api，该插件并没有截图/命令/配置\n\n_下载\n\n\n\nLaterAgent-all_shrunken.jar\n(509.88 KB, 下载次数: 19)\n\n\n\n2018-11-30 00:01 上传\n点击文件名下载附件\n\n\n\n\n\n\n\n_声明/参考资料/部分源码出处\n  本插件为非盈利性插件，免费发布，严禁销售和转卖\n  部分插件源码来自开源项目https://github.com/Xyene/ASM-Late-Bind-Agent 以及 Jdk 8 中的tools.jar\n\n\n\n",
    "replies": [
        {
            "author": "Akkariin",
            "timestamp": 1543516080,
            "txt_content": "♂鲸又出新作品了！\nmark，以后可能要用到"
        }
    ]
}