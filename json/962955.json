{
    "title": "关于forge1.12.2中SimpleImpl数据同步的一点小问题",
    "author": "zxcvbnm156",
    "replyCount": 2,
    "timestamp": 1582013760,
    "txt_content": " 本帖最后由 zxcvbnm156 于 2020-2-18 16:19 编辑 \n\n大佬们虽然文字有点多，但是脉络很清晰，希望大家能帮我看下\n我的forge版本是1.12.2\n首先我为玩家添加了能储存金币数量的能力系统。然后想在打开玩家背包栏的时候在界面上绘制一段文字显示玩家的金币。我的实现思路是这样子的：@SideOnly(Side.CLIENT)\n@SubscribeEvent\npublic static void onRenderGuiScreen(GuiOpenEvent event)\n{\n    if(event.getGui() instanceof GuiInventory)\n    {\n        event.setCanceled(true);\n        Minecraft.getMinecraft().displayGuiScreen(new FantasyValleyInventory(Minecraft.getMinecraft().player));\n        SimpleNetworkWrapperLoader.simpleNetworkWrapper.sendToServer(new GetMoneyRequest());\n        IMoneyStorage capability=Minecraft.getMinecraft().player.getCapability(CapabilitiesLoader.moneyStorage,null);\n        Minecraft.getMinecraft().fontRenderer.drawString(\"当前金币:\",0,0,0xFFFFFFFF);\n    }\n}首先我在客户端监听玩家打开背包的事件，if里面前两句代码是我截断了游戏自带的背包界面然后自己重绘了一个，可以别管它。然后第三句我向服务器发送了一个new GetMoneyRequest()，这个GetMoneyRequest的实现代码是这样子的：\npublic class GetMoneyRequest implements IMessage\n{\n    public GetMoneyRequest(){}\n    @Override\n    public void fromBytes(ByteBuf buf)\n    {\n    }\n    @Override\n    public void toBytes(ByteBuf buf)\n    {\n    }\n}\n它是空的，因为我只是用来提醒服务器要返回玩家金币，所以发送了一个空包。\n之后便是服务器处理这个包的类：\npublic class ServerMessageHandler implements IMessageHandler<GetMoneyRequest,MoneyInfo>\n{\n    @Override\n    public MoneyInfo onMessage(GetMoneyRequest message, MessageContext ctx)\n    {\n        EntityPlayerMP player=ctx.getServerHandler().player;\n        IMoneyStorage capability=player.getCapability(CapabilitiesLoader.moneyStorage,null);\n        return new MoneyInfo(capability.getCoin(),capability.getTicket());\n    }\n}\n代码很简单，前两句是为了获取服务端玩家的金钱储存能力系统\n然后第三句利用能力系统里面getCoin(),getTicket()两个接口返回的数据（分别代表金币，点券）new一个新的Message然后Return给客户端\n这里的MoneyInfo具体实现是这样的（因为图片数量受限我就直接发文字代码了）：\npublic class MoneyInfo implements IMessage\n{\n    public MoneyInfo(){}\n    public int coin;\n    public int ticket;\n    public MoneyInfo(int coin, int ticket)\n    {\n        this.coin=coin;\n        this.ticket=ticket;\n    }\n    @Override\n    public void fromBytes(ByteBuf buf)\n    {\n        buf.writeInt(coin);\n        buf.writeInt(ticket);\n    }\n\n    @Override\n    public void toBytes(ByteBuf buf)\n    {\n        coin=buf.readInt();\n        ticket=buf.readInt();\n    }\n}\n\n这个类也很简单，就是存了金币和点券的数据\n之后我在客户端又写了一个处理这个返回的数据包的类，具体的实现是这样的：\npublic class ClientMessageHandler implements IMessageHandler<MoneyInfo, IMessage>\n{\n    public ClientMessageHandler(){}\n    @Override\n    public IMessage onMessage(MoneyInfo message, MessageContext ctx)\n    {\n        int coin=message.coin;\n        int ticket=message.ticket;\n        Minecraft.getMinecraft().addScheduledTask(()->{\n            EntityPlayerSP player= Minecraft.getMinecraft().player;\n            IMoneyStorage capability=player.getCapability(CapabilitiesLoader.moneyStorage,null);\n            capability.setCoin(coin);\n            capability.setTicket(ticket);});\n        return null;\n    }\n}\n也很简单，就是先获取客户端玩家的能力系统，然后把返回过来的数据利用能力系统setCoin()和setTicket()两个接口填写到能力系统里面。\n最后就是回到这里：\n@SideOnly(Side.CLIENT)\n@SubscribeEvent\npublic static void onRenderGuiScreen(GuiOpenEvent event)\n{\n    if(event.getGui() instanceof GuiInventory)\n    {\n        event.setCanceled(true);\n        Minecraft.getMinecraft().displayGuiScreen(new FantasyValleyInventory(Minecraft.getMinecraft().player));\n        SimpleNetworkWrapperLoader.simpleNetworkWrapper.sendToServer(new GetMoneyRequest());\n        IMoneyStorage capability=Minecraft.getMinecraft().player.getCapability(CapabilitiesLoader.moneyStorage,null);\n        Minecraft.getMinecraft().fontRenderer.drawString(\"当前金币:\",0,0,0xFFFFFFFF);\n    }\n}\n因为刚才已经把数据加载到本地了，所以if里面第四第五句代码就是把本地能力系统里面的数据绘制到游戏界面上。最后就是我注册SimpleNetworkWrapper的代码：\npublic class SimpleNetworkWrapperLoader\n{\n    int ID=0;\n    public static final SimpleNetworkWrapper simpleNetworkWrapper = NetworkRegistry.INSTANCE.newSimpleChannel(FantasyValley.MODID);\n    public SimpleNetworkWrapperLoader()\n    {\n        simpleNetworkWrapper.registerMessage(ClientMessageHandler.class, MoneyInfo.class,ID++, Side.CLIENT);\n        simpleNetworkWrapper.registerMessage(ServerMessageHandler.class,GetMoneyRequest.class,ID++,Side.SERVER);\n    }\n}以上就是我的实现思路，但是我进入游戏后打开背包后游戏就崩溃了，然后弹出那个背景是泥土的画面，上面写着这么一句话（因为图片上传数量受限，就直接码字了）：\n连接已丢失\nA fatal error has occurred, this connection is terminated\n然后IDEA的控制台里面弹了这么一串红色文字：\nCaused by:java.lang.IndexOutOfBoundsException: readerIndex(0)+length(4) exceeds writerIndex(1): UnpooledByteBufAllocator$InstrumentedUnpooledUnsafeHeapByteBuf(ridx:0,widx:1,cap:256)\n我知道是越界错误，可是我实在没看出我的代码里面哪里涉及到越界了。代码肯定是客户端给服务端发数据包那一句引发的，我测试过了，因为注释掉那句就能正常运行了。希望大家能帮帮我，太感谢了。\n\n\n\n\n",
    "replies": [
        {
            "author": "zwtll",
            "timestamp": 1582614240,
            "txt_content": "老哥，我也是发包的时候跟你一模一样的报错，如果你解决了请帮帮我，谢谢！"
        },
        {
            "author": "zxcvbnm156",
            "timestamp": 1582794000,
            "txt_content": "zwtll 发表于 2020-2-25 15:04\n老哥，我也是发包的时候跟你一模一样的报错，如果你解决了请帮帮我，谢谢！ ...\n我解决了，你需要帮助的话把QQ私发给我，我加你帮你看看"
        }
    ]
}