{
    "title": "[1.15+][原版]系统卡顿的原因可能有哪些？",
    "author": "tineseack_bk",
    "replyCount": 7,
    "timestamp": 1586140980,
    "txt_content": " 本帖最后由 tineseack_bk 于 2020-4-6 10:47 编辑 \n\n    是这样，最近在做一个海战类型的图，主要玩法就是玩家操控一个舰艇单位（一堆实体堆砌而成），需要用到一些对舰艇单位的高频操作，包括但不限于一些调用 nbt 转化为分数的计算。单人测试下系统流畅运行，但是放到服务器中就会出现一定的跳 tick 现象。因为我对服务端的卡顿原因了解甚少，做优化也暂时没有大方向，故想了解一些各位的作图经验……下面这里对问题进行一些简述：\n每个单位是由几个盔甲架套模型 + 若干个生物实体作为 hitbox 来检测炮弹击中，每个单位涉及到大约 10 个实体。对这些实体的操作有：\n高频 tp，确保它们相对于一个核心盔甲架是静止的；对一个核心盔甲架高频执行运动模块，通过 execute store 把分数转化为 Motion对上面这个核心盔甲架执行转向模块，思路是：检测玩家和这个盔甲架的视角，做差，然后通过 tp 逐步减少视角差，当视角差小于某个值时停止 tp，即达到 “让盔甲架视角缓慢向玩家靠齐” 的效果；对若干个炮塔盔甲架也执行这样的转向模块，预计每艘船的炮塔在 3-5 个不等。\n\n\n由于是地图，我把不同玩家和对应的船编号，然后通过穷举来确保一些操作的精确性，这就还有可能出现运算量叠加的情况。\n\n\n    我在服务器自行测试了一下，推测应该是这个转向的模块计算量比较大导致跳 tick。随后我 functioon #minecraft:tick 得到的返回值是执行了 800+ 条命令，而且是在仅有一条船的情况下。我并不清楚什么样的命令执行量会对服务端造成比较大的负荷。我也猜测问题出在选择器上的可能比较大。\n\n\n    可能问题有些模糊，我现在主要是不太清楚为什么服务器会开始跳 tick 这些（客户端并没有卡顿），如果各位有类似的作图经验能提供一下感激不尽！\n\n（参考过这个贴子的内容 https://www.mcbbs.net/forum.php?mod=viewthread&tid=994402&page=1&authorid=2742718 对选择器进行了一定程度的优化，然而成效还是不大。）",
    "replies": [
        {
            "author": "理智反迷你",
            "timestamp": 1586143500,
            "txt_content": "安装个optifine\n用fabric和optfabric"
        },
        {
            "author": "chyx",
            "timestamp": 1586144700,
            "txt_content": "你检查炮弹击中是怎么写的？\n检测玩家和这个盔甲架的视角，做差\n这一步又是怎么写的？"
        },
        {
            "author": "tineseack_bk",
            "timestamp": 1586148780,
            "txt_content": " 本帖最后由 tineseack_bk 于 2020-4-6 12:56 编辑 \nchyx 发表于 2020-4-6 11:45\n你检查炮弹击中是怎么写的？\n\n这一步又是怎么写的？\n1.检测炮弹击中是直接抓 HurtTime:9s 的实体，因为需要判定击中了船的哪个部位\n\n2.视角是：高频执行这个：\n\n# 获取玩家朝向\n# 这两个 tag 只是用来选择操控中的玩家\nexecute as @a[tag=inGame,tag=mod_movement] store result score @s RotationX run data get entity @s Rotation[0] 100000\n\n# 特性补偿：强行把玩家朝向范围卡死在 [-180, 180]        \nexecute as @a[scores={RotationX=18000001..},tag=inGame,tag=mod_movement] at @s run scoreboard players operation @s RotationX -= 36000000 Const\nexecute as @a[scores={RotationX=..-18000001},tag=inGame,tag=mod_movement] at @s run scoreboard players operation @s RotationX += 36000000 Const\n\n# 获取 vessel 朝向\n# 这个 vessel 就是运动核心盔甲架\nexecute as @e[type=armor_stand,tag=vessel,tag=core] at @s store result score @s RotationX run data get entity @s Rotation[0] 100000\n\n# 记录朝向差值\nscoreboard players reset * RotationXT\n\nexecute as @e[type=armor_stand,tag=vessel,tag=core] at @s if entity @p[distance=..5,tag=mod_movement,tag=!observing] run scoreboard players operation @s RotationXT = @s RotationX\nexecute as @e[type=armor_stand,tag=vessel,tag=core] at @s run scoreboard players operation @s RotationXT -= @p[distance=..5,tag=mod_movement,tag=!observing] RotationX\n\n# X: 若差值在 1 到 180 度之间，或小于 -180 度，则逆时针转\n# X: 若差值在 -180 到 -1 度之间，或大于 180 度，则顺时针转\n# accel 分数代表挡位，-1 到 3，这里只列出 1\n        execute as @e[type=armor_stand,tag=vessel,tag=core,scores={accel=1}] at @s run function movement:exe_of_accel/accel1\n\n\n\n\nmovement:exe_of_accel/accel1：\n\n# accel: 1\n# 转向\nexecute as @e[type=armor_stand,tag=vessel,tag=core,scores={RotationXT=10..18000000,accel=1}] at @s run tp @s ~ ~ ~ ~-0.5 ~\nexecute as @e[type=armor_stand,tag=vessel,tag=core,scores={RotationXT=-18000000..-10,accel=1}] at @s run tp @s ~ ~ ~ ~0.5 ~\nexecute as @e[type=armor_stand,tag=vessel,tag=core,scores={RotationXT=18000000..,accel=1}] at @s run tp @s ~ ~ ~ ~0.5 ~\nexecute as @e[type=armor_stand,tag=vessel,tag=core,scores={RotationXT=..-18000000,accel=1}] at @s run tp @s ~ ~ ~ ~-0.5 ~\n\n"
        },
        {
            "author": "理智反迷你",
            "timestamp": 1586156520,
            "txt_content": "安装优化mod"
        },
        {
            "author": "Derp的咸鱼",
            "timestamp": 1586257740,
            "txt_content": "安装卡服优化插件，bbs里面就有的"
        },
        {
            "author": "晴路卡",
            "timestamp": 1586263500,
            "txt_content": "晴路卡发现没有自己能回答的帖子了\n所以来到了这里\n\n没人能救你了，金粒能给我吗？\n\n（一天"
        },
        {
            "author": "pengyuyan",
            "timestamp": 1586266380,
            "txt_content": "掉落物定时清理\n经常清除缓存"
        }
    ]
}