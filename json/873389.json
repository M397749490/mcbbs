{
    "title": "没事研究了一下多个经济插件实现跨服经济",
    "author": "Sidoupiar",
    "replyCount": 0,
    "timestamp": 1560539460,
    "txt_content": " 本帖最后由 Sidoupiar 于 2019-6-15 03:15 编辑 \n\n事情的起因是这样的，前段时间突然想搞服务器，那既然搞就要搞群组服，不仅群组服还要多版本。于是问题就来了，各种版本的服务端塞在一起，首当其冲的就是跨服问题。其他的问题还好，这跨服经济就麻烦了。\n为啥麻烦呢？首先，sponge服，选用了Nucleus当基础插件，然而Nucleus点名要求（建议的）使用EconomyLite作为经济插件（建议的另一个经济插件TotalEconomy我没能启动成功，所以先暂时不考虑）。一般跨服经济是需要用数据库的，我就给EconomyLite配好了mysql数据库。然后去找spigot端的经济插件，首先想到的就是iConomy，然而实际测试之后发现不妥。EconomyLite和iConomy的数据格式根本就不一样啊，EconomyLite使用的uuid里识别玩家的，iConomy直接用了玩家的名字（name），数据除了余额以外没有一个一样的，这就尴尬了，表名也不一样，这根本凑不到一起啊。没有办法，我就去找了一个通用的经济插件，大概找了一下，emmm，竟然没有！这就麻烦了。只能硬着头皮凑了。还是因为Nucleus点名（建议）要求使用EconomyLite作为经济插件，又加上spigot上面的插件多，所以我先去找的spigot的插件。然后随便找了一个高版本的经济插件（真的是随便找了个），叫GemsEconomy。弄好mysql，运行了一波发现，GemsEconomy的数据完全覆盖了EconomyLite的数据，看似可行。然而……GemsEconomy把数据分在了三个表里，而EconomyLite只有一个表（这里指的是存储玩家数据的表，EconomyLite还有一个表存储不是玩家的余额的表），还是凑不到一起。这时候就要搞神奇的操作了——头铁凑视图……因为mysql里面，视图可以update……而且mysql里面，查询表和查询视图的语句一模一样（这里我是估计的插件用的SQL语句）……又想到之前看iConomy的处理方式，是随用随存取的，数据库同步更新，这些插件估计也是……如果是群组服的话，一般都是spigot当做登录服务器，然后跳转到sponge服务器。所以，玩家数据会先由GemsEconomy创建完毕，EconomyLite不会参与创建数据，也不会导致数据缺失……然后就是我实际测试中，群组服中所有服务器的玩家的uuid是相同的，不同服务器使用uuid也不会乱掉（这让我想起了当年用白名单的时候玩家的uuid死活对不上的问题）……所以，看起来，视图貌似可行……说那么多没有用，能做到才是真的。\n于是乎我分析了一下这俩插件的数据结构，随便写了个视图：CREATE VIEW ECONOMYLITEPLAYERS AS SELECT\n  A.UUID AS UUID,\n  B.BALANCE AS BALANCE,\n  CONCAT(\n    'economylite:',\n    C.NAME_PLURAL\n  ) AS CURRENCY\nFROM\n  GEMS_ACCOUNTS A,\n  GEMS_BALANCES B,\n  GEMS_CURRENCIES C\nWHERE\n  A.UUID = B.ACCOUNT_ID\nAND B.CURRENCY_ID = C.UUID;复制代码其中`ECONOMYLITEPLAYERS`是EconomyLite插件中存储玩家余额的数据库表的表名，下面FROM的三个表是GemsEconomy中存储玩家余额的表。`CURRENCY`字段拼了一下字符串，原因很简单，GemsEconomy和EconomyLite两个插件都有一个属性，叫做货币，既然跨服，货币自然是一致的，但是，我测试的时候发现，他们存进去的格式并不一样的，假如说你把货币符号设置为M，GemsEconomy的数据里面存储的货币符号就是M，而EconomyLite的数据里面存储的货币符号是“economylite:m”，没错，不仅加了一堆字符，还变成了小写。所以我写视图的时候就在GemsEconomy的数据中的货币符号前面增加了EconomyLite特有的一串字符串。注意：这里我并没有在视图中增加小写转换，因为我认为小写更加稳妥，所以我的货币符号就弄成了小写的字母，所以就不用转换了，也会节省一些数据库的性能（大概）。（加了小写转换的见下）另外我不确定用符号或者汉字做货币等情况会不会兼容，实际中我用不到，所以我也没有试过，有兴趣的可以自行研究。CREATE VIEW ECONOMYLITEPLAYERS AS SELECT\n  A.UUID AS UUID,\n  B.BALANCE AS BALANCE,\n  CONCAT(\n    'economylite:',\n    LOWER( C.NAME_PLURAL )\n  ) AS CURRENCY\nFROM\n  GEMS_ACCOUNTS A,\n  GEMS_BALANCES B,\n  GEMS_CURRENCIES C\nWHERE\n  A.UUID = B.ACCOUNT_ID\nAND B.CURRENCY_ID = C.UUID;复制代码\n在创建视图之前，我先把EconomyLite原来的数据表删了，然后创建视图。启动服务端，一测试，好像真的可以。\n于是乎iConomy就可以凉凉了。话说iConomy在1.13服务端上还有问题，一部分功能用不了，主要指在线发钱的功能。没事就报个错，总是给人摇摇欲坠的感觉（大误）。后来服务端运行了有一段时间，并没有出现什么问题。所以我觉得还可行，就发出来分享一下。\n其余的就没有什么了，由于GemsEconomy和EconomyLite并不是一目了然的数据结构，所以你甚至可以写一个视图用来方便地查看玩家余。CREATE VIEW ECONOMY AS SELECT\n  A.UUID AS UUID,\n  A.NICKNAME AS NICKNAME,\n  B.BALANCE AS BALANCE,\n  C.NAME_PLURAL AS CURRENCY\nFROM\n  GEMS_ACCOUNTS A,\n  GEMS_BALANCES B,\n  GEMS_CURRENCIES C\nWHERE\n  A.UUID = B.ACCOUNT_ID\nAND B.CURRENCY_ID = C.UUID;复制代码\n最后还是那句话，毕竟这么做多少还是会有风险的。所以有条件的话，尽可能采用一套（系列）的经济插件比较稳妥。\n",
    "replies": []
}