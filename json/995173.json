{
    "title": "[原创][安全] NukkitProtocolPatch —— 让您的服务器免于协议层攻击[全版本]",
    "author": "wujipohh",
    "replyCount": 6,
    "timestamp": 1584990600,
    "txt_content": " 本帖最后由 PQguanfang 于 2020-3-24 09:46 编辑 \n\nProtocolPatchW系列 | 交流群: 807182388更新时间：2020年3月24日 (具体以 Github 最新 Commit 为准)\n* 简介：\n    * Nukkit-ProtocolPatch 是 Nukkit 协议层补丁, 用于防御协议层内存溢出攻击 (远程崩服), 保障您的服务器稳定运行\n注意：Nukkit-ProtocolPatch 使用 GPLv3 协议进行授权, 进行二次开发必须开源, 禁止非授权转载.\n* 功能：\n    * 修改 Nukkit 原有数据包编码器, 检测预创建数组大小是否合法. 不合法的数据包将不再进行解码直接丢弃.\nREADMENukkit-ProtocolPatchNukkit protocol will be crashed by remote让您的服务器免于协议层攻击，保障您的服务器稳定运行。\n\n最近有很多服务器来反馈, 用了 xxx 插件导致服务器一直崩溃, 控制台截图如下\n\n\n\n\nfile_1584989239000.jpg (92.31 KB, 下载次数: 0)\n\n下载附件\n\n2020-3-24 02:47 上传\n\n\n\n\n这便就是很明显的远程攻击了.\n\n\n\n实例  我们使用 Nukkit 提供的 mcbedrock-protocol 利用 InventoryTransactionPacket 中的内存溢出漏洞实现了一个 Nukkit-Crasher 远程崩服器\n\n\n\n\n\nimage.png (234.1 KB, 下载次数: 0)\n\n下载附件\n\n2020-3-24 02:40 上传\n\n\n\n\n\n图中可以看到, 图中的数组创建的内存预分配大小没有经过检查\n我们可以构造一个 Int.MAX_VALUE 以此达到内存溢出崩溃的目的\n\n\n\n\n\n\n\nimage.png (158.34 KB, 下载次数: 0)\n\n下载附件\n\n2020-3-24 02:42 上传\n\n\n\n\n\n\n可以看到,  VarInt 写入两个 IntMAX 即可\n\n\n\n\n\nimage.png (127.98 KB, 下载次数: 0)\n\n下载附件\n\n2020-3-24 02:48 上传\n\n\n\n\n\n\n启动一个本地测试 Nukkit 服务器\n\n\n\n\n\n\n\nimage.png (167.85 KB, 下载次数: 0)\n\n下载附件\n\n2020-3-24 02:50 上传\n\n\n\n\n\n\n启动写好的 Nukkit-Crasher\n\n\n\n\n\n\n\nimage.png (133.29 KB, 下载次数: 0)\n\n下载附件\n\n2020-3-24 02:51 上传\n\n\n\n\n\n服务器崩溃, 大致意思就是, 数据包在解码过程中出现异常, 并且内存直接超过 JVM 限制我们启用 Nukkit-ProtocolPatch\n\n\n\n\nimage.png (49.58 KB, 下载次数: 0)\n\n下载附件\n\n2020-3-24 02:53 上传\n\n\n\n\n打开 Nukkit-Crasher\n\n\n\n\nfile_1584989723000.jpg (32.86 KB, 下载次数: 0)\n\n下载附件\n\n2020-3-24 02:55 上传\n\n\n\n\n长时间发包没有任何崩溃的迹象不像当初有明显的, 直接连接超时的特征\n\n\n\n\nimage.png (308.18 KB, 下载次数: 0)\n\n下载附件\n\n2020-3-24 02:56 上传\n\n\n\n\n查看后台, Nukkit-ProtocolPatch 成功拦截了所有违规数据包并且我们可以看到下面造成的大量垃圾连接服务器稳定运行没有崩溃更新记录1.0.0 插件完成\n\n最新版本\n\n\n\nNPP.jar\n(15.68 KB, 下载次数: 222)\n\n\n\n2020-3-24 02:58 上传\n点击文件名下载附件\n1.0.0\n\n\n\n\n\n后记接到用户反馈,到发现问题, 到最后修复, 最后的修复Patch的代码量虽然不多, 但在此期间我们耗费了大量的时间阅读 Nukkit 几乎全部协议层源码将近120个包和使用 NukkitX 的 bedrock-protocol 验证我们的猜想, 修复不易, 希望能得到不错的奖励\n\n安装*安装插件\n    * 丢入你的Plugins文件夹, 没有任何依赖 。\n    * 详细: 如何安装 图文教程 (虽然是 EasyAPI 的, Nukkit-ProtocolPatch 同样使用了 Github Action 自动构建)\n",
    "replies": [
        {
            "author": "果子狸大人",
            "timestamp": 1585012980,
            "txt_content": "你可算填坑了"
        },
        {
            "author": "Latical",
            "timestamp": 1585024560,
            "txt_content": "怪不得最近总是崩服, 终于可以修复了"
        },
        {
            "author": "Cymainey",
            "timestamp": 1585065120,
            "txt_content": "每一次崩服玩家数据都会消失，服了"
        },
        {
            "author": "Nyan-Cat",
            "timestamp": 1585362600,
            "txt_content": "这插件太棒了"
        },
        {
            "author": "TONYCOCOLAA",
            "timestamp": 1585627260,
            "txt_content": "吹爆！i了啊最近服务器老是被协议搞崩"
        },
        {
            "author": "2416632107",
            "timestamp": 1585753560,
            "txt_content": "感谢楼主的分享"
        }
    ]
}