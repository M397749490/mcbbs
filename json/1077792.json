{
    "title": "PVPIN教程RL--如何获取Bukkit插件的JavaPlugin主类实例",
    "author": "William_Shi",
    "replyCount": 2,
    "timestamp": 1594650480,
    "txt_content": "\n那些不会Java的新手们，你们是不是还在为\n不在主类里就无法使用getConfig、不在主类里就无法使用getLogger\n这样的问题而苦恼？那么你们应该看一看这篇教程！\n\n和我一样在编程开发区长期回复Bukkit开发相关问题的开发者们\n有没有在看到各种获取不到主类实例问题时感到崩溃？\n除了“去学Java！”无话可说？\n\n快来看看这篇教程！\n\n首先，请先理解一个基本知识点：\n插件加载之后，主类有且仅有一个实例。\n道理非常简单，如果有多个实例，势必导致onEnable多次被调用\n那么任务调度、事件监听都会被重复注册\n这会带来不可预知的非常非常非常严重的冲突！\n我们所有通过ClassLoader强行创造主类实例的各种方法全部都是开玩笑！\n除非你很有把握且经过深思熟虑，否则不要自己新建主类的实例！\n而且我也不认为有什么常见的使用场景会需要多个主类实例的！\n至于主类是如何只有一个实例的，JavaPlugin（也就是主类继承的那个类）\n通过使用PluginClassLoader加载主类限制主类拥有多个实例\n具体的单例化实现方法没什么太大必要去理解，懂的都会自己去看底层\n \n  public JavaPlugin() {\n    ClassLoader classLoader = getClass().getClassLoader();\n    if (!(classLoader instanceof PluginClassLoader))\n      throw new IllegalStateException(\"JavaPlugin requires \" + PluginClassLoader.class.getName()); \n    ((PluginClassLoader)classLoader).initialize(this);\n  }\n  \n  protected JavaPlugin(@NotNull JavaPluginLoader loader, @NotNull PluginDescriptionFile description, @NotNull File dataFolder, @NotNull File file) {\n    ClassLoader classLoader = getClass().getClassLoader();\n    if (classLoader instanceof PluginClassLoader)\n      throw new IllegalStateException(\"Cannot use initialization constructor at runtime\"); \n    init(loader, loader.server, description, dataFolder, file, classLoader);\n  }\n  复制代码\n就是里面的if (!(classLoader instanceof PluginClassLoader))这段逻辑进行了强制的判断\n而且类加载器还有\n \n if (this.plugin != null || this.pluginInit != null)\n      throw new IllegalArgumentException(\"Plugin already initialized!\", this.pluginState); \n复制代码\n防止重复加载主类的实例\n\n重点知识总结如下：\n1.同一个插件有且仅有一个主类的实例\n2.自己不要新建主类实例（例如new Main() )\n\n正题：如何获取主类实例？\n\n第一种方法：静态变量储存主类实例\n静态变量是什么？上网搜索你可以得到很多相关的解释\n简单地认为，任何地方调用这个静态变量会得到同一个值，它独立于类的实例而存在\n那么主类有且仅有一个实例\n此时我们就可以在主类直接声明一个静态变量\n那么这个静态变量储存了类的那一个唯一的实例\n当在onEnable里把这唯一的实例赋值给这一变量的时候\n这个变量就存储了那个实例且保持不变\n\n\n        public static JavaPlugin plugin;\n\n        @Override\n           public void onEnable() {\n                plugin = this;\n        }\n复制代码\n其他类里面通过 Main.plugin 就可以得到实例了（Main是主类名字，你可以改成自己的）\n比如说Main.plugin.getLogger()\n\n第二种方法：PluginManager获取\n既然Bukkit本身能知道你的插件是不是被重复加载\n并且在你试着自己new一个主类实例时抛出异常\n（其他还有大量例证不一一举出）\n那么Bukkit一定存储了你的主类的实例\n该怎么访问呢？\nhttps://bukkit.windit.net/javado ... n-java.lang.String-\n这样就可以通过你在plugin.yml里写的name，插件的名字来得到主类实例\n比如说Bukkit.getPluginManager().getPlugin(\"PVPINDemoRL\")\n\n第三种方法：JavaPlugin静态方法直接获取\n\n  @NotNull\n  public static <T extends JavaPlugin> T getPlugin(@NotNull Class<T> clazz) {\n    Validate.notNull(clazz, \"Null class cannot have a plugin\");\n    if (!JavaPlugin.class.isAssignableFrom(clazz))\n      throw new IllegalArgumentException(clazz + \" does not extend \" + JavaPlugin.class); \n    ClassLoader cl = clazz.getClassLoader();\n    if (!(cl instanceof PluginClassLoader))\n      throw new IllegalArgumentException(clazz + \" is not initialized by \" + PluginClassLoader.class); \n    JavaPlugin plugin = ((PluginClassLoader)cl).plugin;\n    if (plugin == null)\n      throw new IllegalStateException(\"Cannot get plugin for \" + clazz + \" from a static initializer\"); \n    return clazz.cast(plugin);\n  }复制代码\n对于新手可能难以理解，看不懂的没有关系\n具体使用方法在https://bukkit.windit.net/javado ... in-java.lang.Class-\n传入的参数是主类这个类本身\n还有一个https://bukkit.windit.net/javado ... in-java.lang.Class-\n但是要求这个类的类加载器必须是PluginClassLoader才可以访问到主类实例\n\n第四种方法：构造函数\n构造函数法可能不是很方便，演示尤其麻烦，我很怕有人不会Java，改了改类名就和我说代码用不了\n基本上来说就是你可以在某个类里写一个变量存储主类的实例\n这个变量何处赋值？使用构造器\n但是构造器的名称与类的名称相同，因此不同名的类有不同的构造器名\n而且涉及到了实例变量，这就导致演示很麻烦\n我比较建议采取前三种方法\n\n在这四种方法当中：\n我最喜欢使用第二种\n很多开发者使用第一种\n有一些大佬喜欢使用第三种\n",
    "replies": [
        {
            "author": "dousha0v0",
            "timestamp": 1595196600,
            "txt_content": "楼主很走心哈，给了我很多开发灵感，希望你能够坚持把pvpin教程出下去。"
        },
        {
            "author": "William_Shi",
            "timestamp": 1595206800,
            "txt_content": "dousha0v0 发表于 2020-7-20 06:10\n楼主很走心哈，给了我很多开发灵感，希望你能够坚持把pvpin教程出下去。 ...\n感谢支持，欢迎在索引里提出你想要看的教程主题哈，我教程分篇略多不一定一一看到，索引里回复我都看的，想让我写什么都可以说"
        }
    ]
}