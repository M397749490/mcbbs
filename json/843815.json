{
    "title": "sponge插件这代码有什么问题吗？",
    "author": "453299227",
    "replyCount": 2,
    "timestamp": 1549720320,
    "txt_content": "\nTreeMap<Player, Double> map = new TreeMap<Player, Double>();\nmap.put(who,一个double参数);\n为什么后台就报错了\n[21:46:45] [Server thread/INFO] [nucleus]: Mi_LinX ran the command: /login 123123\n[21:46:47] [Server thread/INFO] [STDOUT]: [com.milin.Main.ExampleListener:onSomeEvent:19]: 检测成功....Cause[{Name=Source, Object={EntityPlayerMP['Mi_LinX'/1009, l='world', x=3118.51, y=147.13, z=4085.83]}}, {Name=HitTarget, Object={SpongeBlockSnapshot{worldUniqueId=00000000-0000-0000-0000-000000000000, position=(0, 0, 0), blockState=minecraft:air, extendedState=minecraft:air}}}]\n[21:46:47] [Server thread/INFO] [STDOUT]: [com.milin.Main.ExampleListener:onSomeEvent:27]: 计算结果....10.918098681860197\n[21:46:47] [Server thread/ERROR] [Sponge]: Could not pass InteractItemEvent$Secondary$MainHand$Impl to Plugin{id=znz, name=znz, version=0.1, source=G:\\服务器备份\\Sponge-1.10.2\\mods\\test-0.0.1-SNAPSHOT.jar}\njava.lang.ClassCastException: net.minecraft.entity.player.EntityPlayerMP cannot be cast to java.lang.Comparable\n        at java.util.TreeMap.compare(Unknown Source) ~[?:1.8.0_181]\n        at java.util.TreeMap.put(Unknown Source) ~[?:1.8.0_181]\n        at com.milin.Main.ExampleListener.onSomeEvent(ExampleListener.java:28) ~[ExampleListener.class:?]\n        at org.spongepowered.common.event.listener.SecondaryListener_ExampleListener_onSomeEvent127.handle(Unknown Source) ~[?:?]\n        at org.spongepowered.common.event.RegisteredListener.handle(RegisteredListener.java:95) ~[RegisteredListener.class:1.10.2-2202-5.1.0-BETA-2039]\n        at org.spongepowered.mod.event.SpongeModEventManager.post(SpongeModEventManager.java:301) [SpongeModEventManager.class:1.10.2-2202-5.1.0-BETA-2039]\n        at org.spongepowered.mod.event.SpongeModEventManager.post(SpongeModEventManager.java:330) [SpongeModEventManager.class:1.10.2-2202-5.1.0-BETA-2039]\n        at org.spongepowered.mod.event.SpongeModEventManager.post(SpongeModEventManager.java:314) [SpongeModEventManager.class:1.10.2-2202-5.1.0-BETA-2039]\n        at org.spongepowered.common.SpongeImpl.postEvent(SpongeImpl.java:141) [SpongeImpl.class:1.10.2-2202-5.1.0-BETA-2039]\n        at org.spongepowered.common.event.SpongeCommonEventFactory.callInteractItemEventSecondary(SpongeCommonEventFactory.java:420) [SpongeCommonEventFactory.class:1.10.2-2202-5.1.0-BETA-2039]\n        at org.spongepowered.common.network.PacketUtil.firePreEvents(PacketUtil.java:241) [PacketUtil.class:1.10.2-2202-5.1.0-BETA-2039]\n        at org.spongepowered.common.network.PacketUtil.onProcessPacket(PacketUtil.java:89) [PacketUtil.class:1.10.2-2202-5.1.0-BETA-2039]\n        at net.minecraft.network.PacketThreadUtil$1.redirect$onProcessPacket$zjc000(SourceFile:39) [fl$1.class:?]\n        at net.minecraft.network.PacketThreadUtil$1.run(SourceFile:13) [fl$1.class:?]\n        at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source) [?:1.8.0_181]\n        at java.util.concurrent.FutureTask.run(Unknown Source) [?:1.8.0_181]\n        at net.minecraft.util.Util.func_181617_a(SourceFile:45) [h.class:?]\n        at net.minecraft.server.MinecraftServer.func_71190_q(MinecraftServer.java:668) [MinecraftServer.class:?]\n        at net.minecraft.server.dedicated.DedicatedServer.func_71190_q(DedicatedServer.java:387) [ld.class:?]\n        at net.minecraft.server.MinecraftServer.func_71217_p(MinecraftServer.java:613) [MinecraftServer.class:?]\n        at net.minecraft.server.MinecraftServer.run(MinecraftServer.java:471) [MinecraftServer.class:?]\n        at java.lang.Thread.run(Unknown Source) [?:1.8.0_181]\n\n这是报错代码  但是不懂啥意思。\n            \n            List<Player> list = (List<Player>) player.getWorld().getPlayers();\n        TreeMap<Player, Double> map = new TreeMap<Player, Double>();\n        for (Player who : list) {\n            //忽略掉自己~\n            if(!who.getName().equals(player.getName())){\n                     double g = GetDistance(player.getLocation().getX(),player.getLocation().getZ(),who.getLocation().getX(),who.getLocation().getZ());\n                     System.out.println(\"计算结果....\"+g);\n                map.put(who,g);    //这是第28行\n            }这是有问题的代码\n\n一天一个问题   这sponge和别的服务端插件完全不一样啊  倒是和mod很像",
    "replies": [
        {
            "author": "a1294790523",
            "timestamp": 1549726740,
            "txt_content": " 本帖最后由 a1294790523 于 2019-2-9 23:43 编辑 \n\n你用的是TreeMap，在没有提供Comparable的时候按照自然顺序排序，然后Player没有实现Comparable接口，so。。。。GG\n你可以在构造的时候提供一个Comparable\n然后的话 你使用TreeMap的目的是什么呢0.0如果需要按照插入顺序排序且使用散列，请使用LinkedHashMap"
        },
        {
            "author": "3TUSK",
            "timestamp": 1549740960,
            "txt_content": " 本帖最后由 u.s.knowledge 于 2019-2-12 11:07 编辑 \n\n请不要直接使用 Player 作为 Map 的 Key！！！会引发内存泄漏！！！而且 Player 的具体实现没有对 equals 和 hashCode 的实现有任何保证，贸然直接使用 Player 作为键，不论是基于散列码和散列表的 HashMap 还是基于红黑树的 TreeMap（根据 https://docs.oracle.com/javase/8/docs/api/java/util/TreeMap.html 的说法，TreeMap 基于红黑树）都可能会让数据在玩家死亡等有可能产生全新的 Player 对象的情况下失去同步！[sup]手动实现 Comparator<Player> 的另说，这里不作讨论，且仍无法解决内存泄漏的问题（根据楼主提供的异常信息，SpongeForge/SpongeVanilla 上的 Player 的幕后应该是 net.minecraft.entity.player.EntityPlayerMP（MCP 名），它持有对 World 的引用，若不能正确回收会导致一连串东西堆积在内存中）[/sup]\n简单的解决方案参考下面。\nimport java.util.HashMap;\nimport java.util.Map;\nimport java.util.UUID;\n\nMap<UUID, Double> theMap = new HashMap(); // 不过为啥要用 TreeMap？HashMap 已经足够了。\n\n// Sponge 中获取玩家 UUID 的方法是 getUniqueId()。\n// 对于其他框架（Bukkit/Spigot、FML/Forge 等）来说操作可能有少许不同，但基本思路都是一致的，\n// 使用 UUID 等轻量、可比较（正确实现了 equals 和 hashCode）、可持久化且时刻保持唯一的标识符\n// 来作为 Map 的键。用玩家名自然也可以，但会在玩家改名后出现数据不同步的问题，请慎重考虑。\ntheMap.put(player.getUniqueId(), data);\n复制代码\n\n参考：https://zhuanlan.zhihu.com/p/38838918\nhttps://docs.spongepowered.org/s ... #storing-references\nhttps://jd.spongepowered.org/7.1 ... l/Identifiable.html\n\nEdit：加注释、包导入、以及简中 SpongeDocs 自己的说明。\nEdit 2: 就算是 Player 不会引发内存泄漏，它也没有对 equals 和 hashCode 的保证。\nEdit 3: 排版\nEdit 4: 排版 * 2Edit 5: @ustc-zzzz 说用 getIdentifier，然而笔者搜了一下发现其实更准确的获得玩家 UUID 的方法是 getUniqueId（来自 Identifiable 接口——在 Sponge 中所有实体都实现了这个接口）。getUniquieId 没有 Optional 一层包装；getIdentifier 返回的是 String，不一定可靠。特此修正并加入相关 Javadocs 链接。\nEdit 6: 排版 * 3，顺带不知道为啥有一行代码被吞了\n\n\n\n\n\n\n"
        }
    ]
}