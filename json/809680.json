{
    "title": "[服务端多线程]服务器服务端最强优化教程 第二次更新",
    "author": "360g",
    "replyCount": 50,
    "timestamp": 1532757180,
    "txt_content": " 本帖最后由 360g 于 2018-8-13 22:04 编辑 \n\n大家可以看到下面这段脚本 和服务器运行状态 是我服务器的启动服务端的脚本运行的服务器 （我一共加了38个MOD）\n\n\n\n\nVCK]1P`3OF9$NJ~PHR$B]3Q.png (37.34 KB, 下载次数: 4)\n\n下载附件\n\n2018-8-13 22:09 上传\n\n\n\n\n\n\n\n\n4(Q{T5_T4_]4CETQ71ZGNTO.png (162.55 KB, 下载次数: 3)\n\n下载附件\n\n2018-7-28 14:22 上传\n\n\n\n\n\n大家可以看到TPS19.968 \n\n这个教程对任何服务器都有用 对任何多核心服务器下运行的服务端都有用\n\n不要看只有19.968 但是运行起来非常爽 因为我们开启了多线程 原本一个核心两个线程的服务器 现在能用到2个核心10个线程\n\n ---------------------------\n性能是一般服务器的三倍\n----------------------------\n\n在最下面有一个新发现的好东西\n\n那么 那段脚本呢 我给大家做个解析 \n-XX:+AggressiveOpts  -XX:+UseCompressedOops 不用我讲了 这个是优化 压缩内存的脚本\n\n也就是论坛内某知名人物发表的文章里提取出来的 \n\n-Xss256k  -XX:ParallelGCThreads=16  这个是什么意思使用8个线程 每个线程使用 256K的内存来对服务器进行\n\nVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV\n -XX:ParallelGCThreads=10 这个是多线程脚本 这个是十个线程 也就是 2 核心 四 线程X2 再加半个核心  \n\n这个在JAVA书上JVM里内存优化上面看到的脚本 下面的都是 \n\n我想了下 平时的服务器服务端只能用到 >1< 个核心 >2< 个线程 但是呢 也不可能不能调核心数量 因此 我就到书上翻了很久\n\n才看到的 -XX:+PARALLELGC 这个脚本 可以对服务器使用CPU核心数量的使用进行一个控制 （也就是所说的一般服务器只能使用到1个核心两个线程）\n\n如果 你不使用这个脚本 那么服务端核心将以默认的 1个核心两个线程进行开服 这时候服务器单核性能不好的缺点就暴露出来了 人多了就卡顿\n\n也就是插件多的情况下 优化 的再好也没用  像国内某知名大型服务器 他一个生存服要带三百多个人 结果每天玩家除了卡就是卡 再好的就是\n\n网络好一点  \n\n-XX:+UseConcMarkSweepGC  这个是 定时将内存自动回收 然后 \n\n -XX:+UseFastAccessorMethods 这个是原始类型的JAVA自带的快速优化 \n\n| -server | 这个呢是启动JAVA的Server（服务器）运行模式  也就是在开服务器的时候会自动把服务器模式打开 配合多线程脚本 性能更加强大 也就不会出现所谓的卡顿 在卡就是服务器网络的卡顿\n\n但是这个只推荐大型生存服和MOD服务器使用 \n\n小游戏服务器使用\n java -server -XX:+AggressiveOpts  -XX:+UseCompressedOops  -XX:+UseFastAccessorMethods -jar \n为什么我要写这个脚本  因为一般的端他只占用最多一个核心两个线程 不写上面多线程脚本的话 但是游戏服务器就不需要这么多线程这是针对游戏服务器的游戏单端编写的一条脚本      然后一般的服务器 生存服他只知道用这个脚本 这就是一般的服务器人多特别的卡的原因 （这里是讲生存类型的服务器）\n\n然后我们需要打开\nserver.properties这个文件在里面添加一个 所谓的代码\n\nuseSMPAPI=true 这个是让服务器打开多线程的一个运算\n就像这样加在这个SERVER的这个文件里\n\n\n\n\nOOVI]%U2F7779Y4RO9M7Y]1.png (6.36 KB, 下载次数: 1)\n\n下载附件\n\n2018-8-13 22:04 上传\n\n\n\n\n\n\n总结一下  \n\njava -server -XX:+AggressiveOpts  -XX:+UseCompressedOops -XX:ParallelGCThreads=10 -XX:+UseConcMarkSweepGC -XX:+UseFastAccessorMethods -jar  \n这个脚本启动服务器运行状态JAVA 压缩内存给服务器使用 使用十个线程 并且自动回收和快速优化服务器 适用于生存服务器等需要承载大人数的服务器服务端\n java  -XX:+AggressiveOpts  -XX:+UseCompressedOops  -XX:+UseFastAccessorMethods -jar \n 这个前面两个脚本是 压缩内存 服务器使用的优化 后面那个是原始的快速优化 适用于单核双线程的小游戏端使用 但是人数不要超过 50人 \n\n再配合这些服务端优化大佬的服务端优化教程贴 效果真的杠杠的 但是 在这个服务器优化的前提上 你必须要使用我的脚本才能对服务器的核心进行一个极大的分配使用 不然你服务器性能在强大 你的服务器性能也无法得到分配 \n\n\n还有一件事情 这不是过度优化 这只是把你服务器的多核心性能给发挥出来 给服务器一个良好的 运行状态 这就是为什么我讲最强优化帖未经过允许 请不要转载 \n\n\n\n\n\n\n\n\n\n\n\n\n",
    "replies": [
        {
            "author": "Skyer",
            "timestamp": 1532760120,
            "txt_content": "感谢大佬支招，涨知识了"
        },
        {
            "author": "YxY小小Y",
            "timestamp": 1532762940,
            "txt_content": "感觉有点乱乱的....也没看到有啥用..."
        },
        {
            "author": "尘",
            "timestamp": 1532765580,
            "txt_content": "似乎对sponge很有效？\n-XX:+AggressiveOpts  -XX:+UseCompressedOops  -XX:+UseFastAccessorMethods"
        },
        {
            "author": "117779284",
            "timestamp": 1532766660,
            "txt_content": "等待大佬出来分析··"
        },
        {
            "author": "360g",
            "timestamp": 1532827320,
            "txt_content": "117779284 发表于 2018-7-28 16:31\n等待大佬出来分析··\n我等下重新编排下这个帖子 你试着理解最好"
        },
        {
            "author": "360g",
            "timestamp": 1532827320,
            "txt_content": "桶家军烦恼 发表于 2018-7-28 16:13\n似乎对sponge很有效？\n-XX:+AggressiveOpts  -XX:+UseCompressedOops  -XX:+UseFastAccessorMethods ...\n对任何服务端"
        },
        {
            "author": "360g",
            "timestamp": 1532827380,
            "txt_content": "YxY小小Y 发表于 2018-7-28 15:29\n感觉有点乱乱的....也没看到有啥用...\n等下我会把帖子重新编排"
        },
        {
            "author": "Hanssc",
            "timestamp": 1532844060,
            "txt_content": "ParallelGCThreads，表示JVM在进行并行GC的时候，用于GC的线程数，-XX:ParallelGCThreads=43，表示配置GC线程数为43\n并不是如你所说。"
        },
        {
            "author": "Hanssc",
            "timestamp": 1532844360,
            "txt_content": "①如果用户显示指定了ParallelGCThreads，则使用用户指定的值。\n②否则，需要根据实际的CPU所能够支持的线程数来计算ParallelGCThreads的值，计算方法见步骤③和步骤④。\n③如果物理CPU所能够支持线程数小于8，则ParallelGCThreads的值为CPU所支持的线程数。这里的阀值为8，是因为JVM中调用nof_parallel_worker_threads接口所传入的switch_pt的值均为8。\n④如果物理CPU所能够支持线程数大于8，则ParallelGCThreads的值为8加上一个调整值，调整值的计算方式为：物理CPU所支持的线程数减去8所得值的5/8或者5/16，JVM会根据实际的情况来选择具体是乘以5/8还是5/16。\n=\n也就是说，你不需要指定回收线程数，jvm会自动最佳选择。"
        },
        {
            "author": "360g",
            "timestamp": 1532848260,
            "txt_content": "Hanssc 发表于 2018-7-29 14:06\n①如果用户显示指定了ParallelGCThreads，则使用用户指定的值。\n②否则，需要根据实际的CPU所能够支持的线 ...\n并不是 我直接告诉你 那个只是用来选择线程的"
        },
        {
            "author": "Hanssc",
            "timestamp": 1532848680,
            "txt_content": "360g 发表于 2018-7-29 15:11\n并不是 我直接告诉你 那个只是用来选择线程的我想了下 平时的服务器服务端只能用到 >1< 个核心 >2< 个线程 但是呢 也不可能不能调核心数量 因此 我就到书上翻了很久\n\n才看到的 -XX:+PARALLELGC 这个脚本 可以对服务器使用CPU核心数量的使用进行一个控制 （也就是所说的一般服务器只能使用到1个核心两个线程）\n\n如果 你不使用这个脚本 那么服务端核心将以默认的 1个核心两个线程进行开服 这时候\n\n简单来说，这里的线程只是用于垃圾回收，并不是让服务端能多线程运行。\n实际，不用加这项，jvm也会根据实际情况自动选择最佳参数。因此，疯狂增加这一项，并不会有非常大的作用，不如让jvm自动选择，三倍性能更是绝对不可能的。"
        },
        {
            "author": "360g",
            "timestamp": 1532848920,
            "txt_content": "Hanssc 发表于 2018-7-29 15:18\n简单来说，这里的线程只是用于垃圾回收，并不是让服务端能多线程运行。\n实际，不用加这项，jvm也会根据 ...\n那你随意 你觉得不行就别用"
        },
        {
            "author": "360g",
            "timestamp": 1532849040,
            "txt_content": "Hanssc 发表于 2018-7-29 15:18\n简单来说，这里的线程只是用于垃圾回收，并不是让服务端能多线程运行。\n实际，不用加这项，jvm也会根据 ...\n麻烦你百度-XX:ParallelGCThreads这个东西 而且我还是书上面翻得"
        },
        {
            "author": "Hanssc",
            "timestamp": 1532849640,
            "txt_content": "360g 发表于 2018-7-29 15:24\n麻烦你百度-XX:ParallelGCThreads这个东西 而且我还是书上面翻得-XX:ParallelGCThreads=10 这个是多线程脚本 这个是十个线程 也就是 2 核心 四 线程X2 再加半个核心  \n\n这个在JAVA书上JVM里内存优化上面看到的脚本 下面的都是 \n\n\n上面列出了与ParallelGCThreads计算相关的几个核心接口，其中，最主要关注nof_parallel_worker_threads接口，该接口中给出了计算ParallelGCThreads值的具体算法，具体如下：\n    ①如果用户显示指定了ParallelGCThreads，则使用用户指定的值。\n    ②否则，需要根据实际的CPU所能够支持的线程数来计算ParallelGCThreads的值，计算方法见步骤③和步骤④。\n    ③如果物理CPU所能够支持线程数小于8，则ParallelGCThreads的值为CPU所支持的线程数。这里的阀值为8，是因为JVM中调用nof_parallel_worker_threads接口所传入的switch_pt的值均为8。\n    ④如果物理CPU所能够支持线程数大于8，则ParallelGCThreads的值为8加上一个调整值，调整值的计算方式为：物理CPU所支持的线程数减去8所得值的5/8或者5/16，JVM会根据实际的情况来选择具体是乘以5/8还是5/16。\n    比如，在64线程的x86 CPU上，如果用户未指定ParallelGCThreads的值，则默认的计算方式为：ParallelGCThreads = 8 + (64 - 8) * (5/8) = 8 + 35 = 43。\n"
        },
        {
            "author": "Hanssc",
            "timestamp": 1532849820,
            "txt_content": "360g 发表于 2018-7-29 15:24\n麻烦你百度-XX:ParallelGCThreads这个东西 而且我还是书上面翻得\n你的一切操作都是针对gc，也就是垃圾回收。\n一般来说jvm自己的选择足以合理回收垃圾。\n当然你硬加线程或许也有极少帮助。\n不过这并不是所谓的让服务端支持多核心。"
        },
        {
            "author": "Didiao0v0",
            "timestamp": 1532947380,
            "txt_content": "这个脚本 能加 -Xms8G -Xmx16G  这种内存分配的吧"
        },
        {
            "author": "Didiao0v0",
            "timestamp": 1532965260,
            "txt_content": "不加 -Xincgc 这个么"
        },
        {
            "author": "1208180423",
            "timestamp": 1532996940,
            "txt_content": "希望楼主能在补充上去一个，如果运行内存最大值大于4G的话建议在前面加个-D64（linux是-d64，有大小写区分）属性，这样可以更好地发挥服务器性能"
        },
        {
            "author": "mc@viphdf.cc",
            "timestamp": 1532999280,
            "txt_content": "我服务器没用这些参数和你差不多38个左右MOD一样流畅...."
        },
        {
            "author": "1208180423",
            "timestamp": 1533000240,
            "txt_content": "mc@viphdf.cc 发表于 2018-7-31 09:08\n我服务器没用这些参数和你差不多38个左右MOD一样流畅....\n其实我也是，只不过我的服务器在遇到大型WE或者其他吃CPU的事的时候TPS会很不正常，其他的时候带十几个人没问题的"
        },
        {
            "author": "火星浮云",
            "timestamp": 1533001020,
            "txt_content": "一看标题以为是个青铜\n然后看了眼内容发现好像是个王者？\n之后看了评论就不敢确定了……\n\n我一个小白点进来干吗……"
        },
        {
            "author": "360g",
            "timestamp": 1533003060,
            "txt_content": "mc@viphdf.cc 发表于 2018-7-31 09:08\n我服务器没用这些参数和你差不多38个左右MOD一样流畅....\n你自己没在服务器内玩过生存 什么叫瞬间卡顿"
        },
        {
            "author": "360g",
            "timestamp": 1533003120,
            "txt_content": "1208180423 发表于 2018-7-31 08:29\n希望楼主能在补充上去一个，如果运行内存最大值大于4G的话建议在前面加个-D64（linux是-d64，有大小写区分 ...\n这个东西我正在弄 我的服务器脚本前几天加进去了"
        },
        {
            "author": "Didiao0v0",
            "timestamp": 1533007440,
            "txt_content": "楼主貌似得分配一下内存 不然服务器自动分配4G 太小了吧\njava -server -Xms8G -Xmx16G -XX:+AggressiveOpts -XX:+UseCompressedOops -XX:ParallelGCThreads=10 -XX:+UseConcMarkSweepGC -XX:+UseFastAccessorMethods -Xincgc -jar"
        },
        {
            "author": "wy834974857",
            "timestamp": 1533041040,
            "txt_content": "感谢大佬讲解,涨知识了!"
        },
        {
            "author": "Regiment_Red",
            "timestamp": 1533095040,
            "txt_content": "线程数怎么改比较好 八核心十六线程的服务器 应该怎么写？"
        },
        {
            "author": "141888",
            "timestamp": 1533221700,
            "txt_content": "MCBBS有你更精彩`"
        },
        {
            "author": "tjwei123",
            "timestamp": 1533304560,
            "txt_content": "请问一下楼主，怎么设置分配内存呢？ 我用了你的参数以后游戏里gc出来只有2G"
        },
        {
            "author": "360g",
            "timestamp": 1534464180,
            "txt_content": "Regiment_Red 发表于 2018-8-1 11:44\n线程数怎么改比较好 八核心十六线程的服务器 应该怎么写？\n你想全部用就把16改成32"
        },
        {
            "author": "iKoumimi",
            "timestamp": 1536896220,
            "txt_content": "360g 发表于 2018-7-31 10:11\n你自己没在服务器内玩过生存 什么叫瞬间卡顿\n加你这个参数之后就会导致瞬间卡顿，请深入研究JVM工作原理再来发帖"
        },
        {
            "author": "3276274211",
            "timestamp": 1537759680,
            "txt_content": "请问 启动脚本是什么？"
        },
        {
            "author": "3307137433",
            "timestamp": 1539656520,
            "txt_content": "确实对性能提升有帮助，支持"
        },
        {
            "author": "j531065605",
            "timestamp": 1540573980,
            "txt_content": "感谢大佬分享，先收藏了"
        },
        {
            "author": "世界边境",
            "timestamp": 1542183660,
            "txt_content": " 本帖最后由 世界边境 于 2018-11-14 16:36 编辑 \n\n那个GC机制有关的参数最好不要乱改，由于JAVA的GC机制(垃圾回收）也是要占用CPU资源的，所以设置的不好可能会导致频繁卡顿，导致TPS虽然没问题，但服务器就是很卡。\nGC的这个参数要根据自己服务器的情况灵活调整，比如前期服务器的CPU资源充足，玩家需要跑图导致大量内存占用，那就可以让GC频繁一些，来减少内存占用，但是到了后期服务器有大量的机器、机制、生物占用CPU资源，一般CPU资源是比较吃紧的，这个时候就不能让GC那么频繁了。\n所以带着大写GC这两个关键字的参数还请斟酌一下自己的CPU是不是足够强劲。\n由于minecraft多线程优化并不是很好，游戏卡不卡全看单核性能，所以个人建议少给CPU加负担比较好，\n比如有一个优化思路是通过降低MaxGCPauselMillis参数降低GC深度，用内存压力换CPU压力，并通过定时重启脚本来释放服务器内存。"
        },
        {
            "author": "360g",
            "timestamp": 1543222380,
            "txt_content": "世界边境 发表于 2018-11-14 16:21\n那个GC机制有关的参数最好不要乱改，由于JAVA的GC机制(垃圾回收）也是要占用CPU资源的，所以设置的不好可能 ...\n2X CPU  E5 2690 0  您觉得怎么样 TheMos端"
        },
        {
            "author": "世界边境",
            "timestamp": 1543244460,
            "txt_content": "360g 发表于 2018-11-26 16:53\n2X CPU  E5 2690 0  您觉得怎么样 TheMos端\n后期的平均占用呢？这个不是单纯说性能高就好的，要看占用，比如说你mod多，即使性能强劲但是CPU占用居高不下就要减少GC次数和深度，给服务器主体计算留出资源。\n毕竟服务器优化比较重要的一点就是灵活变通，根据当前的服务器状态改变优化策略。\n而且多核优化一个比较好的思路是用BC服，把多个子服分配给两个不同的CPU，一个CPU主要负责登陆服、资源世界、小游戏和内存回收等时间短的计算，而另一个CPU主要负责大量的mod实体、机械计算，这样就可以平均的分担CPU压力。"
        },
        {
            "author": "1723624171",
            "timestamp": 1543375380,
            "txt_content": "提示: 作者被禁止或删除 内容自动屏蔽"
        },
        {
            "author": "muying2015",
            "timestamp": 1552751280,
            "txt_content": "我为什么要来看这东西明明是个小白"
        },
        {
            "author": "萌@皮皮鲁",
            "timestamp": 1555847400,
            "txt_content": "catserver能用这个优化吗？能不能发一个启动脚本让我试试"
        },
        {
            "author": "灭HIM专家",
            "timestamp": 1556290920,
            "txt_content": "我10核心20线程的服务器用什么启动脚本好？服务器空岛接近后期了"
        },
        {
            "author": "LinkinPony",
            "timestamp": 1560986400,
            "txt_content": "请先粗略了解JVM原理后再来发帖,不要随意误导他人.\n如果的确对理解GC是什么有困难的话,建议您先看看Oracle给出的文档."
        },
        {
            "author": "astar_ge",
            "timestamp": 1564474440,
            "txt_content": "萌@皮皮鲁 发表于 2019-4-21 19:50\ncatserver能用这个优化吗？能不能发一个启动脚本让我试试\n同在用Catserver，我发现默认启动脚本里，Win给的是-Xms2048M -Xmx2048M，而Linux下是-Xms1024M -Xmx4096M，不同平台下差这么多？我是放到NAS上自己玩的，顶多三四个朋友，不知道该设置多少合适。\n我也是小白一只，一点不懂，虚心请教。"
        },
        {
            "author": "Mactracker",
            "timestamp": 1566288900,
            "txt_content": "請問樓主 -XX 這些腳本 支援Mac開的服務器嗎？ 需要在哪裡加入腳本"
        },
        {
            "author": "晓兜",
            "timestamp": 1566482940,
            "txt_content": "astar_ge 发表于 2019-7-30 16:14\n同在用Catserver，我发现默认启动脚本里，Win给的是-Xms2048M -Xmx2048M，而Linux下是-Xms1024M -Xmx4096 ...\n三四个人玩就不用优化了，够用的"
        },
        {
            "author": "Stant_hed",
            "timestamp": 1566544680,
            "txt_content": "你这个截图没有说服力，区块tiles都这么少= ="
        },
        {
            "author": "光辉的过去",
            "timestamp": 1567486080,
            "txt_content": "看看 谢谢分享"
        },
        {
            "author": "DE_SHARK",
            "timestamp": 1569922140,
            "txt_content": "第一、gc截图的tiles太少，不足以证明你找个参数有实质性的作用\n第二、实测参数 -XX:ParallelGCThreads=16 和 -XX:ParallelGCThreads=10 数值设置不好会引起蹦服\n第三、我任务管理器显示另外两个核心的占用率确实是高了，但tps并没有高多少\n\n再加一句，你弄 20w的tiles 再试一下\n"
        },
        {
            "author": "q1970067798",
            "timestamp": 1583422620,
            "txt_content": "好乱啊                  "
        },
        {
            "author": "aizimin2",
            "timestamp": 1586394960,
            "txt_content": "好乱。。空格也没打全，到最后也不知道自己改加哪条代码。。"
        },
        {
            "author": "TingTim",
            "timestamp": 1589345220,
            "txt_content": "请问楼主是什么端，我用官方服务端试是时候直接把我的服务端核心搞崩了。。"
        }
    ]
}