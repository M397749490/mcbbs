{
    "title": "Sponge MOD服优化经验",
    "author": "dfxxlyc",
    "replyCount": 1,
    "timestamp": 1583255220,
    "txt_content": "开了一年Sponge服，收集了很多优化策略，做一下记录，希望有用\n\n服务器选择：\nMOD服建议选择单核性能高，2核足够，3核和更多容易造成1核有难X核围观的局面。\nRAM（内存）需求比较高，我70个mod的端大约需要4~5GB保持正常运行\n大多数面板服双核E5能保证10~20人60~90mods小服运行\n\n\nforge配置更改：\n出现【推荐更改】的选项，可以考虑更改，其他选项建议直接跳过\n20 tick = 1s\n\nforge.cfg\ngeneral {\n    # 【推荐开启】关闭mod检查，可以关闭大部分mod更新检查（少数mod自己会绕过此机制...）\n    B:disableVersionCheck=true\n\n    # Controls the number threshold at which Packet51 is preferred over Packet52, default and minimum 64, maximum 1024复制代码\n\n\n接下来是forgeChunkLoading.cfg\n\ndefaults {\n    # 如果MOD有特殊设置，采用MOD的设置，默认开启\n    B:enabled=true\n\n    # mod一次操作最多区块数量，默认就行，不要太大\n    I:maximumChunksPerTicket=200\n\n    # 一个mod最多请求多少次区块载入，默认\n    I:maximumTicketCount=200\n\n复制代码\nSponge 配置\n\nSponge的设置有些特殊，我们可以针对每个世界调整，以提高性能，\n每个世界的设置：worlds/mod名/世界类型/世界名/world.cfg\n比如资源世界我可以调低视距到3，反正资源世界没人看风景\n资源世界大幅度提高保存世界的间隔...或者禁用，反正总有一天你需要重置这个世界\n主世界的地方视距调5，因为有人有看风景的需求，而且需要更新很多很多方块和生物\n生物生成调到极低，一般都驻扎在一个地方，刷怪什么的没必要\n\n\n如果没有特殊设置，就采取global.conf的设置\n我们先调整最简单的几项\n\nconfig/Sponge/global.conf\nentity {\n        # 当一堆生物在一块时，后台会发出警告，0表示不检测，看自己需要，一般默认值\n        collision-warn-size=0\n        # 默认，没影响\n        entity-painting-respawn-delay=2\n        # 默认，没影响\n        human-player-list-remove-delay=10\n        # 多少tick后物品消失\n        item-despawn-rate=6000复制代码\n\nSponge 必备模块：\ntileentity-activation模块\n这个模块可以限制TileEntity（就是复杂方块，科技mod的各类机械都是TileEntity）\n限制有两种：超出玩家一定范围就不更新，以及每隔一段时间更新一次，而不是，每个tick都更新一次\n使用方式：\n找到这个模块，开启auto-populate=true（将探查到的tileEntity加入配置文件中）\n然后进游戏尽可能摆你能摆的方块，之后关闭服务器，会发现config多了很多东西\nileentity-activation {\n        auto-populate=true\n        # 默认激活范围\n        default-block-range=48\n        # 默认每多少tick就更新一次tileEntity方块\n        default-tick-rate=4\n        # 对每个mod的tileentity进行设置\n        mods {复制代码注意调整后需要调整各个mod的产能等数据，不然会非常慢...\n完成调整后请关闭auto-populate\n\nentity-activiation-range模块\n这个模块限制实体活动范围\n当距离玩家多少格以后，这些实体将会被暂停，不做任何更新\n使用方法类似上面那个模块，这里不赘述了\n默认值针对的是不同实体，misc通常是一些奇奇怪怪不是生物的实体（比如扔出去的物品）\n\nstruct-saving 模块\n可以不保存世界中的某些结构，减少地图文件体积，使用方法类似\n\n\nSponge timings模块\n这个模块可以用于分析服务器性能，并找出哪些东西卡服\n/sponge timings on 开启功能\n/sponge timings report 产出报告并分析\n/sponge timings off 关闭功能\n\n开启timing后至少过300s才能获得报告\n\n平时不要一直开着这功能，性能损失比较大（10%左右）\n报告包含这些内容：\nTPS, TPS LOSS, 人数\n\nTPS 最高20，即每秒多少tick，18+ TPS 通常能保证流畅体验\nTPS LOSS：统计tps没有到达20的部分，这个值越高，可能代表卡顿越多\n（比如TPS 19.8 但是 LOSS 有10%，那么中间可能有一个强烈的卡顿导致有几个tick被略过）\n\n报告比较难看懂，没有编程基础可以尝试翻译方法名，然后看哪个占得多，\n（比如Hopper是漏斗，对应时间10ms，那意味着他1个tick占用了10ms的CPU运算时间，也就是1tick 20%的计算量）\n\n报告右上方有类型选项，Average能帮助找到长时间卡服的操作，All能找到占用性能的操作\n\n有编程基础的推荐Spark这个插件，拥有更精细的timing功能，可以精确查看哪些方法执行时间最长（自带反混淆方法名），然后针对性优化\nspark tps：查看CPU使用率和TPS\nspark sampler --stop 时间：进行CPU时间分析，一共进行多少秒\n\n\n\n优化mod\nSurge，Foamfix，Betterfps，AI优化，卡顿检测之类的已经提过很多遍了\nfastworkbench，更快的工作台，这个mod比较不错，提高合成表的查询速度https://www.mcmod.cn/class/1486.html\nfastfurance，经常有bug，不建议装，经常出现熔炉贴图丢失和熔炉不工作的bug，现在不知道有没有修复\nDynamicTick，这个优化mod无法和sponge共存，会出现冲突\n\n\n平时服务器维护：\n/sponge tps查看当前tps情况\nworld模块可以管理多世界\n记得那些没用的世界/world unload 世界名 来暂时缓解服务器压力\n如果服务器有几十个世界，建议关闭这些世界的 保持出生点加载的设置\n\nNucleus配置时，如果要给用户rtp权限的话，降低rtp尝试次数，减少卡顿（rtp卡顿非常明显）\n很多mod的config都包含tick rate（更新频率）相关的性能设置，也是一个可以利用的选项。\n上述优化做完后，如果依然卡，就要考虑用spark插件来定位性能消耗的主要对象了\n\n\n附：常见错误报告\n\n错误报告看Error堆栈的详细信息（就是一堆at xxx, at xxx）\n然后看看里面有没有自己熟悉的mod名，大部分情况下都是这个mod所引起的问题（少部分不是）\n\n如果遇到频繁掉线，而网络确定没问题，到log文件夹（客户端和服务端）找日志文件，定位所有没被汇报为Crash的Error，然后开始百度\n\n\n其他类型的错误报告：\n\n> 关键词 NullPointerException，BlockPos\n   可能MOD作者没有针对Sponge兼容，忽略了实体/区块优化导致的Pos空指针异常，只能报告给作者等待解决\n\n> 关键词 NoClassDefFoundError\n   MOD/插件/Sponge/Forge版本不兼容，换版本\n\n> 关键词 ServerHangWatchdog detected that a single server tick took\n   有个地方卡了很久，服务器决定强制关闭（这个时间可以在server.properties中设置）\n   遇到这个问题很难解决，一般有3种：\n      大规模建筑生成，作者mod没写好（比如用mc creator制作的大型建筑生成）\n      线程死锁（我没遇到过）\n      其他奇怪的死循环（大部分都是这）\n  解决比较困难，建议把相关mod扔了\n\n> 关键词 OutofMemory\n   内存RAM不够\n\n\n参考的帖子/网站：\nhttps://www.mcbbs.net/thread-815413-1-1.html\nhttps://www.mcbbs.net/thread-769360-1-1.html\n推荐Sponge文档，中文，非常详细：\nhttps://docs.spongepowered.org/stable/zh-CN/server/management/performance-tweaks.html\n\n\n\n",
    "replies": [
        {
            "author": "xingchena",
            "timestamp": 1583296920,
            "txt_content": "特别详细 弄好了就才能够好"
        }
    ]
}