{
    "title": "在FRP下开BungeeCord跨服服务器返回真实IP",
    "author": "逆天域",
    "replyCount": 12,
    "timestamp": 1575311640,
    "txt_content": " 本帖最后由 逆天域 于 2020-2-15 17:55 编辑 \n\n原理\n在开MC服务器时，若使用frp，我们通常会使用tcp映射，也就是frpc.ini中的：\ntype = tcp复制代码在frp原github的readme中明确给出，使用frp时，返回真实ip的方式有两种，分别是HTTP X-Forwarded-For与Proxy Protocol。\n而前者只适用于HTTP映射，后者则支持全tcp映射\n原readme中是这么给出的：\n\nfrp 支持通过 Proxy Protocol 协议来传递经过 frp 代理的请求的真实 IP，此功能支持所有以 TCP 为底层协议的类型，不支持 UDP。\nProxy Protocol 功能启用后，frpc 在和本地服务建立连接后，会先发送一段 Proxy Protocol 的协议内容给本地服务，本地服务通过解析这一内容可以获得访问用户的真实 IP。所以不仅仅是 HTTP 服务，任何的 TCP 服务，只要支持这一协议，都可以获得用户的真实 IP 地址。\n需要注意的是，在代理配置中如果要启用此功能，需要本地的服务能够支持 Proxy Protocol 这一协议，目前 nginx 和 haproxy 都能够很好的支持。\n\n事实上，作者还是十分贴心的加入了Proxy Protocol这一功能，BungeeCord可以很好的接受Proxy Protocol的包\n在BungeeCord的config.yml中，我们可以在listeners下看到：\nlisteners:\nproxy_protocol: false复制代码而我们只需要把false改为true就可以很完美的让BungeeCord接收Proxy Protocol的包。\n而最后剩下的就仅仅是让frpc启用这项发送Proxy Protocol包的功能，根据原Readme中所说：\n这里以 https 类型为例:\n# frpc.ini\n[web]\ntype = https\nlocal_port = 443\ncustom_domains = test.yourdomain.com\n# 目前支持 v1 和 v2 两个版本的 proxy protocol 协议。\nproxy_protocol_version = v2复制代码只需要在代理配置中增加一行 proxy_protocol_version = v2 即可开启此功能。\n那么如果你的端口是25565，你的MC服务器映射应该是这样的：\n# frpc.ini\n[mcserver]\ntype = tcp\nlocal_port = 25565\nproxy_protocol_version = v2复制代码至此，BungeeCord配合frpc的Proxy Protocol就可以做到完美的返回玩家真实的IP到服务器上。\n这里不一定非要是BungeeCord，只要支持Proxy Protocol的代理都是可以的~\n\n\n\n\n本文为逆天域Intary原创文章，已同步发布至CSDN博客，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接和本声明。\nCSDN文章链接：https://blog.csdn.net/qq_34922260/article/details/103338881\n",
    "replies": [
        {
            "author": "SkyCatcher",
            "timestamp": 1575359340,
            "txt_content": "楼主有了解过spigot下哪些插件能解析Proxy Protocol吗？"
        },
        {
            "author": "逆天域",
            "timestamp": 1575374880,
            "txt_content": "SkyCatcher 发表于 2019-12-3 15:49\n楼主有了解过spigot下哪些插件能解析Proxy Protocol吗？\n抱歉，我还没有去了解单服接收proxy protocol包的方法，不过套一层bungeecord再将默认服务器设一下我觉得效果是一样的"
        },
        {
            "author": "SkyCatcher",
            "timestamp": 1575378120,
            "txt_content": "逆天域 发表于 2019-12-3 20:08\n抱歉，我还没有去了解单服接收proxy protocol包的方法，不过套一层bungeecord再将默认服务器设一下我觉得 ...\n效果应该差不多，但是多一层端会损耗一些性能，同时也增加了复杂度"
        },
        {
            "author": "SkyCatcher",
            "timestamp": 1576324260,
            "txt_content": "我试了下这个方案，有个很大的问题是 proxy_protocol: true 以后，如果直接连接bungeecord，就连不进去了。而只能识别通过proxy protocol后的流量"
        },
        {
            "author": "逆天域",
            "timestamp": 1576418460,
            "txt_content": "SkyCatcher 发表于 2019-12-14 19:51\n我试了下这个方案，有个很大的问题是 proxy_protocol: true 以后，如果直接连接bungeecord，就连不进去了。 ...\n是这样的 因为这改变了bungeecord接收的包的模式 目前可能只有两种接包模式分别建立bc了 暂时还没有想到其他解决方案"
        },
        {
            "author": "SkyCatcher",
            "timestamp": 1576420500,
            "txt_content": "逆天域 发表于 2019-12-15 22:01\n是这样的 因为这改变了bungeecord接收的包的模式 目前可能只有两种接包模式分别建立bc了 暂时还没有想到 ...\n但是分别建立BC的话，两个BC后面的数据可能会不互通吧"
        },
        {
            "author": "逆天域",
            "timestamp": 1576902600,
            "txt_content": "SkyCatcher 发表于 2019-12-15 22:35\n但是分别建立BC的话，两个BC后面的数据可能会不互通吧\nemm 还没试过 毕竟套两层BC的开服很少有人去做 毕竟平常情况下不会有太多的需求 而且也会导致很多麻烦的事情~"
        },
        {
            "author": "3128554048",
            "timestamp": 1582253340,
            "txt_content": "提示: 作者被禁止或删除 内容自动屏蔽"
        },
        {
            "author": "DustSettles",
            "timestamp": 1582755720,
            "txt_content": "逆天域 发表于 2019-12-21 12:30\nemm 还没试过 毕竟套两层BC的开服很少有人去做 毕竟平常情况下不会有太多的需求 而且也会导致很多麻烦的 ...\n在本地BC前再套一层frp，frp占用cpu应该不多吧\n@SkyCatcher"
        },
        {
            "author": "SkyCatcher",
            "timestamp": 1582816260,
            "txt_content": "DustSettles 发表于 2020-2-27 06:22\n在本地BC前再套一层frp，frp占用cpu应该不多吧\n@SkyCatcher\n方案是可行的，但是实在是很麻烦，相当于为了加一条线路，在本地开了个bc端，又在加速节点开了个bc端。网络结构越复杂，出现故障的概率就越大"
        },
        {
            "author": "Melt、",
            "timestamp": 1582867980,
            "txt_content": "11111111111111111111111111"
        },
        {
            "author": "25000.www",
            "timestamp": 1582889880,
            "txt_content": "66666666666666666666"
        }
    ]
}