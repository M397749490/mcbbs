{
    "title": "【Bukkit】 Block的setType问题",
    "author": "mc能吃吗",
    "replyCount": 6,
    "timestamp": 1572067560,
    "txt_content": "如题，我的代码是\n（BlockDamageEvent方块正在被玩家破坏事件下）\ne.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.AIR);复制代码点击后成功清除。\n然后 另一边：\n（BlockBreakEvent 方块破坏事件下）\n                    e.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.COBBLESTONE);\n                    if (true == this.getConfig().getBoolean(\"debug\")) {\n                        getLogger().info(\"放置了原石\");\n                    }复制代码这段代码，debug开启的时候，信息输出了，但是原石却没有放置\n是格式问题还是其他的什么问题？版本Paper-209 1.14.4\n\n\n",
    "replies": [
        {
            "author": "吕易天",
            "timestamp": 1572068940,
            "txt_content": " 本帖最后由 吕易天 于 2019-10-26 13:58 编辑 \n\n设置了Type以后取消事件就行了，你需要看看PlayerInteractManager里面的东西:\npublic boolean breakBlock(final BlockPosition blockposition) {\n        BlockBreakEvent event = null;\n        if (this.player instanceof EntityPlayer) {\n            final org.bukkit.block.Block block = this.world.getWorld().getBlockAt(blockposition.getX(), blockposition.getY(), blockposition.getZ());\n            final boolean isSwordNoBreak = this.gamemode.isCreative() && !this.player.getItemInMainHand().isEmpty() && this.player.getItemInMainHand().getItem() instanceof ItemSword;\n            if (this.world.getTileEntity(blockposition) == null && !isSwordNoBreak) {\n                final PacketPlayOutBlockChange packet = new PacketPlayOutBlockChange(this.world, blockposition);\n                packet.block = Blocks.AIR.getBlockData();\n                this.player.playerConnection.sendPacket(packet);\n            }\n            event = new BlockBreakEvent(block, this.player.getBukkitEntity());\n            event.setCancelled(isSwordNoBreak);\n            final IBlockData nmsData = this.world.getType(blockposition);\n            final Block nmsBlock = nmsData.getBlock();\n            final ItemStack itemstack = this.player.getEquipment(EnumItemSlot.MAINHAND);\n            if (nmsBlock != null && !event.isCancelled() && !this.isCreative() && this.player.hasBlock(nmsBlock.getBlockData()) && (!nmsBlock.o() || EnchantmentManager.getEnchantmentLevel(Enchantments.SILK_TOUCH, itemstack) <= 0)) {\n                final int bonusLevel = EnchantmentManager.getEnchantmentLevel(Enchantments.LOOT_BONUS_BLOCKS, itemstack);\n                event.setExpToDrop(nmsBlock.getExpDrop(this.world, nmsData, bonusLevel));\n            }\n            this.world.getServer().getPluginManager().callEvent(event);\n            if (event.isCancelled()) {\n                if (isSwordNoBreak) {\n                    return false;\n                }\n                this.player.playerConnection.sendPacket(new PacketPlayOutBlockChange(this.world, blockposition));\n                this.cancelBreakBlock(blockposition, nmsData);\n                final TileEntity tileentity = this.world.getTileEntity(blockposition);\n                if (tileentity != null) {\n                    this.player.playerConnection.sendPacket(tileentity.getUpdatePacket());\n                }\n                return false;\n            }\n        }\n        final IBlockData iblockdata = this.world.getType(blockposition);\n        if (iblockdata.getBlock() == Blocks.AIR) {\n            return false;\n        }\n        final TileEntity tileentity2 = this.world.getTileEntity(blockposition);\n        final Block block2 = iblockdata.getBlock();\n        if (iblockdata.getBlock() == Blocks.SKULL && !this.isCreative() && event.isDropItems()) {\n            iblockdata.getBlock().dropNaturally(this.world, blockposition, iblockdata, 1.0f, 0);\n            return this.c(blockposition);\n        }\n        if (iblockdata.getBlock() instanceof BlockShulkerBox && event.isDropItems()) {\n            iblockdata.getBlock().dropNaturally(this.world, blockposition, iblockdata, 1.0f, 0);\n            return this.c(blockposition);\n        }\n        if ((block2 instanceof BlockCommand || block2 instanceof BlockStructure) && !this.player.isCreativeAndOp()) {\n            this.world.notify(blockposition, iblockdata, iblockdata, 3);\n            return false;\n        }\n        if (this.gamemode.c()) {\n            if (this.gamemode == EnumGamemode.SPECTATOR) {\n                return false;\n            }\n            if (!this.player.dk()) {\n                final ItemStack itemstack2 = this.player.getItemInMainHand();\n                if (itemstack2.isEmpty()) {\n                    return false;\n                }\n                if (!itemstack2.a(block2)) {\n                    return false;\n                }\n            }\n        }\n        this.world.a(this.player, 2001, blockposition, Block.getCombinedId(iblockdata));\n        this.world.captureDrops = new ArrayList<EntityItem>();\n        final boolean flag = this.c(blockposition);\n        if (event.isDropItems()) {\n            for (final EntityItem item : this.world.captureDrops) {\n                this.world.addEntity(item);\n            }\n        }\n        this.world.captureDrops = null;\n        if (this.isCreative()) {\n            this.player.playerConnection.sendPacket(new PacketPlayOutBlockChange(this.world, blockposition));\n        }\n        else {\n            final ItemStack itemstack3 = this.player.getItemInMainHand();\n            final ItemStack itemstack4 = itemstack3.isEmpty() ? ItemStack.a : itemstack3.cloneItemStack();\n            final boolean flag2 = this.player.hasBlock(iblockdata);\n            if (!itemstack3.isEmpty()) {\n                itemstack3.a(this.world, iblockdata, blockposition, this.player);\n            }\n            if (flag && flag2 && event.isDropItems()) {\n                iblockdata.getBlock().a(this.world, this.player, blockposition, iblockdata, tileentity2, itemstack4);\n            }\n        }\n        if (flag && event != null) {\n            iblockdata.getBlock().dropExperience(this.world, blockposition, event.getExpToDrop(), this.player);\n        }\n        return flag;\n    }复制代码\n"
        },
        {
            "author": "mc能吃吗",
            "timestamp": 1572071040,
            "txt_content": "吕易天 发表于 2019-10-26 13:49\n设置了Type以后取消事件就行了，你需要看看PlayerInteractManager里面的东西:\n不行 依旧无效。是e.setCancelled(true);吗？\n我把源码发上来\npackage qq2159116373;\n\n\nimport java.io.File;\n\nimport org.bukkit.Material;\nimport org.bukkit.block.Block;\nimport org.bukkit.event.EventHandler;\nimport org.bukkit.event.Listener;\nimport org.bukkit.event.block.BlockBreakEvent;\nimport org.bukkit.event.block.BlockDamageEvent;\nimport org.bukkit.inventory.ItemStack;\nimport org.bukkit.inventory.meta.ItemMeta;\nimport org.bukkit.plugin.java.JavaPlugin;\n\npublic class SK extends JavaPlugin implements Listener {\n\n    @Override\n    public void onEnable() {\n        super.onEnable();\n        \n        if(!getDataFolder().exists()) \n        {\n        getDataFolder().mkdir();\n        }\n        File file=new File(getDataFolder(),\"config.yml\");\n        if (!(file.exists())) {saveDefaultConfig();}\n        reloadConfig();\n        getLogger().info(\"插件已加载，by mo_java30433\");\n        getLogger().info(\"当前版本0.0.1\");\n        getServer().getPluginManager().registerEvents(this, this);\n        if (true == this.getConfig().getBoolean(\"debug\")) {\n            getLogger().info(\"debug状态:开启\");\n        }\n\n    }\n\n    @Override\n    public void onDisable() {\n        getLogger().info(\"插件已关闭，by mo_java30433\");\n    }\n\n    @EventHandler()\n    public void mo(BlockBreakEvent e) {\n        if (true == this.getConfig().getBoolean(\"debug\")) {\n            getLogger().info(\"成功触发事件\");\n        }\n        Block b = e.getBlock();\n        \n        int bx = b.getX();\n        int by = b.getY();\n        int bz = b.getZ();\n        \n        if (b.getWorld().getBlockAt(bx, by - 1, bz).getType() == Material.BEDROCK) {\n            \n            if (true == this.getConfig().getBoolean(\"debug\")) {\n                getLogger().info(\"成功判断方块\");\n            }\n            \n            if (e.getBlock().getLocation().getWorld().getName().equalsIgnoreCase(\"bskyblock_world\")) {\n                if (true == this.getConfig().getBoolean(\"debug\")) {\n                    getLogger().info(\"正确的世界\");\n                }\n                double r = (double)(1.0+Math.random()*(100.0-1+1));\n                //1\n                if (r <= 12.0 && r > 0.0) {\n                    e.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.COAL_ORE);\n                    e.setCancelled(true);\n                }\n                //2\n                if (r <= 12.5 && r > 12.0) {\n                    e.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.DIAMOND_ORE);\n                    e.setCancelled(true);\n                }\n                //3\n                if (r <= 13.0 && r > 12.5) {\n                    e.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.EMERALD_ORE);\n                    e.setCancelled(true);\n                }\n                //4\n                if (r <= 15.0 && r > 13.0) {\n                    e.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.GOLD_ORE);\n                    e.setCancelled(true);\n                }\n                //5\n                if (r <= 23.0 && r > 15.0) {\n                    e.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.IRON_ORE);\n                    e.setCancelled(true);\n                }\n                //6\n                if (r <= 24.0 && r > 23.0) {\n                    e.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.LAPIS_ORE);\n                    e.setCancelled(true);\n                }\n                //7\n                if (r <= 25.0 && r > 24.0) {\n                    e.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.REDSTONE_ORE);\n                    e.setCancelled(true);\n                }\n                //8\n                if (r <= 25.1 && r > 25.0) {\n                    e.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.OBSIDIAN);\n                    e.setCancelled(true);\n                }\n                //end\n                if (r <= 100 && r > 25.1) {\n                    e.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.COBBLESTONE);\n                    if (true == this.getConfig().getBoolean(\"debug\")) {\n                        getLogger().info(\"放置了原石\");\n                        e.setCancelled(true);\n                    }\n                }\n                \n            }\n            \n            if (e.getBlock().getLocation().getWorld().getName().equalsIgnoreCase(\"bskyblock_world_nether\")) {\n                \n                if (true == this.getConfig().getBoolean(\"debug\")) {\n                    getLogger().info(\"正确的世界\");\n                }\n                \n                double r = (double)(1.0+Math.random()*(100.0-1+1));\n                //1\n                if (r <= 3.0 && r > 0.0) {\n                    e.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.NETHER_QUARTZ_ORE);\n                    e.setCancelled(true);\n                }\n                //2\n                if (r <= 6.0 && r > 3.0) {\n                    e.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.GLOWSTONE);\n                    e.setCancelled(true);\n                }\n                //3\n                if (r <= 7.0 && r > 6.0) {\n                    e.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.SOUL_SAND);\n                    e.setCancelled(true);\n                }\n                //4\n                if (r <= 100.0 && r > 7.0) {\n                    e.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.NETHERRACK);\n                    e.setCancelled(true);\n                }\n                \n            }\n            \n            if (e.getBlock().getLocation().getWorld().getName().equalsIgnoreCase(\"bskyblock_world_the_end\")) {\n                \n                if (true == this.getConfig().getBoolean(\"debug\")) {\n                    getLogger().info(\"正确的世界\");\n                }\n        \n                e.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.END_STONE);\n                e.setCancelled(true);\n            }\n        }\n    }\n    \n    @EventHandler()\n    public void bk(BlockDamageEvent e) {\n        \n        ItemStack i = e.getItemInHand();\n        ItemMeta im = i.getItemMeta();\n        if (im.getDisplayName().equals(\"破坏器\")) {\n            if (e.getBlock().getType() == Material.BEDROCK) {\n            e.getBlock().getWorld().getBlockAt(e.getBlock().getLocation()).setType(Material.AIR);\n            }\n        }\n        \n    }\n}\n复制代码"
        },
        {
            "author": "吕易天",
            "timestamp": 1572074340,
            "txt_content": "mc能吃吗 发表于 2019-10-26 14:24\n不行 依旧无效。是e.setCancelled(true);吗？\n我把源码发上来\n你这代码没问题啊，我这里测试运行了一下"
        },
        {
            "author": "吕易天",
            "timestamp": 1572075420,
            "txt_content": " 本帖最后由 吕易天 于 2019-10-26 15:40 编辑 \nmc能吃吗 发表于 2019-10-26 14:24\n不行 依旧无效。是e.setCancelled(true);吗？\n我把源码发上来\n如果不行的话可能是你的事件优先级太高了，所以别的插件处理了这个事件，你可以试试@EventHandler(priority=EventPriority.HIGHEST)\n（顺便一提，Bukkit的事件优先级的意思不是通常的先处理的意思，而是反过来，优先级越高越后处理，那么setCancelled的时候就会优先听它的）"
        },
        {
            "author": "mc能吃吗",
            "timestamp": 1572075900,
            "txt_content": "吕易天 发表于 2019-10-26 15:19\n你这代码没问题啊，我这里测试运行了一下\n我这有问题 问题还挺大 似乎是只有矿物才生成\n原石就不生成"
        },
        {
            "author": "吕易天",
            "timestamp": 1572081900,
            "txt_content": "mc能吃吗 发表于 2019-10-26 15:45\n我这有问题 问题还挺大 似乎是只有矿物才生成\n原石就不生成\n原因就是你把取消事件的语句放入了if(debug)里面"
        }
    ]
}