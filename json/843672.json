{
    "title": "(有解决方案)行为验证再次刷不出来",
    "author": "langyo",
    "replyCount": 10,
    "timestamp": 1549659900,
    "txt_content": "试过 Ctrl + F5，试过代理，没用\n\n死活刷不出来\n\n不过我还能从中看出更具体的一些问题\n\n\n\n如上图所示，控制台报错的来源是 geetest 验证码的预加载脚本，提示的是 JSON 解析出了问题\n\n\n\n我先追踪到了报错的 HTML 部分，第一行其实并没有啥毛病，就一句小萝莉自己加的注释\n\n但或许问题就出在这呢？也许是不是该考虑下把注释移动下位置？或者删掉？\n\n\n\n我又追踪到了报错的 JS 部分，发现这是服务器返回的数据出了问题\n这是真得修了\n\n\n\n已确认本人的网络没有问题，下载数据无误\n\n\n\n因为这验证码问题，我估计又有许多人因登不上论坛而被憋得一句话说不出来……\n\n重开防御脚本副作用就是大啊……\n\n@gamerteam @混乱 \n\n\n\n致普通用户：\n\n请参考此贴解决问题\n（我不是故意成为标题党的，茶馆帖子不会出现在论坛版头，所以只能以这种方式尽可能告诉大家这个问题啦）\n\n(P.S. @SPGoding 你不是说你有坑的咩！怎么又跑出来秀操作啦！(╯‵□′)╯︵┻━┻)\n",
    "replies": [
        {
            "author": "langyo",
            "timestamp": 1549660620,
            "txt_content": "额外补充一下（开保护脚本时编辑实在难受，干脆直接回复）\n\n\n\n是个明白人应该都看得懂什么了吧\n\n我建议的解决方案有两种：\n1. 关闭对链接 /plugin\\.php\\?id=geetest3&model=start&t=([0-9]+)/ （←这是正则表达式，可直接拿去用）的屏蔽，这个需要改写论坛的 PHP 脚本\n检查一下浏览器发来的 href 又费不了多大事，时间成本和防御脚本生成个随机字串返回是差不多的，不会至于让论坛宕机\n\n2. 修改 gt3-init.js（不太建议）\n改一下脚本，让脚本检测一下返回的是 JSON 还是 HTML，如果是 HTML 就提取其中的随机字串并再次向页面发送请求\n有点费事，如果 PHP 改不了，就改 JS"
        },
        {
            "author": "langyo",
            "timestamp": 1549661640,
            "txt_content": " 本帖最后由 langyo 于 2019-2-9 05:38 编辑 \n\n额外再提一句，有关修复论坛开防御脚本时的一劳永逸的无法评分/保存帖子/回复帖子等的解决方案\n\n（这里只是暂时粗略提一下，不提供修复代码）\n\n（或许哪天我有时间，就直接往公告版发可直接复制粘贴的修复代码了呢？）\n\n\n\n修复的关键其实在于正确处理 ajax 请求\n\n在开防御脚本的情况下，浏览器打开由论坛返回的 HTML 文件时，由于自动执行脚本，所以能够成功访问论坛\n\n而当浏览器根据 HTML 文件指向的附属资源（或用户主动请求，例如评分）向论坛发送请求时，使用的 Ajax 是无法像刚刚那样能自动执行脚本的\n\n说白了，解决方案就是改写 Ajax 脚本，把它包装一下，在正式解析返回的数据前先确定下这是防御脚本产生的随机字符串还是真实数据；当发现是防御脚本时，自行重置自己，先执行防御脚本提供的随机字符串，再重新发送 Ajax 请求\n\n其实……原理似乎已经说的很透彻了……吧？\n\n哦还有，产生 Ajax 请求的应该不止这一个脚本，除了 ajax.js 里的以外， geetest 验证码服务的 ajax 与 Discuz！ 自己的 ajax 是分开的，两边都要考虑下……以及，Discuz！ 本身也不止 ajax.js 这一个产生 ajax 请求的脚本"
        },
        {
            "author": "xmdhs",
            "timestamp": 1549682700,
            "txt_content": "这个防御脚本太暴力了。。。\n\n几乎所有请求都得允许那个 js 才行。\n\n不能换换别的吗，比如类似于 cloudflare 的5秒盾"
        },
        {
            "author": "roj234",
            "timestamp": 1549685400,
            "txt_content": " 本帖最后由 roj234 于 2019-2-9 12:12 编辑 \n\n其实和注释并没关系，只是F12不知道错误到底在哪所以显示【当前页面地址:1】\n一般:1都是不知道在哪,比如闭包函数(function(){})();和以前的setInterval有时页面加载完毕之后打开F12也会这样\n"
        },
        {
            "author": "鬼畜畜",
            "timestamp": 1549686360,
            "txt_content": "Discuz自带一大票CC防御，不过论坛并没有开启的打算。\n\n其实挂个CDN也行啊，设置好100%回源+CNAME负载均衡"
        },
        {
            "author": "gamerteam",
            "timestamp": 1549700400,
            "txt_content": "和注释没关系，不用猜了的\n脚本只是临时的，过年期间主运维放假了，临时凑合用用。\n后面已经在调整这方面的内容了"
        },
        {
            "author": "。—。",
            "timestamp": 1549723200,
            "txt_content": "roj234 发表于 2019-2-9 12:10\n其实和注释并没关系，只是F12不知道错误到底在哪所以显示【当前页面地址:1】\n一般:1都是不知道在哪,比如闭 ...\n显示第一行是因为服务器返回的源代码被 tenginx 之类的优化压缩过，需要格式化的话进 Source 里自动格式化再回去就能看到行号，不过要是只登的话咱一个月之前的那个脚本应该一直能用，因为http://www.mcbbs.net/forum.php和http://www.mcbbs.net/portal.php这两个位置从服务器拉 token 都是照搬官方 demo 手动拼参数，和签到入口那边连对象名都一模一样，可以直接用……"
        },
        {
            "author": "xiaopangju",
            "timestamp": 1550020140,
            "txt_content": "我竟然真的用刷新解决了问题(??ω`?)\n\n\n\n\n\n\nScreenshot_2019-02-13-09-07-52.png\n(315.21 KB, 下载次数: 0)\n\n\n\n\n下载附件\n\n\n2019-2-13 09:08 上传\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"
        },
        {
            "author": "langyo",
            "timestamp": 1550020680,
            "txt_content": "冰川橘子 发表于 2019-2-13 09:09\n我竟然真的用刷新解决了问题(??ω`?)\n论坛昨天下午 1 点已经关闭了防御，所以你刷新也能看到验证码了……"
        },
        {
            "author": "xiaopangju",
            "timestamp": 1550031780,
            "txt_content": "langyo 发表于 2019-2-13 09:18\n论坛昨天下午 1 点已经关闭了防御，所以你刷新也能看到验证码了……\n管理员2月7号回复的我，当时还是刷不出来的，但是我都按了很多回才刷出来，但是我手贱，又按了一下，又不见了，不知道循环了多少遍，我才登进来"
        }
    ]
}