{
    "title": "[45w#65]爬",
    "author": "45gfg9",
    "replyCount": 14,
    "timestamp": 1582968360,
    "txt_content": " 本帖最后由 45gfg9 于 2020-2-29 18:32 编辑 \n\n本帖联动：「ALW#244」我写了个特别垃圾的自动翻到对应教材的程序（无聊之作\n\n教育部放出了各个教材怎么能不用呢？\n但是那个网页实在是太长，翻着找麻烦\n所以...\n看到了 然后就在想\n好巧 我也写了一个！\n但是只爬高中课本 懒得写其他的x\n作用就是把所有pdf下载到文件夹里分类\n\n\n运行环境 Python3\n\n参数：\nMAX_THREADS 最大线程数 (int)\nTEACHERS_BOOK 选择教师教学用书(bool) (False为教科书)\n\n记得pip install -U pyquery retry\nimport os\nimport time\nfrom threading import Thread\nfrom urllib import parse, request\n\nfrom retry import retry\nfrom pyquery import PyQuery as pq\n\nimport ssl\nssl._create_default_https_context = ssl._create_unverified_context\ndel ssl\n\nTEACHERS_BOOK = False\nMAX_THREADS = 16\n\nbooks_pending = []\nthreads_running = []\nbooks_failed = []\n\nFOLDER_NAME = 'books'\nos.makedirs(FOLDER_NAME, exist_ok=True)\nos.chdir(FOLDER_NAME)\n\nend = False\n\ndef downloadManager():\n    while True:\n        while books_pending and len(threads_running) < MAX_THREADS:\n            furl, subj, fname = books_pending.pop(0)\n            thread = Thread(target=download, args=(furl, subj, fname))\n            thread.start()\n            threads_running.append(thread)\n        if threads_running:\n            for thread in threads_running:\n                if not thread.is_alive():\n                    threads_running.remove(thread)\n        if end and not books_pending and not threads_running:\n            break\n        time.sleep(0.1)\n\ndef download(url, subj, bname):\n    ERRORS = (ConnectionError, OSError)\n    @retry(ERRORS, tries=3)\n    def idw():\n        print('Downloading', bname)\n        request.urlretrieve(url, filename=f'{subj}/{bname}.pdf')\n        print('Downloaded', bname)\n\n    try:\n        idw()\n    except ERRORS:\n        print(f'Download {bname} failed.')\n        books_failed.append(bname)\n\ndef main():\n    global end\n    url = 'https://bp.pep.com.cn/jc/'\n    print('Starting download manager thread')\n    dmgr = Thread(target=downloadManager)\n    dmgr.start()\n\n    try:\n        doc = pq(str(request.urlopen(url).read(), encoding='utf-8'))\n        rootDiv = doc('div.list_sjzl_jcdzs2020')[6]\n        uls = rootDiv.findall('ul')\n        lis = map(lambda e: e.findall('li')[1 if TEACHERS_BOOK else 0], uls)\n        tas = map(lambda e: e.find('a'), lis)\n        uris = map(lambda e: (e.text, e.get('href')), tas)\n\n        for typ, uri in uris:\n            os.makedirs(typ, exist_ok=True)\n            surl = parse.urljoin(url, uri)\n            sub = pq(str(request.urlopen(surl).read(), encoding='utf-8'))\n            uls = sub('ul')\n            for ul in uls:\n                lis = ul.findall('li')\n                ats = map(lambda e: e.find('a').get('title'), lis)\n                divs = map(lambda e: e.find('div'), lis)\n                buris = map(lambda e: e.findall('a')[1].get('href'), divs)\n                for at, buri in zip(ats, buris):\n                    dest = parse.urljoin(surl, buri)\n                    books_pending.append((dest, typ, at))\n    finally:\n        end = True\n        dmgr.join()\n\nif __name__ == '__main__':\n    main()\n\n运行方法：复制粘贴到py文件里运行\n啥？你想要exe？\n没有 懒得打包（跑）\n不要吐槽，我是垃圾\n\n",
    "replies": [
        {
            "author": "心愿愿",
            "timestamp": 1582968480,
            "txt_content": "你们怎么都会写程序的\n也许我应该去学一下py了（X)\n\n发光的木板（X\n发光的箱子（√"
        },
        {
            "author": "mohui666",
            "timestamp": 1582968540,
            "txt_content": "发光的木板"
        },
        {
            "author": "小丛雨",
            "timestamp": 1582968840,
            "txt_content": "发光木板+1"
        },
        {
            "author": "依喏嗨~",
            "timestamp": 1582969020,
            "txt_content": "不说了都是真大佬，感谢大佬的资源了！"
        },
        {
            "author": "索菲缇娅",
            "timestamp": 1582970820,
            "txt_content": "我想写个C#版的..."
        },
        {
            "author": "草",
            "timestamp": 1582971540,
            "txt_content": "爬草\n虽说我用不着.."
        },
        {
            "author": "莉莉霍瓦特",
            "timestamp": 1582971780,
            "txt_content": "都给我爬！"
        },
        {
            "author": "w841488655",
            "timestamp": 1582971840,
            "txt_content": "发光木板可以"
        },
        {
            "author": "Оil",
            "timestamp": 1582982580,
            "txt_content": "在？\n\n选项为什么没有45可爱？【恼】"
        },
        {
            "author": "樱千落妖精",
            "timestamp": 1582983240,
            "txt_content": "不愧是大佬，解决了我没有课本的困难"
        },
        {
            "author": "Maki_Best",
            "timestamp": 1582983480,
            "txt_content": "…签名档好评。"
        },
        {
            "author": "42313123123123",
            "timestamp": 1582983720,
            "txt_content": "樱千落妖精 发表于 2020-2-29 21:34\n不愧是大佬，解决了我没有课本的困难\n我们发了课本"
        },
        {
            "author": "天空的大楼",
            "timestamp": 1582983960,
            "txt_content": "哈，看来这程序还是个奇怪的程序，我现在还不是能看明白代码的人。只选了c。"
        },
        {
            "author": "柒日良",
            "timestamp": 1584675480,
            "txt_content": "大佬的無聊之作果然就是不同級別……"
        }
    ]
}