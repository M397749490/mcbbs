{
    "title": "[1.13] 如何正确地使用 Brigadier",
    "author": "sjx",
    "replyCount": 1,
    "timestamp": 1525077240,
    "txt_content": "本教程基于 Minecraft 18w16a，假设读者有一定的 Java 基础\n1.13 采用了新的命令解析系统——Brigadier\n它是一个独立的库，没有被混淆，并可以在 ./libraries/com/mojang/brigadier/version/ 下找到\n命令系统基础可以看 @ustc_zzzz （没蓝？！）dalao 的稀里糊涂的commands.json全解析\nSo，如何正确地使用 Brigadier 呢？\n首先看看它的目录结构：\n\ncom.mojang.brigadier.arguments 下面有一些参数类型；com.mojang.brigadier.builder 下面是几个 builder，一会儿会讲到；com.mojang.brigadier.tree 下面是命令的节点；com.mojang.brigadier 下面的 CommandDispatcher 就是整个命令系统的核心，所以 new 一个 CommandDispatcher 实例是很关键的（什么神逻辑）CommandDispatcher<Object> dispatcher = new CommandDispatcher<>();复制代码看起来那个类型参数是表示执行者的类，这里就用 Object 代替了\n首先明确一下目标：\nreturn <result>：返回参数 result，但只接受 -32768 到 32767 之间的整数\nsum <a> <b>：返回参数 a，b 之和，溢出时抛异常\n当然如果要添加其他命令的话，自己发挥吧\n接着看 CommandDispatcher 的结构：\n\n有个 register(LiteralArgumentBuilder<S>) 很显眼（Really？），用于加入新的命令，而 LiteralArgumentBuilder 就是这个命令了，可见其实命令是作为第一个参数处理的\nLiteralArgumentBuilder 是 ArgumentBuilder 的子类，有一个 public static 的方法 literal(String)，用它获取一个实例；ArgumentBuilder 提供了很多方法构造一条命令，比如 then(ArgumentBuilder<S, ?>) 添加参数，executes(Command<S>) 指定命令执行的内容等\n说到 Command，不得不提一下这个 interface 里面唯一的方法 public int run(CommandContext<S> var1) throws CommandSyntaxException;，它接受一个 CommandContext<S> 参数，返回 int，可抛 CommandSyntaxException（真是绝妙的设计）\n所以经过一番摸索之后，我们得到了这样的代码：public static final SimpleCommandExceptionType ERROR_INTEGER_OVERFLOW = new SimpleCommandExceptionType(\"command.int.overflow\", \"Integer overflow\");复制代码dispatcher.register(LiteralArgumentBuilder.literal(\"return\").then(RequiredArgumentBuilder.argument(\"result\", IntegerArgumentType.integer(-32768, 32767)).executes(context -> context.getArgument(\"result\", Integer.class))));\ndispatcher.register(LiteralArgumentBuilder.literal(\"sum\").then(RequiredArgumentBuilder.argument(\"a\", IntegerArgumentType.integer()).then(RequiredArgumentBuilder.argument(\"b\", IntegerArgumentType.integer()).executes(context -> {\n    int a = context.getArgument(\"a\", Integer.class);\n    int b = context.getArgument(\"b\", Integer.class);\n    int r = a + b;\n    if (((a ^ r) & (b ^ r)) < 0) throw ERROR_INTEGER_OVERFLOW.create();\n    return r;\n}))));复制代码测试一下效果：testCommand(dispatcher, \"return 233\", null);\ntestCommand(dispatcher, \"return 2147483647\", null);\ntestCommand(dispatcher, \"sum 233 1\", null);\ntestCommand(dispatcher, \"sum 2147483647 1\", null);复制代码private static <S> void testCommand(CommandDispatcher<S> dispatcher, String input, S source) {\n    try {\n        System.out.println(dispatcher.execute(input, source));\n    } catch (CommandSyntaxException e) {\n        e.printStackTrace();\n    }\n}复制代码输出：233\ncom.mojang.brigadier.exceptions.CommandSyntaxException: Integer must not be more than 32767, found 2147483647 at position 7: return <--[HERE]\n        at com.mojang.brigadier.exceptions.ParameterizedCommandExceptionType.createWithContext(ParameterizedCommandExceptionType.java:46)\n        at com.mojang.brigadier.arguments.IntegerArgumentType.parse(IntegerArgumentType.java:59)\n        at com.mojang.brigadier.arguments.IntegerArgumentType.parse(IntegerArgumentType.java:12)\n        at com.mojang.brigadier.tree.ArgumentCommandNode.parse(ArgumentCommandNode.java:56)\n        at com.mojang.brigadier.CommandDispatcher.parseNodes(CommandDispatcher.java:191)\n        at com.mojang.brigadier.CommandDispatcher.parseNodes(CommandDispatcher.java:219)\n        at com.mojang.brigadier.CommandDispatcher.parse(CommandDispatcher.java:164)\n        at com.mojang.brigadier.CommandDispatcher.execute(CommandDispatcher.java:75)\n        at com.sjx233.brigadier.example.BrigadierExample.testCommand(BrigadierExample.java:40)\n        at com.sjx233.brigadier.example.BrigadierExample.main(BrigadierExample.java:33)\n234\ncom.mojang.brigadier.exceptions.CommandSyntaxException: Integer overflow\n        at com.mojang.brigadier.exceptions.SimpleCommandExceptionType.create(SimpleCommandExceptionType.java:28)\n        at com.sjx233.brigadier.example.BrigadierExample.lambda$1(BrigadierExample.java:28)\n        at com.mojang.brigadier.CommandDispatcher.execute(CommandDispatcher.java:136)\n        at com.mojang.brigadier.CommandDispatcher.execute(CommandDispatcher.java:76)\n        at com.sjx233.brigadier.example.BrigadierExample.testCommand(BrigadierExample.java:40)\n        at com.sjx233.brigadier.example.BrigadierExample.main(BrigadierExample.java:35)复制代码Brigadier 还有很多功能，比如命令的自动补全，如果你感兴趣的话，可以自己反编译探索一下（其实是作者懒）",
    "replies": [
        {
            "author": "2427352694",
            "timestamp": 1525183020,
            "txt_content": "MCBBS有你更精彩~"
        }
    ]
}