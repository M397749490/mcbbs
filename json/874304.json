{
    "title": "[未解决] 在代码中,如何让插件重新加载配置文件？",
    "author": "mcbzhu",
    "replyCount": 12,
    "timestamp": 1560756600,
    "txt_content": "情景：某管理员 修改了config.yml配置文件, 但是他觉得重启服务器 来重新加载插件 很麻烦，也很消耗时间。    于是他想问：\n    怎么才能实现在游戏中,通过输入指令/reload 插件名   或者 /插件名 reload   来实现这个功能。\n\n现在他在主类中重写了onCommand()方法，并且注册了命令 /bs\n\n@Override\n\npublic boolean onCommand(CommandSender sender , Command command , String label , String[] args){\n     // 判断输入的指令是否是 /bs\n     if(command.getName().equals(\"/bs\")){\n\n           // 这里要如何重新加载配置文件？\n\n     }\n}\n\n复制代码",
    "replies": [
        {
            "author": "星",
            "timestamp": 1560757200,
            "txt_content": "如果仅仅是重载config.yml的话\n可以直接使用自带的一些方法\n比如saveConfig();保存\nreloadConfig();重载"
        },
        {
            "author": "mcbzhu",
            "timestamp": 1560761040,
            "txt_content": "小星啊啊啊 发表于 2019-6-17 15:40\n如果仅仅是重载config.yml的话\n可以直接使用自带的一些方法\n比如saveConfig();保存\n重载整个插件 有没有什么方式？"
        },
        {
            "author": "星",
            "timestamp": 1560761220,
            "txt_content": "mcbzhu 发表于 2019-6-17 16:44\n重载整个插件 有没有什么方式？\n整个插件? 你是说其他的配置文件么"
        },
        {
            "author": "mcbzhu",
            "timestamp": 1560761520,
            "txt_content": "小星啊啊啊 发表于 2019-6-17 16:47\n整个插件? 你是说其他的配置文件么\n算了 我还是问 这个config.yml 怎么重载吧....直接写reloadConfig() 吗？"
        },
        {
            "author": "mcbzhu",
            "timestamp": 1560762420,
            "txt_content": "mcbzhu 发表于 2019-6-17 16:52\n算了 我还是问 这个config.yml 怎么重载吧....直接写reloadConfig() 吗？\n不行啊 没有效果"
        },
        {
            "author": "mcbzhu",
            "timestamp": 1560762480,
            "txt_content": "小星啊啊啊 发表于 2019-6-17 15:40\n如果仅仅是重载config.yml的话\n可以直接使用自带的一些方法\n比如saveConfig();保存\n不行呀 没有效果"
        },
        {
            "author": "mcbzhu",
            "timestamp": 1560763020,
            "txt_content": "求大佬帮忙啊啊 啊啊"
        },
        {
            "author": "lgou2w",
            "timestamp": 1560816120,
            "txt_content": "使用 reloadConfig() 是没有错的，但是你获取配置的地方要通过插件实例 getConfig().getXXX 来获取的。也就是当你调用 reloadConfig() 插件父类内部会自动重载配置然后重新赋值内部的 config 对象，那么你使用的地方再 getConfig 就能获取到重载后的数据了。"
        },
        {
            "author": "mcbzhu",
            "timestamp": 1560819120,
            "txt_content": "lgou2w 发表于 2019-6-18 08:02\n使用 reloadConfig() 是没有错的，但是你获取配置的地方要通过插件实例 getConfig().getXXX 来获取的。也就 ...\n我在监听器里myListener边传了 一个JavaPlugin 对象，也就是那个继承了JavaPlugin的主类。然后在监听器里边写的\n\nprivate FileConfiguration config;\nprivate JavaPlugin plgin;\npublic MyListener(JavaPlugin plugin){\n     this.plugin = plugin;\n     this.config = plugin.getCofig();\n}\n复制代码\n\n但是这样就不行啊"
        },
        {
            "author": "lgou2w",
            "timestamp": 1560819420,
            "txt_content": "mcbzhu 发表于 2019-6-18 08:52\n我在监听器里myListener边传了 一个JavaPlugin 对象，也就是那个继承了JavaPlugin的主类。然后在监听器里 ...\n你这样设计的话，当你 reloadConfig 之后，你这个监听器类的 config 对象还是之前的啊。你这个类只需要通过 plugin.getConfig().getXXX 调用就行了，命令那里 plugin.reloadConfig 就行了。"
        },
        {
            "author": "mcbzhu",
            "timestamp": 1560819720,
            "txt_content": "lgou2w 发表于 2019-6-18 08:57\n你这样设计的话，当你 reloadConfig 之后，你这个监听器类的 config 对象还是之前的啊。你这个类只需要通 ...\n我解决了 我把config获取值写到下边的事件监听的方法里了。感谢老哥"
        },
        {
            "author": "吕易天",
            "timestamp": 1586259840,
            "txt_content": " 本帖最后由 吕易天 于 2020-4-7 20:03 编辑 \n\n这个不仅会重载配置文件还会重载class\nboolean reloadlisteners = true;\nBukkit.getPluginManager().disablePlugin(this);\ntry {\nField pluginsField = Bukkit.getPluginManager().getClass().getDeclaredField(\"plugins\");\npluginsField.setAccessible(true);\nList<Plugin> plugins = (List<Plugin>)pluginsField.get(pluginManager);\nField lookupNamesField = Bukkit.getPluginManager().getClass().getDeclaredField(\"lookupNames\");\nlookupNamesField.setAccessible(true);\nMap<String, Plugin> names = (Map<String, Plugin>)lookupNamesField.get(pluginManager);\nMap<Event, SortedSet<RegisteredListener>> listeners = null;\ntry {\n                    Field listenersField =  Bukkit.getPluginManager().getClass().getDeclaredField(\"listeners\");\n                    listenersField.setAccessible(true);\n                    listeners = (Map<Event, SortedSet<RegisteredListener>>)listenersField.get(pluginManager);\n                }\n                catch (Exception e3) {\n                    reloadlisteners = false;\n                }\nField commandMapField = Bukkit.getPluginManager().getClass().getDeclaredField(\"commandMap\");\ncommandMapField.setAccessible(true);\nSimpleCommandMap commandMap = (SimpleCommandMap)commandMapField.get(pluginManager);\nField knownCommandsField = SimpleCommandMap.class.getDeclaredField(\"knownCommands\");\nknownCommandsField.setAccessible(true);\nMap<String, Command> commands = (Map<String,Command>)knownCommandsField.get(commandMap);\nif(plugins!=null)\n  plugins.remove(this);\nif(names!=null)\n  names.remove(this.getName());\nif (listeners != null && reloadlisteners) {\n            for (SortedSet<RegisteredListener> set : listeners.values()) {\n                Iterator<RegisteredListener> it = set.iterator();\n                while (it.hasNext()) {\n                    RegisteredListener value = it.next();\n                    if (value.getPlugin() == this) {\n                        it.remove();\n                    }\n                }\n            }\n        }\n\nif (commandMap != null) {\n            Iterator<Map.Entry<String, Command>> it2 = commands.entrySet().iterator();\n            while (it2.hasNext()) {\n                Map.Entry<String, Command> entry = it2.next();\n                if (entry.getValue() instanceof PluginCommand) {\n                    PluginCommand c = (PluginCommand)entry.getValue();\n                    if (c.getPlugin() != this) {\n                        continue;\n                    }\n                    c.unregister((CommandMap)commandMap);\n                    it2.remove();\n                }\n            }\n        }\n\nClassLoader cl = this.getClass().getClassLoader();\n        if (cl instanceof URLClassLoader) {\n            try {\n                Field pluginField = cl.getClass().getDeclaredField(\"plugin\");\n                pluginField.setAccessible(true);\n                pluginField.set(cl, null);\n                Field pluginInitField = cl.getClass().getDeclaredField(\"pluginInit\");\n                pluginInitField.setAccessible(true);\n                pluginInitField.set(cl, null);\n            }\n            catch (NoSuchFieldException | SecurityException | IllegalArgumentException | IllegalAccessException ex4) {\n                Logger.getLogger(PluginUtil.class.getName()).log(Level.SEVERE, null, ex4);\n            }\n            try {\n                ((URLClassLoader)cl).close();\n            }\n            catch (IOException ex2) {\n                Logger.getLogger(PluginUtil.class.getName()).log(Level.SEVERE, null, ex2);\n            }\n        }\n\nSystem.gc();\nPlugin target = null;\nFile pluginDir = new File(\"plugins\");\nif (!pluginDir.isDirectory())\n  return true;\nFile pluginFile = null;\ntry{\nField tempFile=this.getClass().getDeclaredField(\"file\");\ntempFile.setAccessible(true);\npluginFile=(File)tempFile.get(this);\n}catch(Throwable e){e.printStackTrace();return true;}\nif(!pluginFile.exists() || !pluginFile.isFile())  return true;\ntry {\n            target = Bukkit.getPluginManager().loadPlugin(pluginFile);\n        }\n        catch (InvalidDescriptionException e) {\n            e.printStackTrace();\n            return true;\n        }\n\n    catch (InvalidPluginException e2) {\n            e2.printStackTrace();\n            return true;\n        }\n\ntarget.onLoad();\nBukkit.getPluginManager().enablePlugin(target);\n\nreturn true;\n            }\n            catch (NoSuchFieldException e) {\n                e.printStackTrace();\n                return true;\n            }\n\n           catch (IllegalAccessException e2) {\n                e2.printStackTrace();\n                return true;\n            }"
        }
    ]
}