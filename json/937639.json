{
    "title": "袭击(raid)机制&袭击中心坐标转移算法",
    "author": "Air_Z",
    "replyCount": 10,
    "timestamp": 1578033060,
    "txt_content": " 本帖最后由 Air_Z 于 2020-1-3 14:37 编辑 \n\n参见GP大佬专栏：\n\nhttps://www.bilibili.com/read/cv2817629\n\n最近搞到了源码，有许多缺失，但足够做机制分析了。我综合GP的机制总结，具体实验以及源码，把袭击机制和袭击中心坐标算法介绍一下。\n\n\n0.前置说明\n\n0.1.村民方块\n       如床，工作方块，钟为村民方块。被村民认领后，工作方块处于占据状态。\n\n0.2.村庄区段（villageSections）\n\n       方块，区段，区块参见：\nhttps://blog.csdn.net/silangquan/article/details/51298671\n       在加载渲染区段时，会标记以被占据村民方块所在区段（section）为中心的3*3*3的27个区段为村庄区段。\n\npic1区段坐标\n\n\n       具体算法是，读取被占据的工作方块的坐标，则将其坐标x,y,z坐标除16并向下取整（n>>4）,得到村民方块所在的区段坐标x1,y1,z1（sectionPos），标记[(x1-1,y1-1,z1-1),(x1+1,y1+1,z1+1)]区间内的区段(cube(sectionpos,1))为村庄区段，并记录缓存中（sourseCache）。\n\n1.袭击生成\n       生成条件，玩家处于村庄区段，并且玩家拥有灾厄buff，且即将生成的袭击中心96格内不存在其他袭击中心。\n       一旦开始生成时，游戏会检测玩家坐标距离64的球形范围所有的被占据村民方块的坐标，各取所有坐标x,y,z的平均值向下取整得xr,yr,zr为初始袭击中心坐标。\n\npic2\n\n\n2.袭击中心转移\n   核心代码\nprivate void moveRaidCenterToNearbyVillageSection() {\n        Stream<SectionPos> stream = SectionPos.cube(SectionPos.of(this.center), 2);\n        stream.filter(this.level::isVillage).map(SectionPos::center).min(Comparator.comparingDouble(blockPos -> blockPos.distSqr(this.center))).ifPresent(this::setCenter);\n    }复制代码\n\n\n游戏每tick会检测袭击中心坐标（xr,yr,zr）是否处于村庄区段，若不在村庄区段内，则检测以袭击中心坐标所在区段为中心的5*5*5的125个区段中的所有村庄区段，并获得这些区段的中心方块坐标（x'1,y'1,z'1;x'2,y'2,z'2;...）。如区段坐标为（0，0，0），则其中心方块坐标为（（2*0+1）*8，8，8）\n       将（x'1,y'1,z'1;x'2,y'2,z'2;...）的坐标加上0.5变成（x'1+0.5,y'1+0.5,z'1+0.5;x'2+0.5,y'2+0.5,z'2+0.5;...），游戏会计算袭击中心（xr,yr,zr）与（x'1+0.5,y'1+0.5,z'1+0.5;x'2+0.5,y'2+0.5,z'2+0.5;...）的距离，获得距离的最小值所代表的村庄区段的中心方块坐标，然后将袭击中心转移到该中心方块坐标。\n       这关键的坐标+0.5就造成了我之前遇到的问题：\nhttps://www.mcbbs.net/thread-930319-1-1.html\n计算这个距离的方法是定义在vec3i类里面的，其中还有另一个选项是不加0.5。所以我个人的猜测+0.5是为了避免获得两个相同的距离而设定的。\n       比如，袭击中心为（0，0，0），现在有两个村庄区段（0，-2，0）和（0，2，0），其中心方块坐标为（8，-40，8）和（8，40，8），如果不+0.5，那么这两个坐标和袭击中心坐标距离都一样，就有两个最近的坐标。为了只筛选出一个，就默认+0.5，那么（8，-39.5，8）就比（8，40.5，8）更近了。\n       所以，转移后的袭击中心都在区段中心。\n\n\npic3\n\n\nps:此算法根据源码总结而来，源码将之拆分为许多部分。\n\n\n3.袭击进度条瞬间终止，袭击失败，袭击胜利\n\n       袭击进度条瞬间终止条件：\n1）第一波加载袭击进度条过程中，袭击中心不在村庄区段，且无法转移。2）每波袭击进度条加载完毕时，没有符合条件的区域生成袭击生物。3）游戏模式变为和平模式\n\n       袭击失败条件：\n1）第一波袭击生成后，袭击中心不在村庄区段，且无法转移。\n\n       袭击胜利条件：\n2）已经加入袭击的袭击生物生物全部死亡或全被移出袭击中心112格外。\n\n4.袭击堆叠简单机制\n\n       将已经生成的袭击中心转移到玩家96格外，能再度生成并转移。\n\n5.袭击生物\n\n 本贴只讨论袭击（raid），袭击生物（raider）参见开头GP的专栏介绍。\n\n---------\n错误疏漏之处，不吝赐教。祝各位2020有用不完的绿宝石！",
    "replies": [
        {
            "author": "午夜低语",
            "timestamp": 1578039720,
            "txt_content": "你好，楼主，请问是否有在1.15.1测试过相关的数据？我这两天更新游戏后，发现1.15触发袭击的条件似乎有所变更，但由于不懂程序，查不到相关信息，之前1.14.4按https://www.bilibili.com/video/av64901309此方案做的方案，1.15已经失效"
        },
        {
            "author": "Air_Z",
            "timestamp": 1578052740,
            "txt_content": "午夜低语 发表于 2020-1-3 16:22\n你好，楼主，请问是否有在1.15.1测试过相关的数据？我这两天更新游戏后，发现1.15触发袭击的条件似乎有所变 ...\n源码是19w40a的，1.15版本。我的关于袭击的存档在1.14.4和1.15.1都能照常运行，你再检查下吧。"
        },
        {
            "author": "午夜低语",
            "timestamp": 1578104700,
            "txt_content": "Air_Z 发表于 2020-1-3 19:59\n源码是19w40a的，1.15版本。我的关于袭击的存档在1.14.4和1.15.1都能照常运行，你再检查下吧。 ...\n好的，谢谢楼主，既然源代码没改，那就是我这边存档出问题了"
        },
        {
            "author": "Doomsday_Lonely",
            "timestamp": 1578136560,
            "txt_content": "不知道 我来水贴的"
        },
        {
            "author": "Loginzz",
            "timestamp": 1578193260,
            "txt_content": "提示: 作者被禁止或删除 内容自动屏蔽"
        },
        {
            "author": "星魇雨辰",
            "timestamp": 1578297660,
            "txt_content": "做的快吐了．没有一个能用的．袭击条瞬间消失然后什么都没发生存档正常搬运都无效"
        },
        {
            "author": "xiaoye_time",
            "timestamp": 1578827580,
            "txt_content": "2b2t可以有用吗"
        },
        {
            "author": "时之虫",
            "timestamp": 1582045740,
            "txt_content": "总感觉袭击牵引会被mojang在未来的某个版本里更改算法给休掉……"
        },
        {
            "author": "a341132",
            "timestamp": 1582137060,
            "txt_content": "溜了溜了，学习了"
        },
        {
            "author": "ljrzyx",
            "timestamp": 1582170060,
            "txt_content": "感谢楼主分享！！"
        }
    ]
}