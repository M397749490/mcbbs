{
    "title": "[PCD]Metadata（元数据）的使用",
    "author": "2280761425",
    "replyCount": 3,
    "timestamp": 1565095980,
    "txt_content": " 本帖最后由 2280761425 于 2019-8-6 21:30 编辑 \n\n这东西其实很早前我就在使用了，当时懒得写使用方法就没发出来，最近有点无聊想想还是写出来吧qwq（比map好用）。\n\n要使用Metadata，我们需要用到下面的类\nMetadatable：通过doc我们可以看到有很多类实现了它（有Player等各种实体，也有Block），而Metadata的原意也是希望用这个替代map\nMetadataValue：可以通过Metadatable的getMetadata方法获取。在为Metadatable添加MetadataValue时一般是用FixedMetadataValue类\n\n使用方法：\n先获取对象的MetadataValue：metadatable.getMetadata(\"key\")，如果之前没设置过MetadataValue，还需要先使用setMetadata设置MetadataValue，如：\nplayer.setMetadata(\"键（类似map）\", new FixedMetadataValue(plugin, 要储存的数据));复制代码\n使用getMetadata后获取到的是一个List（并不知道有什么用，是区分不同插件的？希望有大佬补充），我们使用list.get(0)来获取单个元素（MetadataValue），然后用MetadataValue的value()方法获取之前加入的数据，就像这样：\nObject data = player.getMetadata(\"key\").get(0).value();复制代码\n由于获取到的对象是Object类型，还需要通过类型转换才能使用\n\n有时要储存的数据可能比较多，所以我一般是直接在MetadataValue里塞Map（直接用Metadatable的不同键也可以）\n这是我的某插件使用的代码：\n//为了便于区分，一个插件我只使用一个键，所以此方法直接返回保存的数据\npublic static Map<String, Object> getMetadata(Metadatable metadatable) {\n        checkMetadata(metadatable);\n        //获取数据\n        Object value = metadatable.getMetadata(KEY).get(0).value();\n        //类型判断，以进行安全的类型转换\n        if(value instanceof Map) {\n                return (Map<String, Object>) value;\n        }\n        \n        return null;\n}\n\n//检查Metadata是否存在，不存在则创建（值为一个空的Map）\npublic static boolean checkMetadata(Metadatable metadatable) {\n        if(metadatable.hasMetadata(KEY)) {\n                return true;\n        }\n        metadatable.setMetadata(KEY, new FixedMetadataValue(plugin, new HashMap<String, Object>()));\n        return false;\n}\n\n//这是玩家的pvp状态，可以看到使用Metadata储存，代码简单了很多\npublic static boolean isPvping(Map<String, Object> metadata) {\n        if(!metadata.containsKey(\"pvp\")) {\n                metadata.put(\"pvp\", false);\n        }\n        return (boolean) metadata.get(\"pvp\");\n}\n        \npublic static void setPvping(Map<String, Object> metadata, boolean isPvping) {\n        metadata.put(\"pvp\", isPvping);\n}复制代码\n\n注意：Metadata在服务器关闭后就会消失，要保存还需要另写代码，但是它的方便之处在于数据依附的对象销毁后它也就销毁了，所以不像维护外部map那么麻烦（玩家退出重进数据还在）\n\n[groupid=1330]PluginsCDTribe[/groupid]",
    "replies": [
        {
            "author": "弱鸡绿毛怪",
            "timestamp": 1565099700,
            "txt_content": "这种退出服务器重进还在？"
        },
        {
            "author": "2280761425",
            "timestamp": 1565102220,
            "txt_content": " 本帖最后由 2280761425 于 2019-8-7 10:19 编辑 \nMagicLocyDragon 发表于 2019-8-6 21:55\n这种退出服务器重进还在？\n当时实验时我也很迷，但是结果是这样的，难道是玩家退出后数据被保存到了OfflinePlayer中？233"
        },
        {
            "author": "yuxinyu12666",
            "timestamp": 1565106000,
            "txt_content": "6666666666牛+"
        }
    ]
}