{
    "title": "CI010的1.8 Mod小知识",
    "author": "CI010",
    "replyCount": 4,
    "timestamp": 1437314460,
    "txt_content": " 本帖最后由 CI010 于 2015-7-19 07:02 编辑 \n\n概述：\n本教程主要面向那些已经会了一些mod制作基础的人（没有基础的人请去看那些基础的mod教程，多着呢）\n本教程更类似于提供思路+引发讨论，\n本教程的内容皆来自于lz我自己实践的经验，自然有可能是不最完美的解决办法，如有更好的想法，直接回帖\n这个帖子可能会慢慢更新……嗯……\n内容：\n其一：如何改变玩家的移动速度\n我相信，改变玩家的移动速度，是大部分modder都会想要实现的一个东西(并不)\n然而mc里的实现还是意外的不简单……\n\n方法一：使用LivingUpdateEvent，更改玩家的motionX和motionZ来改变玩家移动速度\n\n@SubscribeEvent\n        public void onLivingUpdate(LivingUpdateEvent event)\n        {\n                if (event.entityLiving instanceof EntityPlayer)\n                {\n                        event.entityLiving.motionX *= [倍数];\n                        event.entityLiving.motionZ *= [倍数];\n                }\n        }复制代码\n这种方法非常直截了当，我最初也是使用这种办法。\n但是缺点也是让我非常不爽，他会让玩家的画面造成一定的顿卡，而且提高了对电脑的配置需求\n(我如果没记错的话，这个event每tick发生一次，也就是一秒要额外算40个浮点乘法，虽然那只是mc海量运算中的一滴水……但也是负荷啊)。\n\n\n我搬运和维护的gokistats的跳跃就是这个实现的……如果玩过的会发现跳远技能加高了，跳的时候画面会有顿卡感……\n于是我就开始想：“为啥mc的速度药水的加速效果就没有这种情况呢……一定有别的方法。”\n\n\n后来我发现mc的很多东西都是通过一个叫做SharedMonsterAttributes的东西实现的\nSharedMonsterAttributes有个变量叫做movementSpeed\nmovementSpeed这个IAttribute似乎就是改变速度的关键\n\n于是有了方法一点五\n\n方法一点五：-通过LivingUpdateEvent来改变movementSpeed的数值（一点五的原因时我没我没有试验过这个方法）\n\n@SubscribeEvent\n        public void onLivingUpdate(LivingUpdateEvent event)\n        {\n                if (event.entityLiving instanceof EntityPlayer)\n                {\n                        IAttributeInstance iattributeinstance = event.entityLiving.getEntityAttribute(SharedMonsterAttributes.movementSpeed);\n\n                iattributeinstance.setBaseValue([想要的倍數]);\n                }\n        }复制代码\n这个方法我根本没实验过……谁想试试的可以去试试，写在livingUpdateEvent里+没实验过的原因就是因为我是看到了EntityPlayer中onLivingUpdate()这段源码……\n IAttributeInstance iattributeinstance = this.getEntityAttribute(SharedMonsterAttributes.movementSpeed);\n\n        if (!this.worldObj.isRemote)\n        {\n            iattributeinstance.setBaseValue((double)this.capabilities.getWalkSpeed());\n        }复制代码mc原版每次自己update的时候会把这个值重新设定成capabilities.getWalkSpeed()……如果我们在外界设定那就必须得每一tick都修正速度，不然就被原版修正……\n于是我打算还是和原版看齐吧……免得出bug\n\n\n可以看到原版是通过PlayerCapabilities(EntityPlayer.capabilities)来获得移动速度的，感情mc的player还有个PlayerCapabilities的属性……我都不知道……\n\n但残酷的现实是，当你翻到PlayerCapabilities类里找walkspeed的时候，你却发现这个walkspeed居然是private的，而且他的setter居然还是Client-Side only的……也就是说你只能改客户端的移动速度，这没啥卵用啊……\n\n但我们并不能就这么放弃，好不容易找到的根据地怎么能够随便就放弃呢？\n\n我最后用了一招歪门邪道(我自己感觉是)\n\n方法二：通过PlayerCapabilities中的write、readnbt来更改移动速度\npublic void setSpeed(EntityPlayer player, float speed)\n        {\n                NBTTagCompound tag = new NBTTagCompound();\n                player.capabilities.writeCapabilitiesToNBT(tag);\n\n                tag.getCompoundTag(\"abilities\").setFloat(\"walkSpeed\", speed);\n                player.capabilities.readCapabilitiesFromNBT(tag);\n        }复制代码你也看到了我这个是单独写出来的方法，并没有实际写出应用再哪个事件中，反正这种情况下是你自己决定什么时候用它，只要用过一次，之后就不用再重复设定了，除非你想要再改变移动速度。\n\n这个方法的参数第一个是想要改变速度的玩家，第二个其实是速度的modifier，注意用capabilities来改变速度的时候要注意capabilities的值，默认是0.02，我设置成0.2玩家速度就跟飞一样了……不要设置的太大（我暂时也没研究明白这东西到底到底怎么算）\n\n事实上我这个方法不够完美，可以变成这样：public void setSpeed(EntityPlayer player, float multiplier){\n                NBTTagCompound tag = new NBTTagCompound();\n                player.capabilities.writeCapabilitiesToNBT(tag);\n\n                tag.getCompoundTag(\"abilities\").setFloat(\"walkSpeed\", speed);\n                player.capabilities.readCapabilitiesFromNBT(tag);\n        }复制代码这样第二个参数就是个倍数，玩家速度的更改也是应该根据这个倍数增长(大概……希望如此)\n\n\n\n然而刚刚的解决方案似乎很完美，其实并不完美……orz\n你会发现用这种方式加速后，玩家的跳跃速度居然没有跟着一起改变！？\n这简直就是丧心病狂，为什么会有这种事情发生……\n于是就有了话题2\n\n其二：如何改变玩家的跳跃能力\n\n方法一：使用LivingJumpEvent，更改玩家的motionY来改变玩家的跳跃能力\nwell……还是这个最直截了当的办法……@SubscribeEvent\n        public void onLivingUpdate(LivingJumpEventevent)\n        {\n                if (event.entityLiving instanceof EntityPlayer)\n                {\n                        event.entityLiving.motionY *= [倍数];\n                        event.entityLiving.motionX *= [倍数];\n                        event.entityLiving.motionZ *= [倍数];\n                }\n        }复制代码这样的问题还是……会有顿卡……而且和上一种办法不太兼容，估计是capabilities的算法的原因……\n因为我们再看看源码，会发现上面的capabilities的值传递到一个叫做landMovementFactor的浮点数里了。\n\n后来我翻翻翻……又找到了与landMovementFactor对应的，一个叫做jumpMovementFactor的东西，我还是在EntityPlayer的onLivingUpdate()里看到的\n\n然而我看到这个值，每次update都被speedInAir重置，理论上speedInAir就是jumpMovementFactor的值\nthis.jumpMovementFactor = this.speedInAir;复制代码于是按照以前的思路我就打算把speedInAir给改了……但这一改就是十年……\n从结论上来讲，我不推荐改这个speedInAir，因为需要用到coremod(并不是所有人都会写coremod……)，而且最后解决方案很不完美甚至有可能造成兼容性问题，于是我还是先介绍比较正常的办法吧……\n\n方法二：使用LivingJumpEvent配合LivingUpdateEvent来改变jumpMovementFactor的值\n\n\n@SubscribeEvent\n        public void jumpEvent(LivingJumpEvent event)\n        {\n                if (event.entityLiving instanceof EntityPlayer)\n                {\n                        EntityPlayer player = (EntityPlayer) event.entityLiving;\n\n                        player.jumpMovementFactor = player.capabilities.getWalkSpeed();\n                }\n        }\n\n        @SubscribeEvent\n        public void onLivingUpdate(LivingUpdateEvent event)\n        {\n                 if (event.entityLiving instanceof EntityPlayer)\n                 ((EntityPlayer) event.entityLiving).jumpMovementFactor = ((EntityPlayer) event.entityLiving).capabilities.getWalkSpeed();\n        }复制代码\n别问我为啥不只用LivingUpdateEvent来更新这个jumpMovementFactor……我也不清楚，只用livingupdate的话这个值还是会被重置，速度还是没变，\n需要在跳的时候再设置一次\n\n你可以加上一些dubug信息来看看……\n\n@SubscribeEvent\npublic void jumpEvent(LivingJumpEvent event)\n{\nif (event.entityLiving instanceof EntityPlayer)\n{\nEntityPlayer player = (EntityPlayer) event.entityLiving;\n\nSystem.out.println(\"jump fac is \" + player.jumpMovementFactor);\n\nplayer.jumpMovementFactor = player.capabilities.getWalkSpeed();\n\nSystem.out.println(\"move speed is \" + player.capabilities.getWalkSpeed());\nSystem.out.println(\"jump fac is \" + player.jumpMovementFactor);\n}\n}复制代码\n好了，现在我可以来说我花了十年才搞定的coremod最后还发现可以不用的解决方法了：\n方法三：通过coremod更改原来的EntityPlayer来更改玩家跳跃速度\n\n这个我不太想多讲……说多了都是泪\n\n//找到EntityPlayer中的getToolDigEfficiency(desc为\"(Lnet/minecraft/block/Block;)F\")方法后，改其中的内容复制代码随意建一个类作为Hook中有这个方法（根据上文，我这个类位于net.ci010.attributesmod.coremod包中的CoreHook类）\npublic static float getWalkSpeed(EntityPlayer player)\n        {\n                return player.capabilities.getWalkSpeed();\n        }复制代码使用的时候写\nplayer.getToolDigEfficiency(null);\n复制代码就好了，我选了个返回float的方法，你可以看到他返回的值也就是当前的speedInAir\n\n我也说过这个是根据改移动速度的思路做的方法，也就是说原版的update将会自动修正跳跃时候的移动，只需要使用一次就可以了……\n（但是好虐啊…………）\n\n我没有放出coremod的完整写法，能看懂的就看把，其实外层还有相对小复杂的架构【【【你\n\n\n",
    "replies": [
        {
            "author": "liach",
            "timestamp": 1437354060,
            "txt_content": "话说楼主你知不知道fml的reflectionhelper和forge的enumhelper？主要觉得这种好东西都要coremod太不值了。"
        },
        {
            "author": "CI010",
            "timestamp": 1437375600,
            "txt_content": "liach 发表于 2015-7-19 17:01\n话说楼主你知不知道fml的reflectionhelper和forge的enumhelper？主要觉得这种好东西都要coremod太不值了。 ...\n对fml的东西并不太熟悉……主要是对reflection不熟"
        },
        {
            "author": "CI010",
            "timestamp": 1437375840,
            "txt_content": "liach 发表于 2015-7-19 17:01\n话说楼主你知不知道fml的reflectionhelper和forge的enumhelper？主要觉得这种好东西都要coremod太不值了。 ...\nenumhelper这东西好像很dio……难道是可以直接自定Enum于mc中……"
        },
        {
            "author": "liach",
            "timestamp": 1437437280,
            "txt_content": "CI010 发表于 2015-7-20 15:04\nenumhelper这东西好像很dio……难道是可以直接自定Enum于mc中……\nhttps://github.com/MinecraftForg ... flectionHelper.java\n\n这个可以使用private的函数和值，包括改变private值；\n\nhttps://github.com/MinecraftForg ... til/EnumHelper.java\n\n给Enum加项目，比较牛。"
        }
    ]
}