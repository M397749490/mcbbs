{
    "title": "【CBL|zzzz】[1.13-1.14] 麻将和牌判定与立直麻将番符点数计算[BGM]",
    "author": "pku_zzzz",
    "replyCount": 23,
    "timestamp": 1564156260,
    "txt_content": " 本帖最后由 pku_zzzz 于 2019-8-2 05:00 编辑 \n\n麻将和牌判定与立直麻将番符点数计算\n\n本数据包基于的版本是 MC 1.13.2，不过我认为 1.14.x 应该也是可以的。\n\n本文假设读者在阅读本文前对立直麻将的规则有着最基本的了解。\n\n让我们来一段开挂 BGM，并开始整篇文章吧。\n\nhttps://music.163.com/style/swf/widget.swf?sid=4899128&type=2&auto=0&width=320&height=66\n\n本文中文部分（含标点）合计约 7200 字。\n\n下载链接\n\nhttps://github.com/ustc-zzzz/mahjong-in-mojang-game/raw/master/mahjong-in-mojang-game.zip\n\n使用说明\n\nhttps://github.com/ustc-zzzz/mahjong-in-mojang-game#readme\n\n\n\n局限性\n\n无法处理流局满贯无法自动处理宝牌，需手动输入未检查不合理的牌形（如牌张数≠14+杠数，一张牌出现超过四个等）通常一次判定所执行的命令数会多达数千次，不过一位愿意透露姓名的素学姐曾说过：\n\n那大概也没什么了。\n\n原理\n\n如果读者之前有查过麻将和牌判定与番数计算的方法的话，那么最容易得到的方法应该是——查表法。实际上，查表法对于现代个人计算机来说，是一种相当有效的方法，但是我们面对的是 MC 命令——这对于成百上千万种麻将的可能牌型来说，就困难得多了。\n\n不过，幸运的是，日本有一帮人通过将相似的牌型合并归类，搞出了一套将表的数量足足压缩到九千多行的麻将和牌判定方法。虽然这仍然是查表法，但已经可以以不那么占地方的方式塞进数据包里了。\n\n表格本身是整数到整数的映射。其中每一种牌型对应的是查表法中表格的输入，而和牌的拆分方式则对应着表格的输出。需要注意的是，一种输出不仅可能对应零或一种输入，更可能对应着多种输出，考虑 22334455667788s 这一牌型：\n\n234s 234s 567s 567s 88s234s 234s 678s 678s 55s345s 345s 678s 678s 22s\n\n不考虑七对的话，以上牌型在实际番数计算时均需考虑，这才能保证无论和牌为 2s 到 8s 这七张中的哪一张，最后番数计算时都会有平和一番。\n\n编码输入\n\n编码输入的方式如下：\n\n一、将牌按是否连续拆分，连续的部分按相应位置的牌数映射，最开始与不连续处补零。考虑 111234678m11122z，由于万饼索从一到九是连续的，而字无论如何都不连续，因此最后映射的结果是：0311101110302。\n\n二、按以下规则把数字映射到 bit 并拼凑到一起：\n\n1 => 02 => 0113 => 011114 => 011111101 => 0102 => 011103 => 01111104 => 01111111\n\n那么最后映射到的结果应为 01111100001000111110111，也就是 4067831。\n\n我们很容易从表中查到一个 4067831 => 26084370 的映射。\n\n解码输出\n\n接下来是解码过程：\n\n一、将输出转换为 31 bit 的二进制序列，这里是 0000001100011100000010000010010。我们对该序列进行分组：0 0 0 0 0 0110 0011 1000 0001 0000 010 010，以备后续之用。\n\n二、序列的最低三位为刻子数量（这里是二），次低三位为顺子数量（这里也是二）。\n\n三、接下来的最低四位是雀头的位置（零）以及四个面子的位置（一，八，三，六），注意位置从右往左数，同时，按照上一步的要求，前两个为刻子，后两个为顺子。\n\n四、最后五个 bit 代表输入是否可能满足五种特定的役，这个稍后会讲到。\n\n额外优点\n\n这样的处理甚至带来了几个额外的优点：\n\n它涉及的位运算较多，故很容易处理为记分板的加减乘除它可以处理七对子，也就是七个 2 或者 02 粘在一起的情况它可以处理副露的情况，因为刻子和顺子数量之和并不要求为四它可以提前判定一些役是否存在。这些役包括：七对子、九莲宝灯、一气通贯、两杯口、一杯口，实际上它们正好对应输出最高的五个 bit\n\n那么我们的算番过程实际上分成了五步：\n\n编码映射解码算番算符统计点数\n\n那么我们开始在 MC 里实现吧！\n\n结构\n\n本数据包的文件组成如下：\n\ndata/mahjong/functions：总目录data/mahjong/functions/decoding：处理解码过程data/mahjong/functions/encoding：处理编码过程data/mahjong/functions/handling：处理役种统计过程data/mahjong/functions/mapping：处理映射过程，为自动生成data/mahjong/functions/output：输出和牌状态及番数统计文本data/mahjong/functions/state：输入和牌牌型，部分为自动生成data/mahjong/functions/test：作者加进去的一点小测试\n\n本数据包生成的实体有：\n\n@e[tag=mahjong.pai]：对应三十四种牌的数据@e[tag=mahjong.agari]：对应和牌状态的相关数据@e[tag=mahjong.counter]：对应其他杂七杂八的数据\n\n由于和牌状态可能有多种，但最后只能选中番数最高的一个，因此未被选中的将会被标记为 @e[tag=mahjong.agariprev]。\n\n为 @e[tag=mahjong.pai] 注册的记分板变量有：\n\nmahjongorder：牌的类型，从 0（1m）到 33（7z）mahjongtenpai：该牌是否为最后听牌，是为 1mahjongchiipai：以该牌作为嵌张的顺子（后文简称该牌的顺子）的吃牌数mahjongponpai：针对该牌的碰牌刻子数mahjongkanpai：针对该牌的明杠数mahjongankanpai：针对该牌的暗杠数mahjongcount：该牌未被吃碰杠的牌数mahjongpos：该牌在编码时的位置mahjongkoutsu：分析役种时的临时变量，为在该牌位置的刻子数的三倍mahjongkantsu：分析役种时的临时变量，为在该牌位置的杠子数mahjongjantou：分析役种时的临时变量，为在该牌位置的雀头数的两倍mahjongmentsu：分析役种时的临时变量，为在该牌位置的面子数的三倍\n\n为 @e[tag=mahjong.agari] 注册的记分板变量有：\n\nmahjongfu：用于累加的符数mahjonghan：用于累加的番数mahjongyakuman：用于累加的役满数mahjongranking：最后排序时依靠的指数，由番数和役满数等计算得到mahjongmentsu：和牌时门清的面子数mahjongchiitoi：和牌时的七对标记mahjongchuuren：和牌时的九莲标记mahjongikki：和牌时的一气通贯标记mahjongryanpei：和牌时的两杯口标记mahjongiipei： 和牌时的一杯口标记mahjongankou：和牌时的暗刻数（计暗杠）mahjongkoutsu：和牌时的刻子数（计杠子）mahjongkantsu：和牌时的杠子数mahjongsuushii：风牌数量mahjongchinyao：清幺九数量mahjongsangen：三元牌数量mahjongryuu：绿牌数量mahjongtsuu：字牌数量mahjongman：万子+字牌数量mahjongpin：饼子+字牌数量mahjongsou：索子+字牌数量mahjongdaiyao：带幺九的顺子刻子与雀头牌数\n\n为 @e[tag=mahjong.counter] 注册的记分板变量有：\n\nmahjongkey：映射表的输入mahjongvalue1：映射表的第一个输出，最多四个mahjongvalue2：映射表的第二个输出，最多四个mahjongvalue3：映射表的第三个输出，最多四个mahjongvalue4：映射表的第四个输出，最多四个mahjongranking：最后排序时依靠的指数的最大值mahjongbasepoint：计算点数时所用的基本点数mahjongpoint：最终计算得到的点数mahjongchanfon：场风牌的类型mahjongmenfon：门风牌的类型mahjongriichi：立直及一发状态mahjongsaki：听牌来源mahjongdora：宝牌数\n\n本数据包还定义了一些用于加减乘除的临时用变量，它们均以 mahjongtmp 开头。\n\n现在我们开始一步一步计算。\n\n第一步——加载\n\n这一步生成一个 @e[tag=mahjong.counter] 和三十四个 @e[tag=mahjong.pai]，同时为后者赋值 mahjongorder 为 0 到 33。生成实体及赋值的过程太简单，在此仅提供一个生成北风（4z）对应实体的示例：\n\nsummon minecraft:armor_stand ~ ~ ~5 {CustomName:\"\"4z\"\",Invisible:1b,NoGravity:1b,Invulnerable:1b,Tags:[\"mahjong.pai\",\"mahjong.kaze\"]}复制代码\n不过，在生成实体的时候，我们为部分实体额外指定了几个 tag：\n\nmahjong.chinyao：代表清幺九mahjong.kaze：代表四风mahjong.sangen：代表三元mahjong.ryuukou：代表刻子一定是绿牌的牌mahjong.ryuumen：代表刻子和顺子一定是绿牌的牌（其实只有 3s）mahjong.lowerdaiyao：代表 2m2p2smahjong.higherdaiyao：代表 8m8p8s\n\n最后两个 tag 将会在判定全带幺九、断幺九，平和，以及算符时派上用场。\n\n第二步——输入\n\n这一步主要为 @e[tag=mahjong.counter] 和 @e[tag=mahjong.pai] 赋值，没什么技术含量，略过不表。\n\n第三步——编码\n\n这一步主要将统计结果编码到 @e[tag=mahjong.counter] 的 mahjongkey 变量，主要只是记分板的加法乘法，感兴趣的读者可以翻看 encoding/ 目录下的部分，在此同样略过。\n\n第四步——映射\n\n这一步做的就是查找映射表了。考虑到映射表是整数到整数的映射，因此在查找前我们可以先按输入排序，然后每次缩小一个范围，最后确定映射。\n\n二分法理论上是查找速度最快的，但是考虑到其他的命令会执行多达上千条，而直接使用二分法将会导致 mcfunction 文件数直接爆炸，因此我们有必要换用其他的进制。作者在这里使用的是五进制，每次都会将范围缩小 80%。我们以 4067831 为例：\n\n我们先进行根查询，根查询位于 level1from0000007to7df7df7.mcfunction 文件：\n\nexecute if score @s mahjongkey matches 7..318243 run function mahjong:mapping/level2from0000007to004db23\nexecute if score @s mahjongkey matches 318260..1017720 run function mahjong:mapping/level2from004db34to00f8778\nexecute if score @s mahjongkey matches 1017735..2058220 run function mahjong:mapping/level2from00f8787to01f67ec\nexecute if score @s mahjongkey matches 2058271..4165487 run function mahjong:mapping/level2from01f681fto03f8f6f\nexecute if score @s mahjongkey matches 4165492..132087287 run function mahjong:mapping/level2from03f8f74to7df7df7复制代码\n我们确定其在第四个区间，现在进入 level2from01f681fto03f8f6f.mcfunction：\n\nexecute if score @s mahjongkey matches 2058271..2342543 run function mahjong:mapping/level3from01f681fto023be8f\nexecute if score @s mahjongkey matches 2342582..3091903 run function mahjong:mapping/level3from023beb6to02f2dbf\nexecute if score @s mahjongkey matches 3092347..3913342 run function mahjong:mapping/level3from02f2f7bto03bb67e\nexecute if score @s mahjongkey matches 3913359..4103924 run function mahjong:mapping/level3from03bb68fto03e9ef4\nexecute if score @s mahjongkey matches 4103928..4165487 run function mahjong:mapping/level3from03e9ef8to03f8f6f复制代码\n还是第四个区间，现在进入 level3from03bb68fto03e9ef4.mcfunction：\n\nexecute if score @s mahjongkey matches 3913359..3924799 run function mahjong:mapping/level4from03bb68fto03be33f\nexecute if score @s mahjongkey matches 3924862..3930616 run function mahjong:mapping/level4from03be37eto03bf9f8\nexecute if score @s mahjongkey matches 3930980..4079167 run function mahjong:mapping/level4from03bfb64to03e3e3f\nexecute if score @s mahjongkey matches 4079230..4097983 run function mahjong:mapping/level4from03e3e7eto03e87bf\nexecute if score @s mahjongkey matches 4098023..4103924 run function mahjong:mapping/level4from03e87e7to03e9ef4复制代码\n这回是第三个区间，现在进入 level4from03bfb64to03e3e3f.mcfunction：\n\nexecute if score @s mahjongkey matches 3930980..4070383 run function mahjong:mapping/level5from03bfb64to03e1bef\nexecute if score @s mahjongkey matches 4070687..4071199 run function mahjong:mapping/level5from03e1d1fto03e1f1f\nexecute if score @s mahjongkey matches 4071231..4071390 run function mahjong:mapping/level5from03e1f3fto03e1fde\nexecute if score @s mahjongkey matches 4072415..4077543 run function mahjong:mapping/level5from03e23dfto03e37e7\nexecute if score @s mahjongkey matches 4077551..4079167 run function mahjong:mapping/level5from03e37efto03e3e3f复制代码\n然后我们进入第二个区间对应的 level5from03bfb64to03e1bef.mcfunction：\n\nexecute if score @s mahjongkey matches 3930980 run scoreboard players set @s mahjongvalue1 22043097\nexecute if score @s mahjongkey matches 3930988 run scoreboard players set @s mahjongvalue1 17585561\nexecute if score @s mahjongkey matches 3931120 run scoreboard players set @s mahjongvalue1 17125778\nexecute if score @s mahjongkey matches 4065247 run scoreboard players set @s mahjongvalue1 25969106\nexecute if score @s mahjongkey matches 4067295 run scoreboard players set @s mahjongvalue1 21512594\nexecute if score @s mahjongkey matches 4067807 run scoreboard players set @s mahjongvalue1 26083410\nexecute if score @s mahjongkey matches 4067831 run scoreboard players set @s mahjongvalue1 26084370\nexecute if score @s mahjongkey matches 4068319 run scoreboard players set @s mahjongvalue1 21610578\nexecute if score @s mahjongkey matches 4068343 run scoreboard players set @s mahjongvalue1 21611538\nexecute if score @s mahjongkey matches 4069279 run scoreboard players set @s mahjongvalue1 21610642\nexecute if score @s mahjongkey matches 4069311 run scoreboard players set @s mahjongvalue1 17137746\nexecute if score @s mahjongkey matches 4069351 run scoreboard players set @s mahjongvalue1 21612562\nexecute if score @s mahjongkey matches 4069359 run scoreboard players set @s mahjongvalue1 17138706\nexecute if score @s mahjongkey matches 4070367 run scoreboard players set @s mahjongvalue1 18366603\nexecute if score @s mahjongkey matches 4070383 run scoreboard players set @s mahjongvalue1 18366603复制代码\n到这一步，可选的命令就只剩下十五个左右了，这里直接使用穷举解决了问题。我们可以看到，4067831 正在第七行，对应着 26084370。\n\n通过这种方式，数据包用于映射的 mcfunction 数量被控制在了 800 个以下，同时花费不超过 50 次命令执行就能完成映射过程。\n\n当然了，这一步用到的所有 mcfunction，都是使用代码自动生成的。\n\n第五步——解码\n\n考虑到映射表的输出最多只会有四个，我们将其分别赋值为 mahjongvalue1 到 mahjongvalue4，然后：\n\n取出 mahjongvalue1，如果有的话\n生成一个对应 mahjongvalue1 的 @e[tag=mahjong.agari]为 @e[tag=mahjong.agari] 算役满，要是没有役满，再算普通役计算 mahjongranking 用于事后比较和牌的拆分方式对应的番数大小取掉 mahjong.agari 标签，并标记为 mahjong.agariprev\n取出 mahjongvalue2 并重复上述工作，如果有的话取出 mahjongvalue3 并重复上述工作，如果有的话取出 mahjongvalue4 并重复上述工作，如果有的话取出 mahjongranking 最大的一个，标记为 mahjong.agari为 @e[tag=mahjong.agari] 把宝牌的番加上\n\n以下是分别调用针对 mahjongvalue1 到 mahjongvalue4 的函数部分：\n\nexecute if score @s mahjongvalue1 matches 0.. run function mahjong:decoding/initpart1\nexecute if score @s mahjongvalue2 matches 0.. run function mahjong:decoding/initpart2\nexecute if score @s mahjongvalue3 matches 0.. run function mahjong:decoding/initpart3\nexecute if score @s mahjongvalue4 matches 0.. run function mahjong:decoding/initpart4复制代码\n乍一看上面的流程似乎没什么问题，但是实际上我们忘了一步：国士无双只能被单独处理。\n\n如果连 mahjongvalue1 都没有，考虑国士无双的可能\n\n这里再补充一下 mahjongranking 是怎么计算的。立直麻将的要求是：\n\n如果有役满牌型，选役满数最大的如果没有役满牌型，选对应番数最多的如果有多个番数相同的，选对应符数最大的\n\n我们完全可以搞一个基于 256 进制的公式：\n\nmahjongranking = (mahjongyakuman * 256 + mahjonghan) * 256 + mahjongfu\n\n这样我们选的就是 mahjongranking 的最大值了。实际使用的命令如下：\n\n# set ranking = (yakuman * 256 + han) * 256 + koutsu\nscoreboard players set @s mahjongtmpmul 256\nscoreboard players operation @s mahjongranking = @s mahjongyakuman\nscoreboard players operation @s mahjongranking *= @s mahjongtmpmul\nscoreboard players operation @s mahjongranking += @s mahjonghan\nscoreboard players operation @s mahjongranking *= @s mahjongtmpmul\nscoreboard players operation @s mahjongranking += @s mahjongfu\n# set maximum ranking value in mahjong.counter\nscoreboard players operation @e[tag=mahjong.counter] mahjongranking > @s mahjongranking复制代码\n这样就可以保证 @e[tag=mahjong.counter] 永远储存着 mahjongranking 的最大值了。然后：\n\nscoreboard players operation @e[tag=mahjong.agariprev] mahjongranking -= @s mahjongranking\ntag @e[tag=mahjong.agariprev,scores={mahjongranking=0,mahjonghan=1..},limit=1] add mahjong.agari复制代码\n就可以把 mahjongranking 为最大值，同时保证一番起和的和牌拆分方式选出来了。\n\n第六步——番符\n\n算番可以说是整个过程最难的一步了。麻将的各种役可以说是整个游戏中人为规定最多，亦即需要特殊处理的地方最多的规则。为方便后续输出，我们在统计役种时会为 @e[tag=mahjong.agari] 添加相应的标签，如标签 mahjong.yaku.chinitsu 代表有清一色这个役，以此类推。\n\n在开始之前，我们首先定义“有效张数”这一概念。这一概念简而言之，就是把杠子多出来的那张去掉：\n\n一个顺子的有效张数是三张一个刻子的有效张数是三张一个杠子的有效张数是三张一个雀头的有效张数是两张\n\n同时，为了将七对子纳入我们的统计体系，我们额外规定：\n\n七对子有七个雀头\n\n在进行番符计算时，我们采用的是分阶段计算的方式：第一到三阶段处理役满，第四到六阶段处理普通役，第七阶段处理额外的符数。\n\n国士无双不适用这种统计方式，因此会单独计算，在后文也会提及。\n\n我们先从第一阶段开始。\n\n第一阶段\n\n第一阶段首先将番数役满倍数归零，符数设为起符 20：\n\nscoreboard players set @s mahjongfu 20\nscoreboard players set @s mahjonghan 0\nscoreboard players set @s mahjongyakuman 0复制代码\n然后将映射表的输出拆成若干组 bit，这一阶段可以统计的数据有：\n\n非吃碰杠的刻子数（暂存于 mahjongkoutsu 中）非吃碰杠的面子数（暂存于 mahjongmentsu 中）是否为七对子（0/1，存储于 mahjongchiitoi 中）是否为九莲宝灯（0/1，存储于 mahjongchuuren 中）是否可能有一气通贯（0/1，存储于 mahjongikki 中）是否可能有两杯口（0/1，存储于 mahjongryanpei 中）是否可能有一杯口（0/1，存储于 mahjongiipei 中）\n\n由于映射表的输出包含了每个面子的位置，因此不仅 @e[tag=mahjong.agari]，三十四个 @e[tag=mahjong.pai] 也可以在这一阶段统计非吃碰杠的刻子、面子、及雀头数。以下是将存储于 mahjongtmprem 的第一组面子的数据添加到每张牌对应的实体的命令：\n\nexecute as @e[tag=mahjong.pai] if score @s mahjongpos = @e[tag=mahjong.agari,limit=1] mahjongtmprem run scoreboard players add @s mahjongmentsu 1\nexecute if score @s mahjongkoutsu matches 1.. as @e[tag=mahjong.pai] if score @s mahjongpos = @e[tag=mahjong.agari,limit=1] mahjongtmprem run scoreboard players add @s mahjongkoutsu 1复制代码\n首先为 mahjongpos 和 mahjongtmprem 相等的 @e[tag=mahjong.pai] 的面子数加一，然后考虑到 mahjongkoutsu 标记了刻子数，因此若刻子数大于等于一，我们还要同时为相应的 @e[tag=mahjong.pai] 的刻子数加一。\n\n这一阶段我们只检查役满，可供检查的役满有什么呢？\n\n天和：@e[tag=mahjong.counter] 的 mahjongsaki 为 7地和：@e[tag=mahjong.counter] 的 mahjongsaki 为 6九莲宝灯（含纯正九莲宝灯）：mahjongchuuren 为 1\n\nexecute if entity @e[tag=mahjong.counter,scores={mahjongsaki=6}] run function mahjong:handling/yakuman/markchiihou\nexecute if entity @e[tag=mahjong.counter,scores={mahjongsaki=7}] run function mahjong:handling/yakuman/marktenhou\nexecute if score @s mahjongchuuren matches 1 run function mahjong:handling/yakuman/markchuuren复制代码\n以下以 mahjong:handling/yakuman/markchuuren 为例，描述役满是如何标记的：\n\n# set tmp values\nscoreboard players set @s mahjongtmp 13\nscoreboard players set @s mahjongtmpdiv 13\n# test if it is junsei chuuren\nexecute if entity @s[tag=mahjong.yaku.tenhou] run scoreboard players set @s mahjongtmp 26\nexecute if entity @e[tag=mahjong.pai,scores={mahjongcount=2,mahjongtenpai=1}] run scoreboard players set @s mahjongtmp 26\nexecute if entity @e[tag=mahjong.chinyao,scores={mahjongcount=4,mahjongtenpai=1}] run scoreboard players set @s mahjongtmp 26\n# set tag\nexecute if score @s mahjongtmp matches 13 run tag @s add mahjong.yaku.chuuren\nexecute if score @s mahjongtmp matches 26 run tag @s add mahjong.yaku.chuuren2\n# set mahjonghan\nscoreboard players operation @s mahjonghan += @s mahjongtmp\n# set mahjongyakuman\nscoreboard players operation @s mahjongtmp /= @s mahjongtmpdiv\nscoreboard players operation @s mahjongyakuman += @s mahjongtmp复制代码\n首先如果确定役满了，那么肯定十三番起步，我们先把两个临时值设为 13：\n\nscoreboard players set @s mahjongtmp 13\nscoreboard players set @s mahjongtmpdiv 13复制代码\n然后如果是天和（我们已在 mahjong:handling/yakuman/marktenhou 中判断天和），九莲宝灯自动升格纯正九莲宝灯：\n\nexecute if entity @s[tag=mahjong.yaku.tenhou] run scoreboard players set @s mahjongtmp 26复制代码\n那么其他情况下，我们怎么知道我们的牌是九面听呢？\n\n如果听牌对应的牌在手牌中有两张（或幺九牌四张），那么就是纯正九莲宝灯如果听牌对应的牌在手牌中有一张（或幺九牌三张），那么就不是纯正九莲宝灯\n\nexecute if entity @e[tag=mahjong.pai,scores={mahjongcount=2,mahjongtenpai=1}] run scoreboard players set @s mahjongtmp 26\nexecute if entity @e[tag=mahjong.chinyao,scores={mahjongcount=4,mahjongtenpai=1}] run scoreboard players set @s mahjongtmp 26复制代码\n然后我们为 @e[tag=mahjong.agari] 标记相应的标签：\n\nexecute if score @s mahjongtmp matches 13 run tag @s add mahjong.yaku.chuuren\nexecute if score @s mahjongtmp matches 26 run tag @s add mahjong.yaku.chuuren2复制代码\n最后记录番数和役满倍数（役满倍数为番数的十三分之一，这也是 mahjongtmpdiv 的存在意义）：\n\nscoreboard players operation @s mahjonghan += @s mahjongtmp=\nscoreboard players operation @s mahjongtmp /= @s mahjongtmpdiv\nscoreboard players operation @s mahjongyakuman += @s mahjongtmp复制代码\n最后别忘了为七对子添加额外六个雀头（映射表已为七对子指定了一个雀头）：\n\nexecute if score @s mahjongchiitoi matches 1 run scoreboard players add @e[tag=mahjong.pai,scores={mahjongpos=1..6}] mahjongjantou 1复制代码\n第二阶段\n\n在第二阶段，我们需要深入每一张牌，统计其对应的：\n\n暗刻数（0/1，存储于 mahjongankou 中）杠子数（0/1，存储于 mahjongkantsu 中）刻子数（0/1，存储于 mahjongkoutsu 中）面子数（0/1/2/3/4，存储于 mahjongmentsu 中）\n\n同时为 @e[tag=mahjong.agari] 统计：\n\n暗刻数杠子数刻子数门清的面子数\n\n我们有以下公式：\n\n暗刻数 = 非吃碰杠的刻子数 + 暗杠数 + 修正杠子数 = 暗杠数 + 明杠/加杠数刻子数 = 非吃碰杠的刻子数 + 暗杠数 + 明杠/加杠数 + 碰牌刻子数面子数 = 非吃碰杠的面子数 + 暗杠数 + 明杠/加杠数 + 碰牌刻子数 + 吃牌顺子数\n\n此外还要为 @e[tag=mahjong.agari] 修正：\n\n门清的面子数 = 非吃碰杠的面子数 + 暗杠数\n\nWell，这几个公式整体都很清楚明了，唯一一个需要注意的是那个计算暗刻数的“修正”：双碰听牌时荣和不计含荣和牌的刻子为暗刻。在考虑这一修正的时候有一个问题很关键：如果荣和的牌既可以视作刻子的听牌，也可以视作顺子的听牌，实际统计时采纳哪个呢？\n\n实际上，只要稍作思考，就可以看出：听牌总是优先计为顺子的。\n\n暗刻多有利于三暗刻及四暗刻等役，在计符时也会占据优势听牌计为顺子有利于凑成平和，同时如果听坎张听边张也会加符\n\n那我们判定修正的条件变成了：\n\n听牌来源为荣和听牌对应的牌有一组非暗杠的暗刻听牌对应的牌没有办法匹配成顺子\n\n我们可以进一步简化为：\n\n听牌来源为荣和听牌对应的牌有一组刻子听牌对应的非吃碰杠的牌恰好有三张\n\nexecute if entity @e[tag=mahjong.counter,scores={mahjongsaki=0..2}] run scoreboard players remove @s[scores={mahjongkoutsu=1,mahjongcount=3,mahjongtenpai=1}] mahjongankou 1复制代码\n这一步我们还会计算每种牌对应的符数。我们温习一下立直麻将对于符数的规定：\n\n明刻非幺九 2 符，幺九 4 符暗刻非幺九 4 符，幺九 8 符明杠非幺九 8 符，幺九 16 符暗杠非幺九 16 符，幺九 32 符\n\n我们的算法可以设计为：\n\n符数 = 刻子数符数先翻一番若为杠子，符数再翻两番若为暗刻，符数再翻一番若为清幺九，符数再翻一番若为风牌，符数再翻一番若为三元牌，符数再翻一番\n\nscoreboard players operation @s mahjongtmp = @s mahjongkoutsu\nscoreboard players operation @s[scores={mahjongkantsu=1}] mahjongtmp += @s mahjongtmp\nscoreboard players operation @s[scores={mahjongkantsu=1}] mahjongtmp += @s mahjongtmp\nscoreboard players operation @s[scores={mahjongankou=1}] mahjongtmp += @s mahjongtmp\nscoreboard players operation @s[tag=mahjong.chinyao] mahjongtmp += @s mahjongtmp\nscoreboard players operation @s[tag=mahjong.sangen] mahjongtmp += @s mahjongtmp\nscoreboard players operation @s[tag=mahjong.kaze] mahjongtmp += @s mahjongtmp\nscoreboard players operation @s mahjongtmp += @s mahjongtmp\nscoreboard players operation @e[tag=mahjong.agari] mahjongfu += @s mahjongtmp复制代码\n此外，在这一阶段我们可以统计的役满有：\n\n四杠子：mahjongkantsu 为 4四暗刻（含四暗刻单骑）：mahjongankou 为 4\n\n统计役满的方式和上一阶段大同小异，这里不单独展开了。\n\n最后我们别忘了将雀头数乘二，刻子数和面子数均乘三，得到相对应的有效张数。\n\nscoreboard players set @s mahjongtmpmul 2\nscoreboard players operation @s mahjongjantou *= @s mahjongtmpmul\nscoreboard players set @s mahjongtmpmul 3\nscoreboard players operation @s mahjongmentsu *= @s mahjongtmpmul\nscoreboard players operation @s mahjongkoutsu *= @s mahjongtmpmul复制代码\n第三阶段\n\n这一阶段统计以下牌的有效张数：\n\n风牌（@e[tag=mahjong.kaze]）的刻子和雀头三元牌（@e[tag=mahjong.sangen]）的刻子和雀头清幺九（@e[tag=mahjong.chinyao]）的刻子和雀头2s4s6s8s6z（@e[ta=mahjong.ryuukou]）的刻子和雀头3s（@e[ta=mahjong.ryuumen]）的面子和雀头\n\n通过对上面五个统计量中的两个相加，还可以得出：\n\n字牌的有效张数绿牌的有效张数\n\n在这一阶段，剩余所有的役满都呼之欲出了：\n\n大四喜：风牌 12 张小四喜：风牌 11 张清老头：清幺九 14 张**：三元牌 9 张字一色：字牌 14 张绿一色：绿牌 14 张\n\n如果不存在役满的话，我们进行第四到六阶段，否则直接跳到第七阶段计算符数。\n\n第四阶段\n\n前三阶段收集得到的信息已经足够统计相当数量的役了，因此这一阶段不执行任何额外统计。\n\n从第四阶段开始，门前清的概念十分重要，因此这里需要单独拎出来讲一下门前清是如何判定的。\n\n我们从三个三番役（统计代码均位于 mahjong:handling/sanhan/）的计算开始。首先是二杯口：\n\ntag @s add mahjong.yaku.ryanpeikou\nscoreboard players add @s mahjonghan 3复制代码\n没什么需要解释的，嗯。\n\n然后是纯全带幺九，请注意这里是如何处理“非门清减一番”的：\n\ntag @s add mahjong.yaku.jonchantai\nscoreboard players add @s mahjonghan 3\nexecute if score @s mahjongmentsu matches 0..3 run scoreboard players remove @s mahjonghan 1复制代码\n其实说穿了很简单：门清的面子数为 0/1/2/3 不就是副露了嘛。\n\n然后是混一色。混一色也是“非门清减一番”，理论上应该和上面的处理方式差不多，但真的是这样吗？\n\ntag @s add mahjong.yaku.honitsu\nscoreboard players add @s mahjonghan 3\nexecute if score @s mahjongmentsu matches 0..3 if score @s mahjongchiitoi matches 0 run scoreboard players remove @s mahjonghan 1复制代码\n一个极易忽略的事实是：七对子听牌也是门前清，即使一个面子都没有。\n\n这一步可以处理的役有：\n\n立直、两立直、一发：统计 mahjongriichi抢杠、河底捞鱼、岭上开花、海底摸月：统计 mahjongsaki门前清自摸和：四个非副露的面子自摸或七对子自摸七对子、一气通贯、一杯口、两杯口：统计第一阶段处理映射表输出时得到的数据小三元：三元牌 8 张对对和：刻子数为 4三暗刻：暗刻数为 3三杠子：杠子数为 3役牌：挨个检查门风牌、场风牌、以及三元牌的刻子数量\n\n此处需要额外注意的是：由于吃碰杠的存在，映射表的输入并不一定是 14 张牌，因此这会导致部分和牌牌型中，一杯口和一气通贯漏算。我们将在第六阶段对这两个役进行额外的补算。\n\n第五阶段\n\n这一阶段会将所有统计特殊牌性质的役处理完。这一阶段统计的有效张数有：\n\n混幺九：字牌 + 清幺九带幺九：混幺九 + 2m8m2p8p2s8s 的顺子一色牌 + 字牌：万子 + 字牌、饼子 + 字牌、索子 + 字牌\n\n这一步可以处理的役有：\n\n混老头：混幺九 14 张断幺九：带幺九 0 张纯全带幺九：带幺九 14 张，同时字牌 0 张混全带幺九：带幺九 14 张，同时字牌至少 1 张清一色：一色牌 + 字牌 14 张，同时字牌 0 张混一色：一色牌 + 字牌 14 张，同时字牌至少 1 张\n\n除了有几个役“非门清减一番”外，没什么好注意的。\n\n第六阶段\n\n到了这一步，我们还没有处理，或者说需要额外处理的役种有：\n\n三色同刻三色同顺一气通贯一杯口平和\n\n对于三色同刻和三色同顺，我反正是没想到什么好的办法，只能穷举：\n\n同时有 1m/1p/1s 的刻子/顺子同时有 2m/2p/2s 的刻子/顺子同时有 3m/3p/3s 的刻子/顺子同时有 4m/4p/4s 的刻子/顺子同时有 5m/5p/5s 的刻子/顺子同时有 6m/6p/6s 的刻子/顺子同时有 7m/7p/7s 的刻子/顺子同时有 8m/8p/8s 的刻子/顺子同时有 9m/9p/9s 的刻子/顺子\n\n一气通贯同理：\n\n同时有 2m/5m/8m 的顺子同时有 2p/5p/8p 的顺子同时有 2s/5s/8s 的顺子\n\n一杯口就简单多了。在门清的条件下，我们要求：\n\n存在一张牌没有对应的刻子，但对应的面子的等效牌数至少 6 张\n\n此外，由于这些役往往需要穷举，我们在开始判定前，可以先利用已有的统计数据筛选到一些不可能存在的情况：\n\n三色同刻：刻子至少 3 个，万饼索的有效张数都至少为 3，字的有效张数不超过 5三色同顺：刻子至多 1 个，万饼索的有效张数都至少为 3，字的有效张数不超过 5一气通贯：刻子至多 1 个，带幺九的有效张数至少为 6 至多 11，同时未在第一阶段被提前判定一杯口：门前清的面子有 4 个，同时未在第一阶段被提前判定平和：没有刻子，门前清的面子有 4 个，同时没有三元牌\n\n我们现在只剩下平和一个役没有处理了。因为立直麻将中对平和的规定最多，因此平和是所有役种中最难处理的役，甚至导致了穷举都变得很困难。除去上面的筛选条件外，平和还有以下规定：\n\n不能出现门风牌的雀头不能出现场风牌的雀头听牌不能为边张听牌不能为坎张听牌不能单骑\n\n另外，考虑到立直麻将要求番数大者优先，因此还有一条隐藏规定：\n\n尽可能让听牌对应的顺子往平和牌型靠拢\n\n我们把听牌的要求总结成以下两点：\n\n听牌的上一张有非 2m2p2s 的顺子听牌的下一张有非 8m8p8s 的顺子\n\n那么问题就变得简单了：\n\nscoreboard players set @s mahjongtmp 0\nexecute as @e[tag=mahjong.pai,scores={mahjongtenpai=1}] run scoreboard players operation @e[tag=mahjong.agari] mahjongtmpinc = @s mahjongorder\nscoreboard players add @s mahjongtmpinc 1\nexecute as @e[tag=mahjong.pai] unless entity @s[tag=mahjong.higherdaiyao] if score @s mahjongorder = @e[tag=mahjong.agari,limit=1] mahjongtmpinc if score @s mahjongmentsu > @s mahjongkoutsu run scoreboard players set @e[tag=mahjong.agari] mahjongtmp 1\nscoreboard players remove @s mahjongtmpinc 2\nexecute as @e[tag=mahjong.pai] unless entity @s[tag=mahjong.lowerdaiyao] if score @s mahjongorder = @e[tag=mahjong.agari,limit=1] mahjongtmpinc if score @s mahjongmentsu > @s mahjongkoutsu run scoreboard players set @e[tag=mahjong.agari] mahjongtmp 1复制代码\n我们再额外检查门风牌和场风牌的雀头：\n\nexecute as @e[tag=mahjong.kaze,scores={mahjongjantou=2}] if score @s mahjongorder = @e[tag=mahjong.counter,limit=1] mahjongmenfon run scoreboard players set @s mahjongtmp 0\nexecute as @e[tag=mahjong.kaze,scores={mahjongjantou=2}] if score @s mahjongorder = @e[tag=mahjong.counter,limit=1] mahjongchanfon run scoreboard players set @s mahjongtmp 0复制代码\n最后标记平和：\n\nexecute if score @s mahjongtmp matches 1 run function mahjong:handling/ichihan/markpinfu复制代码\n到此，所有的役种全部处理完毕，换言之，需要计算的番数就只剩下宝牌了。\n\n第七阶段\n\n第七阶段是算符。那么除了在第二阶段处理的外，立直麻将还有哪些需要额外算符的呢？\n\n门清点炮加 10 符如果不是平和的话\n门风牌/场风牌/三元牌雀头加 2 符听边张/坎张/单骑加 2 符自摸加 2 符\n进位到 10 符的整数倍\n\n此外：\n\n若没有平和，但仍然是 20 符，则进位到 30 符七对子无视上面的所有规则，固定 25 符\n\n因为立直麻将在番数相同的情况下，要求符数多者优先，因此：\n\n尽可能让听牌对应顺子，同时往听边张/坎张/单骑靠拢\n\n门清点炮加 10 符的处理方式是显而易见的。而对听牌要求的统计和第六阶段所做的事类似：\n\n边张：听牌的上一张有 2m2p2s 的顺子或下一张有 8m8p8s 的顺子坎张：听牌的对应位置有至少一个顺子单骑：听牌的对应位置有雀头\n\n统计门风牌/场风牌/三元牌雀头的原理不再赘述。\n\n至于如何是进位到 10 符的整数倍的呢？实际上：\n\nscoreboard players set @s mahjongtmpinc 8\nscoreboard players set @s mahjongtmpmul 10\nscoreboard players operation @s mahjongfu += @s mahjongtmpinc\nscoreboard players operation @s mahjongfu /= @s mahjongtmpmul\nscoreboard players operation @s mahjongfu *= @s mahjongtmpmul复制代码\n我们先把符数加 8，这样问题就变成向下取整的问题了。\n\n国士无双\n\n考虑到国士无双无法被映射表映射为和牌，因此我们会在连 mahjongvalue1 都不存在时启用国士无双：\n\nexecute unless score @s mahjongvalue1 matches 0.. run function mahjong:decoding/initpartkokushi复制代码\n检查国士无双的方法说穿了很简单：幺九牌一共有十三种。\n\nscoreboard players set @s mahjongtmp 0\nscoreboard players set @s mahjongtmpdiv 13\nexecute as @e[tag=mahjong.kaze,scores={mahjongcount=1..}] run scoreboard players add @e[tag=mahjong.counter] mahjongtmp 1\nexecute as @e[tag=mahjong.sangen,scores={mahjongcount=1..}] run scoreboard players add @e[tag=mahjong.counter] mahjongtmp 1\nexecute as @e[tag=mahjong.chinyao,scores={mahjongcount=1..}] run scoreboard players add @e[tag=mahjong.counter] mahjongtmp 1复制代码\n如果满足条件，我们就补充生成一个实体：\n\nexecute if score @s mahjongtmp matches 13 at @s run summon minecraft:armor_stand ~ ~ ~8 {CustomName:\"\"agarikokushi\"\",Invisible:1b,NoGravity:1b,Invulnerable:1b,Tags:[\"mahjong.agari\",\"mahjong.agariprev\"]}复制代码\n除了国士无双，我们还需要检查天和和地和：\n\nexecute as @e[tag=mahjong.agari] if entity @e[tag=mahjong.counter,scores={mahjongsaki=6}] run function mahjong:handling/yakuman/markchiihou\nexecute as @e[tag=mahjong.agari] if entity @e[tag=mahjong.counter,scores={mahjongsaki=7}] run function mahjong:handling/yakuman/marktenhou\nexecute as @e[tag=mahjong.agari] run function mahjong:handling/yakuman/markkokushi复制代码\n国士无双固定 30 符：\n\nscoreboard players set @e[tag=mahjong.agari] mahjongfu 30复制代码\n剩下的和普通和牌的处理方式也就都差不多了。\n\n第七步——点数\n\n点数算起来就简单多了，我们先算基本点：\n\n有役满的，基本点 = 役满数 * 8000 点没役满且大于等于 13 番的，基本点 = 8000 点没役满且介于 11 和 12 番的，基本点 = 6000 点没役满且介于 8 和 10 番的，基本点 = 4000 点没役满且介于 6 和 7 番的，基本点 = 3000 点剩下的……诶剩下的呢？\n\n剩下的：如果不超过 5 番，则基本点 = 符数 * 2 ^ (2 + 番数)，并以 2000 封顶。\n\n对于 2 的乘方问题，这里直接使用穷举法了：\n\nexecute if entity @e[tag=mahjong.agari,scores={mahjonghan=1}] run scoreboard players set @s mahjongtmpmul 8\nexecute if entity @e[tag=mahjong.agari,scores={mahjonghan=2}] run scoreboard players set @s mahjongtmpmul 16\nexecute if entity @e[tag=mahjong.agari,scores={mahjonghan=3}] run scoreboard players set @s mahjongtmpmul 32\nexecute if entity @e[tag=mahjong.agari,scores={mahjonghan=4}] run scoreboard players set @s mahjongtmpmul 64\nexecute if entity @e[tag=mahjong.agari,scores={mahjonghan=5}] run scoreboard players set @s mahjongtmpmul 128\nscoreboard players operation @s mahjongbasepoint = @e[tag=mahjong.agari,limit=1] mahjongfu\nscoreboard players operation @s mahjongbasepoint *= @s mahjongtmpmul\nscoreboard players set @s[scores={mahjongbasepoint=2000..}] mahjongbasepoint 2000复制代码\n接下来，亲家得点为基本点的 6 倍，子家为 4 倍（那么怎么判定和牌的到底是亲家还是子家呢：你 484 sa，门风是东风的话就是亲家，门风是南风西风北风的就是子家啊）：\n\nscoreboard players set @s mahjongtmpmul 4\nscoreboard players add @s[scores={mahjongmenfon=27}] mahjongtmpmul 2\nscoreboard players operation @s mahjongpoint = @s mahjongbasepoint\nscoreboard players operation @s mahjongpoint *= @s mahjongtmpmul复制代码\n最后我们向上取整到 100 的整数倍（也就是先把点数加 80 再向下取整）：\n\nscoreboard players set @s mahjongtmpinc 80\nscoreboard players set @s mahjongtmpmul 100\nscoreboard players operation @s mahjongpoint += @s mahjongtmpinc\nscoreboard players operation @s mahjongpoint /= @s mahjongtmpmul\nscoreboard players operation @s mahjongpoint *= @s mahjongtmpmul复制代码\n第八步——输出\n\n这个……输出无非就是一堆 tellraw 命令而已。\n\n感兴趣的打开 mahjong:output/printagari 自己看吧，放张截图：\n\n\n\n总结\n\n麻将是一种拥有非常多的人为规则的游戏，相较普通的大众麻将，立直麻将的规则更是复杂，因此本数据包很有可能有一些 corner case 本人没有顾及到。如读者在使用数据包的时候遇到了问题，尤其是和立直麻将规则本身冲突的问题，或者说读者对于这一数据包有什么意见和建议，望读者不吝赐教。\n\n至于本文的意义……好像也没什么意义（玩命令本身有个 P 的意义哦）。\n\n[groupid=546]Command Block Logic[/groupid]",
    "replies": [
        {
            "author": "ruhuasiyu",
            "timestamp": 1564157100,
            "txt_content": "沉迷麻将的土球……"
        },
        {
            "author": "南派董卓",
            "timestamp": 1564157460,
            "txt_content": "沉迷麻将的土球……+1\n这是土球小号吗？"
        },
        {
            "author": "丢人素学姐",
            "timestamp": 1564280220,
            "txt_content": "你还是需要一个GUI，应该体验会好很多。"
        },
        {
            "author": "(=°ω°)丿",
            "timestamp": 1564719660,
            "txt_content": " 本帖最后由 Teenager_Yang 于 2019-8-2 13:01 编辑 \n\n这是一个只有优秀，没有高亮的帖子\n我第一次见。\n现在有高亮了\n（你到底对麻将有多热爱）\n"
        },
        {
            "author": "fgbfgbfgbfb",
            "timestamp": 1564803720,
            "txt_content": "感谢楼主，(虽然自己没看懂，但感觉好厉害的亚子）"
        },
        {
            "author": "Chaoren⑥",
            "timestamp": 1564818000,
            "txt_content": "什么鬼狗屁，不好使"
        },
        {
            "author": "Leopard_z",
            "timestamp": 1564914240,
            "txt_content": "有啥是mc做不出来的"
        },
        {
            "author": "MC_eternalDH",
            "timestamp": 1565050920,
            "txt_content": "无所不能的mc"
        },
        {
            "author": "lucky888",
            "timestamp": 1565068800,
            "txt_content": " 本帖最后由 lucky888 于 2019-8-24 20:03 编辑 \n\n\"精彩万分，精妙绝伦\"我这句话都是多少天前的了，还扣我分，警告我，你们到底要拿我以前犯的错扣我到什么时候？没事做了吗？一百天以后每个版主都要扣我个遍？"
        },
        {
            "author": "David2019",
            "timestamp": 1565071980,
            "txt_content": "哇哦，非常感谢楼主的这篇文章的分享喔"
        },
        {
            "author": "2860151992",
            "timestamp": 1565073300,
            "txt_content": "打麻将加我的世界，我。。。要。。三缺一了"
        },
        {
            "author": "QAQexe",
            "timestamp": 1565861100,
            "txt_content": "看看，感谢分享"
        },
        {
            "author": "xixikudo",
            "timestamp": 1571791200,
            "txt_content": "楼主有没有兴趣来做一个麻将mod_(:з」∠)_"
        },
        {
            "author": "416410172",
            "timestamp": 1571806920,
            "txt_content": "11111111111"
        },
        {
            "author": "416410172",
            "timestamp": 1571807580,
            "txt_content": "1111111111"
        },
        {
            "author": "416410172",
            "timestamp": 1571809500,
            "txt_content": "11111111111"
        },
        {
            "author": "yuan_small_B",
            "timestamp": 1585061760,
            "txt_content": "我的天 这位教练牛逼啊 （期待以后有机会在mc里面打日麻）\n我看了你这里面说 天和 九莲宝灯 起手的 九莲宝灯 会升级成 纯正九莲宝灯， 那么 国士无双 起手的 天和 应该也是升级成 国士无双十三面 吧？ \n然后想问一下这个有没有设多倍役满？\n比如：\n\n大四喜\n字一色\n四暗刻單騎\n四槓子\n\n六倍役滿\n\n口東東口 口南南口 口西西口 口北北口 發 發"
        },
        {
            "author": "tineseack_bk",
            "timestamp": 1585068540,
            "txt_content": "yuan_small_B 发表于 2020-3-24 22:56\n我的天 这位教练牛逼啊 （期待以后有机会在mc里面打日麻）\n我看了你这里面说 天和 九莲宝灯 起手的 九莲宝 ...\n你这个太棍了，建议直接在游戏里永久禁赛（"
        },
        {
            "author": "yuan_small_B",
            "timestamp": 1585096500,
            "txt_content": "tineseack_bk 发表于 2020-3-25 00:49\n你这个太棍了，建议直接在游戏里永久禁赛（\n我目前只做过一次役满 国士无双\n然而我最自豪的是 有一次 saki大魔王附体做了 岭上开花 最后±0 \n（运气game 运气game）"
        },
        {
            "author": "2453405749",
            "timestamp": 1585109400,
            "txt_content": "楼主厉害，虽然我不怎么懂看着真的厉害"
        },
        {
            "author": "pku_zzzz",
            "timestamp": 1587576900,
            "txt_content": "yuan_small_B 发表于 2020-3-24 22:56\n我的天 这位教练牛逼啊 （期待以后有机会在mc里面打日麻）\n我看了你这里面说 天和 九莲宝灯 起手的 九莲宝 ...国士无双 起手的 天和 应该也是升级成 国士无双十三面\n理论上是会的，但是测试样例没有加\n\n然后想问一下这个有没有设多倍役满\n多倍和复合都有，测试样例里有六倍役满的例子"
        },
        {
            "author": "呆萌苦力怕",
            "timestamp": 1587598980,
            "txt_content": "学到了，感谢大佬！"
        },
        {
            "author": "yuan_small_B",
            "timestamp": 1587624060,
            "txt_content": "pku_zzzz 发表于 2020-4-23 01:35\n理论上是会的，但是测试样例没有加\n感谢这位教练 祝您早日天凤位R2600 或者魂天"
        }
    ]
}