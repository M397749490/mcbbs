{
    "title": "[PCD]爷爷都看得懂的从零开始的核心代码注入教程(一)",
    "author": "弱鸡绿毛怪",
    "replyCount": 4,
    "timestamp": 1534216680,
    "txt_content": " 本帖最后由 MagicLocyDragon 于 2019-7-15 18:01 编辑 \n\n 1-1 ———— 前言   1-1-1 学习本辣鸡教程的最低配置\n—————————————————————————————\n· 熟练面向对象(废话\n· 能熟练使用反射\n· 会使用jdgui等反编译工具翻阅核心代码\n· 对Javassist(Asm)和Javaagent有了解，具体我下面都会说的\n· 对ClassLoader有了解，具体我下面都会说的\n· 有足够的耐心和至少十五分钟的时间\n以上要求的前三个是必须的，如果没有达成你看起来会很吃力.\n—————————————————————————————\n1-1-2 这个能做什么?\n—————————————————————————————\n· 当有插件使用setOp(boolean isOp)方法时，第一时间能获取到并且拦截.\n· 当有插件使用Player.sendMessage(String msg)方法时，能获取到发送的信息并且修改或拦截等等\n· …………\n—————————————————————————————\n1-1-3 废话(雾\n—————————————————————————————\n使用注入核心代码操作的插件现在少的比大熊猫还少，所以想给大家分享一下自己研究的一些成果。\n举个例子:\nhttp://www.mcbbs.net/thread-630067-1-1.html\n这个插件就是运用了Javaagent与Javassist实现了一套反后门，但是你能做的并不仅仅局限于反后门!\n有错误请见谅\n—————————————————————————————\n 1-2 ———— 定目标   1-2-1 目标\n—————————————————————————————\n第一篇教程我们做一个这样的注入:\n当有插件使用Player.sendMessage(String msg);时，如果信息是\"HelloWorld\"，那么就修改成\"ByeWorld\" \n虽然这个pl也许也能实现，不过我们这里使用Javaagent与Javassist实现，有能力的话你可以使用Asm，在这里为了演示得直观，我们使用Javassist.\nJavassist(Maven仓库/下载)\nhttps://mvnrepository.com/artifact/org.javassist/javassist/3.23.1-GA\n\n在做之前，我们要找到Player中的sendMessage的实现位置，打开反编译工具。\n众所周知，CraftPlayer实现了Player接口，那么我们只需要在CraftPlayer类中找就行了\n它在这里:  org.bukkit.craftbukkit.v1_11_R1.entity.CraftPlayer.sendMessage(String msg);\n\n\n\n\nw1.png (5.04 KB, 下载次数: 3)\n\n下载附件\n\n2018-8-14 09:40 上传\n\n\n\n\n\n我们只需在这段代码执行之前注入我们的修改代码即可:\nif (message.equals(\"HelloWorld\")) { message = \"ByeWorld\"; }\n\n· 如果没有了解过Javaagent 我也不想详细说了 直接看csdn里的帖子吧\nhttps://blog.csdn.net/wild46cat/article/details/78917647\n有人说 让服主写Javaagent的启动参数岂不是很麻烦?我们之后会教如何让插件帮服主写启动参数哒~\n—————————————————————————————\n\n 1-3 ———— 实际操作  1-3-1 操作之前\n—————————————————————————————\n 就我们之前的目标而言，这个教程根本都用不着写插件，这只是一个Javaagent的补丁。\n我们先给一下项目开源地址吧\nhttps://github.com/LocyDragon/Course_1\n协议为MIT协议，这代表你可以无偿使用源码。\n—————————————————————————————\n1-3-2 操作\n—————————————————————————————\n我们这里使用maven\n第一步 创建Javaagent执行类(图挂了可以去开源看)\n\n—————————————————————————————\n\n—————————————————————————————\n第二步 在manifest里面指定Premain-Class为Javaagent执行类，我们这里用maven办掉了。如果实在不会的话手写也行。\n—————————————————————————————\n\n\n\n\n1.png (166.62 KB, 下载次数: 2)\n\n下载附件\n\n2018-8-14 10:12 上传\n\n\n\n\n\n编译出来之后 我们用压缩文件打开jar 找到META-INF里的Manifest文件多了一行这个:\n\n\n\n\n1.png (8.09 KB, 下载次数: 4)\n\n下载附件\n\n2018-8-14 10:15 上传\n\n\n\n\n\n如果你实在不知道怎么加的话就把Manifest文件从jar里拖出来写了PremainClass再塞进jar好了.\n—————————————————————————————\n\n第三步 书写注入代码\n—————————————————————————————\n第一步： 确定CraftPlayer类，因为className的输出是像这样的: org/bukkit/craftbukkit/版本/entity/CraftPlayer\n我们很懒 不想判断版本号怎么办? 简单处理一下className即可，下面有源码\n—————————————————————————————\n第二步，注入代码片段（记得把Javassist类库导入下），直接给出最终源码了，注释都写了。\n\n我们把jar编译，(记得javassist打包丢入jar内)丢在服务端根目录下: (注意 别丢plugins文件夹里 原因有很多 我们下次讲\n\n\n\n\n1.png (35.18 KB, 下载次数: 3)\n\n下载附件\n\n2018-8-14 10:31 上传\n\n\n\n\n\n并在bat里面写上有关Javaagent的启动参数\n\n\n\n\n1.png (16.46 KB, 下载次数: 4)\n\n下载附件\n\n2018-8-14 10:43 上传\n\n\n\n\n\n运行服务端，看起来我们已经注入成功了，写个插件测试下吧! （之前这里为了能看到我加了个输出 现在删掉了）\n\n\n\n\n1.png (2.59 KB, 下载次数: 1)\n\n下载附件\n\n2018-8-14 10:45 上传\n\n\n\n\n\n—————————————————————————————\n第三步，测试注入是否成功\n\n\n\n\n1.png (48.56 KB, 下载次数: 0)\n\n下载附件\n\n2018-8-14 10:51 上传\n\n\n\n\n\n很显然，一点毛病都没有\n\n\n\n\n1.png (4.86 KB, 下载次数: 4)\n\n下载附件\n\n2018-8-14 11:04 上传\n\n\n\n\n\n这说明注入成功啦~ 教程到此结束\n\n文件:\nJavaagent注入文件\n\n\n\nAgent.jar\n(594.51 KB, 下载次数: 20)\n\n\n\n2018-8-14 11:17 上传\n点击文件名下载附件\n\n\n\n\n\n\n\n测试jar\n\n\n\nAgentTest.jar\n(2.77 KB, 下载次数: 13)\n\n\n\n2018-8-14 11:18 上传\n点击文件名下载附件\n\n\n\n\n\n\n\n各位的支持会成为我更新的动力\n\nhttp://music.163.com/style/swf/widget.swf?sid=412951828&type=2&auto=1&width=320&height=66[groupid=1330]PluginsCDTribe[/groupid]",
    "replies": [
        {
            "author": "15025321822",
            "timestamp": 1563261000,
            "txt_content": "先马了，慢慢学习"
        },
        {
            "author": "mouwumou",
            "timestamp": 1580030280,
            "txt_content": "\n马了，慢慢学习"
        },
        {
            "author": "chenmoand",
            "timestamp": 1580111460,
            "txt_content": "大佬, 我想说一下在这里直接用Class.forName(String) 会初始化类把,加载静态代码块, 容易出错吧"
        },
        {
            "author": "xiaoqiqi0923",
            "timestamp": 1613815680,
            "txt_content": "大佬, 我想说一下在这里直接用Class.forName(String) 会初始化类把,加载静态代码块, 容易出错吧"
        }
    ]
}