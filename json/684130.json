{
    "title": "关于论坛任务模块的bug",
    "author": "浅念哥",
    "replyCount": 4,
    "timestamp": 1491122340,
    "txt_content": " 本帖最后由 浅念哥 于 2017-4-2 18:57 编辑 \n\nbug利用：在访问页面时\"被接受\"论坛任务\n\n在某一天我突然发现经常莫名其妙的接受了论坛的任务，一开始以为是浏览器缓存，但换个浏览器仍然提示\n于是我在反馈版求助：http://mcbbs.tvt.im/thread-683420-1-1.html\nFHC红石版主回复称是他导致的，并且私信我\n\n\n\n\nQQ截图20170402163150.png (15.71 KB, 下载次数: 0)\n\n下载附件\n\n2017-4-2 16:35 上传\n\n\n\n\n\n经过我测试，在discuz任何版本(包括最新版X3.3)都可以通过<img />HTML标签间接接受任务\n--例如\n接受任务：http://mcbbs.tvt.im/home.php?mod=task&do=apply&id=24\n退出：http://mcbbs.tvt.im/member.php?m ... t&formhash=xxxxxxxx\n收藏：http://mcbbs.tvt.im/home.php?mod ... 0&formhash=xxxxxxxx\n勋章(验证来源)：http://mcbbs.tvt.im/home.php?mod ... ply&medalsubmit=yes\n\n\n\n\nQQ截图20170402164049.png (9.78 KB, 下载次数: 0)\n\n下载附件\n\n2017-4-2 16:43 上传\n\n\n\n\n\n通常这些链接验证formhash或验证来源进行验证，然而任务系统却不验证formhash，也不验证来源\n\n\n初步解决方案：\ndiscuz根目录\\source\\function\\function_discuzcode.php\n搜索\"function bbcodeurl\"，该函数的作用是过滤Discuz代码\nfunction bbcodeurl($url, $tags) {\n        if(!preg_match(\"/<.+?>/s\", $url)) {\n                if(!in_array(strtolower(substr($url, 0, 6)), array('http:/', 'https:', 'ftp://', 'rtsp:/', 'mms://')) && !preg_match('/^static\\//', $url) && !preg_match('/^data\\//', $url)) {\n                        $url = 'http://'.$url;\n                }\n                return str_replace(array('submit', 'member.php?mod=logging', 'home.php?mod=task'), array('', '', ''), str_replace('{url}', addslashes($url), $tags));\n        } else {\n                return '&nbsp;'.$url;\n        }\n}复制代码\n可见\"submit\"和\"member.php?mod=logging\"已经被过滤为空，如上添加\"home.php?mod=task\"即可过滤\n效果：出现以上关键字保存时自动替换为\"\"\n------------------------------------------------------------------------------------------\n以上仅供参考，仍不能从根源解决\n能力有限，建议增加验证\n------------------------------------------------------------------------------------------\n解决方案：增加formhash验证\n刚才试着改了一下发现没什么技术含量\n希望管理员修一下\n\n\n\n\n\n\nQQ截图20170402182706.png (21.14 KB, 下载次数: 0)\n\n下载附件\n\n2017-4-2 18:30 上传\n\n\n\n\n\n\n\n\n\n\n\n\nQQ截图20170402182747.png (20.54 KB, 下载次数: 0)\n\n下载附件\n\n2017-4-2 18:30 上传\n\n\n\n\n\n\n\n\n\n\n\nQQ截图20170402182852.png (30.96 KB, 下载次数: 0)\n\n下载附件\n\n2017-4-2 18:15 上传\n\n\n\n\n\n\ntask模块路径：discuz\\source\\module\\home\\home_task.php\n当参数do等于apply(接受)draw(领取)delete(放弃)的时候加个formhash验证，前台模板按钮链接也加一个URL参数formhash\n常量FORMHASH\n\n\n\n",
    "replies": [
        {
            "author": "xmdhs",
            "timestamp": 1491128640,
            "txt_content": "这个bug真的太猥 琐了  比如看到这张图就收藏了这个帖子\n\n\n好吧 只能对我有用"
        },
        {
            "author": "土球球",
            "timestamp": 1491130500,
            "txt_content": " 本帖最后由 ustc_zzzz 于 2017-4-2 18:58 编辑 \n\n总感觉这个初步解决方案治标不治本= =比如说http://mcbbs.tvt.im/home.php?mod=task&do=apply&id=24可以，那么http://mcbbs.tvt.im/home.php?mod=%74%61%73%6B&do=apply&id=%32%34当然也可以。\n比较直接的解决方法大概是——把这些比较敏感的用户请求全部使用POST而非GET处理，起码是没有办法通过IMG的方法伪造请求了。"
        },
        {
            "author": "浅念哥",
            "timestamp": 1491132540,
            "txt_content": " 本帖最后由 浅念哥 于 2017-4-2 19:32 编辑 \nustc_zzzz 发表于 2017-4-2 18:55\n总感觉这个初步解决方案治标不治本= =比如说http://mcbbs.tvt.im/home.php?mod=task&do=apply&id=24可以， ...\n先正则，把URL的编码都转成正常的字符串\n当我没说\n"
        },
        {
            "author": "YPXxiaoK",
            "timestamp": 1491138660,
            "txt_content": "说实话这个Bug太那啥了"
        }
    ]
}