{
    "title": "插件实例:经验奖章-论如何 添加合成表以及任务调度",
    "author": "初音Py2001",
    "replyCount": 4,
    "timestamp": 1440012780,
    "txt_content": " 本帖最后由 初音Py2001 于 2015-8-20 13:41 编辑 \n\n更新到了v2.2版,下载编译版\n\n/**\n *\n * @author 初音Py2001\n */\npublic class main extends JavaPlugin implements Runnable, Listener {\n\n    @Override\n    public void onEnable() {\n        saveDefaultConfig();\n        配置 = getConfig();\n        刷新时间 = 配置.getInt(\"runTaskTimer\", 4) * 20;\n        buff时间 = 配置.getInt(\"buffTimer\", 8) * 20;\n        if ((buff时间 - 4 * 20) < 刷新时间) {\n            buff时间 = 刷新时间 + 4 * 20;\n        }\n        奖章的合成表建立();\n        任务调度(true);\n        getServer().getPluginManager().registerEvents(this, this);//监听器\n    }\n    FileConfiguration 配置;\n\n    @Override\n    public void onDisable() {\n        HandlerList.unregisterAll((Listener) this);//卸载\n    }\n\n    final static List<String> lore;\n\n    static {\n        lore = new ArrayList<>();\n        lore.add(\"奖章放置在物品栏时:\");\n        lore.add(\"05级获得跳跃提升\");\n        lore.add(\"10级获得速度提升\");\n        lore.add(\"15级获得夜视能力\");\n        lore.add(\"20级获得水下呼吸\");\n        lore.add(\"25级获得急迫提升\");\n\n        lore.add(\"30级获得跳跃提升2\");\n        lore.add(\"40级获得速度提升2\");\n        lore.add(\"50级获得急迫提升2\");\n\n        lore.add(\"60级获得防火能力\");\n        lore.add(\"70级获得生命恢复\");\n    }\n\n    void 奖章的合成表建立() {\n        String t1 = 配置.getString(\"recipe.recipe\", \"NNN,NNN,X-X\");\n        String[] 合成表 = t1.split(\",\");//{\"NNN\", \"NNN\", \"X-X\"};//合成公式\n        String t2 = 配置.getString(\"recipe.Item\", \"338\");\n\n        经验奖章 = new ItemStack(388, 1);//建立一个新的物品堆叠\n        ItemMeta im = 经验奖章.getItemMeta();//获取物品的属性\n        im.setDisplayName(配置.getString(\"recipe.name\", \"经验奖章\"));//设置物品的显示名字\n        im.setLore(lore);//设置物品的Lore\n        经验奖章.setItemMeta(im);//设置物品的属性\n\n        ShapedRecipe recipe = new ShapedRecipe(经验奖章);//获取这个物品堆叠的合成表句柄\n        recipe.shape(合成表);//添加合成公式\n//        recipe.setIngredient('N', Material.GOLD_BLOCK);//设置N是金块\n//        recipe.setIngredient('X', Material.WOOL);//设置X是羊毛\n//        recipe.setIngredient('-', Material.AIR);//设置每个字符是什么方块,不设就是空气\n        shape(recipe, t1);//过程抽离...\n        getServer().addRecipe(recipe);//注册合成表\n    }\n    ItemStack 经验奖章;\n\n    synchronized void 任务调度(boolean 状态) {\n        /*\n         *  这个方法被多个线程操作,有可能发生意外,所以在调用这个方法时,应当使用同步\n         */\n        if (状态) {\n            if (调度任务 == null) {\n                //建立一个任务,20tick之后开始,每隔20*4tick执行一次\n                调度任务 = getServer().getScheduler().runTaskTimer(this, this, 5, 刷新时间);\n            }\n        } else {\n            if (调度任务 != null) {\n                //删除调度任务\n                getServer().getScheduler().cancelTask(调度任务.getTaskId());\n            }\n        }\n    }\n    BukkitTask 调度任务;\n    int 刷新时间;\n\n    private void shape(ShapedRecipe recipe, String t1) {\n        HashSet<Character> s = new HashSet<>();\n        for (char t : t1.toCharArray()) {\n            if (s.contains(t)) {\n                continue;\n            } else {\n                s.add(t);\n            }\n            if (t != ',') {\n                String t3 = 配置.getString(\"recipe.\" + t);\n                if (t3 == null) {\n                    continue;\n                }\n//                System.out.println(t + \": \" + t3);\n                String[] t4 = t3.split(\"\\\\.\");\n//                System.out.println(t + \": \" + Arrays.toString(t4));\n                if (t4.length > 1) {\n                    int t5 = Integer.parseInt(t4[0]);\n                    byte t6 = Byte.parseByte(t4[1]);\n                    System.out.println(t5 + \":\" + t6);\n                    recipe.setIngredient(t, new MaterialData(t5, t6));\n                } else {\n                    int t5 = Integer.parseInt(t4[0]);\n                    recipe.setIngredient(t, new MaterialData(t5));\n                }\n//                System.out.println(t + \": 设置完毕\");\n            }\n        }\n    }\n\n    @EventHandler(priority = EventPriority.LOWEST)\n    public void PlayerJoinEvent(PlayerJoinEvent event) {\n        //监听登陆消息\n        任务调度(true);\n    }\n\n    @Override\n    public void run() {\n        Collection<? extends Player> ps = getServer().getOnlinePlayers();\n        if (ps.isEmpty()) {//服务器没有玩家\n            任务调度(false);\n        }\n        for (Player p : ps) {\n            //检查玩家背包\n            PlayerInventory i = p.getInventory();//获取背包\n            for (int j = 0; j < 9; j++) { //查找\n                ItemStack item = i.getItem(j);\n                if (item == null //这个背包格子没有物品\n                        || !item.hasItemMeta() //物品没有NET标签\n                        || !item.getItemMeta().hasLore()) {//没有Lore\n                    continue;\n                }\n                List<String> l = item.getItemMeta().getLore();\n                if (l.get(0).equals(\"奖章放置在物品栏时:\")) {\n\n                    int lv = p.getLevel();//获取玩家等级\n//                    System.out.println(\"int:\" + j + \" Lv:\" + lv);\n                    if (lv >= 70) {\n                        addBuff(p, PotionEffectType.REGENERATION, buff时间, 0);\n                    }\n                    if (lv >= 60) {\n                        addBuff(p, PotionEffectType.FIRE_RESISTANCE, buff时间, 0);\n                    }\n\n                    if (lv >= 50) {\n                        addBuff(p, PotionEffectType.FAST_DIGGING, buff时间, 1);\n                    }\n                    if (lv >= 40) {\n                        addBuff(p, PotionEffectType.SPEED, buff时间, 1);\n                    }\n                    if (lv >= 30) {\n                        addBuff(p, PotionEffectType.JUMP, buff时间, 1);\n                    }\n\n                    if (lv >= 25) {\n                        addBuff(p, PotionEffectType.FAST_DIGGING, buff时间, 0);\n                    }\n                    if (lv >= 20) {\n                        addBuff(p, PotionEffectType.WATER_BREATHING, buff时间, 0);\n                    }\n                    if (lv >= 15) {\n                        addBuff(p, PotionEffectType.NIGHT_VISION, buff时间 + 160, 0);\n                    }\n                    if (lv >= 10) {\n                        addBuff(p, PotionEffectType.SPEED, buff时间, 0);\n                    }\n                    if (lv >= 5) {\n                        addBuff(p, PotionEffectType.JUMP, buff时间, 0);\n                    }\n\n                    break;//一旦找到了,就结束查找\n                }\n            }\n        }\n    }\n    int buff时间;\n\n    void addBuff(Player p, PotionEffectType Type, int Duration, int Amplifier) {\n        Collection<PotionEffect> ape = p.getActivePotionEffects();//获取玩家所有buff\n        for (PotionEffect next : ape) {\n//            System.out.println(\"Type:\" + Type.equals(next.getType())\n//                    + \" Tick:\" + (Amplifier >= next.getAmplifier())\n//                    + \" Lv:\" + (Duration >= next.getDuration()));\n            if (Type.equals(next.getType())//类型是否一致\n                    && Amplifier >= next.getAmplifier()//比较时间\n                    && Duration >= next.getDuration()) {//比较buff等级\n                p.addPotionEffect(new PotionEffect(Type, Duration, Amplifier), true);//强制替换原来的buff,达到刷新时间的效果\n                return;\n            }\n        }\n//        System.out.println(\"添加\");\n        p.addPotionEffect(new PotionEffect(Type, Duration, Amplifier));\n    }\n}复制代码请务必不要吐槽中文变量/类名/方法名\n5小时不到就完成的渣作,请随意使用\n下面是配置文件..\nrecipe: \n    #合成表\n    Item: 388\n    name: \n    recipe: NNN,NNN,X-X\n    N: 41\n    X: 35.6\n#   -: 0\n#每4秒刷新一次buff\nrunTaskTimer: 4\n#每次buff上8秒,如果比刷新时间短,则自动为刷新时间+4秒\nbuffTimer: 8复制代码",
    "replies": [
        {
            "author": "lxroo96",
            "timestamp": 1441070460,
            "txt_content": "感谢楼主发布源码，让我们小白有参考"
        },
        {
            "author": "qqq137",
            "timestamp": 1441106040,
            "txt_content": "求教如何制作插件 一个完整的教程都没找到"
        },
        {
            "author": "初音Py2001",
            "timestamp": 1441114440,
            "txt_content": "qqq137 发表于 2015-9-1 19:14\n求教如何制作插件 一个完整的教程都没找到\nhttp://www.mcbbs.net/forum.php?m ... eid&typeid=1029\n论坛里很多教程呀..."
        },
        {
            "author": "qqq137",
            "timestamp": 1441114920,
            "txt_content": "初音Py2001 发表于 2015-9-1 21:34\nhttp://www.mcbbs.net/forum.php?mod=forumdisplay&fid=479&filter=typeid&typeid=1029\n论坛里很多教程呀 ...\n额.. 好吧 我没看见还有这个选项..."
        }
    ]
}