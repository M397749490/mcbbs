{
    "title": "【求大神解答】如何解决光影景深引起的内存泄漏？",
    "author": "rtxyd",
    "replyCount": 19,
    "timestamp": 1588598940,
    "txt_content": " 本帖最后由 rtxyd 于 2020-5-4 21:36 编辑 \n\n问题描述：最近玩mc找了很多光影测效果结果有些光影一放到后台就内存飙升。配置信息：forge版本2847。optfine 1.12.2 F5 最新版的。我用纯净客户端+启动器BakaXL 2.2.8.4测的。电脑配置gtx 1066，八代i7，12G内存，游戏分配内存6G。并且试过站内的openj9方案没效果。\n详细说明：我每次加光影之后如果光影里不存在景深(DOF)功能或者没打开景深功能，最小化客户端之后javaw.exe进程内存占用就一直飙升直到崩溃。只加optfine一个mod也会这样。如果内存飙升开始，客户端就会未响应，从最小化切换回来会继续有一段时间未响应但是内存占用不再飙升，观察任务管理器显示内存占用没有变化，游戏内F3显示内存占用(游戏内的内存占用是正常的没有飙升)没有变化，就这样玩一段时间内存占用会慢慢变小到原来的水平，但是只要最小化就会又出问题。\n用optfine内置光影不会出问题。用带有并且打开景深(DOF)的光影不会出问题。不最小化客户端看网页、有QQ什么的其他事情都不会出问题。\n附：在网上查了一下，这是内存泄漏的问题，目前没看到有什么好的解决办法，希望大神帮小白指导一下，有没有从根本上解决问题的办法。暂时不考虑内存清理mod（后台未响应估计装了也没用）。\n\n\n",
    "replies": [
        {
            "author": "EmptyLava",
            "timestamp": 1588599420,
            "txt_content": " 本帖最后由 EmptyLava 于 2020-5-4 21:40 编辑 \n\n建议你发一下无响应时候的日志\n\n1.用这个mod\n[1.12.x][VF——原版修复]游戏不再崩溃，提升三倍FPS，整合包加载速度提高50％！[FS]\nhttps://www.mcbbs.net/thread-792493-1-1.html\n(出处: Minecraft(我的世界)中文论坛)2.增大xmx可减少gc次数\n3.使用更好的gc参数\n-Xss512K -XX:+AggressiveOpts -XX:+UseCompressedOops -XX:+UseCMSCompactAtFullCollection -XX:+UseFastAccessorMethods -XX:ParallelGCThreads=4 -XX:+UseConcMarkSweepGC -XX:CMSFullGCsBeforeCompaction=2 -XX:CMSInitiatingOccupancyFraction=70 -XX:-DisableExplicitGC -XX:TargetSurvivorRatio=90复制代码"
        },
        {
            "author": "rtxyd",
            "timestamp": 1588599600,
            "txt_content": " 本帖最后由 rtxyd 于 2020-5-4 21:41 编辑 \nEmptyLava 发表于 2020-5-4 21:37\n1.用这个mod\n[1.12.x][VF——原版修复]游戏不再崩溃，提升三倍FPS，整合包加载速度提高50％！[FS]\nhttps:// ...\n只能降低飙升的速度吗？我用过光照修复、泡沫修复、原版修复、better fps这些mod对这个问题没有效果。"
        },
        {
            "author": "EmptyLava",
            "timestamp": 1588599720,
            "txt_content": "rtxyd 发表于 2020-5-4 21:40\n只能降低飙升的速度吗？\n去查光影景深导致内存泄漏的原因是不现实的\n只能降低内存提升的速度"
        },
        {
            "author": "rtxyd",
            "timestamp": 1588600500,
            "txt_content": "EmptyLava 发表于 2020-5-4 21:42\n去查光影景深导致内存泄漏的原因是不现实的\n只能降低内存提升的速度\n这是日志，我一直挂着等他内存占用到99%之后java崩溃。好像日志里并没有写未响应的时候发生的事情。我在那之前调到了一个没有景深的光影并最小化等待崩溃。并没有崩溃报告。\n\n\n\n\n\n\n\nlatest.log\n\n\n2020-5-4 21:53 上传\n点击文件名下载附件\n\n\n\n\n55.06 KB, 下载次数: 5\n\n\n\n\n"
        },
        {
            "author": "EmptyLava",
            "timestamp": 1588600800,
            "txt_content": "rtxyd 发表于 2020-5-4 21:55\n这是日志，我一直挂着等他内存占用到99%之后java崩溃。好像日志里并没有写未响应的时候发生的事情。我在 ...\n日志看起来没问题\n全是info"
        },
        {
            "author": "rtxyd",
            "timestamp": 1588600920,
            "txt_content": "EmptyLava 发表于 2020-5-4 21:42\n去查光影景深导致内存泄漏的原因是不现实的\n只能降低内存提升的速度\n我的客户端目录下生成了将近30个G的未知文件文件，不知道为什么。\n\n\n\n\n\n\ndump.png\n(201.59 KB, 下载次数: 0)\n\n\n\n\n下载附件\n\n\n2020-5-4 22:02 上传\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"
        },
        {
            "author": "EmptyLava",
            "timestamp": 1588601100,
            "txt_content": "rtxyd 发表于 2020-5-4 22:02\n我的客户端目录下生成了将近30个G的未知文件文件，不知道为什么。\n试一试参数看下能否减小\n这堆储存文件有点大啊...\n\n无效的话按照这里教程分析一下\nhttps://www.cnblogs.com/wyb628/p/8567610.html"
        },
        {
            "author": "rtxyd",
            "timestamp": 1588601340,
            "txt_content": "EmptyLava 发表于 2020-5-4 22:05\n试一试参数看下能否减小\n这堆储存文件有点大啊...\n谢谢大佬，好像有点复杂，我去学一下看看能不能解决。。。"
        },
        {
            "author": "rtxyd",
            "timestamp": 1588613880,
            "txt_content": " 本帖最后由 rtxyd 于 2020-5-5 04:46 编辑 \nEmptyLava 发表于 2020-5-4 22:05\n试一试参数看下能否减小\n这堆储存文件有点大啊...\njava251版改成你发的参数之后飚的更快了，后台十几秒就崩了，设置xmx512M稍微有点效果但是还是一直涨。其他版本我没试。问题似乎与java版本有关系，我以前就是因为8G内存的电脑带不起（java191版本也会后台飙内存）才换成java251版的。我连着换了好多java版本，有的版本有时候情况没那么严重，只飙十秒就不飙了，不过游戏还是会未响应。另外还有的版本里用chocapic关掉景深没问题，开了会开始飙内存。很迷。。另外这是那个教程最后能得出的结果。我总觉得这个好像没啥问题来着，还是光影的问题吧应该。。。这个图打印出的文件是内存飙到80多的时候输出的，90左右就快要闪退了。\n\n\n\n\n\n\nimage.png\n(322.14 KB, 下载次数: 0)\n\n\n\n\n下载附件\n\n\n2020-5-5 03:56 上传\n\n\n\n\n\n\n\n\n我的光影\n\n\n\n\n\n\n\n\n\n\n\nimage.png\n(219.47 KB, 下载次数: 0)\n\n\n\n\n下载附件\n\n\n2020-5-5 04:37 上传\n\n\n\n\n\n\n\n\nheapdump\n\n\n\n\n\n\n"
        },
        {
            "author": "EmptyLava",
            "timestamp": 1588633740,
            "txt_content": "rtxyd 发表于 2020-5-5 01:38\njava251版改成你发的参数之后飚的更快了，后台十几秒就崩了，设置xmx512M稍微有点效果但是还是一直涨。其 ...\n分析内的栈只能看出是材质导致的...\n如果换一个客户端呢"
        },
        {
            "author": "别投-没送够",
            "timestamp": 1588640340,
            "txt_content": "运行内存调大试试(*Φ皿Φ*)"
        },
        {
            "author": "rtxyd",
            "timestamp": 1588655220,
            "txt_content": "EmptyLava 发表于 2020-5-5 07:09\n分析内的栈只能看出是材质导致的...\n如果换一个客户端呢\n输出的这个文件他显示的总内存数并不是我设置的内存或者客户端占用的内存大小，只有几百M，是正常的吗？之前他飙内存的时候输出了几个javacore文件和heapdump文件太大了我也不知道怎么用。就删了，网上有说javacore是cpu使用情况，heapdump文件是内存使用情况，可以提取出.hprof内存镜像文件。我这个飙到80%的时候输出的文件只有300M，是不是太小了。换一个客户端指的是换java还是重新打包客户端？"
        },
        {
            "author": "rtxyd",
            "timestamp": 1588655400,
            "txt_content": "liangshaoshen 发表于 2020-5-5 08:59\n运行内存调大试试(*Φ皿Φ*)\n没用的。。。我只装了一个optfine并且内存设的是6G。无可厚非吧。"
        },
        {
            "author": "段位全靠肝",
            "timestamp": 1588656000,
            "txt_content": "重装游戏，重装过程中防止病毒侵入，清理电脑"
        },
        {
            "author": "YUN_jiu",
            "timestamp": 1588665960,
            "txt_content": "调高游戏内存，推荐4096MB"
        },
        {
            "author": "rtxyd",
            "timestamp": 1588686060,
            "txt_content": " 本帖最后由 rtxyd 于 2020-5-5 21:49 编辑 \nEmptyLava 发表于 2020-5-5 07:09\n分析内的栈只能看出是材质导致的...\n如果换一个客户端呢\n 我重新做了一个1.12.2的客户端，然后还下载了1.14.4的客户端进行对比（只装optfine和光影），1.14可以兼容所有光影并且不会在后台未响应，没有任何内存上的问题。另外我发现我一直用的java251版是jre251不是jdk，jdk是191版的。不过jdk191好多光影用不了，而从jre\\bin中找到的javaw.exe可以兼容所有光影。jdk191因为很多光影不兼容，除了BSL光影之外我的其他光影都报错，报错的光影最小化之后内存飙升幅度较小或者没有飙升。jre251没有材质报错问题，但是就是有和景深相关的内存飙升问题。另外我还试了openj9的252版和它的large heap版，两个版本一样的效果，内存增长速度明显变慢了（图传不上去）。openj9的262版和262版的large heap版，这个版本的openj9对光影兼容性也很差，jdk191不兼容的光影它也不兼容（报错）最小化之后内存也会短时间增长，并在后台会无响应，很快停止增长。262的large heap版最小化未响应的时的内存的增长速率和openj9 252版类似。后来我又测了openjdk252的hotspot版（这个版本跟jdk191一样光影报错）它还是和openj9 262的情况类似（实际上jdk191就是这个问题），最小化会未响应，内存增长到一定量之后不再增长（对于不会报错的光影来说）。\n\n\n\n\n\nimage.png\n(154.84 KB, 下载次数: 0)\n\n\n\n\n下载附件\n\n\n2020-5-5 20:50 上传\n\n\n\n\n\n\n\n\n正常\n\n\n\n\n\n\n\n\n\n\n\nimage.png\n(154.53 KB, 下载次数: 0)\n\n\n\n\n下载附件\n\n\n2020-5-5 20:50 上传\n\n\n\n\n\n\n\n\n70%占用\n\n\n\n\n\n\n\n\n\n\n\nimage.png\n(154.49 KB, 下载次数: 0)\n\n\n\n\n下载附件\n\n\n2020-5-5 20:51 上传\n\n\n\n\n\n\n\n\n80%占用\n\n\n\n\n\n\n\n\n\n\n\nimage.png\n(83.88 KB, 下载次数: 0)\n\n\n\n\n下载附件\n\n\n2020-5-5 21:02 上传\n\n\n\n\n\n\n\n\n内存增长图\n\n\n\n\n\n\n"
        },
        {
            "author": "EmptyLava",
            "timestamp": 1588686600,
            "txt_content": "rtxyd 发表于 2020-5-5 21:41\n我重新做了一个1.12.2的客户端，然后还下载了1.14.4的客户端进行对比（只装optfine和光影），1.14可以兼 ...\n可能要用1.14的客户端了\n光影不可能兼容性这么差啊.."
        },
        {
            "author": "rtxyd",
            "timestamp": 1588689600,
            "txt_content": " 本帖最后由 rtxyd 于 2020-5-5 22:45 编辑 \nEmptyLava 发表于 2020-5-5 21:50\n可能要用1.14的客户端了\n光影不可能兼容性这么差啊..\n客户端先别换了，我和朋友玩了一段时间了。。我使用集成显卡进行游戏，发现内存增长只会增长一段时间，虽然会未响应但是可以最小化挂着不管。也许我之前测的时候是因为我没调整显卡。。我觉得我先更新一下显卡驱动。"
        },
        {
            "author": "rtxyd",
            "timestamp": 1588699200,
            "txt_content": " 本帖最后由 rtxyd 于 2020-5-6 09:30 编辑 \nEmptyLava 发表于 2020-5-5 21:50\n可能要用1.14的客户端了\n光影不可能兼容性这么差啊..\n大佬，我更新显卡驱动（因为要用GeForce更新）发现了大概原因，我使用原版MC的时候它暂停最小化到后台会多吃30%的GPU，然后我使用光影的时候他暂停最小化后会吃100%GPU，然而如果有景深打开的话，就没有变化。于是我去找了fps reducer mod来降低GPU的占用率，虽然没从根本上解决问题。但是还是有效果了。最小化到后台不会再吃100%GPU了。另外我觉得，可能是暂停最小化后会导致不断渲染什么东西GPU处理不过来，目前我也不知道该怎么解决。使用集成显卡的时候也会导致GPU占用升高，但是集成显卡本身就处理不了独显那么多的数据，所以java能快速反应过来把多余的内存清理掉。然后我使用了N卡自带的游戏优化软件GeForce Experience，开启优化所有游戏，WHISPER MODE之后，即使不加fps reducer，最小化的时候GPU占用会瞬间飙到100%然后以你肉眼看不见的速度降到正常的范围（只是限制了GPU使用，不过使用fps reducer和1.14版本不会出现瞬间飙到100%的现象，并没有改变它对GPU占用增加的问题）。那这个问题就算解决了吧，感谢大佬的建议。问题的大概原因已找到，没有景深的光影会导致我的显卡（GeForce Experience 1060 GPU）满负荷运作，从而导致java无法及时移除渲染过的内存（超过java的处理范围，后台无响应），具体原理还不清楚。使用openj9会减缓内存泄漏的速度。\n\n\n总结一下解决方式：（emmm我去申请一下自行解决吧，顺便\n感谢大佬的帮助\n\n没有你的建议我也找不到这么多解决方法）\n\n①你建议的更新游戏；\n②使用FPS reducer mod；（这个站里有人搬运了）\n③使用其他能优化游戏、限制GPU使用率的插件比如igame，GeForce Experience；\n④使用openj9；（只能减缓）⑤使用集成显卡；（算了吧。。）\n如果以后从根本上解决了我再发个帖子好了。（然而那大概是不可能的）\n\n\n\n\n\n\n"
        }
    ]
}