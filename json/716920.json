{
    "title": "[Tutor][PCD] 如何使用持续集成帮助开发",
    "author": "海螺螺",
    "replyCount": 0,
    "timestamp": 1502108820,
    "txt_content": " 本帖最后由 754503921 于 2017-8-7 22:10 编辑 \n\n如何使用持续集成帮助开发 1. 什么是持续集成\n持续集成（英语：Continuous integration，缩写为 CI），一种软件工程流程，将所有工程师对于软件的工作复本，每天集成数次到共用主线（mainline）上。引用中文维基百科个人理解：当你每次提交代码到 GitHub 等代码仓库时，你可能不知道这次更改造成了什么后果。有了持续集成以后，你将能够得知你的代码的更改所造成的结果。\n持续集成主要负责这些事：\n维护一个代码库自动构建让构建时会自我测试所有人每天至少提交一次应该要构建每一个提交让构建维持快速用在线环境的复本测试让获取最新发布版本更容易任何人都可以查看最后构建的结果自动部署\n也就是说，在利用最佳的情况下，你将不用再担心软件的发布、测试问题，这样你就可以专心在代码编写上了！\n2. 开始你的持续构建之路\n本人为 Bukkit 插件开发者，所以我将以 Bukkit 插件的开发作为示例，其他如 Forge Mod 开发也是类似的。\n由于没有可用的 Jenkins 服务器，所以我将以 Circle CI 作为教程的示例。\n依赖控制系统我使用 Maven 作为这个教程的示例，Forge 使用的 Gradle 也差不多。\n所以，你需要准备：\n一个 GitHub 账号（https://github.com）一个 Circle CI 账号（https://circleci.com/）一些对 Git、依赖控制系统的知识一些对 Linux 的知识（非必需）一些对 YAML 的知识\n为什么要使用 GitHub 而不是类似 coding、码云等国内的网站呢？因为 Circle CI 只有对 GitHub、BitBukkit 的支持。\n为什么需要对 Linux 有一些了解呢？因为 Circle CI 本质上是一台内存为 4 GB 的联网的Linux虚拟机。\n如果对 Maven 毫无概念，我推荐你先看一下这一篇教程： http://www.mcbbs.net/thread-711754-1-1.html\n当你将 GitHub、Maven 配置完全后，我们将开始这篇教程的重点。\n3. 将项目部署到 Circle CI\n进入 Circle CI 主界面，点击 PROJECTS -> Add Project\n\n然后在你的项目列表中，任意选择一个，点击 Setup project\n至此，你已经将你的项目部署到了 Circle CI。\n4. 设置 Circle CI（circle.yml）\n你的确已经将项目部署到了 Circle CI，但是这不代表 Circle CI 会像你想象的一样完成所有的构建并导出，正相反，如果你安装了邮箱客户端或者偶然看了一下邮箱的话，你应该已经收到了 Circle CI 的构建失败的通知了。这也是持续集成的好处之一：构建失败能够及时通知你。\n那么要如何指定你的构建服务器应该怎样做呢？每个 CI 有各自的方法，我使用的 Circle CI 则是需要在项目的根目录，放上一个名为 circle.yml 的文件。Travis CI 则是 .travis.yml，但这不在本文的讨论范围。\nCircle CI 1.0 版本\n先展示一份配置好的 circle.yml。\nmachine:\n  java:\n    version: openjdk8\n  notify:\n    branches:\n      only:\n        - master\ndependencies:\n  override:\n    - git config --global user.email \"circle@circleci.com\"\n    - git config --global user.name \"CircleCI\"\n    - chmod +x scripts/build.sh\n    - ./scripts/build.sh\ntest:\n  post:\n    - yes|mv -f ./target/Plugin-*.jar $CIRCLE_ARTIFACTS/Plugin-$CIRCLE_BUILD_NUM.jar复制代码接着解释每一行是什么意思。\n第一行：\nmachine:\n  java:\n    version: openjdk8\n这里规定了使用的环境，Minecraft 使用的开发环境为 Java，所以我们写 java。使用的版本可以是 openjdk7 或者 openjdk8  notify:\n    branches:\n      only:\n        - master\n只提示 master 分支的构建错误等信息。dependencies:\n  override:\n    - git config --global user.email \"circle@circleci.com\"\n    - git config --global user.name \"CircleCI\"\n    - chmod +x scripts/build.sh\n    - ./scripts/build.sh\n这一部分是正式构建需要做的事。由于此示例项目的构建的命令放在了 script 目录下的 build.sh 中，所以我们会先给这个文件加权限（chmod +x），接着执行这个脚本文件。你也可以直接在 circle.yml 执行命令。\n脚本文件大概是这个样子的：\necho \"正在构建，版本号  $CIRCLE_BUILD_NUM ...\"\nmvn clean install package复制代码nvm clean install package\n这个命令是 Maven 的基本构建生成的命令，会自动下载所有的依赖并编译源码，最后打包放入 /target 目录。\nGradle 就是 ./gradlew build。test:\n  post:\n    - yes|mv -f ./target/Plugin-*.jar $CIRCLE_ARTIFACTS/Plugin-$CIRCLE_BUILD_NUM.jar\n构建完成的 JAR 文件放在 /target 目录，但是 Circle CI 不会自动将其提取。所以我们需要手动移动（mv a.jar b.jar）构建完成的 jar 文件到输出的目录，Circle CI 使用环境变量 $CIRCLE_ARTIFACTS 来表示这个目录。这个项目使用了一些小技巧，使用了 $CIRCLE_BUILD_NUM 这个环境变量来表示构建号。\nGradle 就是 yes|mv -f ./build/lib/*.jar $CIRCLE_ARTIFACTS/Mod-$CIRCLE_BUILD_NUM.jar\n详细的环境变量列表请看 https://circleci.com/docs/2.0/env-vars/ 。\n\n当配置完成 circle.yml 后，你就可以将其上传至 GitHub 了。等待一会儿，你将会收到 Circle CI 发来的构建成功的邮件。\n5. 下载你的构建结果\n点击项目的构建号，点击 Artifacts，展开文件夹，点击你需要用于下载的文件。\n\n6. 其他更厉害的操作\n你可以在你的帖子里加入这样一个小图标装逼，地址为 https://circleci.com/gh/用户/项目/tree/分支.svg\n示例：  这个图标类似 Jenkins 的 embedded status 插件，会实时显示这个项目的构建状况。\n你可以将构建的结果发回 GitHub 的 release 去，参考官方文档。\n你可以搭建自己的服务器，并且配置向你的服务器发送一个 json 包，包含构建的信息。\n你可以使用两个容器并行操作，进行服务端客户端的模拟。\n你可以将 Bukkit 完整的拷贝进你的 GitHub 并使用开启服务器的命令启动这个服务器，反正内存有 4 GB。你可以使用这个方法来进行测试，但是请完成这个测试后关闭服务器，否则 Circle CI 会将处理过长时间的命令视作构建失败。\n甚至你可以利用网站的 API 来自动将结果推送到网站。（如果 spigotmc 有相关的 API 那么就实现了完全的自动发布系统，我也不知道有没有）。\n你可以在官方文档找到开启一个数据库的方法，这样你在测试的时候就可以使用 MySQL 数据库了。\n7. 一些可能有用的链接\nGitHub 地址 https://github.com\nCircle CI 地址 https://circleci.com\nTravis CI 地址 https://travis-ci.org\nCircle CI 文档 https://circleci.com/docs/2.0/\nCircle CI 环境变量 https://circleci.com/docs/2.0/env-vars/\nMaven 的部分教程 http://www.mcbbs.net/thread-711754-1-1.html\n使用的示例项目的地址 https://github.com/IzzelAliz/RandomMarket/\n\n这篇教程仅仅作为抛砖引玉，如果你研究出了更加高级的用法，欢迎分享。 \n[groupid=1330]PluginsCDTribe[/groupid]\n",
    "replies": []
}