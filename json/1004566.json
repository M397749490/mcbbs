{
    "title": "【优化】1.15.2Paper服务端TPS低挖方块回弹传送掉虚空 附详细情况及timings",
    "author": "YZH20011356810",
    "replyCount": 18,
    "timestamp": 1585712520,
    "txt_content": " 本帖最后由 YZH20011356810 于 2020-4-1 13:21 编辑 \n\n需要解决的问题：此子服内玩家游戏出现挖方块回弹、传送有几率掉虚空、拾取地上掉落物慢等问题\n\n最佳回复标准：清晰表示出服务器卡顿原因，并给予解决方案（非极限压缩视距等Ji Duan方案），使TPS平均值提高3以上\n\n此服务器为1.15.2纯净生存服务器 含有刷怪塔、红石机械等元素。\n服务器群组架构\n                                                 --mod服（无人）部署在①\n\nWaterfall（部署在①）             --纯净服 部署在③\n                                                 --大厅、小游戏 部署在①\n\n\n我们使用过的方案：\n1.调整服务端的config文件，压缩部分视距，减少怪物生成频率，取消刷怪笼生成怪物的AI等\n2.使用部分java性能分析工具 分析得到的结果没有比较强的可行性（比如马特占用timings）\n3.采用更高性能的服务器\n\n\n服务器配置:\n①E5 2643 v3 ES版6核心12线程+32G 2400 ECC内存+Z400S  浙江电信100M，上行20M\n\n②3950x 8核心8线程+16G 内存+三星970 EVO    三线BGP\n\n③i7-4790k 超频4.6G 4核心8线程+16G 1866内存+三星860 EVO 浙江电信100M，上行20M\n\n①为服务器原本配置，游戏人数30人时TPS平均为10左右，最低可达5\n\n\n\n\nTIM图片20200401111940.png (12.45 KB, 下载次数: 0)\n\n下载附件\n\n2020-4-1 11:22 上传\n\n\n\n\n\n\n考虑到mc服务端或对CPU主频、内存、硬盘有更高要求，暂时迁移至②配置\n但仍有掉TPS现象\n刚开始：\n\n\n\n\nTIM图片20200401112353.png (32.14 KB, 下载次数: 0)\n\n下载附件\n\n2020-4-1 11:24 上传\n\n\n\n\n\n过了一段时间\n\n\n\n\nTIM图片20200401112403.png (26.61 KB, 下载次数: 0)\n\n下载附件\n\n2020-4-1 11:24 上传\n\n\n\n\n\n\n②主机过期后，服务器迁移到了我的游戏机上\n超频得到了更高主频，但是游戏效果似乎比①齐平或者更差\n\n服务器Timings报告  注：此份报告是在服务器配置③的情况下得到的\n\n需要沟通获得更多信息？\n私信联系\n\n\n\n\n",
    "replies": [
        {
            "author": "EmptyLava",
            "timestamp": 1585712520,
            "txt_content": "YZH20011356810 发表于 2020-4-2 14:27\n比如守卫者鱼场有千把个漏斗矿车\n玩家“主要是减少掉帧？\n不想让矿车动起来\n玩家一去鱼场就会凭空增加20%的pct tick\n\n没做过鱼场，只能用漏斗矿车吗"
        },
        {
            "author": "1784234383",
            "timestamp": 1585713000,
            "txt_content": " 本帖最后由 1784234383 于 2020-4-1 11:54 编辑 \n\n4790K的高主频并不能代表很好的性能\n如果有条件，使用E5-2680 v4或者8700K这种比较新的CPU才是正确的性能提升方案\n4790K和E5 v3系列还是有点老的，3950x也是典型的多线程不顾单线程而看Timings里的话，大部分的性能消耗在实体计算上\n虽然跟拉低视距有点差不多，但是如果你是Spigot系列服务端的话，可以尝试去spigot.yml里限制entity-activation-range\n我空岛服也是出现实体过多造成TPS卡顿，用的如下：\n    entity-activation-range:\n      animals: 6\n      monsters: 16\n      misc: 2\n      water: 16\n\n限制之后TPS明显回升"
        },
        {
            "author": "EmptyLava",
            "timestamp": 1585713240,
            "txt_content": " 本帖最后由 EmptyLava 于 2020-4-1 11:57 编辑 \n\n你用的方案根本不够狠，效果虽然要但不是很明显\n原因(2)\n1.超过100% pct tick的实体占用\n2.有一点区块占用(20%)\n下面我会给你写出方案来全力压缩实体占用\nSpigot.yml\n1.在spigot.yml中设置\nentity-tracking-range\nanimals: 24\nmonsters: 24\nmisc:24\n2.在spigot.yml中设置\nentity-activation-range\nanimals: 10\nmonsters: 20\n3.ticks-per(可能影响分类机)\nhopper-transfer: 24\nhopper-check: 3\nBukkit.yml\n1.在bukkit.yml中设置\nmonster-spawns: 12(30人了，以你服务器配置，不加高来根本没用)\n2.spawn-limits中(反驳一下评分，30人了设置太低，怪都懒得刷)\nmonsters: 30\nanimals: 4\nPpaer.yml\nmax-chunk-sends-per-tick: 45(缓解正常区块加载)\nmax-auti-save-chunks-per-tick: 12(缓解自动保存)\nmax-chunk-gens-per-tick:3(缓解跑图)\n\n这样设置后，玩家高峰时期翻个倍没问题"
        },
        {
            "author": "YZH20011356810",
            "timestamp": 1585713360,
            "txt_content": "1784234383 发表于 2020-4-1 11:50\n4790K的高主频并不能代表很好的性能\n如果有条件，使用E5-2680 v4或者8700K这种比较新的CPU才是正确的性能提 ...\n感谢你的建议 观察到你发布了一个1.15版本的服务器宣传贴\n能否分享一下生存服内玩家人数 TPS 区块、实体、tiles加载情况呢？"
        },
        {
            "author": "1784234383",
            "timestamp": 1585713480,
            "txt_content": "@EmptyLava 哈哈我的服就先不要紧了，不过他们服应该对monster的并没有太大需求吧\nlz的一个小误区就是认为只要主频高性能就高，实际上还受CPU架构 代数的影响，只有同代数的才可以用主频大致衡量性能"
        },
        {
            "author": "1784234383",
            "timestamp": 1585713660,
            "txt_content": "YZH20011356810 发表于 2020-4-1 11:56\n感谢你的建议 观察到你发布了一个1.15版本的服务器宣传贴\n能否分享一下生存服内玩家人数 TPS 区块、实体 ...\n人不是很多，主要集中在空岛服\n有的时候空岛的生存世界的区块大概有两三千，实体两三百这个样子，tiles能达到5000，这也是人数比较高的时候才能出现的，那个时候的TPS是15 16这样子（主要是我用的U也比较垃圾，X5675而已，所以我限制的也比较狠）"
        },
        {
            "author": "EmptyLava",
            "timestamp": 1585713720,
            "txt_content": "1784234383 发表于 2020-4-1 11:58\n@EmptyLava 哈哈我的服就先不要紧了，不过他们服应该对monster的并没有太大需求吧\nlz的一个小误区就是认为 ...\n评分字打错了\n说到架构，amd，yes\n\n\ntimings内看了lz的配置文件，完全就是按照小服务器优化了，大服务器这样优化根本没用"
        },
        {
            "author": "1784234383",
            "timestamp": 1585713840,
            "txt_content": "EmptyLava 发表于 2020-4-1 12:02\n评分字打错了\n说到架构，amd，yes\n但是u1s1，现在单线程的话 红队Epyc系列也是杠不过新点的蓝队的"
        },
        {
            "author": "暮里魔理沙",
            "timestamp": 1585717260,
            "txt_content": "私聊了，论坛帖子不好说事情"
        },
        {
            "author": "YZH20011356810",
            "timestamp": 1585726860,
            "txt_content": "EmptyLava 发表于 2020-4-1 11:54\n你用的方案根本不够狠，效果虽然要但不是很明显\n原因(2)\n1.超过100% pct tick的实体占用\n害 除了\nPpaer.yml\nmax-chunk-sends-per-tick: 45(缓解正常区块加载)\nmax-auti-save-chunks-per-tick: 12(缓解自动保存)\nmax-chunk-gens-per-tick:3(缓解跑图)\n三项因为没找到条目以外 其他的采用了你的配置\n\n\n\n\nSnipaste_2020-04-01_15-39-14.png (17.18 KB, 下载次数: 0)\n\n下载附件\n\n2020-4-1 15:41 上传\n\n\n\n\n\n这是目前的效果\n\n"
        },
        {
            "author": "EmptyLava",
            "timestamp": 1585727160,
            "txt_content": "YZH20011356810 发表于 2020-4-1 15:41\n害 除了\nPpaer.yml\nmax-chunk-sends-per-tick: 45(缓解正常区块加载)\n发个timings咯"
        },
        {
            "author": "YZH20011356810",
            "timestamp": 1585727340,
            "txt_content": "EmptyLava 发表于 2020-4-1 15:46\n发个timings咯\n来咯"
        },
        {
            "author": "EmptyLava",
            "timestamp": 1585728780,
            "txt_content": " 本帖最后由 EmptyLava 于 2020-4-1 16:16 编辑 \nYZH20011356810 发表于 2020-4-1 15:49\n来咯\n\n看了一下\n服务器的pct tick由原来的200%降低到了现在的120%\n实体由100%降低到了60%\n15人的时候tps大概提升了3-6\n\n现在排名前几的都是动物\nbukkit.yml内的animal-spawns: 1200把\n然后用个区块内繁殖限制的插件\n\n另外看方块实体占用有点大\nmax-tick-time的tile和entity都改为20或者30看看吧\n\n再加个villager optimiser插件降低村民智商"
        },
        {
            "author": "YZH20011356810",
            "timestamp": 1585741740,
            "txt_content": "EmptyLava 发表于 2020-4-1 16:13\n看了一下\n服务器的pct tick由原来的200%降低到了现在的120%\n实体由100%降低到了60%\n已修改\n今天晚上刚好服务器要有活动 试试看效果如何\n再请问这三个条目如果paper.yml里原来没有，该添加到哪一项下面\n\nPpaer.yml\nmax-chunk-sends-per-tick: 45(缓解正常区块加载)\nmax-auti-save-chunks-per-tick: 12(缓解自动保存)\nmax-chunk-gens-per-tick:3(缓解跑图)\n"
        },
        {
            "author": "EmptyLava",
            "timestamp": 1585742220,
            "txt_content": "YZH20011356810 发表于 2020-4-1 19:49\n已修改\n今天晚上刚好服务器要有活动 试试看效果如何\n再请问这三个条目如果paper.yml里原来没有，该添加到 ...\n\n我写的时候用的是1.12的paper配置文件\n1.13渲染什么的大改，很多关于区块的优化都没了\n\n添加可以直接在后面加吧，但可能不会生效"
        },
        {
            "author": "YZH20011356810",
            "timestamp": 1585804140,
            "txt_content": "EmptyLava 发表于 2020-4-1 19:57\n我写的时候用的是1.12的paper配置文件\n1.13渲染什么的大改，很多关于区块的优化都没了\nhttps://timings.aikar.co/?id=71e459ffc7ca4ffa81644a7eac55f728\n14人TPS20,12人TPS又变成14了"
        },
        {
            "author": "EmptyLava",
            "timestamp": 1585807500,
            "txt_content": "YZH20011356810 发表于 2020-4-2 13:09\nhttps://timings.aikar.co/?id=71e459ffc7ca4ffa81644a7eac55f728\n14人TPS20,12人TPS又变成14了\n卡的时候漏斗矿车挺多\n你能问一下玩家这些漏斗矿车是干什么的吗"
        },
        {
            "author": "YZH20011356810",
            "timestamp": 1585808820,
            "txt_content": "EmptyLava 发表于 2020-4-2 14:05\n卡的时候漏斗矿车挺多\n你能问一下玩家这些漏斗矿车是干什么的吗\n比如守卫者鱼场有千把个漏斗矿车\n玩家“主要是减少掉帧？\n不想让矿车动起来\n所以每个格子都有一个漏斗矿车”"
        }
    ]
}