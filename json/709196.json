{
    "title": "C#获取我的世界服务器状态",
    "author": "mmmmm_ccccc",
    "replyCount": 2,
    "timestamp": 1500609600,
    "txt_content": " 本帖最后由 mmmmm_ccccc 于 2018-12-29 06:45 编辑 \n\n大家好我又来了，没事在mcbbs上转个贴\n这个已经有人发过了:【.NET】获取MC服务器...\n\n本帖跟———————↗的一样是转自wiki.vg\n可↗有点报错……\n新手不懂的可能还会以为不行……\n就像我以前一样\n所以我再发一次\n废话不多说了，现在就开始：\n首先创建一个类，名字随意\n把下面的代码替换你创建的那个类里的C#:\nusing System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Net;\nusing System.Net.Sockets;\nusing System.Text;\nusing System.Text.RegularExpressions;\n \nnamespace eMZi.Gaming.Minecraft\n{\n    /// <summary>\n    /// Represents retrieved Minecraft Server information\n    /// </summary>\n    public sealed class MinecraftServerInfo\n    {\n        /// <summary>\n        /// Gets the server's MOTD\n        /// </summary>\n        public string ServerMotd { get; private set; }\n \n        /// <summary>\n        /// Gets the server's MOTD converted into HTML\n        /// </summary>\n        public string ServerMotdHtml { get { return this.MotdHtml(); } }\n \n        /// <summary>\n        /// Gets the server's max player count\n        /// </summary>\n        public int MaxPlayerCount { get; private set; }\n \n        /// <summary>\n        /// Gets the server's current player count\n        /// </summary>\n        public int CurrentPlayerCount { get; private set; }\n \n        /// <summary>\n        /// Gets the server's Minecraft version\n        /// </summary>\n        public Version MinecraftVersion { get; private set; }\n        \n        /// <summary>\n        /// Gets HTML colors associated with specific formatting codes\n        /// </summary>\n        private static Dictionary<char, string> MinecraftColors { get { return new Dictionary<char, string>() { { '0', \"#000000\" }, { '1', \"#0000AA\" }, { '2', \"#00AA00\" }, { '3', \"#00AAAA\" }, { '4', \"#AA0000\" }, { '5', \"#AA00AA\" }, { '6', \"#FFAA00\" }, { '7', \"#AAAAAA\" }, { '8', \"#555555\" }, { '9', \"#5555FF\" }, { 'a', \"#55FF55\" }, { 'b', \"#55FFFF\" }, { 'c', \"#FF5555\" }, { 'd', \"#FF55FF\" }, { 'e', \"#FFFF55\" }, { 'f', \"#FFFFFF\" } }; } }\n \n        /// <summary>\n        /// Gets HTML styles associated with specific formatting codes\n        /// </summary>\n        private static Dictionary<char, string> MinecraftStyles { get { return new Dictionary<char, string>() { { 'k', \"none;font-weight:normal;font-style:normal\" }, { 'm', \"line-through;font-weight:normal;font-style:normal\" }, { 'l', \"none;font-weight:900;font-style:normal\" }, { 'n', \"underline;font-weight:normal;font-style:normal;\" }, { 'o', \"none;font-weight:normal;font-style:italic;\" }, { 'r', \"none;font-weight:normal;font-style:normal;color:#FFFFFF;\" } }; } }\n \n        /// <summary>\n        /// Creates a new instance of <see cref=\"MinecraftServerInfo\"/> with specified values\n        /// </summary>\n        /// <param name=\"motd\">Server's MOTD</param>\n        /// <param name=\"maxplayers\">Server's max player count</param>\n        /// <param name=\"playercount\">Server's current player count</param>\n        /// <param name=\"version\">Server's Minecraft version</param>\n        private MinecraftServerInfo(string motd, int maxplayers, int playercount, Version mcversion)\n        {\n            this.ServerMotd = motd;\n            this.MaxPlayerCount = maxplayers;\n            this.CurrentPlayerCount = playercount;\n            this.MinecraftVersion = mcversion;\n        }\n \n        /// <summary>\n        /// Gets the server's MOTD formatted as HTML\n        /// </summary>\n        /// <returns>HTML-formatted MOTD</returns>\n        private string MotdHtml()\n        {\n            Regex regex = new Regex(\"§([k-oK-O])(.*?)(§[0-9a-fA-Fk-oK-OrR]|$)\");\n            string s = this.ServerMotd;\n            while (regex.IsMatch(s))\n                s = regex.Replace(s, m =>\n                {\n                    string ast = \"text-decoration:\" + MinecraftStyles[m.Groups[1].Value[0]];\n                    string html = \"<span style=\"\" + ast + \"\">\" + m.Groups[2].Value + \"</span>\" + m.Groups[3].Value;\n                    return html;\n                });\n            regex = new Regex(\"§([0-9a-fA-F])(.*?)(§[0-9a-fA-FrR]|$)\");\n            while (regex.IsMatch(s))\n                s = regex.Replace(s, m =>\n                {\n                    string ast = \"color:\" + MinecraftColors[m.Groups[1].Value[0]];\n                    string html = \"<span style=\"\" + ast + \"\">\" + m.Groups[2].Value + \"</span>\" + m.Groups[3].Value;\n                    return html;\n                });\n            return s;\n        }\n \n        /// <summary>\n        /// Gets the information from specified server\n        /// </summary>\n        /// <param name=\"endpoint\">IP and Port of the server to get information from</param>\n        /// <returns>A <see cref=\"MinecraftServerInformation\"/> instance with retrieved data</returns>\n        /// <exception cref=\"System.Exception\">Upon failure, throws exception with descriptive information and InnerException with details</exception>\n        public static MinecraftServerInfo GetServerInformation(IPEndPoint endpoint)\n        {\n            if (endpoint == null)\n                throw new ArgumentNullException(\"endpoint\");\n            try\n            {\n                string[] packetdat = null;\n                using (TcpClient client = new TcpClient())\n                {\n                    client.Connect(endpoint);\n                    using (NetworkStream ns = client.GetStream())\n                    {\n                        ns.Write(new byte[] { 0xFE, 0x01 }, 0, 2);\n                        byte[] buff = new byte[2048];\n                        int br = ns.Read(buff, 0, buff.Length);\n                        if (buff[0] != 0xFF)\n                            throw new InvalidDataException(\"Received invalid packet\");\n                        string packet = Encoding.BigEndianUnicode.GetString(buff, 3, br - 3);\n                        if (!packet.StartsWith(\"§\"))\n                            throw new InvalidDataException(\"Received invalid data\");\n                        packetdat = packet.Split('\\u0000');\n                        ns.Close();\n                    }\n                    client.Close();\n                }\n                return new MinecraftServerInfo(packetdat[3], int.Parse(packetdat[5]), int.Parse(packetdat[4]), Version.Parse(packetdat[2]));\n            }\n            catch (SocketException ex)\n            {\n                throw new Exception(\"There was a connection problem, look into InnerException for details\", ex);\n            }\n            catch (InvalidDataException ex)\n            {\n                throw new Exception(\"The data received was invalid, look into InnerException for details\", ex);\n            }\n            catch (Exception ex)\n            {\n                throw new Exception(\"There was a problem, look into InnerException for details\", ex);\n            }\n        }\n \n        /// <summary>\n        /// Gets the information from specified server\n        /// </summary>\n        /// <param name=\"ip\">IP of the server to get info from</param>\n        /// <param name=\"port\">Port of the server to get info from</param>\n        /// <returns>A <see cref=\"MinecraftServerInformation\"/> instance with retrieved data</returns>\n        /// <exception cref=\"System.Exception\">Upon failure, throws exception with descriptive information and InnerException with details</exception>\n        public static MinecraftServerInfo GetServerInformation(IPAddress ip, int port)\n        {\n            return GetServerInformation(new IPEndPoint(ip, port));\n        }\n    }\n}复制代码假如你要点击Form1.cs的button1时显示服务器状态：(这里以内网服务器为例)\nC#:        private void button1_Click(object sender, EventArgs e)\n        {\n            try\n            {\n                string ip = null;\n                IPHostEntry iph = Dns.GetHostEntry(\"127.0.0.1\");//<--IP\n                foreach (IPAddress ip1 in iph.AddressList)\n                {\n                    ip = ip1.ToString();\n                    break;\n                }\n                eMZi.Gaming.Minecraft.MinecraftServerInfo a = null;\n                IPAddress c = null;\n                c = IPAddress.Parse(ip);\n                IPEndPoint b = new IPEndPoint(c, 25565);//<--端口\n                a = eMZi.Gaming.Minecraft.MinecraftServerInfo.GetServerInformation(b);\n                MessageBox.Show(\n                    \"在线人数：\" + a.CurrentPlayerCount.ToString() + \n                    \"\\n最大人数：\" + a.MaxPlayerCount.ToString() + \n                    \"\\n服务器Motd：\" + a.ServerMotdHtml +\n                    \"\\n版本：\" + a.MinecraftVersion.ToString());\n            }\n            catch\n            {\n                MessageBox.Show(\"无法连接到服务器\") ;\n            }\n        }\n\n(因为我用代码格式来编辑帖子一到这里就会变成残缺的，所以我不用代码格式了)\n\n好了就到这里，大家试试吧，VS2010亲测通过\n\n\n\n\n\n",
    "replies": [
        {
            "author": "justiceの深蓝",
            "timestamp": 1500641760,
            "txt_content": "MinecraftServerInfo a = MinecraftServerInfo.GetServerInformation(IPAddress.Parse(\"127.0.0.1\"), 25565);\n\n            Console.WriteLine($\"a.ServerMotd={a.ServerMotd}\");\n            Console.WriteLine($\"a.ServerMotdHtml={a.ServerMotdHtml}\");\n            Console.WriteLine($\"a.MaxPlayerCount={a.MaxPlayerCount}\");\n            Console.WriteLine($\"a.CurrentPlayerCount={a.CurrentPlayerCount}\");\n            Console.WriteLine($\"a.MinecraftVersion={a.MinecraftVersion}\");\n            Console.ReadKey();复制代码\n获取服务器ip的代码可以省略  而且代码没给完"
        },
        {
            "author": "mmmmm_ccccc",
            "timestamp": 1500881640,
            "txt_content": "justiceの深蓝 发表于 2017-7-21 20:56\n获取服务器ip的代码可以省略  而且代码没给完\n不好意思啊，好像是bbs的BUG，我明明复制完了"
        }
    ]
}