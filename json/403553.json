{
    "title": "【.NET】获取MC服务器信息（人数等）代码",
    "author": "mcmny",
    "replyCount": 21,
    "timestamp": 1423222620,
    "txt_content": " 本帖最后由 mcmny 于 2015-2-7 21:39 编辑 \n注意：本代码原出处为wiki.vg，因不知其的开源协议，请谨慎使用，谢谢！\n本代码是制作成命名空间的形式，方便调用。。。。求回复，求人气。。。。。。。。。。。。\n代码：\nVB.net:\nImports System.Collections.Generic\nImports System.IO\nImports System.Net\nImports System.Net.Sockets\nImports System.Text\nImports System.Text.RegularExpressions\n\nNamespace eMZi.Gaming.Minecraft\n        ''' <summary>\n        ''' Represents retrieved Minecraft Server information\n        ''' </summary>\n        Public NotInheritable Class MinecraftServerInfo\n                ''' <summary>\n                ''' Gets the server's MOTD\n                ''' </summary>\n                Public Property ServerMotd() As String\n                        Get\n                                Return m_ServerMotd\n                        End Get\n                        Private Set\n                                m_ServerMotd = Value\n                        End Set\n                End Property\n                Private m_ServerMotd As String\n\n                ''' <summary>\n                ''' Gets the server's MOTD converted into HTML\n                ''' </summary>\n                Public ReadOnly Property ServerMotdHtml() As String\n                        Get\n                                Return Me.MotdHtml()\n                        End Get\n                End Property\n\n                ''' <summary>\n                ''' Gets the server's max player count\n                ''' </summary>\n                Public Property MaxPlayerCount() As Integer\n                        Get\n                                Return m_MaxPlayerCount\n                        End Get\n                        Private Set\n                                m_MaxPlayerCount = Value\n                        End Set\n                End Property\n                Private m_MaxPlayerCount As Integer\n\n                ''' <summary>\n                ''' Gets the server's current player count\n                ''' </summary>\n                Public Property CurrentPlayerCount() As Integer\n                        Get\n                                Return m_CurrentPlayerCount\n                        End Get\n                        Private Set\n                                m_CurrentPlayerCount = Value\n                        End Set\n                End Property\n                Private m_CurrentPlayerCount As Integer\n\n                ''' <summary>\n                ''' Gets the server's Minecraft version\n                ''' </summary>\n                Public Property MinecraftVersion() As Version\n                        Get\n                                Return m_MinecraftVersion\n                        End Get\n                        Private Set\n                                m_MinecraftVersion = Value\n                        End Set\n                End Property\n                Private m_MinecraftVersion As Version\n\n                ''' <summary>\n                ''' Gets HTML colors associated with specific formatting codes\n                ''' </summary>\n                Private Shared ReadOnly Property MinecraftColors() As Dictionary(Of Char, String)\n                        Get\n                                Return New Dictionary(Of Char, String)() From { _\n                                        {\"0\"C, \"#000000\"}, _\n                                        {\"1\"C, \"#0000AA\"}, _\n                                        {\"2\"C, \"#00AA00\"}, _\n                                        {\"3\"C, \"#00AAAA\"}, _\n                                        {\"4\"C, \"#AA0000\"}, _\n                                        {\"5\"C, \"#AA00AA\"}, _\n                                        {\"6\"C, \"#FFAA00\"}, _\n                                        {\"7\"C, \"#AAAAAA\"}, _\n                                        {\"8\"C, \"#555555\"}, _\n                                        {\"9\"C, \"#5555FF\"}, _\n                                        {\"a\"C, \"#55FF55\"}, _\n                                        {\"b\"C, \"#55FFFF\"}, _\n                                        {\"c\"C, \"#FF5555\"}, _\n                                        {\"d\"C, \"#FF55FF\"}, _\n                                        {\"e\"C, \"#FFFF55\"}, _\n                                        {\"f\"C, \"#FFFFFF\"} _\n                                }\n                        End Get\n                End Property\n\n                ''' <summary>\n                ''' Gets HTML styles associated with specific formatting codes\n                ''' </summary>\n                Private Shared ReadOnly Property MinecraftStyles() As Dictionary(Of Char, String)\n                        Get\n                                Return New Dictionary(Of Char, String)() From { _\n                                        {\"k\"C, \"none;font-weight:normal;font-style:normal\"}, _\n                                        {\"m\"C, \"line-through;font-weight:normal;font-style:normal\"}, _\n                                        {\"l\"C, \"none;font-weight:900;font-style:normal\"}, _\n                                        {\"n\"C, \"underline;font-weight:normal;font-style:normal;\"}, _\n                                        {\"o\"C, \"none;font-weight:normal;font-style:italic;\"}, _\n                                        {\"r\"C, \"none;font-weight:normal;font-style:normal;color:#FFFFFF;\"} _\n                                }\n                        End Get\n                End Property\n\n                ''' <summary>\n                ''' Creates a new instance of <see cref=\"MinecraftServerInfo\"/> with specified values\n                ''' </summary>\n                ''' <param name=\"motd\">Server's MOTD</param>\n                ''' <param name=\"maxplayers\">Server's max player count</param>\n                ''' <param name=\"playercount\">Server's current player count</param>\n                ''' <param name=\"version\">Server's Minecraft version</param>\n                Private Sub New(motd As String, maxplayers As Integer, playercount As Integer, mcversion As Version)\n                        Me.ServerMotd = motd\n                        Me.MaxPlayerCount = maxplayers\n                        Me.CurrentPlayerCount = playercount\n                        Me.MinecraftVersion = mcversion\n                End Sub\n\n                ''' <summary>\n                ''' Gets the server's MOTD formatted as HTML\n                ''' </summary>\n                ''' <returns>HTML-formatted MOTD</returns>\n                Private Function MotdHtml() As String\n                        Dim regex As New Regex(\"§([k-oK-O])(.*?)(§[0-9a-fA-Fk-oK-OrR]|$)\")\n                        Dim s As String = Me.ServerMotd\n                        While regex.IsMatch(s)\n                                s = regex.Replace(s, Function(m) \n                                Dim ast As String = \"text-decoration:\" & MinecraftStyles(m.Groups(1).Value(0))\n                                Dim html As String = \"<span style=\"\"\" & ast & \"\"\">\" & m.Groups(2).Value & \"</span>\" & m.Groups(3).Value\n                                Return html\n\nEnd Function)\n                        End While\n                        regex = New Regex(\"§([0-9a-fA-F])(.*?)(§[0-9a-fA-FrR]|$)\")\n                        While regex.IsMatch(s)\n                                s = regex.Replace(s, Function(m) \n                                Dim ast As String = \"color:\" & MinecraftColors(m.Groups(1).Value(0))\n                                Dim html As String = \"<span style=\"\"\" & ast & \"\"\">\" & m.Groups(2).Value & \"</span>\" & m.Groups(3).Value\n                                Return html\n\nEnd Function)\n                        End While\n                        Return s\n                End Function\n\n                ''' <summary>\n                ''' Gets the information from specified server\n                ''' </summary>\n                ''' <param name=\"endpoint\">IP and Port of the server to get information from</param>\n                ''' <returns>A <see cref=\"MinecraftServerInformation\"/> instance with retrieved data</returns>\n                ''' <exception cref=\"System.Exception\">Upon failure, throws exception with descriptive information and InnerException with details</exception>\n                Public Shared Function GetServerInformation(endpoint As IPEndPoint) As MinecraftServerInfo\n                        If endpoint Is Nothing Then\n                                Throw New ArgumentNullException(\"endpoint\")\n                        End If\n                        Try\n                                Dim packetdat As String() = Nothing\n                                Using client As New TcpClient()\n                                        client.Connect(endpoint)\n                                        Using ns As NetworkStream = client.GetStream()\n                                                ns.Write(New Byte() {&Hfe, &H1}, 0, 2)\n                                                Dim buff As Byte() = New Byte(2047) {}\n                                                Dim br As Integer = ns.Read(buff, 0, buff.Length)\n                                                If buff(0) <> &Hff Then\n                                                        Throw New InvalidDataException(\"Received invalid packet\")\n                                                End If\n                                                Dim packet As String = Encoding.BigEndianUnicode.GetString(buff, 3, br - 3)\n                                                If Not packet.StartsWith(\"§\") Then\n                                                        Throw New InvalidDataException(\"Received invalid data\")\n                                                End If\n                                                packetdat = packet.Split(ControlChars.NullChar)\n                                                ns.Close()\n                                        End Using\n                                        client.Close()\n                                End Using\n                                Return New MinecraftServerInfo(packetdat(3), Integer.Parse(packetdat(5)), Integer.Parse(packetdat(4)), Version.Parse(packetdat(2)))\n                        Catch ex As SocketException\n                                Throw New Exception(\"There was a connection problem, look into InnerException for details\", ex)\n                        Catch ex As InvalidDataException\n                                Throw New Exception(\"The data received was invalid, look into InnerException for details\", ex)\n                        Catch ex As Exception\n                                Throw New Exception(\"There was a problem, look into InnerException for details\", ex)\n                        End Try\n                End Function\n\n                ''' <summary>\n                ''' Gets the information from specified server\n                ''' </summary>\n                ''' <param name=\"ip\">IP of the server to get info from</param>\n                ''' <param name=\"port\">Port of the server to get info from</param>\n                ''' <returns>A <see cref=\"MinecraftServerInformation\"/> instance with retrieved data</returns>\n                ''' <exception cref=\"System.Exception\">Upon failure, throws exception with descriptive information and InnerException with details</exception>\n                Public Shared Function GetServerInformation(ip As IPAddress, port As Integer) As MinecraftServerInfo\n                        Return GetServerInformation(New IPEndPoint(ip, port))\n                End Function\n        End Class\nEnd Namespace\n复制代码\nC#:\nusing System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Net;\nusing System.Net.Sockets;\nusing System.Text;\nusing System.Text.RegularExpressions;\n \nnamespace eMZi.Gaming.Minecraft\n{\n    /// <summary>\n    /// Represents retrieved Minecraft Server information\n    /// </summary>\n    public sealed class MinecraftServerInfo\n    {\n        /// <summary>\n        /// Gets the server's MOTD\n        /// </summary>\n        public string ServerMotd { get; private set; }\n \n        /// <summary>\n        /// Gets the server's MOTD converted into HTML\n        /// </summary>\n        public string ServerMotdHtml { get { return this.MotdHtml(); } }\n \n        /// <summary>\n        /// Gets the server's max player count\n        /// </summary>\n        public int MaxPlayerCount { get; private set; }\n \n        /// <summary>\n        /// Gets the server's current player count\n        /// </summary>\n        public int CurrentPlayerCount { get; private set; }\n \n        /// <summary>\n        /// Gets the server's Minecraft version\n        /// </summary>\n        public Version MinecraftVersion { get; private set; }\n        \n        /// <summary>\n        /// Gets HTML colors associated with specific formatting codes\n        /// </summary>\n        private static Dictionary<char, string> MinecraftColors { get { return new Dictionary<char, string>() { { '0', \"#000000\" }, { '1', \"#0000AA\" }, { '2', \"#00AA00\" }, { '3', \"#00AAAA\" }, { '4', \"#AA0000\" }, { '5', \"#AA00AA\" }, { '6', \"#FFAA00\" }, { '7', \"#AAAAAA\" }, { '8', \"#555555\" }, { '9', \"#5555FF\" }, { 'a', \"#55FF55\" }, { 'b', \"#55FFFF\" }, { 'c', \"#FF5555\" }, { 'd', \"#FF55FF\" }, { 'e', \"#FFFF55\" }, { 'f', \"#FFFFFF\" } }; } }\n \n        /// <summary>\n        /// Gets HTML styles associated with specific formatting codes\n        /// </summary>\n        private static Dictionary<char, string> MinecraftStyles { get { return new Dictionary<char, string>() { { 'k', \"none;font-weight:normal;font-style:normal\" }, { 'm', \"line-through;font-weight:normal;font-style:normal\" }, { 'l', \"none;font-weight:900;font-style:normal\" }, { 'n', \"underline;font-weight:normal;font-style:normal;\" }, { 'o', \"none;font-weight:normal;font-style:italic;\" }, { 'r', \"none;font-weight:normal;font-style:normal;color:#FFFFFF;\" } }; } }\n \n        /// <summary>\n        /// Creates a new instance of <see cref=\"MinecraftServerInfo\"/> with specified values\n        /// </summary>\n        /// <param name=\"motd\">Server's MOTD</param>\n        /// <param name=\"maxplayers\">Server's max player count</param>\n        /// <param name=\"playercount\">Server's current player count</param>\n        /// <param name=\"version\">Server's Minecraft version</param>\n        private MinecraftServerInfo(string motd, int maxplayers, int playercount, Version mcversion)\n        {\n            this.ServerMotd = motd;\n            this.MaxPlayerCount = maxplayers;\n            this.CurrentPlayerCount = playercount;\n            this.MinecraftVersion = mcversion;\n        }\n \n        /// <summary>\n        /// Gets the server's MOTD formatted as HTML\n        /// </summary>\n        /// <returns>HTML-formatted MOTD</returns>\n        private string MotdHtml()\n        {\n            Regex regex = new Regex(\"§([k-oK-O])(.*?)(§[0-9a-fA-Fk-oK-OrR]|$)\");\n            string s = this.ServerMotd;\n            while (regex.IsMatch(s))\n                s = regex.Replace(s, m =>\n                {\n                    string ast = \"text-decoration:\" + MinecraftStyles[m.Groups[1].Value[0]];\n                    string html = \"<span style=\"\" + ast + \"\">\" + m.Groups[2].Value + \"</span>\" + m.Groups[3].Value;\n                    return html;\n                });\n            regex = new Regex(\"§([0-9a-fA-F])(.*?)(§[0-9a-fA-FrR]|$)\");\n            while (regex.IsMatch(s))\n                s = regex.Replace(s, m =>\n                {\n                    string ast = \"color:\" + MinecraftColors[m.Groups[1].Value[0]];\n                    string html = \"<span style=\"\" + ast + \"\">\" + m.Groups[2].Value + \"</span>\" + m.Groups[3].Value;\n                    return html;\n                });\n            return s;\n        }\n \n        /// <summary>\n        /// Gets the information from specified server\n        /// </summary>\n        /// <param name=\"endpoint\">IP and Port of the server to get information from</param>\n        /// <returns>A <see cref=\"MinecraftServerInformation\"/> instance with retrieved data</returns>\n        /// <exception cref=\"System.Exception\">Upon failure, throws exception with descriptive information and InnerException with details</exception>\n        public static MinecraftServerInfo GetServerInformation(IPEndPoint endpoint)\n        {\n            if (endpoint == null)\n                throw new ArgumentNullException(\"endpoint\");\n            try\n            {\n                string[] packetdat = null;\n                using (TcpClient client = new TcpClient())\n                {\n                    client.Connect(endpoint);\n                    using (NetworkStream ns = client.GetStream())\n                    {\n                        ns.Write(new byte[] { 0xFE, 0x01 }, 0, 2);\n                        byte[] buff = new byte[2048];\n                        int br = ns.Read(buff, 0, buff.Length);\n                        if (buff[0] != 0xFF)\n                            throw new InvalidDataException(\"Received invalid packet\");\n                        string packet = Encoding.BigEndianUnicode.GetString(buff, 3, br - 3);\n                        if (!packet.StartsWith(\"§\"))\n                            throw new InvalidDataException(\"Received invalid data\");\n                        packetdat = packet.Split('\\u0000');\n                        ns.Close();\n                    }\n                    client.Close();\n                }\n                return new MinecraftServerInfo(packetdat[3], int.Parse(packetdat[5]), int.Parse(packetdat[4]), Version.Parse(packetdat[2]));\n            }\n            catch (SocketException ex)\n            {\n                throw new Exception(\"There was a connection problem, look into InnerException for details\", ex);\n            }\n            catch (InvalidDataException ex)\n            {\n                throw new Exception(\"The data received was invalid, look into InnerException for details\", ex);\n            }\n            catch (Exception ex)\n            {\n                throw new Exception(\"There was a problem, look into InnerException for details\", ex);\n            }\n        }\n \n        /// <summary>\n        /// Gets the information from specified server\n        /// </summary>\n        /// <param name=\"ip\">IP of the server to get info from</param>\n        /// <param name=\"port\">Port of the server to get info from</param>\n        /// <returns>A <see cref=\"MinecraftServerInformation\"/> instance with retrieved data</returns>\n        /// <exception cref=\"System.Exception\">Upon failure, throws exception with descriptive information and InnerException with details</exception>\n        public static MinecraftServerInfo GetServerInformation(IPAddress ip, int port)\n        {\n            return GetServerInformation(new IPEndPoint(ip, port));\n        }\n    }\n}复制代码\n\n\n调用实例:\n本代码以Mcbbs论坛官方服务器为例，且其中部分代码经过本人修改，确保能够执行。。。\nVB.net:\nImports System.Net.Sockets\nImports System.Collections.Generic\nImports System.IO\nImports System.Net\n\nImports System.Text\nImports System.Text.RegularExpressions\n\nPublic Class Form1\n\n    Private Sub Form1_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load\n\n    End Sub\n\n    Private Sub Button1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button1.Click\n        \n        Dim ip As String\n        Dim iph As IPHostEntry = Dns.GetHostEntry(\"mcbbs-play.com\")\n        For Each ip1 As IPAddress In iph.AddressList\n            ip = ip1.ToString\n            Exit For\n        Next\n        Dim a As eMZi.Gaming.Minecraft.MinecraftServerInfo\n        Dim c As IPAddress\n        c = IPAddress.Parse(ip)\n        Dim b As New IPEndPoint(c, 25565)\n        a = eMZi.Gaming.Minecraft.MinecraftServerInfo.GetServerInformation(b)\n        MessageBox.Show(a.ServerMotd)\n        MessageBox.Show(a.ServerMotdHtml)\n        MessageBox.Show(a.MaxPlayerCount)\n        MessageBox.Show(a.CurrentPlayerCount)\n        MessageBox.Show(a.MinecraftVersion)\n    End Sub\nEnd Class\nNamespace eMZi.Gaming.Minecraft\n   \n    Public NotInheritable Class MinecraftServerInfo\n        \n        Public Property ServerMotd() As String\n' Gets the server's MOTD\n            Get\n                Return m_ServerMotd\n            End Get\n            Private Set(ByVal value As String)\n                m_ServerMotd = Value\n            End Set\n        End Property\n        Private m_ServerMotd As String\n\n       \n        Public ReadOnly Property ServerMotdHtml() As String\n            ' Gets the server's MOTD converted into HTML\nGet\n                Return Me.MotdHtml()\n            End Get\n        End Property\n\n       \n        Public Property MaxPlayerCount() As Integer\n            ' Gets the server's max player count\nGet\n                Return m_MaxPlayerCount\n            End Get\n            Private Set(ByVal value As Integer)\n                m_MaxPlayerCount = Value\n            End Set\n        End Property\n        Private m_MaxPlayerCount As Integer\n\n        Public Property CurrentPlayerCount() As Integer\n            ' Gets the server's current player count\nGet\n                Return m_CurrentPlayerCount\n            End Get\n            Private Set(ByVal value As Integer)\n                m_CurrentPlayerCount = Value\n            End Set\n        End Property\n        Private m_CurrentPlayerCount As Integer\n\n        Public Property MinecraftVersion() As String\n            ' Gets the server's Minecraft version\nGet\n                Return m_MinecraftVersion\n            End Get\n            Private Set(ByVal value As String)\n                m_MinecraftVersion = value\n            End Set\n        End Property\n        Private m_MinecraftVersion As String\n\n      \n        Private Shared ReadOnly Property MinecraftColors() As Dictionary(Of Char, String)\n            ' Gets HTML colors associated with specific formatting codes\nGet\n                Return New Dictionary(Of Char, String)() From { _\n                 {\"0\"c, \"#000000\"}, _\n                 {\"1\"c, \"#0000AA\"}, _\n                 {\"2\"c, \"#00AA00\"}, _\n                 {\"3\"c, \"#00AAAA\"}, _\n                 {\"4\"c, \"#AA0000\"}, _\n                 {\"5\"c, \"#AA00AA\"}, _\n                 {\"6\"c, \"#FFAA00\"}, _\n                 {\"7\"c, \"#AAAAAA\"}, _\n                 {\"8\"c, \"#555555\"}, _\n                 {\"9\"c, \"#5555FF\"}, _\n                 {\"a\"c, \"#55FF55\"}, _\n                 {\"b\"c, \"#55FFFF\"}, _\n                 {\"c\"c, \"#FF5555\"}, _\n                 {\"d\"c, \"#FF55FF\"}, _\n                 {\"e\"c, \"#FFFF55\"}, _\n                 {\"f\"c, \"#FFFFFF\"} _\n                }\n            End Get\n        End Property\n\n       \n        Private Shared ReadOnly Property MinecraftStyles() As Dictionary(Of Char, String)\n            Get\n                Return New Dictionary(Of Char, String)() From { _\n                 {\"k\"c, \"none;font-weight:normal;font-style:normal\"}, _\n                 {\"m\"c, \"line-through;font-weight:normal;font-style:normal\"}, _\n                 {\"l\"c, \"none;font-weight:900;font-style:normal\"}, _\n                 {\"n\"c, \"underline;font-weight:normal;font-style:normal;\"}, _\n                 {\"o\"c, \"none;font-weight:normal;font-style:italic;\"}, _\n                 {\"r\"c, \"none;font-weight:normal;font-style:normal;color:#FFFFFF;\"} _\n                }\n            End Get\n        End Property\n\n        \n        Private Sub New(ByVal motd As String, ByVal maxplayers As Integer, ByVal playercount As Integer, ByVal mcversion As String)\n            Me.ServerMotd = motd\n            Me.MaxPlayerCount = maxplayers\n            Me.CurrentPlayerCount = playercount\n            Me.MinecraftVersion = mcversion\n        End Sub\n\n      \n        Private Function MotdHtml() As String\n            Dim regex As New Regex(\"§([k-oK-O])(.*?)(§[0-9a-fA-Fk-oK-OrR]|$)\")\n            Dim s As String = Me.ServerMotd\n            While regex.IsMatch(s)\n                s = regex.Replace(s, Function(m)\n                                         Dim ast As String = \"text-decoration:\" & MinecraftStyles(m.Groups(1).Value(0))\n                                         Dim html As String = \"<span style=\"\"\" & ast & \"\"\">\" & m.Groups(2).Value & \"</span>\" & m.Groups(3).Value\n                                         Return html\n\n                                     End Function)\n            End While\n            regex = New Regex(\"§([0-9a-fA-F])(.*?)(§[0-9a-fA-FrR]|$)\")\n            While regex.IsMatch(s)\n                s = regex.Replace(s, Function(m)\n                                         Dim ast As String = \"color:\" & MinecraftColors(m.Groups(1).Value(0))\n                                         Dim html As String = \"<span style=\"\"\" & ast & \"\"\">\" & m.Groups(2).Value & \"</span>\" & m.Groups(3).Value\n                                         Return html\n\n                                     End Function)\n            End While\n            Return s\n        End Function\n\n        \n        Public Shared Function GetServerInformation(ByVal endpoint As IPEndPoint) As MinecraftServerInfo\n            If endpoint Is Nothing Then\n                Throw New ArgumentNullException(\"endpoint\")\n            End If\n            Try\n                Dim packetdat As String() = Nothing\n                Using client As New TcpClient()\n                    client.Connect(endpoint)\n                    Using ns As NetworkStream = client.GetStream()\n                        ns.Write(New Byte() {&HFE, &H1}, 0, 2)\n                        Dim buff As Byte() = New Byte(2047) {}\n                        Dim br As Integer = ns.Read(buff, 0, buff.Length)\n                        If buff(0) <> &HFF Then\n                            Throw New InvalidDataException(\"Received invalid packet\")\n                        End If\n                        Dim packet As String = Encoding.BigEndianUnicode.GetString(buff, 3, br - 3)\n                        If Not packet.StartsWith(\"§\") Then\n                            Throw New InvalidDataException(\"Received invalid data\")\n                        End If\n                        packetdat = packet.Split(ControlChars.NullChar)\n                        ns.Close()\n                    End Using\n                    client.Close()\n                End Using\n                Return New MinecraftServerInfo(packetdat(3), Integer.Parse(packetdat(5)), Integer.Parse(packetdat(4)), (packetdat(2)))\n            Catch ex As SocketException\n                Throw New Exception(\"There was a connection problem, look into InnerException for details\", ex)\n            Catch ex As InvalidDataException\n                Throw New Exception(\"The data received was invalid, look into InnerException for details\", ex)\n            Catch ex As Exception\n                Throw New Exception(\"There was a problem, look into InnerException for details\", ex)\n            End Try\n        End Function\n\n        Public Shared Function GetServerInformation(ByVal ip As IPAddress, ByVal port As Integer) As MinecraftServerInfo\n            Return GetServerInformation(New IPEndPoint(ip, port))\n        End Function\n    End Class\nEnd Namespace\n复制代码\nC#:\nusing Microsoft.VisualBasic;\nusing System;\nusing System.Collections;\nusing System.Collections.Generic;\nusing System.Data;\nusing System.Diagnostics;\nusing System.Net.Sockets;\nusing System.IO;\nusing System.Net;\n\nusing System.Text;\nusing System.Text.RegularExpressions;\n\npublic class Form1\n{\n\n\n        private void Form1_Load(System.Object sender, System.EventArgs e)\n        {\n        }\n\n        private void Button1_Click(System.Object sender, System.EventArgs e)\n        {\n\n                string ip = null;\n                IPHostEntry iph = Dns.GetHostEntry(\"mcbbs-play.com\");\n                foreach (IPAddress ip1 in iph.AddressList) {\n                        ip = ip1.ToString();\n                        break; // TODO: might not be correct. Was : Exit For\n                }\n                eMZi.Gaming.Minecraft.MinecraftServerInfo a = null;\n                IPAddress c = null;\n                c = IPAddress.Parse(ip);\n                IPEndPoint b = new IPEndPoint(c, 25565);\n                a = eMZi.Gaming.Minecraft.MinecraftServerInfo.GetServerInformation(b);\n                MessageBox.Show(a.ServerMotd);\n                MessageBox.Show(a.ServerMotdHtml);\n                MessageBox.Show(a.MaxPlayerCount);\n                MessageBox.Show(a.CurrentPlayerCount);\n                MessageBox.Show(a.MinecraftVersion);\n        }\n        public Form1()\n        {\n                Load += Form1_Load;\n        }\n}\nnamespace eMZi.Gaming.Minecraft\n{\n\n        public sealed class MinecraftServerInfo\n        {\n\n                public string ServerMotd {\n                        // Gets the server's MOTD\n                        get { return m_ServerMotd; }\n                        private set { m_ServerMotd = value; }\n                }\n\n                private string m_ServerMotd;\n\n                public string ServerMotdHtml {\n                        // Gets the server's MOTD converted into HTML\n                        get { return this.MotdHtml(); }\n                }\n\n\n                public int MaxPlayerCount {\n                        // Gets the server's max player count\n                        get { return m_MaxPlayerCount; }\n                        private set { m_MaxPlayerCount = value; }\n                }\n\n                private int m_MaxPlayerCount;\n                public int CurrentPlayerCount {\n                        // Gets the server's current player count\n                        get { return m_CurrentPlayerCount; }\n                        private set { m_CurrentPlayerCount = value; }\n                }\n\n                private int m_CurrentPlayerCount;\n                public string MinecraftVersion {\n                        // Gets the server's Minecraft version\n                        get { return m_MinecraftVersion; }\n                        private set { m_MinecraftVersion = value; }\n                }\n\n                private string m_MinecraftVersion;\n\n                private static Dictionary<char, string> MinecraftColors {\n                        // Gets HTML colors associated with specific formatting codes\n                        get { return new Dictionary<char, string> {{'0',\"#000000\"},{'1',\"#0000AA\"},{'2',\"#00AA00\"},{'3',\"#00AAAA\"},{'4',\"#AA0000\"},{'5',\"#AA00AA\"},{'6',\"#FFAA00\"},{'7',\"#AAAAAA\"},{'8',\"#555555\"},{'9',\"#5555FF\"},{'a',\"#55FF55\"},{'b',\"#55FFFF\"},{'c',\"#FF5555\"},{'d',\"#FF55FF\"},{'e',\"#FFFF55\"},{'f',\"#FFFFFF\"}}; }\n                }\n\n\n                private static Dictionary<char, string> MinecraftStyles {\n                        get { return new Dictionary<char, string> {{'k',\"none;font-weight:normal;font-style:normal\"},{'m',\"line-through;font-weight:normal;font-style:normal\"},{'l',\"none;font-weight:900;font-style:normal\"},{'n',\"underline;font-weight:normal;font-style:normal;\"},{'o',\"none;font-weight:normal;font-style:italic;\"},{'r',\"none;font-weight:normal;font-style:normal;color:#FFFFFF;\"}}; }\n                }\n\n\n                private MinecraftServerInfo(string motd, int maxplayers, int playercount, string mcversion)\n                {\n                        this.ServerMotd = motd;\n                        this.MaxPlayerCount = maxplayers;\n                        this.CurrentPlayerCount = playercount;\n                        this.MinecraftVersion = mcversion;\n                }\n\n\n                private string MotdHtml()\n                {\n                        Regex regex = new Regex(\"§([k-oK-O])(.*?)(§[0-9a-fA-Fk-oK-OrR]|$)\");\n                        string s = this.ServerMotd;\n                        while (regex.IsMatch(s)) {\n                                s = regex.Replace(s, m =>\n                                {\n                                        string ast = \"text-decoration:\" + MinecraftStyles[m.Groups(1).Value(0)];\n                                        string html = \"<span style=\"\" + ast + \"\">\" + m.Groups(2).Value + \"</span>\" + m.Groups(3).Value;\n                                        return html;\n\n                                });\n                        }\n                        regex = new Regex(\"§([0-9a-fA-F])(.*?)(§[0-9a-fA-FrR]|$)\");\n                        while (regex.IsMatch(s)) {\n                                s = regex.Replace(s, m =>\n                                {\n                                        string ast = \"color:\" + MinecraftColors[m.Groups(1).Value(0)];\n                                        string html = \"<span style=\"\" + ast + \"\">\" + m.Groups(2).Value + \"</span>\" + m.Groups(3).Value;\n                                        return html;\n\n                                });\n                        }\n                        return s;\n                }\n\n\n                public static MinecraftServerInfo GetServerInformation(IPEndPoint endpoint)\n                {\n                        if (endpoint == null) {\n                                throw new ArgumentNullException(\"endpoint\");\n                        }\n                        try {\n                                string[] packetdat = null;\n                                using (TcpClient client = new TcpClient()) {\n                                        client.Connect(endpoint);\n                                        using (NetworkStream ns = client.GetStream()) {\n                                                ns.Write(new byte[] {\n                                                        0xfe,\n                                                        0x1\n                                                }, 0, 2);\n                                                byte[] buff = new byte[2048];\n                                                int br = ns.Read(buff, 0, buff.Length);\n                                                if (buff[0] != 0xff) {\n                                                        throw new InvalidDataException(\"Received invalid packet\");\n                                                }\n                                                string packet = Encoding.BigEndianUnicode.GetString(buff, 3, br - 3);\n                                                if (!packet.StartsWith(\"§\")) {\n                                                        throw new InvalidDataException(\"Received invalid data\");\n                                                }\n                                                packetdat = packet.Split(ControlChars.NullChar);\n                                                ns.Close();\n                                        }\n                                        client.Close();\n                                }\n                                return new MinecraftServerInfo(packetdat[3], int.Parse(packetdat[5]), int.Parse(packetdat[4]), (packetdat[2]));\n                        } catch (SocketException ex) {\n                                throw new Exception(\"There was a connection problem, look into InnerException for details\", ex);\n                        } catch (InvalidDataException ex) {\n                                throw new Exception(\"The data received was invalid, look into InnerException for details\", ex);\n                        } catch (Exception ex) {\n                                throw new Exception(\"There was a problem, look into InnerException for details\", ex);\n                        }\n                }\n\n                public static MinecraftServerInfo GetServerInformation(IPAddress ip, int port)\n                {\n                        return GetServerInformation(new IPEndPoint(ip, port));\n                }\n        }\n}\n复制代码\n\n\n\n\n",
    "replies": [
        {
            "author": "kuangwenxin",
            "timestamp": 1423223040,
            "txt_content": "毛玩意            "
        },
        {
            "author": "mcmny",
            "timestamp": 1423223100,
            "txt_content": " 本帖最后由 mcmny 于 2015-2-6 19:47 编辑 \nkuangwenxin 发表于 2015-2-6 19:44\n毛玩意\n适用于VB.net与C#及一切以.net为平台的语言获取MC服务器信息的代码。。。。。"
        },
        {
            "author": "kuangwenxin",
            "timestamp": 1423223160,
            "txt_content": "奥                          "
        },
        {
            "author": "変態のマギ",
            "timestamp": 1423224060,
            "txt_content": "提示: 作者被禁止或删除 内容自动屏蔽"
        },
        {
            "author": "mcmny",
            "timestamp": 1423583700,
            "txt_content": "啦啦啦，拉来版主。。。\n@zhh0000zhh \n"
        },
        {
            "author": "我才是小灰灰",
            "timestamp": 1423612740,
            "txt_content": "类似源码我用E写过"
        },
        {
            "author": "mcmny",
            "timestamp": 1423621740,
            "txt_content": "我才是小灰灰 发表于 2015-2-11 07:59\n类似源码我用E写过\n表示这是我从WIKI.VG那里转来的。。。。"
        },
        {
            "author": "awt2003",
            "timestamp": 1423659780,
            "txt_content": "太好了！我正好需要这个！"
        },
        {
            "author": "wahaha216",
            "timestamp": 1423730340,
            "txt_content": "貌似不能获取localhost的？"
        },
        {
            "author": "mcmny",
            "timestamp": 1423736100,
            "txt_content": "wahaha216 发表于 2015-2-12 16:39\n貌似不能获取localhost的？\n只需要把IP改为127.0.0.1即可。。。。"
        },
        {
            "author": "wahaha216",
            "timestamp": 1423746480,
            "txt_content": "mcmny 发表于 2015-2-12 18:15\n只需要把IP改为127.0.0.1即可。。。。\nsoga。3Q   "
        },
        {
            "author": "PeoLeser",
            "timestamp": 1428236820,
            "txt_content": "简直赞b(￣▽￣)d~"
        },
        {
            "author": "matts8008",
            "timestamp": 1436597100,
            "txt_content": "提示: 作者被禁止或删除 内容自动屏蔽"
        },
        {
            "author": "mcmny",
            "timestamp": 1436597220,
            "txt_content": "matts8008 发表于 2015-7-11 14:45\n这是什么代码？JAVA？\n.NET平台的代码，不是java。。。。"
        },
        {
            "author": "matts8008",
            "timestamp": 1436620320,
            "txt_content": "提示: 作者被禁止或删除 内容自动屏蔽"
        },
        {
            "author": "幻境雲達達",
            "timestamp": 1436621580,
            "txt_content": "然而我根本看不懂233"
        },
        {
            "author": "mmmmm_ccccc",
            "timestamp": 1494393780,
            "txt_content": "请问楼主，为什么不行？出现了一个错误"
        },
        {
            "author": "qq2467315284",
            "timestamp": 1494396120,
            "txt_content": "对于会C#的我来说这真是太好了QWQ\n感谢LZ"
        },
        {
            "author": "gofly",
            "timestamp": 1494638940,
            "txt_content": "大爱楼主！有VB.NET也~"
        },
        {
            "author": "TheEvilDude",
            "timestamp": 1494750780,
            "txt_content": "提示: 作者被禁止或删除 内容自动屏蔽"
        },
        {
            "author": "justiceの深蓝",
            "timestamp": 1500641580,
            "txt_content": "MinecraftServerInfo a = MinecraftServerInfo.GetServerInformation(IPAddress.Parse(\"127.0.0.1\"), 25565);\n\n            Console.WriteLine($\"a.ServerMotd={a.ServerMotd}\");\n            Console.WriteLine($\"a.ServerMotdHtml={a.ServerMotdHtml}\");\n            Console.WriteLine($\"a.MaxPlayerCount={a.MaxPlayerCount}\");\n            Console.WriteLine($\"a.CurrentPlayerCount={a.CurrentPlayerCount}\");\n            Console.WriteLine($\"a.MinecraftVersion={a.MinecraftVersion}\");\n            Console.ReadKey();复制代码\n何必写前面那一堆呢.."
        }
    ]
}